{% from "macros.html" import navigation %}
{% extends "skeleton.html" -%}
{% block title -%}
    Tor Relays
{% endblock -%}
{% block body -%}
<h2>
{% block header -%}
{% endblock -%}
</h2>

{% block navigation -%}
{% endblock -%}

<p>
{% block description -%}
{% endblock -%}
</p>

<p class="text-muted" style="margin-bottom: 15px;">
<small>Last updated: {{ relays.timestamp }}. Refreshed every 30 minutes from the Tor directory authorities via <a href="https://onionoo.torproject.org/">Tor Project's onionoo API</a>.</small>
</p>

<table class="table table-condensed">
<tr>
    <th></th>
    <th>Nickname</th>
    <th><a href="https://nusenu.github.io/ContactInfo-Information-Sharing-Specification/" target="_blank" title="Autonomous Relay Operator Identifier - unverified">AROI</a></th>
    <th>Contact</th>
    <th>BW</th>
    {% if key and not is_index -%}
    <th title="Bandwidth measured by >=3 bandwidth authorities">BW Measured</th>
    {% endif -%}
    <th class="visible-md visible-lg">IP Address</th>
    <th>AS Number</th>
    <th>AS Name</th>
    <th>Country</th>
    <th>Platform</th>
    <th class="visible-md visible-lg">Flags</th>
    <th class="visible-md visible-lg">First Seen</th>
    {% if key and not is_index -%}
    <th class="visible-md visible-lg">Last Restarted</th>
    {% endif -%}
</tr>
<tbody>
    {% if is_index -%}
	{% set relay_list = relays.json['relay_subset'][:500] -%}
    {% else -%}
	{% set relay_list = relays.json['relay_subset'] -%}
    {% endif -%}
    {% for relay in relay_list -%}
	<tr>
	    {% if relay['running'] -%}
		<td>
		    <span class="circle circle-online" title="This relay is online"></span>
		</td>
	    {% else -%}
		<td>
		    <span class="circle circle-offline" title="This relay is offline"></span>
		</td>
	    {% endif -%}
	    {% if relay['effective_family']|length > 1 -%}
		<td title="{{ relay.get('nickname_escaped', relay['nickname']|escape) }}">
		    <a href="{{ page_ctx.path_prefix }}relay/{{ relay['fingerprint']|escape }}/">{{ relay.get('nickname_truncated', relay['nickname'][:14]|escape) }}</a> (<a href="{{ page_ctx.path_prefix }}family/{{ relay['fingerprint']|escape }}/">{{
			relay['effective_family']| length }}</a>)
		    </td>
		{% else -%}
		    <td title="{{ relay.get('nickname_escaped', relay['nickname']|escape) }}">
			<a href="{{ page_ctx.path_prefix }}relay/{{ relay['fingerprint']|escape }}/">{{ relay.get('nickname_truncated', relay['nickname'][:14]|escape) }}</a>
		    </td>
		{% endif -%}
		{% if key != 'contact' -%}
		    {% if relay['aroi_domain'] and relay['aroi_domain'] != 'none' -%}
			<td>
			    <a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/" title="{{ relay.get('aroi_domain_escaped', relay['aroi_domain']|escape) }}">{{ relay.get('aroi_domain_escaped', relay['aroi_domain']|escape) }}</a>
			</td>
		    {% else -%}
			<td>none</td>
		    {% endif -%}
		    {% if relay['contact'] -%}
			<td>
			    <a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/" 
				title="{{ relay.get('contact_escaped', relay['contact']|escape) }}" class="contact-text">{{ relay.get('contact_escaped', relay['contact']|escape) }}</a>
			</td>
		    {% else -%}
			<td title="none">
			    none
			</td>
		    {% endif -%}
		{% else -%}
		    {% if relay['aroi_domain'] and relay['aroi_domain'] != 'none' -%}
			<td>{{ relay.get('aroi_domain_escaped', relay['aroi_domain']|escape) }}</td>
		    {% else -%}
			<td>none</td>
		    {% endif -%}
		    <td title="{{ relay.get('contact_escaped', relay['contact']|escape) }}">
			<span class="contact-text">{{ relay.get('contact_escaped', relay['contact']|escape) }}</span>
		    </td>
		{% endif -%}
		<td>{{ relay.get('obs_bandwidth_with_unit', relay['observed_bandwidth']|filesizeformat) }}</td>
		{% if key and not is_index -%}
		    <td title=">=3 bandwidth authorities have measured">
		        {% if relay['measured'] is not none -%}
		            {% if relay['measured'] -%}Yes{% else -%}No{% endif -%}
		        {% else -%}
		            unknown
		        {% endif -%}
		    </td>
		{% endif -%}
		<td class="visible-md visible-lg">
		    <a href="https://bgp.tools/prefix/{{ relay.get('ip_address', relay['or_addresses'][0].split(':')[0] if relay.get('or_addresses') else 'unknown')|escape }}">{{ relay.get('ip_address', relay['or_addresses'][0].split(':')[0] if relay.get('or_addresses') else 'unknown')|escape }}</a>
		</td>
		{% if relay['as'] -%}
		    {% if key != 'as' -%}
			<td>
			    <a href="{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/">{{
			    relay['as']|escape }}</a>
			</td>
		    {% else -%}
			<td>{{ relay['as']|escape }}</td>
		    {% endif -%}
		{% else -%}
		    <td>Unknown</td>
		{% endif -%}
		{% if relay['as_name'] -%}
		    <td>
			<a href="https://bgp.tools/{{ relay['as']|escape }}"
			   title="{{ relay.get('as_name_escaped', relay['as_name']|escape) }}">{{ relay.get('as_name_truncated', relay['as_name'][:20]|escape) }}</a>
		    </td>
		{% else -%}
		    <td>Unknown</td>
		{% endif -%}
		{% if relay['country'] -%}
		    {% if key != 'country' -%}
			<td>
			    <a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">
				<img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relay['country']|escape }}.png"
				     title="{{ relay['country_name']|escape }}"
				     alt="{{ relay['country_name']|escape }}">
			    </a>
			</td>
		    {% else -%}
			<td>
			    <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relay['country']|escape }}.png"
				 title="{{ relay['country_name']|escape }}"
				 alt="{{ relay['country_name']|escape }}">
			    {{ relay['country_name']|escape }}
			</td>
		    {% endif -%}
		{% else -%}
		    <td>X</td>
		{% endif -%}
		{% if key != 'platform' -%}
		    <td>
			<a href="{{ page_ctx.path_prefix }}platform/{{ relay['platform']|escape }}/">{{ relay.get('platform_truncated', relay['platform'][:10]|escape) }}</a>
		    </td>
		{% else -%}
		    <td>{{ relay.get('platform_truncated', relay['platform'][:10]|escape) }}</td>
		{% endif -%}
		<td class="visible-md visible-lg">
		    {% for flag in relay['flags'] -%}
			{% if flag != 'StaleDesc' -%}
			    {% set flag_idx = loop.index0 -%}
			    {% if relay.get('flags_lower_escaped') -%}
			        {# Multi-threaded mode: use pre-computed escaped values #}
			        <a href="{{ page_ctx.path_prefix }}flag/{{ relay['flags_lower_escaped'][flag_idx] }}/">
				    <img src="{{ page_ctx.path_prefix }}static/images/flags/{{ relay['flags_lower_escaped'][flag_idx] }}.png"
				         title="{{ relay['flags_escaped'][flag_idx] }}"
				         alt="{{ relay['flags_escaped'][flag_idx] }}">
			        </a>
			    {% else -%}
			        {# Single-threaded mode: compute values inline (original behavior) #}
			        <a href="{{ page_ctx.path_prefix }}flag/{{ flag|lower|escape }}/">
				    <img src="{{ page_ctx.path_prefix }}static/images/flags/{{ flag|lower|escape }}.png"
				         title="{{ flag|escape }}"
				         alt="{{ flag|escape }}">
			        </a>
			    {% endif -%}
			{% endif -%}
		    {% endfor
		    -%}
		</td>
		{% if key != 'first_seen' -%}
		    <td class="visible-md visible-lg">
			<a href="{{ page_ctx.path_prefix }}first_seen/{{ relay.get('first_seen_date_escaped', relay['first_seen'].split(' ')[0]|escape) }}/">{{ relay.get('first_seen_date_escaped', relay['first_seen'].split(' ')[0]|escape) }}</a>
		    </td>
		{% else -%}
		    <td class="visible-md visible-lg">
			{{ relay.get('first_seen_date_escaped', relay['first_seen'].split(' ')[0]|escape) }}
		    </td>
		{% endif -%}
		{% if key and not is_index -%}
		    <td class="visible-md visible-lg" title="{{ relay.get('last_restarted_date', relay.get('last_restarted', 'unknown').split(' ')[0])|escape }}">
		        {{ relay.get('last_restarted_ago', 'unknown') }}
		    </td>
		{% endif -%}
	    </tr>
	{% endfor -%}
    </tbody>
</table>
{% endblock -%}
