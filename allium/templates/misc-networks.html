{% from "macros.html" import navigation %}
{% extends "skeleton.html" -%}
{% set sorted_by_label = sorted_by.split(',')[0].split('.')[1] -%}
{% block title -%}
    Relay Radar :: AS Networks By {{ sorted_by_label|replace('_',
    ' ')|title }}
{% endblock -%}
{% block body -%}
    <h2>
        AS Networks by {{ sorted_by_label|replace('_', ' ')|title }}
    </h2>
    
    {{ navigation('networks', is_misc_page=true) }}
    
    <p>
        Internet providers hosting Tor relays - reveals dependency on specific hosting companies and network infrastructure.
    </p>

    <ul style="margin-bottom: 15px;">
        <li><strong>Networks</strong>: {{ relays.json['sorted']['as']|length }} Autonomous Systems (ASes) hosting relays currently active</li>
        <li><strong>Network Totals</strong>: {{ relays.json['sorted']['as'].values()|sum(attribute='guard_count') }} Guard, {{ relays.json['sorted']['as'].values()|sum(attribute='middle_count') }} Middle, {{ relays.json['sorted']['as'].values()|sum(attribute='exit_count') }} Exit for {{ relays.json['sorted']['as'].values()|sum(attribute='guard_count') + relays.json['sorted']['as'].values()|sum(attribute='middle_count') + relays.json['sorted']['as'].values()|sum(attribute='exit_count') }} Total Relays</li>
        <li><strong>Infrastructure Dependency</strong>: {% set as_list = relays.json['sorted']['as'].values()|list %}{% if as_list %}{% set largest_as = as_list|max(attribute='consensus_weight_fraction') %}{{ "%.1f"|format((largest_as.consensus_weight_fraction|default(0)) * 100) }}% hosted by largest AS{% else %}0% hosted by largest AS{% endif %} | {% set sorted_as = as_list|sort(attribute='consensus_weight_fraction', reverse=true) %}{% set top_3_weight = sorted_as[:3]|sum(attribute='consensus_weight_fraction') %}{{ "%.1f"|format((top_3_weight|default(0)) * 100) }}% in top 3 ASes | {% set single_relay_count = 0 %}{% for as_data in as_list %}{% set total_relays = (as_data.guard_count|default(0)) + (as_data.middle_count|default(0)) + (as_data.exit_count|default(0)) %}{% if total_relays == 1 %}{% set single_relay_count = single_relay_count + 1 %}{% endif %}{% endfor %}{{ single_relay_count }} networks host single relays only</li>
        <li><strong>Sorted by</strong>: {{ sorted_by_label|replace('_', ' ') }}</li>
        <li><strong>Key</strong>: BW = Bandwidth, CW = Consensus Weight, AS = Autonomous System (network provider)</li>
    </ul>
    
    <p class="text-muted" style="margin-bottom: 15px;">
    <small>Last updated: {{ relays.timestamp }}. Refreshed every 30 minutes from the Tor directory authorities via <a href="https://onionoo.torproject.org/">Tor Project's onionoo API</a>.</small>
    </p>
    
    <div class="table-responsive-xs">
    <table class="table table-condensed mobile-simplified">
        <tr>
            <th>AS Number</th>
            <th class="hidden-xs">AS Name</th>
            <th>Country</th>
            <th class="text-center bw-header" title="Bandwidth">BW</th>
            <th class="text-center cw-header hidden-xs-extra" title="Consensus Weight">CW</th>
            <th class="text-center rc-header">Relays</th>
            <th class="hidden-xs" title="Number of unique AROI / contact operators using this network">Contacts</th>
            <th class="hidden-sm" title="Number of unique effective families using this network">Families</th>
        </tr>
        <tbody>
            {% for k, v in relays.json['sorted']['as'].items()|sort(attribute=sorted_by,
                reverse=True) -%}
                <tr>
                    {% set obs_unit = relays._determine_unit(v['bandwidth']) -%}
                    {% set obs_bandwidth = relays._format_bandwidth_with_unit(v['bandwidth'], obs_unit) -%}
                    {% set guard_bw = relays._format_bandwidth_with_unit(v['guard_bandwidth'], obs_unit) -%}
                    {% set middle_bw = relays._format_bandwidth_with_unit(v['middle_bandwidth'], obs_unit) -%}
                    {% set exit_bw = relays._format_bandwidth_with_unit(v['exit_bandwidth'], obs_unit) -%}
                    <td>
                        <a href="{{ path_prefix }}as/{{ k|escape }}/">{{ k|escape }}</a>
                    </td>
                    {% if v['as_name'] -%}
                        <td class="hidden-xs" title="{{ v['as_name']|escape }}">
                            <a href="https://bgp.tools/{{ k|escape }}">{{ v['as_name']|truncate(20)|escape }}</a>
                        </td>
                    {% else -%}
                        <td class="hidden-xs">Unknown</td>
                    {% endif -%}
                    {% if v['country'] -%}
                        <td>
                            <a href="{{ path_prefix }}country/{{ v['country']|escape }}/">
                                <img src="{{ path_prefix }}static/images/cc/{{ v['country']|escape }}.png"
                                     title="{{ v['country_name']|escape }}"
                                     alt="{{ v['country_name']|escape }}">
                            </a>
                        </td>
                    {% else -%}
                        <td>X</td>
                    {% endif -%}
                    {% if v['bandwidth'] == 0 -%}
                        <td class="text-center bw-data">0 {{ obs_unit }}</td>
                    {% else -%}
                        <td class="text-center bw-data">{{ obs_bandwidth }} {{ obs_unit }}</td>
                    {% endif -%}
                    {% if v['consensus_weight_fraction'] == 0 and v['guard_consensus_weight_fraction'] == 0 and v['middle_consensus_weight_fraction'] == 0 and v['exit_consensus_weight_fraction'] == 0 -%}
                        <td class="text-center cw-data hidden-xs-extra">0%</td>
                    {% else -%}
                        <td class="text-center cw-data hidden-xs-extra">{{ "%.2f%%"|format(v['consensus_weight_fraction'] * 100) }}</td>
                    {% endif -%}
                    <td class="text-center rc-data">{{ v['guard_count'] + v['middle_count'] + v['exit_count'] }}</td>
                    <td class="hidden-xs">{{ v['unique_contact_count'] }}</td>
                    <td class="hidden-sm">{{ v['unique_family_count'] }}</td>
                </tr>
            {% endfor -%}
        </tbody>
    </table>
    </div>
{% endblock -%}
