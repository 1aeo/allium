{% from "macros.html" import navigation %}
{% extends "skeleton.html" -%}
{% block title -%}
    Relay Radar :: Directory Authorities by Network Health
{% endblock -%}
{% block body -%}
    <h2>
        Directory Authorities by Network Health
    </h2>
    
    {{ navigation('authorities', page_ctx) }}
    
    <p>
        Directory authorities vote on the status of relays in the Tor network and provide bandwidth measurements. Monitor their health and consensus participation.
    </p>

    <ul style="margin-bottom: 15px;">
        <li><strong>Directory Authorities:</strong> {{ relays.authorities_summary.total_authorities }} authorities currently active</li>
        <li><strong>Version Compliance:</strong> 
            {% set compliant_authorities = relays.authorities_data | selectattr('recommended_version', 'equalto', true) | list %}
            {% set non_compliant_authorities = relays.authorities_data | selectattr('recommended_version', 'equalto', false) | list %}
            {{ compliant_authorities|length }}/{{ relays.authorities_summary.total_authorities }} on recommended version | {{ non_compliant_authorities|length }}/{{ relays.authorities_summary.total_authorities }} non-compliant
        </li>
        <li><strong>Uptime Status (1M):</strong> 
            {% if relays.authorities_summary.above_average_uptime -%}
                <span style="color: green; font-weight: bold;">{{ relays.authorities_summary.above_average_uptime|length }} above average</span>
            {% else -%}
                <span style="color: green; font-weight: bold;">0 above average</span>
            {%- endif %} | 
            {% if relays.authorities_summary.below_average_uptime -%}
                <span style="color: #ff8c00; font-weight: bold;">{{ relays.authorities_summary.below_average_uptime|length }} below average</span>
            {% else -%}
                <span style="color: #ff8c00; font-weight: bold;">0 below average</span>
            {%- endif %} | 
            {% if relays.authorities_summary.problem_uptime -%}
                <span style="color: red; font-weight: bold;">{{ relays.authorities_summary.problem_uptime|length }} problematic</span>
            {% else -%}
                <span style="color: red; font-weight: bold;">0 problematic</span>
            {%- endif %}
        </li>
                    <li><strong>Key:</strong> BW = Observed Bandwidth Capacity, CW = Consensus Weight, Z = Z-score (statistical uptime deviation)</li>
    </ul>

    <br>

    <!-- MAIN AUTHORITY TABLE -->
    <h3>Directory Authority Status</h3>
    <br>
    
    <p class="text-muted" style="margin-bottom: 15px;">
    <small>Last updated: {{ relays.timestamp }}. Refreshed every 30 minutes from the Tor directory authorities via <a href="https://onionoo.torproject.org/">Tor Project's onionoo API</a>.</small>
    </p>
    
    <!-- AUTHORITY HEALTH ALERTS - From real-time health checks -->
    {% if relays.consensus_health_data and relays.consensus_health_data.alerts %}
    {% set alerts = relays.consensus_health_data.alerts %}
    {% if alerts %}
    <div style="margin-bottom: 15px;">
        {% for alert in alerts %}
        <div style="background: {% if alert.severity == 'critical' %}#f8d7da{% elif alert.severity == 'error' %}#f8d7da{% else %}#fff3cd{% endif %}; 
                    border: 1px solid {% if alert.severity == 'critical' %}#f5c6cb{% elif alert.severity == 'error' %}#f5c6cb{% else %}#ffeaa7{% endif %}; 
                    color: {% if alert.severity == 'critical' %}#721c24{% elif alert.severity == 'error' %}#721c24{% else %}#856404{% endif %}; 
                    padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <strong>{% if alert.severity == 'critical' %}üö®{% elif alert.severity == 'error' %}‚ö†Ô∏è{% else %}‚è±Ô∏è{% endif %} {{ alert.message }}</strong>
            {% if alert.details %}<br><small>{{ alert.details }}</small>{% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endif %}

    <!-- UPTIME DATA STATUS NOTIFICATION -->
    {% if relays.uptime_metadata -%}
        {% if relays.uptime_metadata.status == 'not_modified' -%}
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚ÑπÔ∏è Uptime Data Status:</strong> 
                {% if relays.uptime_metadata.last_updated -%}
                    Uptime statistics unchanged since last check. Last updated: <strong>{{ relays.uptime_metadata.last_updated }}</strong>
                {% else -%}
                    Uptime statistics unchanged since last check.
                {%- endif %}
                <br><small>This means the uptime data shown below may not reflect the most recent changes.</small>
            </div>
        {% elif relays.uptime_metadata.status == 'error' -%}
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚ö†Ô∏è Uptime Data Error:</strong> {{ relays.uptime_metadata.message }}
                <br><small>Uptime statistics may be unavailable or incomplete.</small>
            </div>
        {% elif relays.uptime_metadata.status == 'success' and relays.uptime_metadata.last_updated -%}
            <div style="background: #d1edff; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚úÖ Uptime Data Fresh:</strong> Successfully updated {{ relays.uptime_metadata.last_updated }}
                {% if relays.uptime_metadata.authorities_count -%}
                    ({{ relays.uptime_metadata.authorities_count }} authorities)
                {%- endif %}
            </div>
        {%- endif %}
    {%- endif %}
    
    <table class="table table-condensed" style="font-size: 13px;">
        <tr>
            <th>Authority Name</th>
            <th>Online Status</th>
            <th title="Bandwidth Authority: Does this authority run a bandwidth scanner to measure relay speeds?">BW Auth</th>
            <th title="Voted this hour: Did this authority submit a vote in the most recent consensus cycle?">Voted</th>
            <th>AS Number</th>
            <th>AS Name</th>
            <th>Country</th>
            <th title="Percentage of time authority was online over 1 month, 6 months, 1 year, and 5 years periods">Uptime (1M/6M/1Y/5Y)</th>
            <th>Version</th>
            <th>Platform</th>
            <th title="Version compliance: ‚úÖ = On recommended version, ‚ùå = Not on recommended version">Rec. Ver.</th>
            <th>First Seen</th>
            <th>Last Restarted</th>
        </tr>
        <tbody>
        {% for authority in relays.authorities_data -%}
            <tr>
                {% set is_problematic = not authority.running or (authority.uptime_zscore and authority.uptime_zscore <= -2.0) -%}
                <td>
                    <a href="{{ page_ctx.path_prefix }}relay/{{ authority.fingerprint }}/" 
                       {% if is_problematic %}style="color: #dc3545; font-weight: bold; text-decoration: underline;"
                       {% else %}style="text-decoration: underline;"{% endif %}>
                        {{ authority.nickname }}
                    </a>
                </td>
                <td>
                    {% if authority.running -%}
                        <span style="color: green; font-weight: bold;">üü¢ Online</span>
                    {% else -%}
                        <span style="color: red; font-weight: bold;">üî¥ Offline (last seen: {{ authority.last_seen }})</span>
                    {%- endif %}
                </td>
                <td style="text-align: center;">
                    {% if relays.collector_bw_authorities and authority.nickname in relays.collector_bw_authorities %}
                        <span style="color: #28a745;" title="Runs bandwidth scanner">üìä Yes</span>
                    {% else %}
                        <span style="color: #6c757d;" title="Does not run bandwidth scanner">No</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if relays.collector_flag_thresholds and authority.nickname in relays.collector_flag_thresholds %}
                        <span style="color: #28a745;" title="Submitted vote this hour">‚úì</span>
                    {% elif relays.collector_flag_thresholds %}
                        <span style="color: #dc3545;" title="Did not submit vote this hour">‚úó</span>
                    {% else %}
                        <span style="color: #6c757d;" title="CollecTor data not available">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if authority.as -%}
                        <a href="{{ page_ctx.path_prefix }}as/{{ authority.as }}/">{{ authority.as }}</a>
                    {% else -%}
                        N/A
                    {%- endif %}
                </td>
                <td>
                    {% if authority.as_name -%}
                        <a href="https://bgp.tools/{{ authority.as }}" title="{{ authority.as_name }}">{{ authority.as_name|truncate(length=20) }}</a>
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.country -%}
                        <a href="{{ page_ctx.path_prefix }}country/{{ authority.country }}/">
                            <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ authority.country|lower }}.png"
                                 title="{{ authority.country_name }}"
                                 alt="{{ authority.country_name }}">
                        </a>
                        {{ authority.country }}
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('1_month') is not none -%}
                        <span title="1 month uptime: {{ "%.1f%%"|format(authority.uptime_percentages['1_month']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['1_month']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('6_months') is not none -%}
                        <span title="6 month uptime: {{ "%.1f%%"|format(authority.uptime_percentages['6_months']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['6_months']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('1_year') is not none -%}
                        <span title="1 year uptime: {{ "%.1f%%"|format(authority.uptime_percentages['1_year']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['1_year']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('5_years') is not none -%}
                        <span title="5 year uptime: {{ "%.1f%%"|format(authority.uptime_percentages['5_years']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['5_years']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %}
                    {% if authority.uptime_zscore is not none -%}
                        | <span 
                        {% if authority.uptime_zscore > 0.3 -%}
                            style="color: green; font-weight: bold;"
                        {% elif authority.uptime_zscore <= -2.0 -%}
                            style="color: red; font-weight: bold;"
                        {% else -%}
                            style="color: #ff8c00; font-weight: bold;"
                        {%- endif %}
                        title="Z-score: Statistical measure of how far this authority's uptime deviates from the average. Values below -2.0 indicate significantly poor uptime.">Z: {{ "%.1f"|format(authority.uptime_zscore) }}</span>
                    {%- endif %}
                </td>
                <td>{{ authority.version if authority.version else "Unknown" }}</td>
                <td>
                    {% if authority.platform -%}
                        <a href="{{ page_ctx.path_prefix }}platform/{{ authority.platform|escape }}/">{{ authority.platform|escape }}</a>
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.recommended_version is not none -%}
                        {% if authority.recommended_version -%}
                            <span style="color: green; font-weight: bold;" title="Running recommended version">‚úÖ</span>
                        {% else -%}
                            <span style="color: red; font-weight: bold;" title="Not running recommended version">‚ùå</span>
                        {%- endif %}
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.first_seen -%}
                        <a href="{{ page_ctx.path_prefix }}first_seen/{{ authority.first_seen.split(' ')[0].replace('-', '') }}/" title="{{ authority.first_seen }}">{{ authority.first_seen.split(' ')[0] }}</a>
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>{{ authority.last_restarted.split(' ')[0] if authority.last_restarted else "Unknown" }}</td>
            </tr>
        {% endfor -%}
        </tbody>
    </table>

    <br><br>

    <!-- LEGEND/NOTES -->
    <div style="background: #f0f0f0; padding: 15px; border-radius: 6px;">
        <h4>Legend:</h4>
        <ul style="margin: 0; padding-left: 20px;">
            <li><strong>BW Auth (Bandwidth Authority):</strong> <span style="color: #28a745;">üìä Yes</span> = Authority runs a bandwidth scanner to measure relay speeds. Only bandwidth authorities contribute to consensus weight calculations.</li>
            <li><strong>Voted:</strong> <span style="color: #28a745;">‚úì</span> = Authority submitted a vote in the most recent consensus cycle. <span style="color: #dc3545;">‚úó</span> = Vote not received this hour.</li>
            <li><strong>Uptime (1M/6M/1Y/5Y):</strong> Percentage of time authority was online over 1 month, 6 months, 1 year, and 5 years periods</li>
            <li><strong>Uptime Z-Score:</strong> Statistical measure comparing this authority's 1-month uptime to other authorities. <span style="color: green; font-weight: bold;">Green (above average)</span>, <span style="color: #ff8c00; font-weight: bold;">Yellow (normal)</span>, <span style="color: red; font-weight: bold;">Red (significantly below average, ‚â§-2.0)</span></li>
            <li><strong>Version:</strong> Current Tor software version running on the authority</li>
            <li><strong>Platform:</strong> Full platform description including Tor version and operating system</li>
            <li><strong>Rec. Ver.:</strong> Recommended version compliance. <span style="color: green; font-weight: bold;">‚úÖ = On recommended version</span>, <span style="color: red; font-weight: bold;">‚ùå = Not on recommended version</span></li>
            <li><strong>First Seen:</strong> When this authority first appeared in the directory consensus</li>
            <li><strong>Last Restarted:</strong> When the authority software was last restarted</li>
        </ul>
    </div>

    <br><br>

    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    {# FLAG THRESHOLDS TABLE - From CollecTor authority votes                          #}
    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    {% if relays.collector_flag_thresholds %}
    <h3 id="flag-thresholds">
        <a href="#flag-thresholds" style="text-decoration: none; color: inherit;">Flag Thresholds by Authority</a>
    </h3>
    <p class="text-muted" style="margin-bottom: 15px;">
        <small>
            Each directory authority sets its own thresholds for assigning flags to relays. 
            These values are extracted from authority votes via <a href="https://collector.torproject.org" target="_blank" rel="noopener">CollecTor</a>.
            Relays must meet these thresholds to receive the corresponding flags.
        </small>
    </p>

    {# Bandwidth Authorities Indicator #}
    {% if relays.collector_bw_authorities %}
    <div style="background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
        <strong>üìä Bandwidth Authorities:</strong> 
        {{ relays.collector_bw_authorities|join(', ') }}
        <br><small>These authorities run bandwidth scanners and provide measured bandwidth values for relays.</small>
    </div>
    {% endif %}

    <div style="overflow-x: auto;">
    <table class="table table-condensed table-striped" style="font-size: 11px;">
        <thead>
            <tr>
                <th style="min-width: 150px;">Threshold</th>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                <th style="min-width: 80px; text-align: center;">{{ auth_name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {# Guard Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>üõ°Ô∏è Guard Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Weighted Fractional Uptime required for Guard flag (percentage of time online)">Guard WFU</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('guard-wfu') is not none %}
                        {% if thresholds['guard-wfu'] <= 1 %}
                            {{ "%.1f%%"|format(thresholds['guard-wfu'] * 100) }}
                        {% else %}
                            {{ "%.1f%%"|format(thresholds['guard-wfu']) }}
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Time Known required for Guard flag (how long authority has tracked the relay)">Guard Time Known</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('guard-tk') is not none %}
                        {% set days = thresholds['guard-tk'] / 86400 %}
                        {{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Minimum bandwidth required for Guard flag (including exits)">Guard BW (inc. exits)</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('guard-bw-inc-exits') is not none %}
                        {% set bw = thresholds['guard-bw-inc-exits'] %}
                        {% if bw >= 1000000 %}
                            {{ "%.1f MB/s"|format(bw / 1000000) }}
                        {% elif bw >= 1000 %}
                            {{ "%.1f KB/s"|format(bw / 1000) }}
                        {% else %}
                            {{ bw }} B/s
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# Stable Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>‚öì Stable Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Minimum uptime required for Stable flag">Stable Uptime</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('stable-uptime') is not none %}
                        {% set days = thresholds['stable-uptime'] / 86400 %}
                        {{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Mean Time Between Failures required for Stable flag">Stable MTBF</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('stable-mtbf') is not none %}
                        {% set days = thresholds['stable-mtbf'] / 86400 %}
                        {{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# Fast Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>‚ö° Fast Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Minimum bandwidth speed required for Fast flag">Fast Speed</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('fast-speed') is not none %}
                        {% set bw = thresholds['fast-speed'] %}
                        {% if bw >= 1000000 %}
                            {{ "%.1f MB/s"|format(bw / 1000000) }}
                        {% elif bw >= 1000 %}
                            {{ "%.1f KB/s"|format(bw / 1000) }}
                        {% else %}
                            {{ bw }} B/s
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# HSDir Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>üìÅ HSDir Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Weighted Fractional Uptime required for HSDir flag">HSDir WFU</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('hsdir-wfu') is not none %}
                        {% if thresholds['hsdir-wfu'] <= 1 %}
                            {{ "%.1f%%"|format(thresholds['hsdir-wfu'] * 100) }}
                        {% else %}
                            {{ "%.1f%%"|format(thresholds['hsdir-wfu']) }}
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Time Known required for HSDir flag">HSDir Time Known</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('hsdir-tk') is not none %}
                        {% set days = thresholds['hsdir-tk'] / 86400 %}
                        {{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# Additional Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>üìä Other Thresholds</strong></td>
            </tr>
            <tr>
                <td title="Whether MTBF data is sufficient">Enough MTBF</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('enough-mtbf') is not none %}
                        {% if thresholds['enough-mtbf'] == 1 %}
                            <span style="color: #28a745;">‚úì</span>
                        {% else %}
                            <span style="color: #dc3545;">‚úó</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>
    </div>

    <div style="background: #f0f0f0; padding: 15px; border-radius: 6px; margin-top: 15px;">
        <h4>Flag Threshold Legend:</h4>
        <ul style="margin: 0; padding-left: 20px;">
            <li><strong>Guard WFU:</strong> Weighted Fractional Uptime - percentage of time relay has been online. Typically ‚â•98% required.</li>
            <li><strong>Guard Time Known:</strong> How long the authority has tracked this relay. Typically ‚â•8 days (691200 seconds) required.</li>
            <li><strong>Guard BW:</strong> Minimum bandwidth capacity for Guard eligibility. Varies by authority based on network conditions.</li>
            <li><strong>Stable Uptime:</strong> Continuous uptime required for Stable flag. Varies 14-20 days by authority.</li>
            <li><strong>Stable MTBF:</strong> Mean Time Between Failures - average time between relay restarts/failures.</li>
            <li><strong>Fast Speed:</strong> Minimum bandwidth for Fast flag. Based on network median bandwidth.</li>
            <li><strong>HSDir WFU/TK:</strong> Requirements for Hidden Service Directory flag (serving .onion address lookups).</li>
            <li><strong>‚Äî</strong> = Threshold not available or not set by this authority.</li>
        </ul>
    </div>
    {% endif %}

    <!-- FOOTER -->
    <br><br>
    <p><i>Data sources: <a href="https://onionoo.torproject.org" target="_blank" rel="noopener">Onionoo API</a>{% if relays.collector_flag_thresholds %}, <a href="https://collector.torproject.org" target="_blank" rel="noopener">Tor CollecTor</a>{% endif %}</i></p>
    <p><i>Last updated: {{ relays.timestamp }} (updates every 15-60 minutes depending on data source)</i></p>

{% endblock -%} 