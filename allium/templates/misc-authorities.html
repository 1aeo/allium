{% from "macros.html" import navigation %}
{% extends "skeleton.html" -%}
{% block title -%}
    Relay Radar :: Directory Authorities by Network Health
{% endblock -%}
{% block body -%}
    <h2>
        Directory Authorities by Network Health
    </h2>
    
    {{ navigation('authorities', page_ctx) }}
    
    <p>
        Directory authorities vote on the status of relays in the Tor network and provide bandwidth measurements. Monitor their health and consensus participation.
    </p>

    <ul style="margin-bottom: 15px;">
        <li><strong>Directory Authorities:</strong> {{ relays.authorities_summary.total_authorities }} authorities discovered (dynamic from Onionoo)</li>
        
        {# Consensus status from CollecTor #}
        {% if relays.consensus_status %}
        <li><strong>Consensus Status:</strong> 
            {% if relays.consensus_status.freshness == 'fresh' %}
                <span style="color: green; font-weight: bold;">FRESH</span>
            {% elif relays.consensus_status.freshness == 'stale' %}
                <span style="color: #ff8c00; font-weight: bold;">STALE</span>
            {% else %}
                <span style="color: red; font-weight: bold;">{{ relays.consensus_status.freshness|upper }}</span>
            {% endif %}
            | {{ relays.consensus_status.voted_count|default(0) }}/{{ relays.authorities_summary.total_authorities }} Voted at {{ relays.collector_fetched_at.replace('T', ' ').split('.')[0] if relays.collector_fetched_at else relays.timestamp }} (fetch time, votes from same consensus period)
            {% if relays.consensus_status.next_consensus_time %}
            | Next: {{ relays.consensus_status.next_consensus_time }}
            {% endif %}
        </li>
        {% endif %}
        
        {# Consensus Method from CollecTor votes #}
        {% if relays.consensus_method_info and relays.consensus_method_info.current_method %}
        <li><strong>Consensus Method:</strong> 
            <span style="font-weight: bold;">{{ relays.consensus_method_info.current_method }}</span>
            (from consensus document)
            {% if relays.consensus_method_info.max_method and relays.consensus_method_info.max_method > relays.consensus_method_info.current_method %}
            | Max available: <strong>{{ relays.consensus_method_info.max_method }}</strong> (supported by {{ relays.consensus_method_info.max_method_support }}/{{ relays.consensus_method_info.total_voters }} authorities)
            {% endif %}
        </li>
        {% endif %}
        
        <li><strong>Version Compliance:</strong> 
            {% set compliant_authorities = relays.authorities_data | selectattr('recommended_version', 'equalto', true) | list %}
            {% set non_compliant_authorities = relays.authorities_data | selectattr('recommended_version', 'equalto', false) | list %}
            {{ compliant_authorities|length }}/{{ relays.authorities_summary.total_authorities }} on recommended version | {{ non_compliant_authorities|length }}/{{ relays.authorities_summary.total_authorities }} non-compliant
        </li>
        <li><strong>Uptime Status (1M):</strong> 
            {% if relays.authorities_summary.above_average_uptime -%}
                <span style="color: green; font-weight: bold;">{{ relays.authorities_summary.above_average_uptime|length }} above average</span>
            {% else -%}
                <span style="color: green; font-weight: bold;">0 above average</span>
            {%- endif %} | 
            {% if relays.authorities_summary.below_average_uptime -%}
                <span style="color: #ff8c00; font-weight: bold;">{{ relays.authorities_summary.below_average_uptime|length }} below average</span>
            {% else -%}
                <span style="color: #ff8c00; font-weight: bold;">0 below average</span>
            {%- endif %} | 
            {% if relays.authorities_summary.problem_uptime -%}
                <span style="color: red; font-weight: bold;">{{ relays.authorities_summary.problem_uptime|length }} problematic</span>
            {% else -%}
                <span style="color: red; font-weight: bold;">0 problematic</span>
            {%- endif %}
        </li>
        
        {# Latency status (voting authorities only) #}
        {% if relays.latency_summary %}
        <li><strong>Latency Status</strong> <span style="font-size: 0.85em; color: #666;">(voting authorities)</span><strong>:</strong> 
            <span style="color: green;">{{ relays.latency_summary.ok_count|default(0) }}/{{ relays.authorities_summary.total_authorities }} OK</span>
            {% if relays.latency_summary.slow_count > 0 %}
            | <span style="color: #ff8c00;">{{ relays.latency_summary.slow_count }} slow</span>
            {% endif %}
            {% if relays.latency_summary.down_count > 0 %}
            | <span style="color: red;">{{ relays.latency_summary.down_count }} down</span>
            {% endif %}
        </li>
        {% endif %}
        
        <li><strong>Key:</strong> BW = Observed Bandwidth Capacity, CW = Consensus Weight, Z = Z-score (statistical uptime deviation)</li>
    </ul>

    <br>

    <!-- MAIN AUTHORITY TABLE -->
    <h3>Directory Authority Status</h3>
    <br>
    
    <p class="text-muted" style="margin-bottom: 15px;">
    <small>Last updated: {{ relays.timestamp }}. Data from <a href="https://onionoo.torproject.org/">Onionoo API</a> + <a href="https://collector.torproject.org" target="_blank" rel="noopener">CollecTor</a> (votes, thresholds).</small>
    </p>
    
    <!-- UPTIME DATA STATUS NOTIFICATION -->
    {% if relays.uptime_metadata -%}
        {% if relays.uptime_metadata.status == 'not_modified' -%}
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚ÑπÔ∏è Uptime Data Status:</strong> 
                {% if relays.uptime_metadata.last_updated -%}
                    Uptime statistics unchanged since last check. Last updated: <strong>{{ relays.uptime_metadata.last_updated }}</strong>
                {% else -%}
                    Uptime statistics unchanged since last check.
                {%- endif %}
                <br><small>This means the uptime data shown below may not reflect the most recent changes.</small>
            </div>
        {% elif relays.uptime_metadata.status == 'error' -%}
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚ö†Ô∏è Uptime Data Error:</strong> {{ relays.uptime_metadata.message }}
                <br><small>Uptime statistics may be unavailable or incomplete.</small>
            </div>
        {% elif relays.uptime_metadata.status == 'success' and relays.uptime_metadata.last_updated -%}
            <div style="background: #d1edff; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚úÖ Uptime Data Fresh:</strong> Successfully updated {{ relays.uptime_metadata.last_updated }}
                {% if relays.uptime_metadata.authorities_count -%}
                    ({{ relays.uptime_metadata.authorities_count }} authorities)
                {%- endif %}
            </div>
        {%- endif %}
    {%- endif %}
    
    {# Main table: EXISTING columns + 3 NEW columns (Voted, BW Auth, Latency) #}
    <table class="table table-condensed" style="font-size: 13px;">
        <tr>
            <th title="Source: Onionoo | File: details | Field: nickname (has Authority flag)">Authority Name</th>
            <th title="Source: Onionoo | File: details | Field: running">Online Status</th>
            {# NEW columns with detailed tooltips #}
            <th title="Source: CollecTor | Vote file exists for this consensus period{% if relays.collector_fetched_at %} | Checked: {{ relays.collector_fetched_at.replace('T', ' ').split('.')[0] }}{% endif %}">Voted</th>
            <th title="Source: CollecTor | Has 'bandwidth-file-headers' line = runs sbws scanner">BW Auth</th>
            <th title="TCP connection test to authority's directory port | Response time in milliseconds">Latency (ms)</th>
            <th title="Source: CollecTor | Consensus method this authority supports (from consensus-methods line in vote)">Consensus Method</th>
            {# Existing columns #}
            <th title="Source: Onionoo | File: details | Field: as">AS Number</th>
            <th title="Source: Onionoo | File: details | Field: as_name">AS Name</th>
            <th title="Source: Onionoo | File: details | Field: country">Country</th>
            <th title="Source: Onionoo | File: uptime | 1M/6M/1Y/5Y uptime percentages">Uptime (1M/6M/1Y/5Y)</th>
            <th title="Source: Onionoo | File: details | Field: version">Version</th>
            <th title="Source: Onionoo | File: details | Field: recommended_version">Rec. Ver.</th>
            <th title="Source: Onionoo | File: details | Field: first_seen | Time since first observed on network">Age</th>
            <th title="Source: Onionoo | File: details | Field: last_restarted">Last Restarted</th>
        </tr>
        <tbody>
        {% for authority in relays.authorities_data -%}
            <tr>
                {% set is_problematic = not authority.running or (authority.uptime_zscore and authority.uptime_zscore <= -2.0) -%}
                <td>
                    <a href="{{ page_ctx.path_prefix }}relay/{{ authority.fingerprint }}/" 
                       {% if is_problematic %}style="color: #dc3545; font-weight: bold; text-decoration: underline;"
                       {% else %}style="text-decoration: underline;"{% endif %}>
                        {{ authority.nickname }}
                    </a>
                </td>
                <td>
                    {% if authority.running -%}
                        <span style="color: green; font-weight: bold;">üü¢ Online</span>
                    {% else -%}
                        <span style="color: red; font-weight: bold;">üî¥ Offline</span>
                    {%- endif %}
                </td>
                
                {# NEW: Voted status - show relay count if voted, colored text #}
                <td>
                    {% if authority.collector_data and authority.collector_data.voted %}
                        {% set relay_count = authority.collector_data.relay_count|default(0) %}
                        <span style="color: {% if relay_count > 1 %}#28a745{% else %}#dc3545{% endif %}; font-weight: bold;" title="Vote received with {{ relay_count }} relays{% if relays.collector_fetched_at %} | Checked: {{ relays.collector_fetched_at.replace('T', ' ').split('.')[0] }}{% endif %}">{{ relay_count }}</span>
                    {% elif authority.collector_data is defined %}
                        <span style="color: #dc3545; font-weight: bold;" title="No vote file found at https://collector.torproject.org/recent/relay-descriptors/votes/{% if relays.collector_fetched_at %} | Checked: {{ relays.collector_fetched_at.replace('T', ' ').split('.')[0] }}{% endif %}">0</span>
                    {% else %}
                        <span style="color: #6c757d;" title="CollecTor data not available">‚Äî</span>
                    {% endif %}
                </td>
                
                {# NEW: BW Authority status #}
                <td>
                    {% if authority.collector_data and authority.collector_data.is_bw_authority %}
                        <span style="color: #28a745; font-weight: bold;" title="Runs bandwidth scanner (sbws)">Yes</span>
                    {% else %}
                        <span style="color: #6c757d;" title="Does not run bandwidth scanner">No</span>
                    {% endif %}
                </td>
                
                {# NEW: Latency #}
                <td>
                    {% if authority.latency_ms is defined and authority.latency_ms is not none %}
                        {% if authority.latency_ms >= 2000 %}
                            <span style="color: #dc3545; font-weight: bold;" title="Connection timed out after 2 seconds{% if authority.latency_checked_at %} | Checked: {{ authority.latency_checked_at.replace('T', ' ').split('.')[0] }}{% endif %}">Timeout</span>
                        {% elif authority.latency_ms > 500 %}
                            <span style="color: #dc3545; font-weight: bold;" title="Response time: {{ authority.latency_ms|round|int }} ms (slow, >500ms){% if authority.latency_checked_at %} | Checked: {{ authority.latency_checked_at.replace('T', ' ').split('.')[0] }}{% endif %}">{{ authority.latency_ms|round|int }}</span>
                        {% elif authority.latency_ms > 200 %}
                            <span style="color: #ff8c00;" title="Response time: {{ authority.latency_ms|round|int }} ms (moderate, >200ms){% if authority.latency_checked_at %} | Checked: {{ authority.latency_checked_at.replace('T', ' ').split('.')[0] }}{% endif %}">{{ authority.latency_ms|round|int }}</span>
                        {% else %}
                            <span title="Response time: {{ authority.latency_ms|round|int }} ms (good, ‚â§200ms){% if authority.latency_checked_at %} | Checked: {{ authority.latency_checked_at.replace('T', ' ').split('.')[0] }}{% endif %}">{{ authority.latency_ms|round|int }}</span>
                        {% endif %}
                    {% elif authority.latency_error is defined and authority.latency_error %}
                        <span style="color: #dc3545; font-weight: bold;" title="Error: {{ authority.latency_error }}{% if authority.latency_checked_at %} | Checked: {{ authority.latency_checked_at.replace('T', ' ').split('.')[0] }}{% endif %}">‚úó</span>
                    {% else %}
                        <span style="color: #6c757d;" title="Latency check not performed">‚Äî</span>
                    {% endif %}
                </td>
                
                {# Max consensus method this authority supports #}
                <td>
                    {% if authority.collector_data and authority.collector_data.max_consensus_method %}
                        {% set auth_max = authority.collector_data.max_consensus_method %}
                        {% set network_max = relays.consensus_method_info.max_method if relays.consensus_method_info else None %}
                        <span style="{% if network_max and auth_max >= network_max %}color: #28a745; font-weight: bold;{% elif auth_max %}color: #dc3545;{% endif %}" title="This authority supports consensus method {{ auth_max }}{% if network_max and auth_max < network_max %} (network highest: {{ network_max }}){% endif %}">{{ auth_max }}</span>
                    {% else %}
                        <span style="color: #6c757d;" title="No vote data available">‚Äî</span>
                    {% endif %}
                </td>
                
                <td>
                    {% if authority.as -%}
                        <a href="{{ page_ctx.path_prefix }}as/{{ authority.as }}/">{{ authority.as }}</a>
                    {% else -%}
                        N/A
                    {%- endif %}
                </td>
                <td>
                    {% if authority.as_name -%}
                        <a href="https://bgp.tools/{{ authority.as }}" title="{{ authority.as_name }}">{{ authority.as_name|truncate(length=20) }}</a>
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.country -%}
                        <a href="{{ page_ctx.path_prefix }}country/{{ authority.country }}/">
                            <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ authority.country|lower }}.png"
                                 title="{{ authority.country_name }}"
                                 alt="{{ authority.country_name }}">
                        </a>
                        {{ authority.country }}
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('1_month') is not none -%}
                        <span title="1 month uptime: {{ "%.1f%%"|format(authority.uptime_percentages['1_month']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['1_month']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('6_months') is not none -%}
                        <span title="6 month uptime: {{ "%.1f%%"|format(authority.uptime_percentages['6_months']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['6_months']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('1_year') is not none -%}
                        <span title="1 year uptime: {{ "%.1f%%"|format(authority.uptime_percentages['1_year']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['1_year']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('5_years') is not none -%}
                        <span title="5 year uptime: {{ "%.1f%%"|format(authority.uptime_percentages['5_years']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['5_years']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %}
                    {% if authority.uptime_zscore is not none -%}
                        | <span 
                        {% if authority.uptime_zscore > 0.3 -%}
                            style="color: green; font-weight: bold;"
                        {% elif authority.uptime_zscore <= -2.0 -%}
                            style="color: red; font-weight: bold;"
                        {% else -%}
                            style="color: #ff8c00; font-weight: bold;"
                        {%- endif %}
                        title="Z-score: Statistical measure of how far this authority's uptime deviates from the average. Values below -2.0 indicate significantly poor uptime.">Z: {{ "%.1f"|format(authority.uptime_zscore) }}</span>
                    {%- endif %}
                </td>
                <td>{{ authority.version if authority.version else "Unknown" }}</td>
                <td>
                    {% if authority.recommended_version is not none -%}
                        {% if authority.recommended_version -%}
                            <span style="color: #28a745; font-weight: bold;" title="Running recommended version">Yes</span>
                        {% else -%}
                            <span style="color: #dc3545; font-weight: bold;" title="Not running recommended version">No</span>
                        {%- endif %}
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.first_seen_relative -%}
                        <a href="{{ page_ctx.path_prefix }}first_seen/{{ authority.first_seen.split(' ')[0].replace('-', '') }}/" title="{{ authority.first_seen_timestamp }}">{{ authority.first_seen_relative }}</a>
                    {% elif authority.first_seen -%}
                        <a href="{{ page_ctx.path_prefix }}first_seen/{{ authority.first_seen.split(' ')[0].replace('-', '') }}/" title="{{ authority.first_seen }}">{{ authority.first_seen.split(' ')[0] }}</a>
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>{{ authority.last_restarted.split(' ')[0] if authority.last_restarted else "Unknown" }}</td>
            </tr>
        {% endfor -%}
        </tbody>
    </table>

    {# ALERTS SECTION #}
    {% if relays.authority_alerts %}
    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px 15px; border-radius: 6px; margin-top: 10px;">
        <strong>‚ö†Ô∏è Alerts:</strong>
        <ul style="margin: 5px 0; padding-left: 20px;">
        {% for alert in relays.authority_alerts %}
            <li>{{ alert }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    <br><br>

    <!-- LEGEND/NOTES -->
    <div style="background: #f0f0f0; padding: 15px; border-radius: 6px; margin-top: 15px;">
        <h4>Legend:</h4>
        <ul style="margin: 0; padding-left: 20px;">
            <li><strong>Online:</strong> üü¢ = Online, üî¥ = Offline</li>
            <li><strong>Voted:</strong> Shows number of relays in authority's vote. <span style="color: #28a745; font-weight: bold;">Green (&gt;1)</span> = Vote received with relays, <span style="color: #dc3545; font-weight: bold;">Red (0)</span> = No vote or empty. Hover for details and check timestamp.</li>
            <li><strong>BW Auth:</strong> <span style="color: #28a745; font-weight: bold;">Yes</span> = Runs bandwidth scanner (sbws), <span style="color: #6c757d;">No</span> = Does not run scanner</li>
            <li><strong>Latency (ms):</strong> TCP connection time to authority's directory port. <span style="color: #ff8c00;">Orange = &gt;200ms</span>, <span style="color: #dc3545; font-weight: bold;">Red = &gt;500ms</span>, <span style="color: #dc3545; font-weight: bold;">Timeout</span> = &gt;2s, <span style="color: #dc3545; font-weight: bold;">‚úó</span> = Connection failed. Hover for exact time and check timestamp.</li>
            <li><strong>Uptime (1M/6M/1Y/5Y):</strong> Percentage of time authority was online over 1 month, 6 months, 1 year, and 5 years periods</li>
            <li><strong>Uptime Z-Score:</strong> Statistical measure comparing this authority's 1-month uptime to other authorities. <span style="color: green; font-weight: bold;">Green (above average)</span>, <span style="color: #ff8c00; font-weight: bold;">Yellow (normal)</span>, <span style="color: red; font-weight: bold;">Red (significantly below average, ‚â§-2.0)</span></li>
            <li><strong>Rec. Ver.:</strong> <span style="color: green; font-weight: bold;">Yes</span> = On recommended version, <span style="color: red; font-weight: bold;">No</span> = Not recommended</li>
            <li><strong>Age:</strong> Time since authority was first observed on the network (hover for exact timestamp)</li>
        </ul>
    </div>

    {# Flag Thresholds Table - from CollecTor consensus data #}
    {% if relays.collector_flag_thresholds %}
    <br><br>
    <h3 id="flag-thresholds">
        <a href="#flag-thresholds" style="text-decoration: none; color: inherit;">Flag Thresholds by Authority</a>
    </h3>
    <p class="text-muted" style="font-size: 13px; margin-bottom: 15px;">
        Each directory authority has different thresholds for assigning flags to relays. 
        Values extracted from authority votes via <a href="https://collector.torproject.org/recent/relay-descriptors/votes/" target="_blank" rel="noopener">Tor CollecTor</a>{% if relays.collector_fetched_at %} (fetched: {{ relays.collector_fetched_at }}){% endif %}.
    </p>
    
    <div style="overflow-x: auto; overflow-y: visible; position: relative;">
    <table class="table table-condensed table-striped" style="font-size: 12px;">
        <thead>
            <tr>
                <th>Threshold</th>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                <th style="text-align: center;">{{ auth_name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {# Guard Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>üõ°Ô∏è Guard Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Weighted Fractional Uptime required for Guard flag">Guard WFU</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('guard-wfu') is not none %}
                        {% if thresholds['guard-wfu'] <= 1 %}
                            ‚â•{{ "%.1f%%"|format(thresholds['guard-wfu'] * 100) }}
                        {% else %}
                            ‚â•{{ "%.1f%%"|format(thresholds['guard-wfu']) }}
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Time Known required for Guard flag (how long authority has tracked the relay)">Guard Time Known</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('guard-tk') is not none %}
                        {% set days = thresholds['guard-tk'] / 86400 %}
                        ‚â•{{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Top 25% bandwidth threshold (guard-bw-inc-exits). Relays with observed_bandwidth above this OR ‚â•2 MB/s qualify for Guard.">Guard BW (top 25%)</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('guard-bw-inc-exits') is not none %}
                        {% set bw = thresholds['guard-bw-inc-exits'] %}
                        {% set bw_unit = bw|determine_unit(relays.use_bits) %}
                        {% set bw_formatted = bw|format_bandwidth_with_unit(bw_unit) %}
                        ‚â•{{ bw_formatted }} {{ bw_unit }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="V2Dir flag - relay supports directory protocol v2+. Required for Guard. Based on relay capability (DirPort or tunneled-dir-server), not a threshold.">V2Dir Flag</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {# V2Dir is a capability flag, not threshold-based. All authorities require it for Guard. #}
                    {% if thresholds.get('known_flags') and 'V2Dir' in thresholds.get('known_flags', []) %}
                        <span style="color: #28a745;">‚úì Required</span>
                    {% else %}
                        <span style="color: #28a745;">‚úì Required</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# Stable Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>‚öì Stable Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Minimum uptime required for Stable flag">Stable Uptime</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('stable-uptime') is not none %}
                        {% set days = thresholds['stable-uptime'] / 86400 %}
                        ‚â•{{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Mean Time Between Failures required for Stable flag">Stable MTBF</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('stable-mtbf') is not none %}
                        {% set days = thresholds['stable-mtbf'] / 86400 %}
                        ‚â•{{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Whether authority has collected sufficient MTBF data to calculate Stable flag thresholds">Enough MTBF</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('enough-mtbf') is not none %}
                        {% if thresholds['enough-mtbf'] == 1 %}
                            <span style="color: #28a745;">‚úì</span>
                        {% else %}
                            <span style="color: #dc3545;">‚úó</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# Fast Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>‚ö° Fast Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Minimum bandwidth speed required for Fast flag (dynamically calculated from network, represents top 7/8ths percentile)">Fast Speed (7/8ths)</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('fast-speed') is not none %}
                        {% set bw = thresholds['fast-speed'] %}
                        {% set bw_unit = bw|determine_unit(relays.use_bits) %}
                        {% set bw_formatted = bw|format_bandwidth_with_unit(bw_unit) %}
                        ‚â•{{ bw_formatted }} {{ bw_unit }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# HSDir Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>üìÅ HSDir Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Weighted Fractional Uptime required for HSDir flag">HSDir WFU</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('hsdir-wfu') is not none %}
                        {% if thresholds['hsdir-wfu'] <= 1 %}
                            ‚â•{{ "%.1f%%"|format(thresholds['hsdir-wfu'] * 100) }}
                        {% else %}
                            ‚â•{{ "%.1f%%"|format(thresholds['hsdir-wfu']) }}
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Time Known required for HSDir flag">HSDir Time Known</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('hsdir-tk') is not none %}
                        {% set days = thresholds['hsdir-tk'] / 86400 %}
                        ‚â•{{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>
    </div>

    <div style="background: #f0f0f0; padding: 15px; border-radius: 6px; margin-top: 15px;">
        <h4>Flag Threshold Legend:</h4>
        
        <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
            <strong>üõ°Ô∏è Guard Flag Calculation Logic</strong>
            <p style="margin: 10px 0 5px 0;">Per <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">Tor Directory Specification</a>, a relay qualifies for Guard if ALL of the following are true:</p>
            <ol style="margin: 5px 0; padding-left: 25px;">
                <li><strong>Fast flag:</strong> Relay has the Fast flag (bandwidth ‚â•100 KB/s OR in top 7/8ths)</li>
                <li><strong>Stable flag:</strong> Relay has the Stable flag (sufficient uptime/MTBF)</li>
                <li><strong>WFU ‚â• guard-wfu threshold:</strong> Weighted Fractional Uptime at or above the median for "familiar" relays (typically 98%)</li>
                <li><strong>Time Known ‚â• guard-tk threshold:</strong> Relay is "familiar" - authority has tracked it for sufficient time (typically 8 days)</li>
                <li><strong>Bandwidth requirement (one of):</strong>
                    <ul style="margin: 3px 0; padding-left: 20px;">
                        <li><strong>Option A:</strong> Observed bandwidth ‚â• <code>AuthDirGuardBWGuarantee</code> (default <strong>2 MB/s</strong>)</li>
                        <li><strong>Option B:</strong> Observed bandwidth in top 25% of relays (‚â• <code>guard-bw-inc-exits</code> shown in table)</li>
                    </ul>
                </li>
                <li><strong>V2Dir flag:</strong> Relay supports directory protocol v2+</li>
            </ol>
            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                <strong>Important:</strong> The bandwidth check uses <code>observed_bandwidth</code> from the relay's server descriptor (actual capacity in bytes/s), 
                NOT the scaled consensus weight shown in votes. The 2 MB/s guarantee means any relay with ‚â•2 MB/s observed bandwidth can be a Guard, 
                regardless of network size.<br>
                <strong>‚öôÔ∏è AuthDirGuardBWGuarantee:</strong> This is a <strong>hardcoded Tor configuration parameter</strong> (default: 2 MB/s = 2,097,152 bytes/s). 
                It is NOT present in vote files - authorities use their compiled-in default. This value rarely changes and provides a stable minimum 
                bandwidth guarantee for Guard eligibility independent of network size fluctuations.
                <a href="https://gitlab.torproject.org/tpo/core/tor/-/blob/release-0.4.8/src/feature/dirauth/dirauth_options.inc#L21" target="_blank" rel="noopener">[View in Tor source - Line 21]</a><br>
                <strong>Sources:</strong> 
                <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">dir-spec: Assigning Flags</a> |
                <a href="https://spec.torproject.org/dir-spec/computing-bw-weights.html" target="_blank" rel="noopener">dir-spec: Computing BW Weights</a> |
                <a href="https://blog.torproject.org/how-bandwidth-scanners-monitor-tor-network/" target="_blank" rel="noopener">Bandwidth Scanners Blog</a>
            </p>
        </div>
        
        <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #28a745;">
            <strong>‚ö° Fast Flag Calculation Logic</strong>
            <p style="margin: 10px 0 5px 0;">Per <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">Tor Directory Specification</a>, a relay qualifies for Fast if its observed bandwidth is:</p>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>In the <strong>top 7/8ths</strong> (87.5%) for known active routers (‚â• <code>fast-speed</code> threshold shown above)</li>
                <li><strong>OR</strong> at least <strong>100 KB/s</strong> (absolute minimum fallback)</li>
            </ul>
            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                The <code>fast-speed</code> threshold in the table is <strong>dynamically calculated</strong> by each authority based on the bandwidth distribution of all relays. 
                It typically equals or exceeds 100 KB/s. The 100 KB/s fallback ensures relays on low-bandwidth networks can still qualify.
                <br><strong>Source:</strong> <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">dir-spec: Assigning Flags in a Vote</a>
            </p>
        </div>
        
        <div style="background: #cce5ff; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #007bff;">
            <strong>üèÉ Running Flag Calculation Logic</strong>
            <p style="margin: 10px 0 5px 0;">Per <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">Tor Directory Specification</a>:</p>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>A directory authority considers a relay <strong>"Running"</strong> when the relay is reachable/active by connecting to the relay's OR port</li>
            </ul>
            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                When an authority <strong>votes</strong> for a relay, that means the authority considers it Running (reachable).
                If an authority cannot reach a relay, it will not include the relay in its vote.
                A relay must be Running from a majority of authorities (‚â•5/9) to be included in the final consensus.
                <br><strong>Source:</strong> <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">dir-spec: Assigning Flags in a Vote</a>
            </p>
        </div>
        
        <div style="background: #e2d5f0; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #6f42c1;">
            <strong>‚öì Stable Flag Calculation Logic</strong>
            <p style="margin: 10px 0 5px 0;">Per <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">Tor Directory Specification</a>, a relay qualifies for Stable if:</p>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>Weighted MTBF ‚â• <code>stable-mtbf</code> threshold (median MTBF of all active relays)</li>
                <li><strong>OR</strong> Weighted MTBF ‚â• <strong>7 days</strong> (604800 seconds, absolute minimum)</li>
            </ul>
            
            <p style="margin: 10px 0 5px 0;"><strong>How Directory Authorities Measure MTBF:</strong></p>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                <li><strong>Tracks reachability</strong> ‚Äî Each authority independently tests if it can connect to relay's OR port</li>
                <li><strong>Records "up" intervals</strong> ‚Äî Tracks periods when the relay was successfully reachable</li>
                <li><strong>Calculates Weighted MTBF</strong> ‚Äî Weighted mean of all intervals when relay was "observed to be up"</li>
                <li><strong>Weights recent data more</strong> ‚Äî Uses discount factor of 0.95 every 12 hours (<a href="https://research.torproject.org/techreports/relay-stability-2011-06-30.pdf" target="_blank" rel="noopener">research paper</a>)</li>
                <li><strong>Requires sufficient data</strong> ‚Äî At least 4 days of MTBF data needed for valid assessment</li>
            </ul>
            
            <p style="margin: 10px 0 5px 0;"><strong>MTBF vs Uptime ‚Äî Key Distinction:</strong></p>
            <table style="font-size: 12px; margin: 5px 0; border-collapse: collapse; width: 100%;">
                <tr style="background: #d4c4e8;">
                    <th style="padding: 4px 8px; text-align: left; border: 1px solid #b8a8d0;">Metric</th>
                    <th style="padding: 4px 8px; text-align: left; border: 1px solid #b8a8d0;">Source</th>
                    <th style="padding: 4px 8px; text-align: left; border: 1px solid #b8a8d0;">Meaning</th>
                </tr>
                <tr>
                    <td style="padding: 4px 8px; border: 1px solid #b8a8d0;"><strong>MTBF</strong> (stats mtbf=X)</td>
                    <td style="padding: 4px 8px; border: 1px solid #b8a8d0;">Authority-measured</td>
                    <td style="padding: 4px 8px; border: 1px solid #b8a8d0;">Mean Time Between Failures ‚Äî authority's observation of relay's reachability history</td>
                </tr>
                <tr>
                    <td style="padding: 4px 8px; border: 1px solid #b8a8d0;"><strong>Uptime</strong> (last_restarted)</td>
                    <td style="padding: 4px 8px; border: 1px solid #b8a8d0;">Relay self-reported</td>
                    <td style="padding: 4px 8px; border: 1px solid #b8a8d0;">Time since last restart ‚Äî from relay's own descriptor</td>
                </tr>
            </table>
            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                <strong>Key Point:</strong> Authority does NOT use relay's self-reported uptime for MTBF. It independently measures reachability.
                The Stable flag is based on <em>uptime history</em>, not current uptime ‚Äî a relay with good history that recently restarted may keep Stable.
            </p>
            
            <p style="margin: 10px 0 5px 0; font-size: 12px;"><strong>From <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">dir-spec ¬ß Assigning Flags</a>:</strong></p>
            <blockquote style="margin: 5px 0 5px 15px; padding: 8px; background: #f5f0fa; border-left: 3px solid #6f42c1; font-size: 12px; font-style: italic;">
                "To calculate weighted MTBF, compute the weighted mean of the lengths of all intervals when the router was observed to be up, 
                weighting intervals by Œ±^n, where n is the amount of time that has passed since the interval ended, and Œ± is chosen so that 
                measurements over approximately one month old no longer influence the weighted MTBF much."
            </blockquote>
            
            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                <strong>‚ö†Ô∏è Study Finding:</strong> Our analysis of 10k+ relays shows authorities assigning Stable to relays with MTBF as low as ~5 days, 
                below both the published threshold and 7-day minimum. The <code>stable-mtbf</code> in flag-thresholds is the <em>median</em> MTBF value, not the minimum threshold.
                See <a href="../docs/studies/stable-flag-threshold-study.md">Stable Flag Threshold Study</a>.
                <br><strong>Sources:</strong> 
                <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">dir-spec</a> |
                <a href="https://research.torproject.org/techreports/relay-stability-2011-06-30.pdf" target="_blank" rel="noopener">Relay Stability Research (2011)</a>
            </p>
        </div>
        
        <div style="background: #d1ecf1; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #17a2b8;">
            <strong>‚úÖ Valid Flag Calculation Logic</strong>
            <p style="margin: 10px 0 5px 0;">Per <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">Tor Directory Specification</a>, a relay qualifies for Valid if:</p>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>The relay is <strong>Running</strong> (reachable by the authority)</li>
                <li>The relay's identity key is <strong>not blacklisted</strong></li>
                <li>The relay has a <strong>valid descriptor</strong></li>
            </ul>
            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                Unlike Running (which just means reachable), Valid confirms the relay is verified and allowed to participate.
                Almost all Running relays also have Valid unless they've been manually blacklisted.
                <br><strong>Source:</strong> <a href="https://spec.torproject.org/dir-spec/assigning-flags-vote.html" target="_blank" rel="noopener">dir-spec: Assigning Flags in a Vote</a>
            </p>
        </div>

        <ul style="margin: 0; padding-left: 20px;">
            <li><strong>Running:</strong> Relay is reachable from the authority (authority could connect to its OR port).</li>
            <li><strong>Valid:</strong> Relay is verified and allowed to participate in the network (not blacklisted).</li>
            <li><strong>Guard WFU:</strong> Weighted Fractional Uptime - relay's uptime weighted so recent downtime counts more.</li>
            <li><strong>Guard Time Known:</strong> How long the authority has tracked this relay (familiarity requirement).</li>
            <li><strong>Guard BW (top 25%):</strong> Top 25% bandwidth threshold (guard-bw-inc-exits). Relays above this OR ‚â•2 MB/s qualify for Guard.</li>
            <li><strong>Stable Uptime:</strong> Continuous uptime threshold for Stable flag.</li>
            <li><strong>Stable MTBF:</strong> Mean Time Between Failures threshold. Published value is median; actual minimum ~5-7 days.</li>
            <li><strong>Fast Speed (7/8ths):</strong> Bandwidth threshold for Fast flag (top 7/8ths of network OR ‚â•100 KB/s).</li>
            <li><strong>HSDir WFU/TK:</strong> Requirements for Hidden Service Directory flag. WFU ‚â•98% (all authorities). TK per dir-spec: ‚â•25 hours (most authorities use default); moria1 uses ‚â•10 days.</li>
            <li><strong>Enough MTBF:</strong> Boolean flag from <code>flag-thresholds</code> line (0 or 1). 
                <span style="color: #28a745;">‚úì (=1)</span> = Authority has collected <strong>sufficient MTBF stability data</strong> to accurately compute stability-related thresholds. 
                <span style="color: #dc3545;">‚úó (=0)</span> = Authority recently restarted or lacks historical uptime data. 
                When =0, the authority may use conservative fallback thresholds instead of computed medians.</li>
            <li><strong>V2Dir:</strong> Relay supports directory protocol v2+ (required for Guard flag).</li>
            <li><strong>‚Äî</strong> = Threshold not available from this authority.</li>
        </ul>
        
        <h5 style="margin-top: 15px;">Special/Restrictive Flags:</h5>
        <ul style="margin: 0; padding-left: 20px;">
            <li><strong>MiddleOnly:</strong> Relay is restricted to middle position only. Assigned by authorities to relays that should not be used as Guard or Exit due to operator restrictions, concerns, or lack of qualification. No specific thresholds - assigned based on authority discretion.</li>
            <li><strong>BadExit:</strong> Relay has been flagged as misbehaving when used as an exit node. Traffic will not be routed through it for exit positions. Operators should contact <a href="mailto:bad-relays@lists.torproject.org">bad-relays@lists.torproject.org</a>.</li>
            <li><strong>NoEdConsensus:</strong> Authority is not including Ed25519 identity key in this relay's vote. Usually temporary.</li>
            <li><strong>StaleDesc:</strong> Relay's descriptor is older than 18 hours. Relay may be experiencing issues.</li>
        </ul>
    </div>
    {% endif %}

    <!-- FOOTER -->
    <br><br>
    <p><i>Data sources: <a href="https://onionoo.torproject.org" target="_blank" rel="noopener">Onionoo API</a>{% if relays.collector_flag_thresholds %}, <a href="https://collector.torproject.org" target="_blank" rel="noopener">Tor CollecTor</a>{% endif %}</i></p>
    <p><i>Last updated: {{ relays.timestamp }} (updates every 15-60 minutes depending on data source)</i></p>

{% endblock -%} 