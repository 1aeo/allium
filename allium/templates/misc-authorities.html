{% from "macros.html" import navigation %}
{% extends "skeleton.html" -%}
{% block title -%}
    Relay Radar :: Directory Authorities by Network Health
{% endblock -%}
{% block body -%}
    <h2>
        Directory Authorities by Network Health
    </h2>
    
    {{ navigation('authorities', page_ctx) }}
    
    <p>
        Directory authorities vote on the status of relays in the Tor network and provide bandwidth measurements. Monitor their health and consensus participation.
    </p>

    <ul style="margin-bottom: 15px;">
        <li><strong>Directory Authorities:</strong> {{ relays.authorities_summary.total_authorities }} authorities discovered (dynamic from Onionoo)</li>
        
        {# Consensus status from CollecTor #}
        {% if relays.consensus_status %}
        <li><strong>Consensus Status:</strong> 
            {% if relays.consensus_status.freshness == 'fresh' %}
                <span style="color: green; font-weight: bold;">FRESH</span>
            {% elif relays.consensus_status.freshness == 'stale' %}
                <span style="color: #ff8c00; font-weight: bold;">STALE</span>
            {% else %}
                <span style="color: red; font-weight: bold;">{{ relays.consensus_status.freshness|upper }}</span>
            {% endif %}
            | {{ relays.consensus_status.voted_count|default(0) }}/{{ relays.authorities_summary.total_authorities }} Voted
            {% if relays.consensus_status.next_consensus_time %}
            | Next: {{ relays.consensus_status.next_consensus_time }}
            {% endif %}
        </li>
        {% endif %}
        
        <li><strong>Version Compliance:</strong> 
            {% set compliant_authorities = relays.authorities_data | selectattr('recommended_version', 'equalto', true) | list %}
            {% set non_compliant_authorities = relays.authorities_data | selectattr('recommended_version', 'equalto', false) | list %}
            {{ compliant_authorities|length }}/{{ relays.authorities_summary.total_authorities }} on recommended version | {{ non_compliant_authorities|length }}/{{ relays.authorities_summary.total_authorities }} non-compliant
        </li>
        <li><strong>Uptime Status (1M):</strong> 
            {% if relays.authorities_summary.above_average_uptime -%}
                <span style="color: green; font-weight: bold;">{{ relays.authorities_summary.above_average_uptime|length }} above average</span>
            {% else -%}
                <span style="color: green; font-weight: bold;">0 above average</span>
            {%- endif %} | 
            {% if relays.authorities_summary.below_average_uptime -%}
                <span style="color: #ff8c00; font-weight: bold;">{{ relays.authorities_summary.below_average_uptime|length }} below average</span>
            {% else -%}
                <span style="color: #ff8c00; font-weight: bold;">0 below average</span>
            {%- endif %} | 
            {% if relays.authorities_summary.problem_uptime -%}
                <span style="color: red; font-weight: bold;">{{ relays.authorities_summary.problem_uptime|length }} problematic</span>
            {% else -%}
                <span style="color: red; font-weight: bold;">0 problematic</span>
            {%- endif %}
        </li>
        
        {# Latency status #}
        {% if relays.latency_summary %}
        <li><strong>Latency Status:</strong> 
            <span style="color: green;">{{ relays.latency_summary.ok_count|default(0) }}/{{ relays.authorities_summary.total_authorities }} OK</span>
            {% if relays.latency_summary.slow_count > 0 %}
            | <span style="color: #ff8c00;">{{ relays.latency_summary.slow_count }} slow</span>
            {% endif %}
            {% if relays.latency_summary.down_count > 0 %}
            | <span style="color: red;">{{ relays.latency_summary.down_count }} down</span>
            {% endif %}
        </li>
        {% endif %}
        
        <li><strong>Key:</strong> BW = Observed Bandwidth Capacity, CW = Consensus Weight, Z = Z-score (statistical uptime deviation)</li>
    </ul>

    <br>

    <!-- MAIN AUTHORITY TABLE -->
    <h3>Directory Authority Status</h3>
    <br>
    
    <p class="text-muted" style="margin-bottom: 15px;">
    <small>Last updated: {{ relays.timestamp }}. Data from <a href="https://onionoo.torproject.org/">Onionoo API</a> + <a href="https://collector.torproject.org" target="_blank" rel="noopener">CollecTor</a> (votes, thresholds).</small>
    </p>
    
    <!-- UPTIME DATA STATUS NOTIFICATION -->
    {% if relays.uptime_metadata -%}
        {% if relays.uptime_metadata.status == 'not_modified' -%}
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚ÑπÔ∏è Uptime Data Status:</strong> 
                {% if relays.uptime_metadata.last_updated -%}
                    Uptime statistics unchanged since last check. Last updated: <strong>{{ relays.uptime_metadata.last_updated }}</strong>
                {% else -%}
                    Uptime statistics unchanged since last check.
                {%- endif %}
                <br><small>This means the uptime data shown below may not reflect the most recent changes.</small>
            </div>
        {% elif relays.uptime_metadata.status == 'error' -%}
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚ö†Ô∏è Uptime Data Error:</strong> {{ relays.uptime_metadata.message }}
                <br><small>Uptime statistics may be unavailable or incomplete.</small>
            </div>
        {% elif relays.uptime_metadata.status == 'success' and relays.uptime_metadata.last_updated -%}
            <div style="background: #d1edff; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚úÖ Uptime Data Fresh:</strong> Successfully updated {{ relays.uptime_metadata.last_updated }}
                {% if relays.uptime_metadata.authorities_count -%}
                    ({{ relays.uptime_metadata.authorities_count }} authorities)
                {%- endif %}
            </div>
        {%- endif %}
    {%- endif %}
    
    {# Main table: EXISTING columns + 3 NEW columns (Voted, BW Auth, Latency) #}
    <table class="table table-condensed" style="font-size: 13px;">
        <tr>
            <th title="Source: Onionoo | File: details | Field: nickname (has Authority flag)">Authority Name</th>
            <th title="Source: Onionoo | File: details | Field: running">Online Status</th>
            {# NEW columns with detailed tooltips #}
            <th title="Source: CollecTor | File: vote | Vote file exists for this consensus hour">Voted</th>
            <th title="Source: CollecTor | File: vote | Has 'bandwidth-file-headers' line = runs sbws scanner">BW Auth</th>
            <th title="Source: Direct HTTP | HEAD request to dir_address | Response time in ms">Latency</th>
            {# Existing columns #}
            <th title="Source: Onionoo | File: details | Field: as">AS Number</th>
            <th title="Source: Onionoo | File: details | Field: as_name">AS Name</th>
            <th title="Source: Onionoo | File: details | Field: country">Country</th>
            <th title="Source: Onionoo | File: uptime | 1M/6M/1Y/5Y uptime percentages">Uptime (1M/6M/1Y/5Y)</th>
            <th title="Source: Onionoo | File: details | Field: version">Version</th>
            <th title="Source: Onionoo | File: details | Field: recommended_version">Rec. Ver.</th>
            <th title="Source: Onionoo | File: details | Field: first_seen">First Seen</th>
            <th title="Source: Onionoo | File: details | Field: last_restarted">Last Restarted</th>
        </tr>
        <tbody>
        {% for authority in relays.authorities_data -%}
            <tr>
                {% set is_problematic = not authority.running or (authority.uptime_zscore and authority.uptime_zscore <= -2.0) -%}
                <td>
                    <a href="{{ page_ctx.path_prefix }}relay/{{ authority.fingerprint }}/" 
                       {% if is_problematic %}style="color: #dc3545; font-weight: bold; text-decoration: underline;"
                       {% else %}style="text-decoration: underline;"{% endif %}>
                        {{ authority.nickname }}
                    </a>
                </td>
                <td>
                    {% if authority.running -%}
                        <span style="color: green; font-weight: bold;">üü¢ Online</span>
                    {% else -%}
                        <span style="color: red; font-weight: bold;">üî¥ Offline</span>
                    {%- endif %}
                </td>
                
                {# NEW: Voted status - colored text #}
                <td>
                    {% if authority.collector_data and authority.collector_data.voted %}
                        <span style="color: #28a745; font-weight: bold;" title="Vote received this consensus period">Yes</span>
                    {% elif authority.collector_data is defined %}
                        <span style="color: #dc3545; font-weight: bold;" title="No vote received">No</span>
                    {% else %}
                        <span style="color: #6c757d;" title="CollecTor data not available">‚Äî</span>
                    {% endif %}
                </td>
                
                {# NEW: BW Authority status #}
                <td>
                    {% if authority.collector_data and authority.collector_data.is_bw_authority %}
                        <span style="color: #28a745; font-weight: bold;" title="Runs bandwidth scanner (sbws)">Yes</span>
                    {% else %}
                        <span style="color: #6c757d;" title="Does not run bandwidth scanner">No</span>
                    {% endif %}
                </td>
                
                {# NEW: Latency #}
                <td>
                    {% if authority.latency_ms is defined and authority.latency_ms is not none %}
                        {% if authority.latency_ms > 500 %}
                            <span style="color: #dc3545; font-weight: bold;">{{ authority.latency_ms }} ms</span>
                        {% elif authority.latency_ms > 200 %}
                            <span style="color: #ff8c00;">{{ authority.latency_ms }} ms</span>
                        {% else %}
                            {{ authority.latency_ms }} ms
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;" title="Latency data not available">‚Äî</span>
                    {% endif %}
                </td>
                
                <td>
                    {% if authority.as -%}
                        <a href="{{ page_ctx.path_prefix }}as/{{ authority.as }}/">{{ authority.as }}</a>
                    {% else -%}
                        N/A
                    {%- endif %}
                </td>
                <td>
                    {% if authority.as_name -%}
                        <a href="https://bgp.tools/{{ authority.as }}" title="{{ authority.as_name }}">{{ authority.as_name|truncate(length=20) }}</a>
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.country -%}
                        <a href="{{ page_ctx.path_prefix }}country/{{ authority.country }}/">
                            <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ authority.country|lower }}.png"
                                 title="{{ authority.country_name }}"
                                 alt="{{ authority.country_name }}">
                        </a>
                        {{ authority.country }}
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('1_month') is not none -%}
                        <span title="1 month uptime: {{ "%.1f%%"|format(authority.uptime_percentages['1_month']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['1_month']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('6_months') is not none -%}
                        <span title="6 month uptime: {{ "%.1f%%"|format(authority.uptime_percentages['6_months']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['6_months']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('1_year') is not none -%}
                        <span title="1 year uptime: {{ "%.1f%%"|format(authority.uptime_percentages['1_year']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['1_year']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('5_years') is not none -%}
                        <span title="5 year uptime: {{ "%.1f%%"|format(authority.uptime_percentages['5_years']) }}">{{ "%.1f%%"|format(authority.uptime_percentages['5_years']) }}</span>
                    {% else -%}
                        N/A
                    {%- endif %}
                    {% if authority.uptime_zscore is not none -%}
                        | <span 
                        {% if authority.uptime_zscore > 0.3 -%}
                            style="color: green; font-weight: bold;"
                        {% elif authority.uptime_zscore <= -2.0 -%}
                            style="color: red; font-weight: bold;"
                        {% else -%}
                            style="color: #ff8c00; font-weight: bold;"
                        {%- endif %}
                        title="Z-score: Statistical measure of how far this authority's uptime deviates from the average. Values below -2.0 indicate significantly poor uptime.">Z: {{ "%.1f"|format(authority.uptime_zscore) }}</span>
                    {%- endif %}
                </td>
                <td>{{ authority.version if authority.version else "Unknown" }}</td>
                <td>
                    {% if authority.recommended_version is not none -%}
                        {% if authority.recommended_version -%}
                            <span style="color: #28a745; font-weight: bold;" title="Running recommended version">Yes</span>
                        {% else -%}
                            <span style="color: #dc3545; font-weight: bold;" title="Not running recommended version">No</span>
                        {%- endif %}
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.first_seen -%}
                        <a href="{{ page_ctx.path_prefix }}first_seen/{{ authority.first_seen.split(' ')[0].replace('-', '') }}/" title="{{ authority.first_seen }}">{{ authority.first_seen.split(' ')[0] }}</a>
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>{{ authority.last_restarted.split(' ')[0] if authority.last_restarted else "Unknown" }}</td>
            </tr>
        {% endfor -%}
        </tbody>
    </table>

    <br><br>

    {# ALERTS SECTION (NEW) #}
    {% if relays.authority_alerts %}
    <br>
    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px;">
        <strong>‚ö†Ô∏è Alerts:</strong>
        <ul style="margin: 5px 0; padding-left: 20px;">
        {% for alert in relays.authority_alerts %}
            <li>{{ alert }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    <br><br>

    <!-- LEGEND/NOTES -->
    <div style="background: #f0f0f0; padding: 15px; border-radius: 6px;">
        <h4>Legend:</h4>
        <ul style="margin: 0; padding-left: 20px;">
            <li><strong>Online:</strong> üü¢ = Online, üî¥ = Offline</li>
            <li><strong>Voted:</strong> <span style="color: #28a745; font-weight: bold;">Yes</span> = Submitted vote this consensus period, <span style="color: #dc3545; font-weight: bold;">No</span> = No vote received</li>
            <li><strong>BW Auth:</strong> <span style="color: #28a745; font-weight: bold;">Yes</span> = Runs bandwidth scanner (sbws), <span style="color: #6c757d;">No</span> = Does not run scanner</li>
            <li><strong>Latency:</strong> Response time to authority's directory port (checked on page load). <span style="color: #ff8c00;">Orange = &gt;200ms</span>, <span style="color: #dc3545; font-weight: bold;">Red = &gt;500ms</span></li>
            <li><strong>Uptime (1M/6M/1Y/5Y):</strong> Percentage of time authority was online over 1 month, 6 months, 1 year, and 5 years periods</li>
            <li><strong>Uptime Z-Score:</strong> Statistical measure comparing this authority's 1-month uptime to other authorities. <span style="color: green; font-weight: bold;">Green (above average)</span>, <span style="color: #ff8c00; font-weight: bold;">Yellow (normal)</span>, <span style="color: red; font-weight: bold;">Red (significantly below average, ‚â§-2.0)</span></li>
            <li><strong>Rec. Ver.:</strong> <span style="color: green; font-weight: bold;">Yes</span> = On recommended version, <span style="color: red; font-weight: bold;">No</span> = Not recommended</li>
            <li><strong>Flag Thresholds:</strong> Requirements for relays to receive Guard/Stable/Fast flags (varies per authority)</li>
        </ul>
    </div>

    {# Flag Thresholds Table - from CollecTor consensus data #}
    {% if relays.collector_flag_thresholds %}
    <br><br>
    <h3 id="flag-thresholds">
        <a href="#flag-thresholds" style="text-decoration: none; color: inherit;">Flag Thresholds by Authority</a>
    </h3>
    <p class="text-muted" style="font-size: 13px; margin-bottom: 15px;">
        Each directory authority has different thresholds for assigning flags to relays. 
        These values are extracted from authority votes via <a href="https://collector.torproject.org" target="_blank" rel="noopener">Tor CollecTor</a>.
    </p>
    
    <div style="overflow-x: auto;">
    <table class="table table-condensed table-striped" style="font-size: 12px;">
        <thead>
            <tr>
                <th>Threshold</th>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                <th style="text-align: center;">{{ auth_name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {# Guard Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>üõ°Ô∏è Guard Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Weighted Fractional Uptime required for Guard flag">Guard WFU</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('guard-wfu') is not none %}
                        {% if thresholds['guard-wfu'] <= 1 %}
                            {{ "%.1f%%"|format(thresholds['guard-wfu'] * 100) }}
                        {% else %}
                            {{ "%.1f%%"|format(thresholds['guard-wfu']) }}
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Time Known required for Guard flag (how long authority has tracked the relay)">Guard Time Known</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('guard-tk') is not none %}
                        {% set days = thresholds['guard-tk'] / 86400 %}
                        {{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Minimum bandwidth required for Guard flag (including exits)">Guard BW (inc. exits)</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('guard-bw-inc-exits') is not none %}
                        {% set bw = thresholds['guard-bw-inc-exits'] %}
                        {% if bw >= 1000000 %}
                            {{ "%.1f MB/s"|format(bw / 1000000) }}
                        {% elif bw >= 1000 %}
                            {{ "%.1f KB/s"|format(bw / 1000) }}
                        {% else %}
                            {{ bw }} B/s
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# Stable Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>‚öì Stable Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Minimum uptime required for Stable flag">Stable Uptime</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('stable-uptime') is not none %}
                        {% set days = thresholds['stable-uptime'] / 86400 %}
                        {{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Mean Time Between Failures required for Stable flag">Stable MTBF</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('stable-mtbf') is not none %}
                        {% set days = thresholds['stable-mtbf'] / 86400 %}
                        {{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# Fast Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>‚ö° Fast Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Minimum bandwidth speed required for Fast flag">Fast Speed</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('fast-speed') is not none %}
                        {% set bw = thresholds['fast-speed'] %}
                        {% if bw >= 1000000 %}
                            {{ "%.1f MB/s"|format(bw / 1000000) }}
                        {% elif bw >= 1000 %}
                            {{ "%.1f KB/s"|format(bw / 1000) }}
                        {% else %}
                            {{ bw }} B/s
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# HSDir Flag Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>üìÅ HSDir Flag Requirements</strong></td>
            </tr>
            <tr>
                <td title="Weighted Fractional Uptime required for HSDir flag">HSDir WFU</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('hsdir-wfu') is not none %}
                        {% if thresholds['hsdir-wfu'] <= 1 %}
                            {{ "%.1f%%"|format(thresholds['hsdir-wfu'] * 100) }}
                        {% else %}
                            {{ "%.1f%%"|format(thresholds['hsdir-wfu']) }}
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td title="Time Known required for HSDir flag">HSDir Time Known</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('hsdir-tk') is not none %}
                        {% set days = thresholds['hsdir-tk'] / 86400 %}
                        {{ "%.1f d"|format(days) }}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            {# Additional Thresholds #}
            <tr style="background: #e8f4fd;">
                <td colspan="{{ relays.collector_flag_thresholds|length + 1 }}"><strong>üìä Other Thresholds</strong></td>
            </tr>
            <tr>
                <td title="Whether MTBF data is sufficient">Enough MTBF</td>
                {% for auth_name in relays.collector_flag_thresholds.keys()|sort %}
                {% set thresholds = relays.collector_flag_thresholds[auth_name] %}
                <td style="text-align: center;">
                    {% if thresholds.get('enough-mtbf') is not none %}
                        {% if thresholds['enough-mtbf'] == 1 %}
                            <span style="color: #28a745;">‚úì</span>
                        {% else %}
                            <span style="color: #dc3545;">‚úó</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">‚Äî</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>
    </div>

    <div style="background: #f0f0f0; padding: 15px; border-radius: 6px; margin-top: 15px;">
        <h4>Flag Threshold Legend:</h4>
        <ul style="margin: 0; padding-left: 20px;">
            <li><strong>Guard WFU:</strong> Weighted Fractional Uptime - percentage of time relay has been online. Typically ‚â•98% required.</li>
            <li><strong>Guard Time Known:</strong> How long the authority has tracked this relay. Typically ‚â•8 days (691200 seconds) required.</li>
            <li><strong>Guard BW:</strong> Minimum bandwidth capacity for Guard eligibility. Varies by authority based on network conditions.</li>
            <li><strong>Stable Uptime:</strong> Continuous uptime required for Stable flag. Varies 14-20 days by authority.</li>
            <li><strong>Stable MTBF:</strong> Mean Time Between Failures - average time between relay restarts/failures.</li>
            <li><strong>Fast Speed:</strong> Minimum bandwidth for Fast flag. Based on network median bandwidth.</li>
            <li><strong>HSDir WFU/TK:</strong> Requirements for Hidden Service Directory flag (serving .onion address lookups).</li>
            <li><strong>‚Äî</strong> = Threshold not available or not set by this authority.</li>
        </ul>
    </div>
    {% endif %}

    <!-- FOOTER -->
    <br><br>
    <p><i>Data sources: <a href="https://onionoo.torproject.org" target="_blank" rel="noopener">Onionoo API</a>{% if relays.collector_flag_thresholds %}, <a href="https://collector.torproject.org" target="_blank" rel="noopener">Tor CollecTor</a>{% endif %}</i></p>
    <p><i>Last updated: {{ relays.timestamp }} (updates every 15-60 minutes depending on data source)</i></p>

{% endblock -%} 