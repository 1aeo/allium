{% from "macros.html" import navigation %}
{% extends "skeleton.html" -%}
{% block title -%}
    Relay Radar :: Directory Authorities by Network Health
{% endblock -%}
{% block body -%}
    <h2>
        Directory Authorities by Network Health
    </h2>
    
    {{ navigation('authorities', page_ctx) }}
    
    <p>
        Directory authorities vote on the status of relays in the Tor network and provide bandwidth measurements. Monitor their health and consensus participation.
    </p>

    <!-- CONSENSUS HEALTH SUMMARY SECTION -->
    <div style="background: #e8f4fd; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <h3>Consensus Health Summary</h3>
        <ul>
            <li><strong>Consensus age:</strong> <!-- TODO: Implement consensus age from consensus-health API -->TODO (as of {{ relays.timestamp }})</li>
            <li><strong>Next consensus:</strong> <!-- TODO: Implement next consensus time from consensus-health API -->TODO (as of {{ relays.timestamp }})</li>
            <li><strong>Relays:</strong> {{ relays.json['relays']|length }} total</li>
            <li><strong>Relays failed consensus:</strong> <!-- TODO: Implement failed consensus count from consensus-health API -->TODO total, <!-- TODO: Calculate percentage -->TODO% of total</li>
            <li><strong>Network relays - less than 3 bandwidth authorities measured:</strong> <!-- TODO: Implement BW authority measurement count from consensus-health API -->TODO total, <!-- TODO: Calculate percentage -->TODO% of total</li>
            <li><strong>Network relays - less than 3 directory authority consensus votes:</strong> <!-- TODO: Implement dir auth vote count from consensus-health API -->TODO total, <!-- TODO: Calculate percentage -->TODO% of total</li>
            <li><strong>All on latest Tor version:</strong> <!-- TODO: Implement version check from consensus-health API -->TODO</li>
        </ul>
        
        <h4>Directory Authority Metrics</h4>
        <ul>
            <li style="margin: 5px 0;"><strong>Version Compliance:</strong> <!-- TODO: Implement version compliance check -->TODO/{{ relays.authorities_summary.total_authorities }} authorities on recommended version (<!-- TODO: Get current recommended version -->TODO)</li>
            <li style="margin: 5px 0;"><strong>Version Non-Compliance:</strong> <!-- TODO: Implement version non-compliance check -->TODO/{{ relays.authorities_summary.total_authorities }} authorities outdated</li>
            <li style="margin: 5px 0;"><strong>Uptime (1 month):</strong> 
                {% if relays.authorities_summary.above_average_uptime -%}
                    <span style="color: green; font-weight: bold;">Above average: 
                    {% for auth in relays.authorities_summary.above_average_uptime -%}
                        {{ auth.nickname }} (Z: {{ "%.1f"|format(auth.uptime_zscore) }}){% if not loop.last %}, {% endif %}
                    {%- endfor %}</span>
                {%- endif %}
                {% if relays.authorities_summary.above_average_uptime and (relays.authorities_summary.below_average_uptime or relays.authorities_summary.problem_uptime) %} | {% endif %}
                {% if relays.authorities_summary.below_average_uptime -%}
                    <span style="color: #ff8c00; font-weight: bold;">Below average: 
                    {% for auth in relays.authorities_summary.below_average_uptime -%}
                        {{ auth.nickname }} (Z: {{ "%.1f"|format(auth.uptime_zscore) }}){% if not loop.last %}, {% endif %}
                    {%- endfor %}</span>
                {%- endif %}
                {% if relays.authorities_summary.below_average_uptime and relays.authorities_summary.problem_uptime %} | {% endif %}
                {% if relays.authorities_summary.problem_uptime -%}
                    <span style="color: red; font-weight: bold;">Problem: 
                    {% for auth in relays.authorities_summary.problem_uptime -%}
                        {{ auth.nickname }} (Z: {{ "%.1f"|format(auth.uptime_zscore) }}){% if not loop.last %}, {% endif %}
                    {%- endfor %}</span>
                {%- endif %}
            </li>
        </ul>
    </div>

    <br>

    <!-- MAIN AUTHORITY TABLE -->
    <h3>Directory Authority Status</h3>
    <br>
    
    <p class="text-muted" style="margin-bottom: 15px;">
    <small>Last updated: {{ relays.timestamp }}. Refreshed every 30 minutes from the Tor directory authorities via <a href="https://onionoo.torproject.org/">Tor Project's onionoo API</a>.</small>
    </p>
    
    <!-- UPTIME DATA STATUS NOTIFICATION -->
    {% if relays.uptime_metadata -%}
        {% if relays.uptime_metadata.status == 'not_modified' -%}
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚ÑπÔ∏è Uptime Data Status:</strong> 
                {% if relays.uptime_metadata.last_updated -%}
                    Uptime statistics unchanged since last check. Last updated: <strong>{{ relays.uptime_metadata.last_updated }}</strong>
                {% else -%}
                    Uptime statistics unchanged since last check.
                {%- endif %}
                <br><small>This means the uptime data shown below may not reflect the most recent changes.</small>
            </div>
        {% elif relays.uptime_metadata.status == 'error' -%}
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚ö†Ô∏è Uptime Data Error:</strong> {{ relays.uptime_metadata.message }}
                <br><small>Uptime statistics may be unavailable or incomplete.</small>
            </div>
        {% elif relays.uptime_metadata.status == 'success' and relays.uptime_metadata.last_updated -%}
            <div style="background: #d1edff; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>‚úÖ Uptime Data Fresh:</strong> Successfully updated {{ relays.uptime_metadata.last_updated }}
                {% if relays.uptime_metadata.authorities_count -%}
                    ({{ relays.uptime_metadata.authorities_count }} authorities)
                {%- endif %}
            </div>
        {%- endif %}
    {%- endif %}
    
    <table class="table table-condensed" style="font-size: 13px;">
        <tr>
            <th>Authority Name</th>
            <th>Online Status</th>
            <th>Relay Coverage</th>
            <th>Last Vote</th>
            <th>Last BW Measurement</th>
            <th>AS Number</th>
            <th>AS Name</th>
            <th>Country</th>
            <th>Uptime (1mo/6mo/1yr/5yr)</th>
            <th>Version</th>
            <th>Platform</th>
            <th title="Recommended version: TODO">Rec. Ver.</th>
            <th>First Seen</th>
            <th>Last Restarted</th>
        </tr>
        <tbody>
        {% for authority in relays.authorities_data -%}
            <tr>
                {% set is_problematic = not authority.running or (authority.uptime_zscore and authority.uptime_zscore <= -2.0) -%}
                <td>
                    <a href="{{ path_prefix }}relay/{{ authority.fingerprint }}.html" 
                       {% if is_problematic %}style="color: #dc3545; font-weight: bold; text-decoration: underline;"
                       {% else %}style="text-decoration: underline;"{% endif %}>
                        {{ authority.nickname }}
                    </a>
                </td>
                <td>
                    {% if authority.running -%}
                        <span style="color: green; font-weight: bold;">üü¢ Online</span>
                    {% else -%}
                        <span style="color: red; font-weight: bold;">üî¥ Offline (last seen: {{ authority.last_seen }})</span>
                    {%- endif %}
                </td>
                <td><!-- TODO: Implement relay coverage from consensus-health API -->TODO | <span style="color: #999;">Z: <!-- TODO: Calculate coverage Z-score -->TODO</span></td>
                <td><!-- TODO: Implement last vote time from CollecTor API -->TODO</td>
                <td><!-- TODO: Implement last BW measurement time from CollecTor API -->TODO</td>
                <td>{{ authority.as if authority.as else "N/A" }}</td>
                <td>{{ authority.as_name if authority.as_name else "Unknown" }}</td>
                <td>
                    {% if authority.country_name -%}
                        üåç {{ authority.country_name }}
                    {% else -%}
                        Unknown
                    {%- endif %}
                </td>
                <td>
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('1_month') is not none -%}
                        {{ "%.1f%%"|format(authority.uptime_percentages['1_month']) }}
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('6_months') is not none -%}
                        {{ "%.1f%%"|format(authority.uptime_percentages['6_months']) }}
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('1_year') is not none -%}
                        {{ "%.1f%%"|format(authority.uptime_percentages['1_year']) }}
                    {% else -%}
                        N/A
                    {%- endif %} / 
                    {% if authority.uptime_percentages and authority.uptime_percentages.get('5_years') is not none -%}
                        {{ "%.1f%%"|format(authority.uptime_percentages['5_years']) }}
                    {% else -%}
                        N/A
                    {%- endif %}
                    {% if authority.uptime_zscore is not none -%}
                        | <span 
                        {% if authority.uptime_zscore > 0.3 -%}
                            style="color: green; font-weight: bold;"
                        {% elif authority.uptime_zscore <= -2.0 -%}
                            style="color: red; font-weight: bold;"
                        {% else -%}
                            style="color: #ff8c00; font-weight: bold;"
                        {%- endif %}>Z: {{ "%.1f"|format(authority.uptime_zscore) }}</span>
                    {%- endif %}
                </td>
                <td>{{ authority.version if authority.version else "Unknown" }}</td>
                <td>{{ authority.platform if authority.platform else "Unknown" }}</td>
                <td><!-- TODO: Implement recommended version compliance check -->TODO</td>
                <td>{{ authority.first_seen.split(' ')[0] if authority.first_seen else "Unknown" }}</td>
                <td>{{ authority.last_restarted.split(' ')[0] if authority.last_restarted else "Unknown" }}</td>
            </tr>
        {% endfor -%}
        </tbody>
    </table>

    <br><br>

    <!-- LEGEND/NOTES -->
    <div style="background: #f0f0f0; padding: 15px; border-radius: 6px;">
        <h4>Legend:</h4>
        <ul style="margin: 0; padding-left: 20px;">
            <li><strong>Relay Coverage:</strong> Number of relays measured by this authority / Total relays (percentage)</li>
            <li><strong>Z-Score:</strong> Standard deviations from mean coverage. <span style="color: green; font-weight: bold;">Green (&lt;-1)</span>, <span style="color: #ff8c00; font-weight: bold;">Yellow (-1 to +2)</span>, <span style="color: red; font-weight: bold;">Red (&gt;+2)</span></li>
            <li><strong>Last Vote:</strong> When authority last submitted a consensus vote</li>
            <li><strong>Last BW Measurement:</strong> When authority last provided bandwidth measurements</li>
            <li><strong>Uptime (1mo/6mo/1yr/5yr):</strong> Percentage of time authority was online over 1 month, 6 months, 1 year, and 5 years periods</li>
            <li><strong>Uptime Z-Score:</strong> Based on 1-month uptime compared to other authorities. <span style="color: green; font-weight: bold;">Green (above average)</span>, <span style="color: #ff8c00; font-weight: bold;">Yellow (normal)</span>, <span style="color: red; font-weight: bold;">Red (below -2.0)</span></li>
            <li><strong>Version:</strong> Current Tor software version running on the authority</li>
            <li><strong>Platform:</strong> Full platform description including Tor version and operating system</li>
            <li><strong>Rec. Ver.:</strong> Recommended version compliance check. <span style="color: green; font-weight: bold;">‚úÖ = On recommended version</span>, <span style="color: red; font-weight: bold;">‚ùå = Outdated version</span></li>
            <li><strong>First Seen:</strong> When this authority first appeared in the directory consensus</li>
            <li><strong>Last Restarted:</strong> When the authority software was last restarted</li>
        </ul>
    </div>

    <!-- FOOTER -->
    <br><br>
    <p><i>Data sources: Onionoo API<!-- TODO: Add CollecTor API and consensus-health.torproject.org when implemented --></i></p>
    <p><i>Last updated: {{ relays.timestamp }} (updates every 15 minutes)</i></p>

{% endblock -%} 