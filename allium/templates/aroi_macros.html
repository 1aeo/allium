{# AROI Leaderboard Macros - Eliminate Template Code Duplication #}

{# Champion Badge Macro - Eliminate 10x duplicate champion badge blocks #}
{% macro champion_badge(category_key, leaderboard_data, title, emoji, panel_class="panel-warning", champion_class="", path_prefix="") %}
    <div class="col-md-3 col-sm-6 aroi-champion-badge">
        <div class="panel {{ panel_class }}">
            <div class="panel-body text-center {{ champion_class }}">
                <h3 class="aroi-header-spacing">{{ emoji }} {{ title }}</h3>
                {% if leaderboard_data %}
                    {% set champion = leaderboard_data[0] %}
                    <h4><strong><a href="{{ path_prefix }}contact/{{ champion.contact_hash }}/" title="Contact: {{ champion.contact_info|escape }}" class="aroi-underline-link">{{ champion.aroi_domain|escape if champion.aroi_domain and champion.aroi_domain != 'none' else champion.operator_key|escape }}</a></strong></h4>
                    <p>
                        {% if category_key == "bandwidth" %}
                            {{ champion.total_bandwidth }} {{ champion.bandwidth_unit }}
                        {% elif category_key == "consensus_weight" %}
                            {{ champion.total_consensus_weight_pct }} authority
                        {% elif category_key == "exit_authority" %}
                            {{ champion.exit_consensus_weight_pct }} exit authority
                        {% elif category_key == "exit_operators" %}
                            {{ champion.exit_count }} exit relays
                        {% elif category_key == "guard_operators" %}
                            {{ champion.guard_count }} guard relays
                        {% elif category_key == "most_diverse" %}
                            <span title="Diversity Score: Geographic (countries Ã— 2.0) + Platform (OS types Ã— 1.5) + Network (unique ASNs Ã— 1.0)">{{ champion.diversity_score }} diversity</span>
                        {% elif category_key == "platform_diversity" %}
                            {{ champion.non_linux_count }} non-Linux relays
                        {% elif category_key == "non_eu_leaders" %}
                            {{ champion.non_eu_count }} non-EU relays
                        {% elif category_key == "frontier_builders" %}
                            {{ champion.rare_country_count }} rare countries
                        {% elif category_key == "network_veterans" %}
                            {{ champion.veteran_days }} days
                        {% endif %}
                    </p>
                    <small>
                        {% if category_key == "exit_authority" %}
                            {{ champion.exit_count }} exit relays
                        {% elif category_key == "most_diverse" %}
                            {{ champion.country_count }} countries
                        {% else %}
                            {{ champion.total_relays }} total relays
                        {% endif %}
                    </small>
                {% endif %}
            </div>
        </div>
    </div>
{% endmacro %}

{# Top 3 Table Macro - Eliminate 10x duplicate top 3 table blocks #}
{% macro top3_table(title, emoji, leaderboard_data, achievements, performance_type, page_ctx) %}
    <div class="aroi-subsection">
        <h4>{{ emoji }} {{ title }}</h4>
        {% if leaderboard_data %}
        <div class="table-responsive">
            <table class="table table-striped aroi-top3-table">
                <thead>
                    <tr>
                        <th>Operator</th>
                        <th>Achievement</th>
                        <th>Performance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in leaderboard_data[:3] %}
                    <tr>
                        <td>
                            <strong>
                                {% if entry.rank == 1 %}ðŸ¥‡{% elif entry.rank == 2 %}ðŸ¥ˆ{% elif entry.rank == 3 %}ðŸ¥‰{% endif %}
                                <a href="{{ page_ctx.path_prefix }}contact/{{ entry.contact_hash }}/" title="Contact: {{ entry.contact_info|escape }}" class="aroi-underline-link">{{ entry.aroi_domain|escape if entry.aroi_domain and entry.aroi_domain != 'none' else entry.operator_key|escape }}</a>
                            </strong>
                        </td>
                        <td>
                            {% if performance_type == "non_eu_leaders" %}
                                {{ entry.geographic_achievement }}
                            {% else %}
                                {% if entry.rank == 1 %}{{ achievements[0] }}
                                {% elif entry.rank == 2 %}{{ achievements[1] }}
                                {% elif entry.rank == 3 %}{{ achievements[2] }}
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if performance_type == "bandwidth" %}
                                {{ entry.total_bandwidth }} {{ entry.bandwidth_unit }} across {{ entry.total_relays }} relays
                            {% elif performance_type == "consensus_weight" %}
                                {{ entry.total_consensus_weight_pct }} network authority
                            {% elif performance_type == "exit_authority" %}
                                {{ entry.exit_consensus_weight_pct }} exit authority
                            {% elif performance_type == "exit_operators" %}
                                {{ entry.exit_count }} active exit relays
                            {% elif performance_type == "guard_operators" %}
                                {{ entry.guard_count }} active guard relays
                            {% elif performance_type == "most_diverse" %}
                                {{ entry.country_count }} countries, <span title="Diversity Score: Geographic (countries Ã— 2.0) + Platform (OS types Ã— 1.5) + Network (unique ASNs Ã— 1.0)">{{ entry.diversity_score }} diversity</span>
                            {% elif performance_type == "platform_diversity" %}
                                {{ entry.non_linux_count }} non-Linux relays, {{ entry.total_bandwidth }} {{ entry.bandwidth_unit }}
                            {% elif performance_type == "non_eu_leaders" %}
                                {{ entry.country_count }} countries, {{ entry.total_bandwidth }} {{ entry.bandwidth_unit }}
                            {% elif performance_type == "frontier_builders" %}
                                <span title="{{ entry.rare_country_tooltip }}">{{ entry.relays_in_rare_countries }} relays in {{ entry.rare_country_count }} rare countries</span>
                            {% elif performance_type == "network_veterans" %}
                                <span title="{{ entry.veteran_tooltip }}">{{ entry.veteran_days }} days * {{ entry.total_relays }} relays</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
{% endmacro %}

{# Ranking Table Components - Eliminate massive duplication in ranking tables #}

{# Rank Badge Macro - Handles rank display with proper medal styling (used ~50 times) #}
{% macro rank_badge(rank) %}
    {% if rank <= 3 %}
        <span class="badge {% if rank == 1 %}aroi-rank-gold{% elif rank == 2 %}aroi-rank-silver{% else %}aroi-rank-bronze{% endif %}">
            {% if rank == 1 %}ðŸ¥‡{% elif rank == 2 %}ðŸ¥ˆ{% else %}ðŸ¥‰{% endif %} {{ rank }}
        </span>
    {% else %}
        <span class="badge badge-default">{{ rank }}</span>
    {% endif %}
{% endmacro %}

{# Operator Link Macro - Handles operator name/domain links with proper styling (used ~50 times) #}
{% macro operator_link(entry, page_ctx, include_title=true, strong=true) %}
    <a href="{{ page_ctx.path_prefix }}contact/{{ entry.contact_hash }}/" {% if include_title %}title="Contact: {{ entry.contact_info|escape }}"{% endif %} class="aroi-underline-link">
        {% if strong %}<strong>{% endif %}
        {% if entry.aroi_domain and entry.aroi_domain != 'none' %}
            {{ entry.aroi_domain|escape }}
        {% else %}
            {{ entry.operator_key|escape }}
        {% endif %}
        {% if strong %}</strong>{% endif %}
    </a>
{% endmacro %}

{# Generic Ranking Table Macro - For the loop-based tables with standardized columns #}
{% macro generic_ranking_table(category_key, category_name, category_data, emoji, page_ctx) %}
    <section id="{{ category_key }}" class="aroi-section">
        <h3>{{ emoji }} {{ category_name }} - Top 25</h3>
        {% if category_data %}
        <div class="table-responsive">
            <table class="table table-striped table-condensed aroi-rankings-table aroi-category-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Operator (AROI)</th>
                        <th>Relays</th>
                        <th>Key Metric</th>
                        <th>Bandwidth</th>
                        <th>Countries</th>
                        <th>Platforms</th>
                        <th>Specialization</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in category_data[:25] %}
                    <tr>
                        <td>{{ rank_badge(entry.rank) }}</td>
                        <td>{{ operator_link(entry, page_ctx) }}</td>
                        <td>{{ entry.total_relays }}</td>
                        <td>
                            <strong>
                            {% if category_key == 'most_diverse' %}<span title="Diversity Score: Geographic (countries Ã— 2.0) + Platform (OS types Ã— 1.5) + Network (unique ASNs Ã— 1.0)">{{ entry.diversity_score }}</span>
                            {% elif category_key == 'platform_diversity' %}{{ entry.non_linux_count }} non-Linux
                            {% elif category_key == 'non_eu_leaders' %}{{ entry.non_eu_count }} non-EU
                            {% elif category_key == 'frontier_builders' %}{{ entry.rare_country_count }} rare
                            {% elif category_key == 'network_veterans' %}{{ entry.veteran_score }}
                            {% endif %}
                            </strong>
                        </td>
                        <td>{{ entry.total_bandwidth }} {{ entry.bandwidth_unit }}</td>
                        <td>{{ entry.country_count }}</td>
                        <td>{{ entry.platform_count }}</td>
                        <td>
                            {% if category_key == 'most_diverse' %}Geographic diversity
                            {% elif category_key == 'platform_diversity' %}OS diversity
                            {% elif category_key == 'non_eu_leaders' %}Global expansion
                            {% elif category_key == 'frontier_builders' %}<span title="{{ entry.rare_country_tooltip }}">{{ entry.rare_country_details if entry.rare_country_details else 'Frontier presence' }}</span>
                            {% elif category_key == 'network_veterans' %}<span title="{{ entry.veteran_tooltip }}">{{ entry.veteran_details_short if entry.veteran_details_short else 'Network longevity' }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <p>No data available for {{ category_name }}.</p>
        </div>
        {% endif %}
    </section>
{% endmacro %} 