{# AROI Leaderboard Macros - Eliminate Template Code Duplication #}

{# Champion Badge Macro - Eliminate 10x duplicate champion badge blocks #}
{% macro champion_badge(category_key, leaderboard_data, title, emoji, panel_class="panel-warning", champion_class="", path_prefix="", use_bits=false) %}
    <div class="col-md-3 col-sm-6 aroi-champion-badge">
        <div class="panel {{ panel_class }}">
            <div class="panel-body text-center {{ champion_class }}">
                <h3 class="aroi-header-spacing" title="Elite champion in {{ title.lower() }} category">{{ emoji }} {{ title }}</h3>
                {% if leaderboard_data %}
                    {% set champion = leaderboard_data[0] %}
                    <h4><strong><a href="{{ path_prefix }}contact/{{ champion.contact_hash }}/" title="Contact: {{ champion.contact_info_escaped }}" class="aroi-underline-link">{{ champion.display_name|escape }}</a></strong></h4>
                    <p>
                        {% if category_key == "bandwidth" %}
                            <span title="Total observed bandwidth capacity in {% if use_bits %}{{ champion.bandwidth_unit }} (bits per second){% else %}{{ champion.bandwidth_unit }} (bytes per second){% endif %}">{{ champion.total_bandwidth }} {{ champion.bandwidth_unit }}</span>
                        {% elif category_key == "consensus_weight" %}
                            <span title="Network consensus weight controlling Tor routing decisions">{{ champion.total_consensus_weight_pct }} authority</span>
                        {% elif category_key == "exit_authority" %}
                            <span title="Control over internet exit traffic routing">{{ champion.exit_consensus_weight_pct }} exit authority</span>
                        {% elif category_key == "exit_operators" %}
                            <span title="Active exit relays providing critical internet access points">{{ champion.exit_count }} exit relays</span>
                        {% elif category_key == "guard_operators" %}
                            <span title="Active guard relays serving as critical network entry points">{{ champion.guard_count }} guard relays</span>
                        {% elif category_key == "most_diverse" %}
                            <span title="Diversity Score: Geographic (countries Ã— 2.0) + Platform (OS types Ã— 1.5) + Network (unique ASNs Ã— 1.0)">{{ champion.diversity_score }} diversity</span>
                        {% elif category_key == "platform_diversity" %}
                            <span title="Relays promoting OS diversity beyond Linux dominance">{{ champion.non_linux_count }} non-Linux relays</span>
                        {% elif category_key == "non_eu_leaders" %}
                            <span title="Relays expanding Tor geographic reach beyond European Union">{{ champion.non_eu_count }} non-EU relays</span>
                        {% elif category_key == "frontier_builders" %}
                            <span title="Countries with strategic importance but underrepresented in Tor network">{{ champion.rare_country_count }} rare countries</span>
                        {% elif category_key == "network_veterans" %}
                            <span title="Online and serving traffic since first day">{{ champion.veteran_days }} days</span>
                        {% endif %}
                    </p>
                    <small>
                        {% if category_key == "exit_authority" %}
                            <span title="Complete relay infrastructure operated by exit authority champion">{{ champion.exit_count }} exit relays</span>
                        {% elif category_key == "most_diverse" %}
                            <span title="Geographic distribution of relay operations">{{ champion.country_count }} countries</span>
                        {% else %}
                            <span title="Complete relay infrastructure operated by champion">{{ champion.total_relays }} total relays</span>
                        {% endif %}
                    </small>
                {% endif %}
            </div>
        </div>
    </div>
{% endmacro %}

{# Top 3 Table Macro - Eliminate 10x duplicate top 3 table blocks #}
{% macro top3_table(title, emoji, leaderboard_data, achievements, performance_type, page_ctx, use_bits=false) %}
    <div class="aroi-subsection">
        <h4 title="Top 3 performers in {{ title.lower() }} category">{{ emoji }} {{ title }}</h4>
        {% if leaderboard_data %}
        <div class="table-responsive">
            <table class="table table-striped aroi-top3-table">
                <thead>
                    <tr>
                        <th title="Relay operator with podium placement">Operator</th>
                        <th title="Recognition level earned for performance in this category">Achievement</th>
                        <th title="Detailed performance metrics and operational statistics">Performance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in leaderboard_data[:3] %}
                    <tr>
                        <td>
                            <strong>
                                {% if entry.rank == 1 %}ðŸ¥‡{% elif entry.rank == 2 %}ðŸ¥ˆ{% elif entry.rank == 3 %}ðŸ¥‰{% endif %}
                                <a href="{{ page_ctx.path_prefix }}contact/{{ entry.contact_hash }}/" title="Contact: {{ entry.contact_info_escaped }}" class="aroi-underline-link">{{ entry.display_name|escape }}</a>
                            </strong>
                        </td>
                        <td>
                            {% if performance_type == "non_eu_leaders" %}
                                <span title="Geographic achievement expanding Tor reach beyond European Union">{{ entry.geographic_achievement }}</span>
                            {% else %}
                                <span title="Achievement level for rank {{ entry.rank }} in {{ performance_type.replace('_', ' ').title() }} category">
                                {% if entry.rank == 1 %}{{ achievements[0] }}
                                {% elif entry.rank == 2 %}{{ achievements[1] }}
                                {% elif entry.rank == 3 %}{{ achievements[2] }}
                                {% endif %}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if performance_type == "bandwidth" %}
                                <span title="Total observed bandwidth capacity in {% if use_bits %}{{ entry.bandwidth_unit }} (bits per second){% else %}{{ entry.bandwidth_unit }} (bytes per second){% endif %} across all relays">{{ entry.total_bandwidth }} {{ entry.bandwidth_unit }} across {{ entry.total_relays }} relays</span>
                            {% elif performance_type == "consensus_weight" %}
                                <span title="Percentage of total Tor network consensus weight controlling routing decisions">{{ entry.total_consensus_weight_pct }} network authority</span>
                            {% elif performance_type == "exit_authority" %}
                                <span title="Percentage of exit consensus weight controlling internet access points">{{ entry.exit_consensus_weight_pct }} exit authority</span>
                            {% elif performance_type == "exit_operators" %}
                                <span title="Number of active exit relays providing critical internet access points">{{ entry.exit_count }} active exit relays</span>
                            {% elif performance_type == "guard_operators" %}
                                <span title="Number of active guard relays serving as critical network entry points">{{ entry.guard_count }} active guard relays</span>
                            {% elif performance_type == "most_diverse" %}
                                <span title="Geographic distribution and diversity score calculation">{{ entry.country_count }} countries, <span title="Diversity Score: Geographic (countries Ã— 2.0) + Platform (OS types Ã— 1.5) + Network (unique ASNs Ã— 1.0)">{{ entry.diversity_score }} diversity</span></span>
                            {% elif performance_type == "platform_diversity" %}
                                <span title="Non-Linux relays promoting OS diversity and total bandwidth capacity">{{ entry.non_linux_count }} non-Linux relays, {{ entry.total_bandwidth }} {{ entry.bandwidth_unit }}</span>
                            {% elif performance_type == "non_eu_leaders" %}
                                <span title="Geographic expansion beyond EU with bandwidth contribution">{{ entry.country_count }} countries, {{ entry.total_bandwidth }} {{ entry.bandwidth_unit }}</span>
                            {% elif performance_type == "frontier_builders" %}
                                <span title="{{ entry.rare_country_tooltip }}">{{ entry.relays_in_rare_countries }} relays in {{ entry.rare_country_count }} rare countries</span>
                            {% elif performance_type == "network_veterans" %}
                                <span title="{{ entry.veteran_tooltip }}">{{ entry.veteran_days }} days * {{ entry.total_relays }} relays</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
{% endmacro %}

{# Ranking Table Components - Eliminate massive duplication in ranking tables #}

{# Rank Badge Macro - Handles rank display with proper medal styling (used ~50 times) #}
{% macro rank_badge(rank) %}
    {% if rank <= 3 %}
        <span class="badge {% if rank == 1 %}aroi-rank-gold{% elif rank == 2 %}aroi-rank-silver{% else %}aroi-rank-bronze{% endif %}" title="{% if rank == 1 %}Gold medal - Champion{% elif rank == 2 %}Silver medal - Runner-up{% else %}Bronze medal - Third place{% endif %} position">
            {% if rank == 1 %}ðŸ¥‡{% elif rank == 2 %}ðŸ¥ˆ{% else %}ðŸ¥‰{% endif %} {{ rank }}
        </span>
    {% else %}
        <span class="badge badge-default" title="Rank {{ rank }} in this category">{{ rank }}</span>
    {% endif %}
{% endmacro %}

{# Operator Link Macro - Handles operator name/domain links with proper styling (used ~50 times) #}
{% macro operator_link(entry, page_ctx, include_title=true, strong=true) %}
    <a href="{{ page_ctx.path_prefix }}contact/{{ entry.contact_hash }}/" {% if include_title %}title="Contact: {{ entry.contact_info_escaped }}"{% endif %} class="aroi-underline-link">
        {% if strong %}<strong>{% endif %}
        {{ entry.display_name|escape }}
        {% if strong %}</strong>{% endif %}
    </a>
{% endmacro %}

{# Generic Ranking Table Macro - For the loop-based tables with standardized columns #}
{% macro generic_ranking_table(category_key, category_name, category_data, emoji, page_ctx, use_bits=false) %}
    <section id="{{ category_key }}" class="aroi-section">
        <h3 title="Operators ranked by 
        {%- if category_key == 'most_diverse' -%}combined geographic, platform, and network diversity scores
        {%- elif category_key == 'platform_diversity' -%}number of non-Linux relays promoting OS diversity
        {%- elif category_key == 'non_eu_leaders' -%}number of relays operated outside the European Union
        {%- elif category_key == 'frontier_builders' -%}rare country scores from strategically important countries
        {%- elif category_key == 'network_veterans' -%}earliest relay start dates recognizing network pioneers
        {%- endif -%}">{{ emoji }} {{ category_name }} - Top 25</h3>
        {% if category_data %}
        <div class="table-responsive">
            <table class="table table-striped table-condensed aroi-rankings-table aroi-category-table">
                <thead>
                    <tr>
                        <th title="Position in {{ category_name.lower() }} leaderboard">Rank</th>
                        <th title="Authenticated Relay Operator Identifier following ContactInfo specification">Operator (AROI)</th>
                        <th title="Total number of relays operated by this operator">Relays</th>
                        <th title="Primary ranking metric for 
                        {%- if category_key == 'most_diverse' -%}diversity score calculation
                        {%- elif category_key == 'platform_diversity' -%}non-Linux relay count
                        {%- elif category_key == 'non_eu_leaders' -%}non-EU relay count
                        {%- elif category_key == 'frontier_builders' -%}rare country score
                        {%- elif category_key == 'network_veterans' -%}veteran score calculation
                        {%- endif -%}">Key Metric</th>
                        <th title="Total observed bandwidth capacity in {% if use_bits %}bits per second{% else %}bytes per second{% endif %}">Bandwidth</th>
                        <th title="Number of countries with relay operations">Countries</th>
                        {% if category_key != 'frontier_builders' %}
                        <th title="Number of different operating systems used">Platforms</th>
                        {% endif %}
                        <th title="Primary operational focus or unique contribution to Tor network">Specialization</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in category_data[:25] %}
                    <tr>
                        <td>{{ rank_badge(entry.rank) }}</td>
                        <td>{{ operator_link(entry, page_ctx) }}</td>
                        <td title="Active relays currently contributing to Tor network">{{ entry.total_relays }}</td>
                        <td>
                            <strong>
                            {% if category_key == 'most_diverse' %}<span title="Diversity Score: Geographic (countries Ã— 2.0) + Platform (OS types Ã— 1.5) + Network (unique ASNs Ã— 1.0)">{{ entry.diversity_score }}</span>
                            {% elif category_key == 'platform_diversity' %}<span title="Relays promoting operating system diversity beyond Linux dominance">{{ entry.non_linux_count }} non-Linux</span>
                            {% elif category_key == 'non_eu_leaders' %}<span title="Relays expanding Tor geographic reach beyond European Union concentration">{{ entry.non_eu_count }} non-EU</span>
                            {% elif category_key == 'frontier_builders' %}<span title="Countries with strategic importance but underrepresented in Tor network">{{ entry.rare_country_count }} rare</span>
                            {% elif category_key == 'network_veterans' %}<span title="Online and serving traffic since first day">{{ entry.veteran_score }}</span>
                            {% endif %}
                            </strong>
                        </td>
                        <td title="Observed bandwidth capacity in {% if use_bits %}{{ entry.bandwidth_unit }} (bits per second){% else %}{{ entry.bandwidth_unit }} (bytes per second){% endif %}">{{ entry.total_bandwidth }} {{ entry.bandwidth_unit }}</td>
                        <td title="Geographic distribution of relay operations">{{ entry.country_count }}</td>
                        {% if category_key != 'frontier_builders' %}
                        <td title="Operating system diversity across relay infrastructure">{{ entry.platform_count }}</td>
                        {% endif %}
                        <td>
                            {% if category_key == 'most_diverse' %}<span title="Highest combined geographic, platform, and network diversity scores">Geographic diversity</span>
                            {% elif category_key == 'platform_diversity' %}<span title="Promoting operating system diversity beyond Linux dominance">OS diversity</span>
                            {% elif category_key == 'non_eu_leaders' %}<span title="Expanding Tor's geographic reach beyond European Union concentration">Global expansion</span>
                            {% elif category_key == 'frontier_builders' %}<span title="{{ entry.rare_country_tooltip }}">{{ entry.rare_country_details if entry.rare_country_details else 'Frontier presence' }}</span>
                            {% elif category_key == 'network_veterans' %}<span title="{{ entry.veteran_tooltip }}">{{ entry.veteran_details_short if entry.veteran_details_short else 'Network longevity' }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <p>No data available for {{ category_name }}.</p>
        </div>
        {% endif %}
    </section>
{% endmacro %} 