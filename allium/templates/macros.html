{% macro breadcrumbs(page_type, page_data=none, path_prefix="") -%}
<nav aria-label="breadcrumb" style="margin-bottom: 10px;">
    <ol class="breadcrumb" style="background: none; padding: 0; margin: 0; font-size: 0.9em; list-style: none;">
        <li style="display: inline;"><a href="{{ path_prefix }}index.html">Home</a></li>
        {% if page_type == 'as_detail' and page_data %}
            <li style="display: inline;"> > <a href="{{ path_prefix }}misc/networks-by-bandwidth.html">Browse by Network</a></li>
            <li style="display: inline; color: #777;"> > {{ page_data.as_number }}</li>
        {% elif page_type == 'contact_detail' and page_data %}
            <li style="display: inline;"> > <a href="{{ path_prefix }}misc/contacts-by-bandwidth.html">Browse by Contact</a></li>
            <li style="display: inline; color: #777;"> > {% if page_data.aroi_domain and page_data.aroi_domain != 'none' %}{{ page_data.aroi_domain }}{% else %}{{ page_data.contact_hash[:8] }}{% endif %}</li>
        {% elif page_type == 'country_detail' and page_data %}
            <li style="display: inline;"> > <a href="{{ path_prefix }}misc/countries-by-bandwidth.html">Browse by Country</a></li>
            <li style="display: inline; color: #777;"> > {{ page_data.country_name }}</li>
        {% elif page_type == 'family_detail' and page_data %}
            <li style="display: inline;"> > <a href="{{ path_prefix }}misc/families-by-bandwidth.html">Browse by Family</a></li>
            <li style="display: inline; color: #777;"> > {% if page_data.aroi_domain and page_data.aroi_domain != 'none' %}{{ page_data.aroi_domain }}{% else %}{{ page_data.family_hash[:8] }}{% endif %}</li>
        {% elif page_type == 'platform_detail' and page_data %}
            <li style="display: inline;"> > <a href="{{ path_prefix }}misc/platforms-by-bandwidth.html">Browse by Platform</a></li>
            <li style="display: inline; color: #777;"> > {{ page_data.platform_name }}</li>
        {% elif page_type == 'first_seen_detail' and page_data %}
            <li style="display: inline;"> > <a href="{{ path_prefix }}misc/all.html">All Relays</a></li>
            <li style="display: inline; color: #777;"> > First Seen {{ page_data.date }}</li>
        {% elif page_type == 'flag_detail' and page_data %}
            <li style="display: inline;"> > <a href="{{ path_prefix }}misc/all.html">All Relays</a></li>
            <li style="display: inline; color: #777;"> > {{ page_data.flag_name|title }} Relays</li>
        {% elif page_type == 'relay_detail' and page_data %}
            <li style="display: inline;"> > <a href="{{ path_prefix }}misc/networks-by-bandwidth.html">Browse by Network</a></li>
            {% if page_data.as_number %}
                <li style="display: inline;"> > <a href="{{ path_prefix }}as/{{ page_data.as_number }}/">{{ page_data.as_number }}</a></li>
            {% endif %}
            <li style="display: inline; color: #777;"> > {{ page_data.nickname }}</li>
        {% elif page_type == 'home' and page_data %}
            <li style="display: inline; color: #777;"> > {{ page_data.page_name }}</li>
        {% elif page_type == 'misc_listing' and page_data %}
            <li style="display: inline; color: #777;"> > {{ page_data.page_name }}</li>
        {% endif %}
    </ol>
</nav>
{%- endmacro %}

{# =============================================================================
   SEARCH FORM MACRO (DRY - reusable search input with security attributes)
   ============================================================================= #}
{% macro search_input(path_prefix, variant='desktop') -%}
{#
    Renders a search input field with proper security attributes.
    
    Args:
        path_prefix: URL path prefix for the search action
        variant: 'desktop' (compact) or 'mobile' (full-width)
    
    Security attributes applied:
        - maxlength: Prevents DoS via extremely long queries
        - pattern: Client-side validation (defense-in-depth)
        - autocomplete=off: Prevents sensitive data leakage
        - spellcheck=false: Prevents data being sent to spell-check services
#}
{% set placeholder = "Search relays..." if variant == 'desktop' else "Search: fingerprint, nickname, AROI, IP, AS number, family, country..." %}
{% set input_class = "form-control input-sm" if variant == 'desktop' else "form-control" %}
{% set btn_class = "btn btn-sm btn-default" if variant == 'desktop' else "btn btn-primary" %}
{% set btn_content = '<span class="glyphicon glyphicon-search" aria-hidden="true"></span>' if variant == 'desktop' else 'Search' %}
<input type="text" 
       name="q" 
       class="{{ input_class }}" 
       placeholder="{{ placeholder }}"
       title="Search by fingerprint, nickname, AROI, IP, AS number, family, or country"
       maxlength="100"
       pattern="[A-Za-z0-9\s\-_.@:]+"
       autocomplete="off"
       autocapitalize="off"
       spellcheck="false">
<span class="input-group-btn">
    <button type="submit" class="{{ btn_class }}">{{ btn_content | safe }}</button>
</span>
{%- endmacro %}

{% macro navigation(active_section, page_ctx={'path_prefix': ''}, show_breadcrumbs=true) -%}
    {% if show_breadcrumbs and page_ctx.breadcrumb_type and page_ctx.breadcrumb_data %}
        {{ breadcrumbs(page_ctx.breadcrumb_type, page_ctx.breadcrumb_data, page_ctx.path_prefix) }}
    {% endif %}
    <nav class="navbar navbar-default" style="margin-bottom: 20px;">
        <div class="container-fluid">
            <!-- CSS-only hamburger toggle using checkbox hack -->
            <input type="checkbox" id="navbar-toggle" class="navbar-toggle-checkbox" style="display: none;">
            
            <div class="navbar-header">
                <label for="navbar-toggle" class="navbar-toggle" role="button" aria-label="Toggle navigation">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </label>
                <span class="navbar-brand visible-xs">Browse Categories</span>
            </div>
            
            <div class="navbar-collapse" id="main-navbar">
                <ul class="nav navbar-nav">
                    <li class="{% if active_section == 'network_health' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}network-health.html">Network Health</a>
                    </li>
                    <li class="{% if active_section == 'aroi' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}index.html">Operator Champions</a>
                    </li>
                    <li class="{% if active_section == 'contacts' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}misc/contacts-by-bandwidth.html">By Operator / Contact</a>
                    </li>
                    <li class="{% if active_section == 'families' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}misc/families-by-bandwidth.html">By Family</a>
                    </li>
                    <li class="{% if active_section == 'networks' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}misc/networks-by-bandwidth.html">By Network</a>
                    </li>
                    <li class="{% if active_section == 'countries' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}misc/countries-by-bandwidth.html">By Country</a>
                    </li>
                    <li class="{% if active_section == 'platforms' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}misc/platforms-by-bandwidth.html">By Platform</a>
                    </li>
                    <li class="{% if active_section == 'authorities' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}misc/authorities.html">Directory Authorities</a>
                    </li>
                    <li class="{% if active_section == 'top500' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}top500.html">Top 500 Relays</a>
                    </li>
                    <li class="{% if active_section == 'all' %}active{% endif %}">
                        <a href="{{ page_ctx.path_prefix }}misc/all.html">All Relays</a>
                    </li>
                </ul>
                
                <!-- Desktop: Search in navbar (hidden on mobile via CSS) -->
                <form action="{{ page_ctx.path_prefix }}search" method="GET" 
                      class="navbar-form navbar-right hidden-xs hidden-sm"
                      style="margin-right: 0;">
                    <div class="input-group" style="width: 220px;">
                        {{ search_input(page_ctx.path_prefix, 'desktop') }}
                    </div>
                </form>
            </div>
        </div>
    </nav>
    
    <!-- Mobile: Search bar below navbar (hidden on desktop via CSS) -->
    <div class="allium-mobile-search visible-xs visible-sm">
        <form action="{{ page_ctx.path_prefix }}search" method="GET">
            <div class="input-group">
                {{ search_input(page_ctx.path_prefix, 'mobile') }}
            </div>
        </form>
    </div>
{%- endmacro %}

{% macro detail_summary(bandwidth, bandwidth_unit, guard_bandwidth, middle_bandwidth, exit_bandwidth, consensus_weight_fraction, guard_consensus_weight_fraction, middle_consensus_weight_fraction, exit_consensus_weight_fraction, guard_count, middle_count, exit_count, total_relays, network_position, aroi_domain=none, contact=none, contact_md5=none, page_ctx=none, unique_aroi_list=none, unique_contact_list=none, unique_aroi_count=none, unique_contact_count=none, unique_aroi_contact_html=none, aroi_to_contact_map=none) -%}
<ul style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px;">
    <li><strong><span title="Observed bandwidth capacity represents the estimated maximum throughput this group can handle, combining total, guard, middle, and exit bandwidth contributions">Bandwidth Capacity</span>:</strong> ~{{ bandwidth }} {{ bandwidth_unit }}
        {%- if guard_count > 0 or middle_count > 0 or exit_count > 0 %} 
        (<span title="Bandwidth capacity dedicated to guard relay operations">{{ guard_bandwidth }} {{ bandwidth_unit }} guard capacity</span>
        {%- if middle_count > 0 %}, <span title="Bandwidth capacity dedicated to middle relay operations">{{ middle_bandwidth }} {{ bandwidth_unit }} middle capacity</span>{% endif -%}
        {%- if exit_count > 0 %}, <span title="Bandwidth capacity dedicated to exit relay operations">{{ exit_bandwidth }} {{ bandwidth_unit }} exit capacity</span>{% endif -%}
        )
        {%- endif %}</li>
    <li><strong><span title="Network influence represents the percentage of overall consensus weight, indicating relative importance in the Tor network across guard, middle, and exit positions">Network Influence</span>:</strong> {{ "%.2f%%"|format(consensus_weight_fraction * 100) }} of overall consensus weight
        {%- if guard_count > 0 or middle_count > 0 or exit_count > 0 %} 
        (<span title="Percentage of guard consensus weight for entry position selection">{{ "%.2f%%"|format(guard_consensus_weight_fraction * 100) }} guard</span>
        {%- if middle_count > 0 %}, <span title="Percentage of middle consensus weight for routing position selection">{{ "%.2f%%"|format(middle_consensus_weight_fraction * 100) }} middle</span>{% endif -%}
        {%- if exit_count > 0 %}, and <span title="Percentage of exit consensus weight for exit position selection">{{ "%.2f%%"|format(exit_consensus_weight_fraction * 100) }} exit</span>{% endif -%}
        )
        {%- endif %}</li>
    <li><strong><span title="Network position indicates the strategic role distribution of relays. Labels: Guard-focused (>60% guard), Exit-focused (>40% exit), Multi-role (both guard and exit >20%), Balanced (mixed roles), Guard-only (100% guard), Exit-only (100% exit), Middle-only (100% middle)">Network Position</span>:</strong> {{ network_position.formatted_string }}</li>
    {%- if unique_aroi_count is not none and unique_contact_count is not none %}
    <li><strong><span title="Unique AROI operators and contact information for this network">Unique AROI Operators and Contact Information</span>:</strong> {{ unique_contact_count }}
        {%- if unique_aroi_contact_html %}, {{ unique_aroi_contact_html|safe }}{% endif -%}
    </li>
    {%- endif %}
    {%- if aroi_domain and aroi_domain != 'none' and aroi_domain != '' %}
    <li><strong><span title="Autonomous Relay Operator Identifier - unverified">AROI</span>:</strong> 
    {% if base_url and aroi_domain in validated_aroi_domains -%}
    <a href="{{ base_url }}/{{ aroi_domain|lower|escape }}/">{{ aroi_domain|escape }}</a>
    {% else -%}
    <a href="{{ page_ctx.path_prefix if page_ctx else '../../' }}contact/{{ contact_md5|escape }}/">{{ aroi_domain|escape }}</a>
    {% endif -%}
    </li>
    {%- endif %}
    {%- if contact_md5 %}
    <li><strong>Contact:</strong> <a href="{{ page_ctx.path_prefix if page_ctx else '../../' }}contact/{{ contact_md5|escape }}/">{% if contact and contact.strip() %}{{ contact|escape }}{% else %}none{% endif %}</a></li>
    {%- endif %}
</ul>
{%- endmacro %}

{% macro aroi_validation_icon(fingerprint, aroi_domain, validated_fps, unvalidated_fps) -%}
    {% if fingerprint in validated_fps -%}
        <span style="color: #28a745; margin-left: 4px;" title="AROI Validated: This relay's fingerprint has been cryptographically verified via the operator's AROI proof">‚úì</span>
    {% elif fingerprint in unvalidated_fps -%}
        <a href="#aroi-validation-issues" style="color: #ffc107; margin-left: 4px; text-decoration: none;" title="AROI Validation Failed: This relay has AROI configured but validation failed - see details below">‚ö†</a>
    {% elif aroi_domain and aroi_domain != 'none' -%}
        <span style="color: #dc3545; margin-left: 4px;" title="No AROI Validation: This relay has AROI configured but no validation data is available">‚úó</span>
    {% endif -%}
{%- endmacro %}

{# =============================================================================
   AROI VALIDATION BADGE MACRO (DRY - used by contact.html and family.html)
   Shows "‚úì Verified" / "‚ö† Partially Verified" / "‚úó Unvalidated" badge
   ============================================================================= #}
{% macro aroi_validation_badge(contact_validation_status) -%}
{% if contact_validation_status and contact_validation_status.has_aroi -%}
    {% if contact_validation_status.validation_status == 'validated' -%}
        <span style="color: #28a745; font-weight: bold; margin-left: 5px;" title="All {{ contact_validation_status.validation_summary.relays_with_aroi }} relays with AROI have valid cryptographic proofs">‚úì Verified</span>
    {% elif contact_validation_status.validation_status == 'partially_validated' -%}
        <a href="#aroi-validation-issues" style="color: #ffc107; font-weight: bold; margin-left: 5px; text-decoration: none;" title="{{ contact_validation_status.validation_summary.validated_count }}/{{ contact_validation_status.validation_summary.relays_with_aroi }} relays validated ({{ "%.1f"|format(contact_validation_status.validation_summary.validation_rate) }}%) - See details below">‚ö† Partially Verified</a>
    {% elif contact_validation_status.validation_status == 'unvalidated' -%}
        <a href="#aroi-validation-issues" style="color: #dc3545; font-weight: bold; margin-left: 5px; text-decoration: none;" title="AROI validation failed - See details below">‚úó Unvalidated</a>
    {% endif -%}
{% endif -%}
{%- endmacro %}

{# =============================================================================
   AROI VALIDATION BADGE WITH COUNT MACRO (for when domain isn't parsed)
   Shows relay count in badge: "‚úì Verified (X relays)"
   ============================================================================= #}
{% macro aroi_validation_badge_with_count(contact_validation_status) -%}
{% if contact_validation_status and contact_validation_status.has_aroi -%}
    {% if contact_validation_status.validation_status == 'validated' -%}
        <span style="color: #28a745; font-weight: bold;" title="All {{ contact_validation_status.validation_summary.relays_with_aroi }} relays with AROI have valid cryptographic proofs">‚úì Verified ({{ contact_validation_status.validation_summary.relays_with_aroi }} relays)</span>
    {% elif contact_validation_status.validation_status == 'partially_validated' -%}
        <a href="#aroi-validation-issues" style="color: #ffc107; font-weight: bold; text-decoration: none;" title="{{ contact_validation_status.validation_summary.validated_count }}/{{ contact_validation_status.validation_summary.relays_with_aroi }} relays validated ({{ "%.1f"|format(contact_validation_status.validation_summary.validation_rate) }}%) - See details below">‚ö† Partially Verified ({{ contact_validation_status.validation_summary.validated_count }}/{{ contact_validation_status.validation_summary.relays_with_aroi }})</a>
    {% elif contact_validation_status.validation_status == 'unvalidated' -%}
        <a href="#aroi-validation-issues" style="color: #dc3545; font-weight: bold; text-decoration: none;" title="AROI validation failed for {{ contact_validation_status.validation_summary.relays_with_aroi }} relays - See details below">‚úó Unvalidated ({{ contact_validation_status.validation_summary.relays_with_aroi }} relays)</a>
    {% endif -%}
{% endif -%}
{%- endmacro %}

{# =============================================================================
   AROI VALIDATION ISSUES SECTION MACRO (DRY - used by contact.html and family.html)
   Shows detailed error list for relays with validation failures
   ============================================================================= #}
{% macro aroi_validation_issues_section(contact_validation_status, aroi_validation_timestamp, page_ctx) -%}
{% if contact_validation_status and contact_validation_status.has_aroi and contact_validation_status.unvalidated_relays and contact_validation_status.show_detailed_errors %}
<div id="aroi-validation-issues" style="margin-top: 30px; padding: 15px; background-color: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; max-width: 1200px;">
    <h4 style="margin-top: 0; margin-bottom: 12px; color: #856404;">
        <strong>‚ö†Ô∏è AROI Validation Issues ({{ contact_validation_status.validation_summary.validated_count }}/{{ contact_validation_status.validation_summary.relays_with_aroi }} relays validated)</strong>
    </h4>
    
    <p style="margin-bottom: 10px; font-size: 14px; color: #856404;">
        The following relays have AROI validation errors. Fix these to improve your validation status:
    </p>
    
    {% if contact_validation_status.validation_available %}
    <p style="margin-bottom: 12px; font-size: 13px; color: #666; font-style: italic;">
        Validation data last updated: {{ aroi_validation_timestamp if aroi_validation_timestamp else 'Unknown' }}
    </p>
    {% endif %}
    
    <ul style="list-style-type: none; padding-left: 0; margin-bottom: 10px;">
        {% for relay in contact_validation_status.unvalidated_relays %}
        <li style="margin-bottom: 6px; padding: 8px; background-color: #fff; border-radius: 3px; font-size: 13px; border: 1px solid #ffeeba;">
            <strong><a href="{{ page_ctx.path_prefix }}relay/{{ relay.fingerprint }}/">{{ relay.nickname|escape }}</a></strong>
            <span style="color: #666;">‚Ä¢</span>
            <span style="color: #dc3545;">{{ relay.error|escape }}</span>
            {% if relay.proof_type and relay.proof_type != 'unknown' %}
                <span style="color: #666;">‚Ä¢ Proof type: {{ relay.proof_type }}</span>
            {% endif %}
            <span style="color: #666;">‚Ä¢ Fingerprint: <code style="font-size: 11px;">{{ relay.fingerprint }}</code></span>
        </li>
        {% endfor %}
    </ul>
    
    <p style="font-size: 12px; color: #856404; margin-bottom: 0;">
        üìñ <strong>Need help?</strong> See the <a href="https://nusenu.github.io/ContactInfo-Information-Sharing-Specification/" target="_blank" rel="noopener" style="color: #856404; text-decoration: underline;">AROI Specification</a> for guidance on setting up valid cryptographic proofs.
    </p>
</div>
{% endif %}
{%- endmacro %} 