{% extends "skeleton.html" -%}
{% from "macros.html" import navigation %}
{% block title -%}
	Tor Relays :: {{ relay['nickname']|escape }}
{% endblock -%}
{% block body -%}
<style>
.section-header {
    position: relative;
    display: inline-block;
}

.anchor-link {
    text-decoration: none;
    color: inherit;
}







/* Highlight section when targeted */
:target {
    background-color: rgba(255, 193, 7, 0.2);
    padding: 8px;
    border-radius: 4px;
    margin: -8px;
    transition: background-color 0.3s;
}


</style>
<div id="content">
<h2>View Relay "{{ relay['nickname'] }}"</h2>
{% set relay_data = {'nickname': relay['nickname'], 'fingerprint': relay['fingerprint'], 'as_number': relay['as']} %}
{{ navigation('all', page_ctx) }}
<h4>
{% if relay['effective_family']|length > 1 -%}
<a href="{{ page_ctx.path_prefix }}family/{{ relay['fingerprint']|escape }}/">Family: {{ relay['effective_family']|length }} relays</a>
{% else -%}
Family: {{ relay['effective_family']|length }} relay
{% endif -%} | 
{% if relay['as'] -%}
<a href="{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/">{{ relay['as']|escape }}</a>
{% else -%}
AS: unknown
{% endif -%} | 
{% if relay['country'] -%}
<a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">{{ relay['country_name']|escape }}</a>
{% else -%}
Country: unknown
{% endif -%} | 
<a href="{{ page_ctx.path_prefix }}platform/{{ relay['platform']|escape }}/">{{ relay['platform']|escape }}</a>
</h4>
<p>Last fetch was at {{ relays.timestamp }}.</p>
<div class="row">
<div class="col-md-6">
<dl>
<dt>
Nickname
</dt>
<dd>
{{ relay['nickname']|escape }}
</dd>

<dt>
Fingerprint
</dt>
<dd>
<code>{{ relay['fingerprint']|escape }}</code>
</dd>

<dt>
AROI <a href="https://nusenu.github.io/ContactInfo-Information-Sharing-Specification/" target="_blank" title="Autonomous Relay Operator Identifier - unverified">(?)</a>
</dt>
{% if relay['aroi_domain'] and relay['aroi_domain'] != 'none' -%}
<dd>
{% if base_url and relay['aroi_domain'] in validated_aroi_domains -%}
<a href="{{ base_url }}/{{ relay['aroi_domain']|lower|escape }}/">{{ relay['aroi_domain']|escape }}</a>
{% else -%}
<a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/">{{ relay['aroi_domain']|escape }}</a>
{% endif -%}
</dd>
{% else -%}
<dd>
none
</dd>
{% endif -%}
<dt>
Contact
</dt>
{% if relay['contact'] -%}
<dd style="word-wrap: break-word; word-break: break-all; max-width: 100%; overflow-wrap: break-word;">
<a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/" style="word-wrap: break-word; word-break: break-all; overflow-wrap: break-word;">{{
relay['contact']|escape }}</a>
</dd>
{% else -%}
<dd>
<a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}">none</a>
</dd>
{% endif -%}
<dt id="ipv4-exit-policy-summary">
<div class="section-header">
<a href="#ipv4-exit-policy-summary" class="anchor-link">IPv4 Exit Policy Summary</a>
</div>
</dt>
<dd>
{% if relay['exit_policy_summary'] -%}
{%- set v4_summary = relay['exit_policy_summary'].items() -%}
<pre class="pre-scrollable">{% for k, v in v4_summary -%}
{{ k|escape }}: {{ '\n  ' + v|join('\n  ')|escape }}
{% endfor -%}
</pre>
{% else -%}
<pre>none</pre>
{% endif -%}
</dd>
<dt id="ipv6-exit-policy-summary">
<div class="section-header">
<a href="#ipv6-exit-policy-summary" class="anchor-link">IPv6 Exit Policy Summary</a>
</div>
</dt>
<dd>
{% if relay['exit_policy_v6_summary'] -%}
{%- set v6_summary = relay['exit_policy_v6_summary'].items() -%}
<pre class="pre-scrollable">{% for k, v in v6_summary -%}
{{ k|escape }}: {{ '\n  ' + v|join('\n  ')|escape }}
{% endfor -%}
</pre>
{% else -%}
<pre>none</pre>
{% endif -%}
</dd>
<dt id="exit-policy">
<div class="section-header">
<a href="#exit-policy" class="anchor-link">Exit Policy</a>
</div>
</dt>
<dd>
<pre class="pre-scrollable">{% for policy in relay['exit_policy'] -%}
{{ policy|escape }}
{% endfor -%}
</pre>
</dd>
{% if relay['effective_family']|length > 1 -%}
<dt id="effective-family" title="Array of fingerprints of relays that are in an effective, mutual family relationship with this relay. These relays are part of this relay's family and they consider this relay to be part of their family. Always contains the relay's own fingerprint. Omitted if the descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#effective-family" class="anchor-link">Effective Family Members: {{ relay['effective_family']|length }}</a> (<a href="{{ page_ctx.path_prefix }}family/{{ relay['fingerprint']|escape }}/">View</a>)
</div>
</dt>
{% else -%}
<dt id="effective-family" title="Array of fingerprints of relays that are in an effective, mutual family relationship with this relay. These relays are part of this relay's family and they consider this relay to be part of their family. Always contains the relay's own fingerprint. Omitted if the descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#effective-family" class="anchor-link">Effective Family Member: {{ relay['effective_family']|length }}</a>
</div>
</dt>
{% endif -%}
<dd>
<pre class="pre-scrollable">{% for e_relay in relay['effective_family'] -%}
{% if relay['effective_family']|length > 1 -%}
<a href="../{{ e_relay|escape }}/">{{ e_relay|escape }}</a>
{% else -%}
{{ e_relay|escape }}
{% endif -%}
{% endfor -%}
</pre>
</dd>
<dt id="alleged-family" title="Array of fingerprints of relays that are not in an effective, mutual family relationship with this relay. These relays are part of this relay's family but they don't consider this relay to be part of their family. Omitted if empty or if descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#alleged-family" class="anchor-link">Alleged Family {% if relay['alleged_family'] and relay['alleged_family']|length == 1 -%}Member{% else -%}Members{% endif -%}: {% if relay['alleged_family'] -%}{{ relay['alleged_family']|length }}{% else -%}0{% endif -%}</a>
</div>
</dt>
<dd>
{% if relay['alleged_family'] -%}
<pre class="pre-scrollable">{% for a_relay in relay['alleged_family'] -%}
{% if relay['alleged_family']|length > 1 -%}
<a href="../{{ a_relay|escape }}/">{{ a_relay|escape }}</a>
{% else -%}
{{ a_relay|escape }}
{% endif -%}
{% endfor -%}
{% else -%}
<pre class="pre-scrollable">none
{% endif -%}
</pre>
</dd>
<dt id="indirect-family" title="Array of fingerprints of relays that consider this relay to be part of their family but that are not part of this relay's family. Omitted if empty or if descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#indirect-family" class="anchor-link">Indirect Family {% if relay['indirect_family'] and relay['indirect_family']|length == 1 -%}Member{% else -%}Members{% endif -%}: {% if relay['indirect_family'] -%}{{ relay['indirect_family']|length }}{% else -%}0{% endif -%}</a>
</div>
</dt>
<dd>
{% if relay['indirect_family'] -%}
<pre class="pre-scrollable">{% for i_relay in relay['indirect_family'] -%}
{% if relay['indirect_family']|length > 1 -%}
<a href="../{{ i_relay|escape }}/">{{ i_relay|escape }}</a>
{% else -%}
{{ i_relay|escape }}
{% endif -%}
{% endfor -%}
{% else -%}
<pre class="pre-scrollable">none
{% endif -%}
</pre>
</dd>
</dl>
</div>
<div class="col-md-6">
<dl>
<dt title="Bandwidth capacity details: Observed capacity | Advertised capability | Rate limit | Burst limit">
Bandwidth Capacity (Observed | Advertised | Rate Limit | Burst Limit)
</dt>
    {% set obs_unit = relay['observed_bandwidth']|determine_unit(relays.use_bits) -%}
    {% set obs_bandwidth = relay['observed_bandwidth']|format_bandwidth_with_unit(obs_unit) -%}
<dd>
<span title="Observed: {{ obs_bandwidth }} {{ obs_unit }}">{{ obs_bandwidth }} {{ obs_unit }}</span> | 
{% if relay['advertised_bandwidth'] -%}{% set adv_unit = relay['advertised_bandwidth']|determine_unit(relays.use_bits) -%}{% set adv_bandwidth = relay['advertised_bandwidth']|format_bandwidth_with_unit(adv_unit) -%}<span title="Advertised: {{ adv_bandwidth }} {{ adv_unit }}">{{ adv_bandwidth }} {{ adv_unit }}</span>{% else -%}<span title="Advertised: unknown">unknown</span>{% endif -%} | 
{% if relay['bandwidth_rate'] -%}{% set rate_unit = relay['bandwidth_rate']|determine_unit(relays.use_bits) -%}{% set rate_bandwidth = relay['bandwidth_rate']|format_bandwidth_with_unit(rate_unit) -%}<span title="Rate: {{ rate_bandwidth }} {{ rate_unit }}">{{ rate_bandwidth }} {{ rate_unit }}</span>{% else -%}<span title="Rate: unknown">unknown</span>{% endif -%} | 
{% if relay['bandwidth_burst'] -%}{% set burst_unit = relay['bandwidth_burst']|determine_unit(relays.use_bits) -%}{% set burst_bandwidth = relay['bandwidth_burst']|format_bandwidth_with_unit(burst_unit) -%}<span title="Burst: {{ burst_bandwidth }} {{ burst_unit }}">{{ burst_bandwidth }} {{ burst_unit }}</span>{% else -%}<span title="Burst: unknown">unknown</span>{% endif -%}
{% if relay['measured'] is not none -%}
    {% if relay['measured'] -%}
        &nbsp;&nbsp;<span style="color: #28a745; font-weight: bold;" title="Bandwidth capacity measured by ‚â•3 bandwidth authorities">‚úì</span>
    {% else -%}
        &nbsp;&nbsp;<span style="color: #dc3545; font-weight: bold;" title="Bandwidth capacity not measured by ‚â•3 bandwidth authorities">‚úó</span>
    {% endif -%}
{% else -%}
    &nbsp;&nbsp;<span style="color: #6c757d;" title="Bandwidth capacity measurement status unknown">?</span>
{% endif -%}
</dd>

<dt>
Network Participation (Consensus Weight | Guard | Middle | Exit)
</dt>
<dd>
<span title="Fraction of this relay's consensus weight compared to the sum of all consensus weights in the network. This fraction is a very rough approximation of the probability of this relay to be selected by clients.">{% if relay['consensus_weight_fraction'] -%}{{ "%.2f"|format(relay['consensus_weight_fraction'] * 100) }}%{% else -%}N/A{% endif -%}</span> | 
<span title="Probability of this relay to be selected for the guard position. This probability is calculated based on consensus weights, relay flags, and bandwidth weights in the consensus. Path selection depends on more factors, so that this probability can only be an approximation.">{% if relay['guard_probability'] -%}{{ "%.2f"|format(relay['guard_probability'] * 100) }}%{% else -%}N/A{% endif -%}</span> | 
<span title="Probability of this relay to be selected for the middle position. This probability is calculated based on consensus weights, relay flags, and bandwidth weights in the consensus. Path selection depends on more factors, so that this probability can only be an approximation.">{% if relay['middle_probability'] -%}{{ "%.2f"|format(relay['middle_probability'] * 100) }}%{% else -%}N/A{% endif -%}</span> | 
<span title="Probability of this relay to be selected for the exit position. This probability is calculated based on consensus weights, relay flags, and bandwidth weights in the consensus. Path selection depends on more factors, so that this probability can only be an approximation.">{% if relay['exit_probability'] -%}{{ "%.2f"|format(relay['exit_probability'] * 100) }}%{% else -%}N/A{% endif -%}</span>
{% if relay['fingerprint'] in relays.json.smart_context.performance_correlation.template_optimized.underutilized_fingerprints %}
<br><small class="text-warning">‚ö†Ô∏è Underutilized: High bandwidth capacity but low consensus weight</small>
{% endif %}
</dd>

<dt title="IP address and TCP port where this relay accepts onion-routing connections, with hostname when available">
OR Address
</dt>
<dd>
{% if relay['verified_host_names'] -%}
{% for hostname in relay['verified_host_names'] -%}
<span class="verified-hostname" title="verified hostname">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
{% endfor %} | {% for address in relay['or_addresses'] -%}{{ address }}{% if not loop.last %}, {% endif %}{% endfor -%}
{% elif relay['unverified_host_names'] -%}
{% for hostname in relay['unverified_host_names'] -%}
<span class="unverified-hostname" title="unverified hostname">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
{% endfor %} | {% for address in relay['or_addresses'] -%}{{ address }}{% if not loop.last %}, {% endif %}{% endfor -%}
{% else -%}
{% for address in relay['or_addresses'] -%}{{ address }}{% if not loop.last %}, {% endif %}{% endfor -%}
{% endif -%}
</dd>
<dt>
Exit Address
</dt>
{% if relay['exit_address'] -%}
<dd>
{{ relay['exit_address']|escape }}
</dd>
{% else -%}
<dd>
none
</dd>
{% endif -%}
<dt>
Dir Address
</dt>
{% if relay['dir_address'] -%}
<dd>
<a href="http://{{ relay['dir_address']|escape }}">{{
relay['dir_address']|escape }}</a>
</dd>
{% else -%}
<dd>
none
</dd>
{% endif -%}

<dt>
{% if relay['city_name'] or relay['region_name'] -%}City | Region | Country{% else -%}Country{% endif -%}
</dt>
<dd>
{% if relay['city_name'] -%}
<span title="City name of the location of this relay as found by a geolocation database. Omitted if the relay location could not be found or if the database does not contain city information.">{{ relay['city_name']|escape }}</span>
{% endif -%}
{% if relay['city_name'] and relay['region_name'] -%} | {% endif -%}
{% if relay['region_name'] -%}
<span title="Region name of the location of this relay as found by a geolocation database. Omitted if the relay location could not be found or if the database does not contain region information.">{{ relay['region_name']|escape }}</span>
{% endif -%}
{% if (relay['city_name'] or relay['region_name']) and relay['country'] -%} | {% endif -%}
{% if relay['country'] -%}
<a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">
<img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relay['country']|lower|escape }}.png"
title="{{ relay['country_name']|escape }}"
alt="{{ relay['country_name']|escape }}">
</a> <span title="Country name of the location of this relay as found by a geolocation database based on the relay's IP address. Omitted if the relay location could not be found.">{{ relay['country_name']|escape }}</span>
{% else -%}
unknown
{% endif -%}
</dd>
{% if relay['latitude'] and relay['longitude'] and relay['latitude'] != 0 and relay['longitude'] != 0 -%}
<dt>
Latitude, Longitude
</dt>
<dd>
<span title="Latitude of the location of this relay as found by a geolocation database based on the relay's IP address. Omitted if the relay location could not be found.">{{ relay['latitude']|escape }}</span>, 
<span title="Longitude of the location of this relay as found by a geolocation database based on the relay's IP address. Omitted if the relay location could not be found.">{{ relay['longitude']|escape }}</span>
</dd>
{% endif -%}
<dt>
Interactive Map
</dt>
<dd>
<a href="https://routefluxmap.1aeo.com/#relay={{ relay['fingerprint']|escape }}" target="_blank" rel="noopener" title="View this relay on RouteFluxMap interactive visualization">üó∫Ô∏è View on Interactive Map</a>
</dd>
<dt>
Autonomous System (AS Number | AS Name)
</dt>
<dd>
{% if relay['as'] -%}
<a href='{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/' title="AS Number">{{ relay['as']|escape }}</a>
{% else -%}
<span title="AS Number">unknown</span>
{% endif -%} | {% if relay['as_name'] -%}
<span title="AS Name">{{ relay['as_name']|escape }}</span> (<a href='https://bgp.tools/{{ relay['as']|escape }}'>BGP.tools</a>)
{% else -%}
<span title="AS Name">unknown</span>
{% endif -%}
</dd>

<dt>
Flags: {{ relay['flags']|reject('equalto', 'StaleDesc')|list|length }}
</dt>
<dd>
{% for flag in relay['flags'] -%}
{% if flag != 'StaleDesc' -%}
<a href="{{ page_ctx.path_prefix }}flag/{{ flag.lower()|escape }}/">
<img src="{{ page_ctx.path_prefix }}static/images/flags/{{ flag.lower()|escape }}.png"
title="{{ flag|escape }}"
alt="{{ flag|escape }}">
</a> {{ flag|escape }}
{% endif -%}
{% endfor -%}
</dd>

<dt title="Flag-specific uptime percentages showing the reliability of this relay when operating in its primary network role. Priority: Exit > Guard > Fast > Running flags.">
Flag Uptime (1M/6M/1Y/5Y)
</dt>
<dd>
{% if relay.get('flag_uptime_display') and relay['flag_uptime_display'] != 'N/A' -%}
    {% if relay['flag_uptime_display'] == 'Match' -%}
        <span title="{{ relay['flag_uptime_tooltip']|escape }}">Match Overall Uptime ({{ relay['uptime_api_display']|safe }})</span>
    {% else -%}
        <span title="{{ relay['flag_uptime_tooltip']|escape }}">{{ relay['flag_uptime_display']|safe }}</span>
    {% endif -%}
{% else -%}
N/A
{% endif -%}
</dd>
<dt title="{% if contact_display_data and contact_display_data.outliers and contact_display_data.outliers.tooltip %}{{ contact_display_data.outliers.tooltip }}{% else %}Statistical outliers: ‚â•2œÉ from average{% endif %}">
Uptime (1M/6M/1Y/5Y)
</dt>
<dd>
{% if relay.get('uptime_api_display') -%}
    {{ relay['uptime_api_display']|safe }}
{% else -%}
    N/A
{% endif -%}
</dd>
<dt>
Uptime / Downtime
</dt>
<dd>
{% if relay.get('uptime_display') -%}
    {% if relay['uptime_display'].startswith('DOWN') -%}
        <span style="color: #dc3545;">{{ relay['uptime_display']|escape }}</span>
    {% else -%}
        {{ relay['uptime_display']|escape }}
    {% endif -%}
{% else -%}
    N/A
{% endif -%}
</dd>
<dt>
Seen (First | Last)
</dt>
<dd>
<a href="{{ page_ctx.path_prefix }}first_seen/{{ relay['first_seen'].split(' ', 1)[0]|escape }}/">{{ relay['first_seen']|format_time_ago }} ({{ relay['first_seen']|escape }})</a> | {{ relay['last_seen']|format_time_ago }} ({{ relay['last_seen']|escape }})
</dd>
<dt title="UTC timestamp when this relay was last (re-)started. Missing if router descriptor containing this information cannot be found.">
Last Restarted
</dt>
<dd>
{% if relay['last_restarted'] -%}
{{ relay['last_restarted']|format_time_ago }} ({{ relay['last_restarted']|escape }})
{% else -%}
unknown
{% endif -%}
</dd>
<dt title="UTC timestamp when this relay last stopped announcing an IPv4 or IPv6 address or TCP port where it previously accepted onion-routing or directory connections. This timestamp can serve as indicator whether this relay would be a suitable fallback directory.">
Last Changed Address or Port
</dt>
<dd>
{% if relay['last_changed_address_or_port'] -%}
{{ relay['last_changed_address_or_port']|escape }}
{% else -%}
unknown
{% endif -%}
</dd>
<dt title="Boolean field saying whether this relay indicated that it is hibernating in its last known server descriptor. This information may be helpful to decide whether a relay that is not running anymore has reached its accounting limit and has not dropped out due to a technical problem. Omitted if the last known server descriptor of this relay does not contain hibernation information or if no such descriptor is known.">
Hibernating
</dt>
<dd>
{% if relay['hibernating'] is not none -%}
{% if relay['hibernating'] -%}Yes{% else -%}No{% endif -%}
{% else -%}
unknown
{% endif -%}
</dd>
<dt>
Platform (Short | Long)
</dt>
<dd>
<a href='{{ page_ctx.path_prefix }}platform/{{ relay['platform']|escape }}/' title="Simplified platform identifier for categorization">{{ relay['platform']|escape }}</a> | <span title="Complete platform information as reported by relay">{% if relay['platform_raw'] -%}{{ relay['platform_raw']|escape }}{% else -%}{{ relay['platform']|escape }}{% endif -%}</span>
</dd>
<dt>
Version (Running | Recommended | Status)
</dt>
<dd>
<span title="Tor software version without leading 'Tor' as reported by the directory authorities in the 'v' line of the consensus. Omitted if either the directory authorities or the relay did not report which version the relay runs or if the relay runs an alternative Tor implementation.">{% if relay['version'] -%}{{ relay['version']|escape }}{% else -%}unknown{% endif -%}</span> | 
<span title="Boolean field saying whether the Tor software version of this relay is recommended by the directory authorities or not. Uses the relay version in the consensus. Omitted if either the directory authorities did not recommend versions, or the relay did not report which version it runs.">{% if relay['recommended_version'] is not none -%}{% if relay['recommended_version'] -%}Yes{% else -%}No{% endif -%}{% else -%}unknown{% endif -%}</span> | 
<span title="Status of the Tor software version of this relay based on the versions recommended by the directory authorities. Possible version statuses are: 'recommended' if a version is listed as recommended; 'experimental' if a version is newer than every recommended version; 'obsolete' if a version is older than every recommended version; 'new in series' if a version has other recommended versions with the same first three components, and the version is newer than all such recommended versions, but it is not newer than every recommended version; 'unrecommended' if none of the above conditions hold. Omitted if either the directory authorities did not recommend versions, or the relay did not report which version it runs.">{% if relay['version_status'] -%}{{ relay['version_status']|escape }}{% else -%}unknown{% endif -%}</span>
</dd>
</dl>
</div>
</div>

{# Consensus Diagnostics Section - Shows per-authority voting information #}
{% if relay.collector_diagnostics and relay.collector_diagnostics.available %}
{% set diag = relay.collector_diagnostics %}
{% set rv = diag.relay_values %}
<div class="row" style="margin-top: 20px;">
<div class="col-md-12">
<h3 id="consensus-diagnostics">
<div class="section-header">
<a href="#consensus-diagnostics" class="anchor-link">üîç Consensus Diagnostics</a>
</div>
</h3>
<p class="text-muted" style="font-size: 13px; margin-bottom: 15px;">
Real-time data from <a href="https://collector.torproject.org" target="_blank" rel="noopener">Tor CollecTor</a> showing how directory authorities view this relay.
</p>

{# Consensus Status Summary #}
<div style="padding: 15px; border-radius: 6px; margin-bottom: 20px;
            background: {% if diag.consensus_status.status_class == 'success' %}#d4edda{% else %}#f8d7da{% endif %};
            border: 1px solid {% if diag.consensus_status.status_class == 'success' %}#c3e6cb{% else %}#f5c6cb{% endif %};">
    <h4 style="margin-top: 0;">
        {% if diag.in_consensus %}
            <span style="color: #155724;">‚úì {{ diag.consensus_status.display }}</span>
        {% else %}
            <span style="color: #721c24;">‚úó {{ diag.consensus_status.display }}</span>
        {% endif %}
    </h4>
    <small style="color: {% if diag.consensus_status.status_class == 'success' %}#155724{% else %}#721c24{% endif %};">
        {{ diag.vote_count }}/{{ diag.total_authorities }} authorities voted for this relay 
        (majority required: {{ diag.majority_required }})
    </small>
</div>

{# Issues and Advice Section #}
{% if diag.issues %}
<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
    <h5 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Identified Issues</h5>
    <ul style="margin-bottom: 0; padding-left: 20px;">
    {% for issue in diag.issues %}
        <li>
            <strong>{{ issue.title }}</strong>: {{ issue.description }}
            {% if issue.suggestion %}
            <br><small style="color: #666;">üí° {{ issue.suggestion }}</small>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
</div>
{% endif %}

{# ============== TABLE 1: SUMMARY (Quick Answers) ============== #}
<h4 id="relay-summary">
<div class="section-header">
<a href="#relay-summary" class="anchor-link">Summary: Your Relay vs Consensus</a>
</div>
</h4>
<p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">
Quick overview showing your relay's values vs what the MAJORITY of authorities require.
<span style="color: #28a745;">Green</span> = meets threshold, <span style="color: #dc3545;">Red</span> = below threshold, <span style="color: #ffc107;">Yellow</span> = partial.
</p>
{% if rv %}
<div style="overflow-x: auto;">
<table class="table table-condensed table-striped" style="font-size: 12px;">
<thead>
<tr>
    <th title="Source: CollecTor | File: vote | Metric being measured">Metric</th>
    <th title="Source: CollecTor | File: vote | Your relay's value">Your Value</th>
    <th title="Source: CollecTor | File: vote | From flag-thresholds line">Consensus Threshold</th>
    <th>Status</th>
</tr>
</thead>
<tbody>
    <tr title="Source: CollecTor | Majority = floor(authority_count/2)+1">
        <td>In Consensus</td>
        <td>{{ diag.vote_count }}/{{ diag.total_authorities }} authorities</td>
        <td>‚â•{{ diag.majority_required }}/{{ diag.total_authorities }} (majority)</td>
        <td>
            {% if diag.in_consensus %}
                <span style="color: #28a745; font-weight: bold;">IN CONSENSUS</span>
            {% else %}
                <span style="color: #dc3545; font-weight: bold;">NOT IN CONSENSUS</span>
            {% endif %}
        </td>
    </tr>
    <tr title="Source: CollecTor | File: vote | Value: stats wfu=X | Threshold: flag-thresholds guard-wfu=X">
        <td>WFU (guard-wfu)</td>
        <td>{{ rv.wfu_display }}</td>
        <td>‚â•98% (all authorities)</td>
        <td>
            {% if rv.wfu_meets %}
                <span style="color: #28a745; font-weight: bold;">MEETS</span>
            {% else %}
                <span style="color: #dc3545; font-weight: bold;">BELOW - cannot get Guard</span>
            {% endif %}
        </td>
    </tr>
    <tr title="Source: CollecTor | File: vote | Value: stats tk=X | Threshold: flag-thresholds guard-tk=X">
        <td>Time Known (tk)</td>
        <td>{{ rv.tk_display }}</td>
        <td>‚â•8 days (all authorities)</td>
        <td>
            {% if rv.tk_meets %}
                <span style="color: #28a745; font-weight: bold;">MEETS</span>
            {% else %}
                <span style="color: #dc3545; font-weight: bold;">BELOW - need {{ "%.1f"|format(rv.tk_days_needed) }} more days</span>
            {% endif %}
        </td>
    </tr>
    <tr title="Source: CollecTor | File: vote | Value: w Measured=X | Threshold: flag-thresholds guard-bw-inc-exits=X">
        <td>Guard BW</td>
        <td>{{ rv.measured_bw_display }}</td>
        <td>{{ rv.guard_bw_range }} (varies)</td>
        <td>
            {% if rv.guard_bw_meets_all %}
                <span style="color: #28a745; font-weight: bold;">MEETS - all authorities</span>
            {% elif rv.guard_bw_meets_some %}
                <span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ rv.guard_bw_meets_count }}/{{ rv.total_authorities }} authorities</span>
            {% else %}
                <span style="color: #dc3545; font-weight: bold;">BELOW - no authorities</span>
            {% endif %}
        </td>
    </tr>
    <tr title="Source: CollecTor | File: vote | Value: stats tk=X | Threshold: flag-thresholds stable-uptime=X">
        <td>Stable Uptime</td>
        <td>{{ rv.tk_display }}</td>
        <td>{{ rv.stable_range }} (varies)</td>
        <td>
            {% if rv.stable_meets_all %}
                <span style="color: #28a745; font-weight: bold;">MEETS - all authorities</span>
            {% else %}
                <span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ rv.stable_meets_count }}/{{ rv.total_authorities }}</span>
            {% endif %}
        </td>
    </tr>
    <tr title="Source: CollecTor | File: vote | Value: w Measured=X | Threshold: flag-thresholds fast-speed=X">
        <td>Fast Speed</td>
        <td>{{ rv.fast_speed_display }}</td>
        <td>{{ rv.fast_range }} (varies)</td>
        <td>
            {% if rv.fast_meets_all %}
                <span style="color: #28a745; font-weight: bold;">MEETS - all authorities</span>
            {% else %}
                <span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ rv.fast_meets_count }}/{{ rv.total_authorities }}</span>
            {% endif %}
        </td>
    </tr>
    <tr title="Source: CollecTor | File: vote | Threshold: flag-thresholds hsdir-wfu=X (typically 98%)">
        <td>HSDir WFU</td>
        <td>{{ rv.wfu_display }}</td>
        <td>‚â•{{ "%.1f"|format(rv.hsdir_wfu_threshold * 100) }}% (from all auths)</td>
        <td>
            {% if rv.hsdir_wfu_meets %}
                <span style="color: #28a745; font-weight: bold;">MEETS</span>
            {% else %}
                <span style="color: #dc3545; font-weight: bold;">BELOW - cannot get HSDir</span>
            {% endif %}
        </td>
    </tr>
    <tr title="Source: CollecTor | File: vote | Threshold: flag-thresholds hsdir-tk=X (~10 days)">
        <td>HSDir TK</td>
        <td>{{ rv.tk_display }}</td>
        <td>‚â•{{ "%.1f"|format(rv.hsdir_tk_threshold / 86400) }} days (from all auths)</td>
        <td>
            {% if rv.hsdir_tk_meets %}
                <span style="color: #28a745; font-weight: bold;">MEETS</span>
            {% else %}
                <span style="color: #dc3545; font-weight: bold;">BELOW - need {{ "%.1f"|format(rv.hsdir_tk_days_needed) }} more days</span>
            {% endif %}
        </td>
    </tr>
    <tr title="Source: CollecTor | File: vote | Has 'r' entry = IPv4 reachable">
        <td>IPv4 Reachable</td>
        <td>{{ rv.ipv4_reachable_count }}/{{ rv.total_authorities }} authorities</td>
        <td>‚â•{{ diag.majority_required }}/{{ diag.total_authorities }} (majority)</td>
        <td>
            {% if rv.ipv4_reachable_count >= diag.majority_required %}
                <span style="color: #28a745; font-weight: bold;">REACHABLE</span>
            {% else %}
                <span style="color: #dc3545; font-weight: bold;">NOT REACHABLE</span>
            {% endif %}
        </td>
    </tr>
    <tr title="Source: CollecTor | File: vote | Has 'a' line = IPv6 reachable | Some authorities don't test IPv6">
        <td>IPv6 Reachable</td>
        <td>{{ rv.ipv6_reachable_count }}/{{ rv.ipv6_tested_count }} tested</td>
        <td>‚â•majority of testers</td>
        <td>
            {% if rv.ipv6_tested_count == 0 %}
                <span style="color: #6c757d; font-weight: bold;">NOT TESTED</span>
            {% elif rv.ipv6_reachable_count >= (rv.ipv6_tested_count // 2 + 1) %}
                <span style="color: #28a745; font-weight: bold;">REACHABLE</span>
            {% elif rv.ipv6_reachable_count > 0 %}
                <span style="color: #ffc107; font-weight: bold;">PARTIAL</span>
            {% else %}
                <span style="color: #dc3545; font-weight: bold;">NOT REACHABLE</span>
            {% endif %}
        </td>
    </tr>
</tbody>
</table>
</div>
{% endif %}

{# Actionable advice based on issues #}
{% if diag.advice %}
<div style="background: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 6px; padding: 15px; margin: 20px 0;">
    <strong>üí° Advice:</strong>
    <ul style="margin: 5px 0 0 0; padding-left: 20px;">
    {% for advice_item in diag.advice %}
        <li>{{ advice_item }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}

{# ============== TABLE 2: PER-AUTHORITY DETAILS (Diagnosis) ============== #}
<h4 id="authority-votes">
<div class="section-header">
<a href="#authority-votes" class="anchor-link">Per-Authority Details</a>
</div>
</h4>
<p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">
Detailed breakdown showing what EACH authority sees. Use to diagnose specific issues.
Text color: <span style="color: #28a745;">green</span> = meets threshold, 
<span style="color: #dc3545;">red</span> = below threshold,
<span style="color: #6c757d;">gray</span> = not tested/not applicable.
</p>
<div style="overflow-x: auto;">
<table class="table table-condensed table-striped" style="font-size: 11px;">
<thead>
<tr>
    <th title="Source: Onionoo | File: details | Field: nickname, fingerprint">Authority</th>
    <th title="Source: CollecTor | File: vote | Relay reachable via IPv4 (has 'r' entry)">IPv4</th>
    <th title="Source: CollecTor | File: vote | Field: 'a' line | N/T = authority doesn't test IPv6">IPv6</th>
    <th title="Source: CollecTor | File: vote | Field: 's' line (ALL flags)">Flags</th>
    <th title="Source: CollecTor | File: vote | Field: w Measured=X | N/A = no bandwidth-file-headers">Meas. BW</th>
    <th title="Source: CollecTor | File: vote | Your: stats wfu=X | Threshold: guard-wfu=X, hsdir-wfu=X">WFU</th>
    <th title="Source: CollecTor | File: vote | Your: stats tk=X | Threshold: guard-tk=X">TK</th>
    <th title="Source: CollecTor | File: vote | Threshold: guard-bw-inc-exits=X (varies by authority)">Guard BW</th>
    <th title="Source: CollecTor | File: vote | Threshold: stable-uptime=X, stable-mtbf=X">Stable</th>
    <th title="Source: CollecTor | File: vote | Threshold: fast-speed=X (varies by authority)">Fast</th>
    <th title="Source: CollecTor | File: vote | Threshold: hsdir-tk=X (~10 days), requires hsdir-wfu">HSDir TK</th>
</tr>
</thead>
<tbody>
{% for vote in diag.authority_table %}
<tr class="{% if not vote.voted %}row-not-voted{% endif %}">
    <td><strong>{{ vote.authority }}</strong>{% if vote.is_bw_authority %} <span title="Runs bandwidth scanner">üìä</span>{% endif %}</td>
    <td>
        {% if vote.ipv4_reachable %}
            <span style="color: #28a745;">Yes</span>
        {% else %}
            <span style="color: #dc3545;">No</span>
        {% endif %}
    </td>
    <td>
        {% if vote.ipv6_reachable == true %}
            <span style="color: #28a745;">Yes</span>
        {% elif vote.ipv6_reachable == false %}
            <span style="color: #dc3545;">No</span>
        {% else %}
            <span style="color: #6c757d;" title="This authority doesn't test IPv6">N/T</span>
        {% endif %}
    </td>
    <td style="max-width: 150px; word-wrap: break-word; font-size: 10px;">
        {% if vote.flags %}
            {{ vote.flags_display }}
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    <td>
        {% if vote.is_bw_authority %}
            {% if vote.measured is not none %}
                {{ vote.measured_display }}
            {% else %}
                <span style="color: #6c757d;">‚Äî</span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;" title="Does not run bandwidth scanner">N/A</span>
        {% endif %}
    </td>
    <td>
        {% if vote.voted and vote.wfu is not none %}
            <span style="color: {% if vote.wfu_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Threshold: ‚â•{{ "%.1f"|format(vote.guard_wfu_threshold * 100) }}%">
                {{ vote.wfu_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    <td>
        {% if vote.voted and vote.tk is not none %}
            <span style="color: {% if vote.tk_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Threshold: ‚â•{{ "%.1f"|format(vote.guard_tk_threshold / 86400) }} days">
                {{ vote.tk_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    <td>
        {% if vote.voted and vote.guard_bw_threshold %}
            <span style="color: {% if vote.guard_bw_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your BW: {{ rv.measured_bw_display if rv else 'N/A' }}">
                ‚â•{{ vote.guard_bw_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    <td>
        {% if vote.voted and vote.stable_threshold %}
            <span style="color: {% if vote.stable_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your uptime: {{ rv.tk_display if rv else 'N/A' }}">
                ‚â•{{ vote.stable_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    <td>
        {% if vote.voted and vote.fast_threshold %}
            <span style="color: {% if vote.fast_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your speed: {{ rv.fast_speed_display if rv else 'N/A' }}">
                ‚â•{{ vote.fast_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    <td>
        {% if vote.voted and vote.hsdir_tk_threshold %}
            <span style="color: {% if vote.hsdir_tk_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your TK: {{ rv.tk_display if rv else 'N/A' }} | HSDir WFU: {{ "%.1f"|format(vote.hsdir_wfu_threshold * 100) }}%">
                ‚â•{{ vote.hsdir_tk_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<p style="font-size: 11px; color: #666; margin-top: 5px;">
N/T = authority doesn't test IPv6 ‚Ä¢ 
N/A = authority doesn't run bandwidth scanner ‚Ä¢
üìä = runs bandwidth scanner
</p>

{# Flag Eligibility Summary #}
<h4 id="flag-eligibility" style="margin-top: 20px;">
<div class="section-header">
<a href="#flag-eligibility" class="anchor-link">Flag Eligibility Summary</a>
</div>
</h4>
<p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">
Shows eligibility for major flags based on each authority's thresholds. Need majority ({{ diag.majority_required }}/{{ diag.total_authorities }}) for flag assignment.
</p>
<div class="row">
{% for flag_name, flag_data in diag.flag_summary.items() %}
<div class="col-md-3 col-sm-6" style="margin-bottom: 15px;">
    <div style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; text-align: center;
                background: {% if flag_data.status_class == 'success' %}#d4edda{% elif flag_data.status_class == 'danger' %}#f8d7da{% else %}#fff3cd{% endif %};">
        <strong style="text-transform: capitalize;">{{ flag_name }}</strong><br>
        <span style="font-size: 18px; font-weight: bold;
                     color: {% if flag_data.status_class == 'success' %}#155724{% elif flag_data.status_class == 'danger' %}#721c24{% else %}#856404{% endif %};">
            {{ flag_data.eligible_count }}/{{ flag_data.total_authorities }}
        </span><br>
        <small>{{ flag_data.display }}</small>
    </div>
</div>
{% endfor %}
</div>

{# Reachability Summary #}
{% if diag.reachability_summary %}
<h4 id="reachability" style="margin-top: 20px;">
<div class="section-header">
<a href="#reachability" class="anchor-link">Reachability Summary</a>
</div>
</h4>
<div class="row">
<div class="col-md-6">
    <div style="border: 1px solid #ddd; border-radius: 6px; padding: 15px;
                background: {% if diag.reachability_summary.ipv4.status_class == 'success' %}#d4edda{% else %}#f8d7da{% endif %};">
        <strong>IPv4 Reachability</strong><br>
        <span style="font-size: 24px; font-weight: bold;">
            {{ diag.reachability_summary.ipv4.reachable_count }}/{{ diag.reachability_summary.ipv4.total }}
        </span><br>
        <small>{{ diag.reachability_summary.ipv4.display }}</small>
    </div>
</div>
<div class="col-md-6">
    <div style="border: 1px solid #ddd; border-radius: 6px; padding: 15px;
                background: {% if diag.reachability_summary.ipv6.status_class == 'success' %}#d4edda{% elif diag.reachability_summary.ipv6.status_class == 'muted' %}#f0f0f0{% else %}#f8d7da{% endif %};">
        <strong>IPv6 Reachability</strong><br>
        <span style="font-size: 24px; font-weight: bold;">
            {{ diag.reachability_summary.ipv6.reachable_count }}/{{ diag.reachability_summary.ipv6.total }}
        </span><br>
        <small>{{ diag.reachability_summary.ipv6.display }}</small>
        {% if diag.reachability_summary.ipv6.not_tested %}
        <br><small style="color: #6c757d;">Not tested by: {{ diag.reachability_summary.ipv6.not_tested|join(', ') }}</small>
        {% endif %}
    </div>
</div>
</div>
{% endif %}

{# Bandwidth Summary #}
{% if diag.bandwidth_summary and diag.bandwidth_summary.average is not none %}
<h4 id="bandwidth-measurements" style="margin-top: 20px;">
<div class="section-header">
<a href="#bandwidth-measurements" class="anchor-link">Bandwidth Measurements</a>
</div>
</h4>
<div style="border: 1px solid #ddd; border-radius: 6px; padding: 15px; background: #f8f9fa;">
    <div class="row">
        <div class="col-md-3 col-sm-6 text-center">
            <small>Average</small><br>
            <strong style="font-size: 18px;">{{ diag.bandwidth_summary.average_display }}</strong>
        </div>
        <div class="col-md-3 col-sm-6 text-center">
            <small>Minimum</small><br>
            <strong style="font-size: 18px;">{{ diag.bandwidth_summary.min_display }}</strong>
        </div>
        <div class="col-md-3 col-sm-6 text-center">
            <small>Maximum</small><br>
            <strong style="font-size: 18px;">{{ diag.bandwidth_summary.max_display }}</strong>
        </div>
        <div class="col-md-3 col-sm-6 text-center">
            <small>Measurements</small><br>
            <strong style="font-size: 18px;">{{ diag.bandwidth_summary.measurement_count }}</strong>
        </div>
    </div>
    {% if diag.bandwidth_summary.deviation_class == 'warning' %}
    <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 4px;">
        <small>‚ö†Ô∏è High deviation between measurements ({{ diag.bandwidth_summary.deviation_display }}). Different authorities may see different bandwidth.</small>
    </div>
    {% endif %}
</div>
{% endif %}

{# Legend #}
<div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 6px; font-size: 12px;">
    <strong>Legend:</strong>
    <ul style="margin: 5px 0 0 0; padding-left: 20px;">
        <li><strong>WFU (Weighted Fractional Uptime):</strong> Must be ‚â•98% for Guard and HSDir flags. <span style="color: #28a745;">Green</span> = meets threshold, <span style="color: #dc3545;">Red</span> = below threshold.</li>
        <li><strong>Time Known (TK):</strong> How long the authority has tracked this relay. Must be ‚â•8 days for Guard flag, ~10 days for HSDir.</li>
        <li><strong>Guard BW:</strong> Minimum bandwidth to be considered for Guard flag. Varies by authority.</li>
        <li><strong>Stable:</strong> Minimum uptime to get Stable flag. Varies by authority.</li>
        <li><strong>Fast:</strong> Minimum speed to get Fast flag. Varies by authority.</li>
        <li><strong>N/T:</strong> Not Tested - authority doesn't test this (e.g., some don't test IPv6).</li>
        <li><strong>N/A:</strong> Not Applicable - authority doesn't provide this data (e.g., non-BW authorities don't measure bandwidth).</li>
        <li><strong>üìä:</strong> Authority runs a bandwidth scanner and provides measured bandwidth values.</li>
    </ul>
</div>

<p style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
    <strong>Note:</strong> Each authority calculates thresholds based on the relays it observes.
    WFU (98% for Guard/HSDir) and Time Known (8 days for Guard, ~10 days for HSDir) are typically constant,
    but bandwidth-related thresholds (Guard BW, Stable, Fast) vary significantly across authorities.
    All threshold values are pulled dynamically from the flag-thresholds line in each authority's vote file.
</p>

</div>
</div>
{% endif %}

</div>
{% endblock -%}
