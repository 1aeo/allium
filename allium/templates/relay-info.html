{% extends "skeleton.html" -%}
{% from "macros.html" import navigation %}
{% block title -%}
	Tor Relays :: {{ relay['nickname']|escape }}
{% endblock -%}
{% block body -%}
<style>
.section-header {
    position: relative;
    display: inline-block;
}

.anchor-link {
    text-decoration: none;
    color: inherit;
}







/* Highlight section when targeted */
:target {
    background-color: rgba(255, 193, 7, 0.2);
    padding: 8px;
    border-radius: 4px;
    margin: -8px;
    transition: background-color 0.3s;
}


</style>
<div id="content">
<h2>View Relay "{{ relay['nickname'] }}"</h2>
{% set relay_data = {'nickname': relay['nickname'], 'fingerprint': relay['fingerprint'], 'as_number': relay['as']} %}
{{ navigation('all', page_ctx) }}
<h4>
{% if relay['effective_family']|length > 1 -%}
<a href="{{ page_ctx.path_prefix }}family/{{ relay['fingerprint']|escape }}/">Family: {{ relay['effective_family']|length }} relays</a>
{% else -%}
Family: {{ relay['effective_family']|length }} relay
{% endif -%} | 
{% if relay['as'] -%}
<a href="{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/">{{ relay['as']|escape }}</a>
{% else -%}
AS: unknown
{% endif -%} | 
{% if relay['country'] -%}
<a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">{{ relay['country_name']|escape }}</a>
{% else -%}
Country: unknown
{% endif -%} | 
<a href="{{ page_ctx.path_prefix }}platform/{{ relay['platform']|escape }}/">{{ relay['platform']|escape }}</a>
</h4>
<p>Last fetch was at {{ relays.timestamp }}.</p>
<div class="row">
<div class="col-md-6">
<dl>
<dt>
Nickname
</dt>
<dd>
{{ relay['nickname']|escape }}
</dd>

<dt>
Fingerprint
</dt>
<dd>
<code>{{ relay['fingerprint']|escape }}</code>
</dd>

<dt>
AROI <a href="https://nusenu.github.io/ContactInfo-Information-Sharing-Specification/" target="_blank" title="Autonomous Relay Operator Identifier - unverified">(?)</a>
</dt>
{% if relay['aroi_domain'] and relay['aroi_domain'] != 'none' -%}
<dd>
{% if base_url and relay['aroi_domain'] in validated_aroi_domains -%}
<a href="{{ base_url }}/{{ relay['aroi_domain']|lower|escape }}/">{{ relay['aroi_domain']|escape }}</a>
{% else -%}
<a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/">{{ relay['aroi_domain']|escape }}</a>
{% endif -%}
</dd>
{% else -%}
<dd>
none
</dd>
{% endif -%}
<dt>
Contact
</dt>
{% if relay['contact'] -%}
<dd style="word-wrap: break-word; word-break: break-all; max-width: 100%; overflow-wrap: break-word;">
<a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/" style="word-wrap: break-word; word-break: break-all; overflow-wrap: break-word;">{{
relay['contact']|escape }}</a>
</dd>
{% else -%}
<dd>
<a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}">none</a>
</dd>
{% endif -%}
<dt id="ipv4-exit-policy-summary">
<div class="section-header">
<a href="#ipv4-exit-policy-summary" class="anchor-link">IPv4 Exit Policy Summary</a>
</div>
</dt>
<dd>
{% if relay['exit_policy_summary'] -%}
{%- set v4_summary = relay['exit_policy_summary'].items() -%}
<pre class="pre-scrollable">{% for k, v in v4_summary -%}
{{ k|escape }}: {{ '\n  ' + v|join('\n  ')|escape }}
{% endfor -%}
</pre>
{% else -%}
<pre>none</pre>
{% endif -%}
</dd>
<dt id="ipv6-exit-policy-summary">
<div class="section-header">
<a href="#ipv6-exit-policy-summary" class="anchor-link">IPv6 Exit Policy Summary</a>
</div>
</dt>
<dd>
{% if relay['exit_policy_v6_summary'] -%}
{%- set v6_summary = relay['exit_policy_v6_summary'].items() -%}
<pre class="pre-scrollable">{% for k, v in v6_summary -%}
{{ k|escape }}: {{ '\n  ' + v|join('\n  ')|escape }}
{% endfor -%}
</pre>
{% else -%}
<pre>none</pre>
{% endif -%}
</dd>
<dt id="exit-policy">
<div class="section-header">
<a href="#exit-policy" class="anchor-link">Exit Policy</a>
</div>
</dt>
<dd>
<pre class="pre-scrollable">{% for policy in relay['exit_policy'] -%}
{{ policy|escape }}
{% endfor -%}
</pre>
</dd>
{% if relay['effective_family']|length > 1 -%}
<dt id="effective-family" title="Array of fingerprints of relays that are in an effective, mutual family relationship with this relay. These relays are part of this relay's family and they consider this relay to be part of their family. Always contains the relay's own fingerprint. Omitted if the descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#effective-family" class="anchor-link">Effective Family Members: {{ relay['effective_family']|length }}</a> (<a href="{{ page_ctx.path_prefix }}family/{{ relay['fingerprint']|escape }}/">View</a>)
</div>
</dt>
{% else -%}
<dt id="effective-family" title="Array of fingerprints of relays that are in an effective, mutual family relationship with this relay. These relays are part of this relay's family and they consider this relay to be part of their family. Always contains the relay's own fingerprint. Omitted if the descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#effective-family" class="anchor-link">Effective Family Member: {{ relay['effective_family']|length }}</a>
</div>
</dt>
{% endif -%}
<dd>
<pre class="pre-scrollable">{% for e_relay in relay['effective_family'] -%}
{% if relay['effective_family']|length > 1 -%}
<a href="../{{ e_relay|escape }}/">{{ e_relay|escape }}</a>
{% else -%}
{{ e_relay|escape }}
{% endif -%}
{% endfor -%}
</pre>
</dd>
<dt id="alleged-family" title="Array of fingerprints of relays that are not in an effective, mutual family relationship with this relay. These relays are part of this relay's family but they don't consider this relay to be part of their family. Omitted if empty or if descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#alleged-family" class="anchor-link">Alleged Family {% if relay['alleged_family'] and relay['alleged_family']|length == 1 -%}Member{% else -%}Members{% endif -%}: {% if relay['alleged_family'] -%}{{ relay['alleged_family']|length }}{% else -%}0{% endif -%}</a>
</div>
</dt>
<dd>
{% if relay['alleged_family'] -%}
<pre class="pre-scrollable">{% for a_relay in relay['alleged_family'] -%}
{% if relay['alleged_family']|length > 1 -%}
<a href="../{{ a_relay|escape }}/">{{ a_relay|escape }}</a>
{% else -%}
{{ a_relay|escape }}
{% endif -%}
{% endfor -%}
{% else -%}
<pre class="pre-scrollable">none
{% endif -%}
</pre>
</dd>
<dt id="indirect-family" title="Array of fingerprints of relays that consider this relay to be part of their family but that are not part of this relay's family. Omitted if empty or if descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#indirect-family" class="anchor-link">Indirect Family {% if relay['indirect_family'] and relay['indirect_family']|length == 1 -%}Member{% else -%}Members{% endif -%}: {% if relay['indirect_family'] -%}{{ relay['indirect_family']|length }}{% else -%}0{% endif -%}</a>
</div>
</dt>
<dd>
{% if relay['indirect_family'] -%}
<pre class="pre-scrollable">{% for i_relay in relay['indirect_family'] -%}
{% if relay['indirect_family']|length > 1 -%}
<a href="../{{ i_relay|escape }}/">{{ i_relay|escape }}</a>
{% else -%}
{{ i_relay|escape }}
{% endif -%}
{% endfor -%}
{% else -%}
<pre class="pre-scrollable">none
{% endif -%}
</pre>
</dd>
</dl>
</div>
<div class="col-md-6">
<dl>
<dt title="Bandwidth capacity details: Observed capacity | Advertised capability | Rate limit | Burst limit">
Bandwidth Capacity (Observed | Advertised | Rate Limit | Burst Limit)
</dt>
    {% set obs_unit = relay['observed_bandwidth']|determine_unit(relays.use_bits) -%}
    {% set obs_bandwidth = relay['observed_bandwidth']|format_bandwidth_with_unit(obs_unit) -%}
<dd>
<span title="Observed: {{ obs_bandwidth }} {{ obs_unit }}">{{ obs_bandwidth }} {{ obs_unit }}</span> | 
{% if relay['advertised_bandwidth'] -%}{% set adv_unit = relay['advertised_bandwidth']|determine_unit(relays.use_bits) -%}{% set adv_bandwidth = relay['advertised_bandwidth']|format_bandwidth_with_unit(adv_unit) -%}<span title="Advertised: {{ adv_bandwidth }} {{ adv_unit }}">{{ adv_bandwidth }} {{ adv_unit }}</span>{% else -%}<span title="Advertised: unknown">unknown</span>{% endif -%} | 
{% if relay['bandwidth_rate'] -%}{% set rate_unit = relay['bandwidth_rate']|determine_unit(relays.use_bits) -%}{% set rate_bandwidth = relay['bandwidth_rate']|format_bandwidth_with_unit(rate_unit) -%}<span title="Rate: {{ rate_bandwidth }} {{ rate_unit }}">{{ rate_bandwidth }} {{ rate_unit }}</span>{% else -%}<span title="Rate: unknown">unknown</span>{% endif -%} | 
{% if relay['bandwidth_burst'] -%}{% set burst_unit = relay['bandwidth_burst']|determine_unit(relays.use_bits) -%}{% set burst_bandwidth = relay['bandwidth_burst']|format_bandwidth_with_unit(burst_unit) -%}<span title="Burst: {{ burst_bandwidth }} {{ burst_unit }}">{{ burst_bandwidth }} {{ burst_unit }}</span>{% else -%}<span title="Burst: unknown">unknown</span>{% endif -%}
{% if relay['measured'] is not none -%}
    {% if relay['measured'] -%}
        &nbsp;&nbsp;<span style="color: #28a745; font-weight: bold;" title="Bandwidth capacity measured by ‚â•3 bandwidth authorities">‚úì</span>
    {% else -%}
        &nbsp;&nbsp;<span style="color: #dc3545; font-weight: bold;" title="Bandwidth capacity not measured by ‚â•3 bandwidth authorities">‚úó</span>
    {% endif -%}
{% else -%}
    &nbsp;&nbsp;<span style="color: #6c757d;" title="Bandwidth capacity measurement status unknown">?</span>
{% endif -%}
</dd>

<dt>
Network Participation (Consensus Weight | Guard | Middle | Exit)
</dt>
<dd>
<span title="Fraction of this relay's consensus weight compared to the sum of all consensus weights in the network. This fraction is a very rough approximation of the probability of this relay to be selected by clients.">{% if relay['consensus_weight_fraction'] -%}{{ "%.2f"|format(relay['consensus_weight_fraction'] * 100) }}%{% else -%}N/A{% endif -%}</span> | 
<span title="Probability of this relay to be selected for the guard position. This probability is calculated based on consensus weights, relay flags, and bandwidth weights in the consensus. Path selection depends on more factors, so that this probability can only be an approximation.">{% if relay['guard_probability'] -%}{{ "%.2f"|format(relay['guard_probability'] * 100) }}%{% else -%}N/A{% endif -%}</span> | 
<span title="Probability of this relay to be selected for the middle position. This probability is calculated based on consensus weights, relay flags, and bandwidth weights in the consensus. Path selection depends on more factors, so that this probability can only be an approximation.">{% if relay['middle_probability'] -%}{{ "%.2f"|format(relay['middle_probability'] * 100) }}%{% else -%}N/A{% endif -%}</span> | 
<span title="Probability of this relay to be selected for the exit position. This probability is calculated based on consensus weights, relay flags, and bandwidth weights in the consensus. Path selection depends on more factors, so that this probability can only be an approximation.">{% if relay['exit_probability'] -%}{{ "%.2f"|format(relay['exit_probability'] * 100) }}%{% else -%}N/A{% endif -%}</span>
{% if relay['fingerprint'] in relays.json.smart_context.performance_correlation.template_optimized.underutilized_fingerprints %}
<br><small class="text-warning">‚ö†Ô∏è Underutilized: High bandwidth capacity but low consensus weight</small>
{% endif %}
</dd>

<dt title="IP address and TCP port where this relay accepts onion-routing connections, with hostname when available">
OR Address
</dt>
<dd>
{% if relay['verified_host_names'] -%}
{% for hostname in relay['verified_host_names'] -%}
<span class="verified-hostname" title="verified hostname">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
{% endfor %} | {% for address in relay['or_addresses'] -%}{{ address }}{% if not loop.last %}, {% endif %}{% endfor -%}
{% elif relay['unverified_host_names'] -%}
{% for hostname in relay['unverified_host_names'] -%}
<span class="unverified-hostname" title="unverified hostname">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
{% endfor %} | {% for address in relay['or_addresses'] -%}{{ address }}{% if not loop.last %}, {% endif %}{% endfor -%}
{% else -%}
{% for address in relay['or_addresses'] -%}{{ address }}{% if not loop.last %}, {% endif %}{% endfor -%}
{% endif -%}
</dd>
<dt>
Exit Address
</dt>
{% if relay['exit_address'] -%}
<dd>
{{ relay['exit_address']|escape }}
</dd>
{% else -%}
<dd>
none
</dd>
{% endif -%}
<dt>
Dir Address
</dt>
{% if relay['dir_address'] -%}
<dd>
<a href="http://{{ relay['dir_address']|escape }}">{{
relay['dir_address']|escape }}</a>
</dd>
{% else -%}
<dd>
none
</dd>
{% endif -%}

<dt>
{% if relay['city_name'] or relay['region_name'] -%}City | Region | Country{% else -%}Country{% endif -%}
</dt>
<dd>
{% if relay['city_name'] -%}
<span title="City name of the location of this relay as found by a geolocation database. Omitted if the relay location could not be found or if the database does not contain city information.">{{ relay['city_name']|escape }}</span>
{% endif -%}
{% if relay['city_name'] and relay['region_name'] -%} | {% endif -%}
{% if relay['region_name'] -%}
<span title="Region name of the location of this relay as found by a geolocation database. Omitted if the relay location could not be found or if the database does not contain region information.">{{ relay['region_name']|escape }}</span>
{% endif -%}
{% if (relay['city_name'] or relay['region_name']) and relay['country'] -%} | {% endif -%}
{% if relay['country'] -%}
<a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">
<img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relay['country']|lower|escape }}.png"
title="{{ relay['country_name']|escape }}"
alt="{{ relay['country_name']|escape }}">
</a> <span title="Country name of the location of this relay as found by a geolocation database based on the relay's IP address. Omitted if the relay location could not be found.">{{ relay['country_name']|escape }}</span>
{% else -%}
unknown
{% endif -%}
</dd>
{% if relay['latitude'] and relay['longitude'] and relay['latitude'] != 0 and relay['longitude'] != 0 -%}
<dt>
Latitude, Longitude
</dt>
<dd>
<span title="Latitude of the location of this relay as found by a geolocation database based on the relay's IP address. Omitted if the relay location could not be found.">{{ relay['latitude']|escape }}</span>, 
<span title="Longitude of the location of this relay as found by a geolocation database based on the relay's IP address. Omitted if the relay location could not be found.">{{ relay['longitude']|escape }}</span>
</dd>
{% endif -%}
<dt>
Interactive Map
</dt>
<dd>
<a href="https://routefluxmap.1aeo.com/#relay={{ relay['fingerprint']|escape }}" target="_blank" rel="noopener" title="View this relay on RouteFluxMap interactive visualization">üó∫Ô∏è View on Interactive Map</a>
</dd>
<dt>
Autonomous System (AS Number | AS Name)
</dt>
<dd>
{% if relay['as'] -%}
<a href='{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/' title="AS Number">{{ relay['as']|escape }}</a>
{% else -%}
<span title="AS Number">unknown</span>
{% endif -%} | {% if relay['as_name'] -%}
<span title="AS Name">{{ relay['as_name']|escape }}</span> (<a href='https://bgp.tools/{{ relay['as']|escape }}'>BGP.tools</a>)
{% else -%}
<span title="AS Name">unknown</span>
{% endif -%}
</dd>

<dt>
Flags: {{ relay['flags']|reject('equalto', 'StaleDesc')|list|length }}
</dt>
<dd>
{% for flag in relay['flags'] -%}
{% if flag != 'StaleDesc' -%}
<a href="{{ page_ctx.path_prefix }}flag/{{ flag.lower()|escape }}/">
<img src="{{ page_ctx.path_prefix }}static/images/flags/{{ flag.lower()|escape }}.png"
title="{{ flag|escape }}"
alt="{{ flag|escape }}">
</a> {{ flag|escape }}
{% endif -%}
{% endfor -%}
</dd>

<dt title="Flag-specific uptime percentages showing the reliability of this relay when operating in its primary network role. Priority: Exit > Guard > Fast > Running flags.">
Flag Uptime (1M/6M/1Y/5Y)
</dt>
<dd>
{% if relay.get('flag_uptime_display') and relay['flag_uptime_display'] != 'N/A' -%}
    {% if relay['flag_uptime_display'] == 'Match' -%}
        <span title="{{ relay['flag_uptime_tooltip']|escape }}">Match Overall Uptime ({{ relay['uptime_api_display']|safe }})</span>
    {% else -%}
        <span title="{{ relay['flag_uptime_tooltip']|escape }}">{{ relay['flag_uptime_display']|safe }}</span>
    {% endif -%}
{% else -%}
N/A
{% endif -%}
</dd>
<dt title="{% if contact_display_data and contact_display_data.outliers and contact_display_data.outliers.tooltip %}{{ contact_display_data.outliers.tooltip }}{% else %}Statistical outliers: ‚â•2œÉ from average{% endif %}">
Uptime (1M/6M/1Y/5Y)
</dt>
<dd>
{% if relay.get('uptime_api_display') -%}
    {{ relay['uptime_api_display']|safe }}
{% else -%}
    N/A
{% endif -%}
</dd>
<dt>
Uptime / Downtime
</dt>
<dd>
{% if relay.get('uptime_display') -%}
    {% if relay['uptime_display'].startswith('DOWN') -%}
        <span style="color: #dc3545;">{{ relay['uptime_display']|escape }}</span>
    {% else -%}
        {{ relay['uptime_display']|escape }}
    {% endif -%}
{% else -%}
    N/A
{% endif -%}
</dd>
<dt>
Seen (First | Last)
</dt>
<dd>
<a href="{{ page_ctx.path_prefix }}first_seen/{{ relay['first_seen'].split(' ', 1)[0]|escape }}/">{{ relay['first_seen']|format_time_ago }} ({{ relay['first_seen']|escape }})</a> | {{ relay['last_seen']|format_time_ago }} ({{ relay['last_seen']|escape }})
</dd>
<dt title="UTC timestamp when this relay was last (re-)started. Missing if router descriptor containing this information cannot be found.">
Last Restarted
</dt>
<dd>
{% if relay['last_restarted'] -%}
{{ relay['last_restarted']|format_time_ago }} ({{ relay['last_restarted']|escape }})
{% else -%}
unknown
{% endif -%}
</dd>
<dt title="UTC timestamp when this relay last stopped announcing an IPv4 or IPv6 address or TCP port where it previously accepted onion-routing or directory connections. This timestamp can serve as indicator whether this relay would be a suitable fallback directory.">
Last Changed Address or Port
</dt>
<dd>
{% if relay['last_changed_address_or_port'] -%}
{{ relay['last_changed_address_or_port']|escape }}
{% else -%}
unknown
{% endif -%}
</dd>
<dt title="Boolean field saying whether this relay indicated that it is hibernating in its last known server descriptor. This information may be helpful to decide whether a relay that is not running anymore has reached its accounting limit and has not dropped out due to a technical problem. Omitted if the last known server descriptor of this relay does not contain hibernation information or if no such descriptor is known.">
Hibernating
</dt>
<dd>
{% if relay['hibernating'] is not none -%}
{% if relay['hibernating'] -%}Yes{% else -%}No{% endif -%}
{% else -%}
unknown
{% endif -%}
</dd>
<dt>
Platform (Short | Long)
</dt>
<dd>
<a href='{{ page_ctx.path_prefix }}platform/{{ relay['platform']|escape }}/' title="Simplified platform identifier for categorization">{{ relay['platform']|escape }}</a> | <span title="Complete platform information as reported by relay">{% if relay['platform_raw'] -%}{{ relay['platform_raw']|escape }}{% else -%}{{ relay['platform']|escape }}{% endif -%}</span>
</dd>
<dt>
Version (Running | Recommended | Status)
</dt>
<dd>
<span title="Tor software version without leading 'Tor' as reported by the directory authorities in the 'v' line of the consensus. Omitted if either the directory authorities or the relay did not report which version the relay runs or if the relay runs an alternative Tor implementation.">{% if relay['version'] -%}{{ relay['version']|escape }}{% else -%}unknown{% endif -%}</span> | 
<span title="Boolean field saying whether the Tor software version of this relay is recommended by the directory authorities or not. Uses the relay version in the consensus. Omitted if either the directory authorities did not recommend versions, or the relay did not report which version it runs.">{% if relay['recommended_version'] is not none -%}{% if relay['recommended_version'] -%}Yes{% else -%}No{% endif -%}{% else -%}unknown{% endif -%}</span> | 
<span title="Status of the Tor software version of this relay based on the versions recommended by the directory authorities. Possible version statuses are: 'recommended' if a version is listed as recommended; 'experimental' if a version is newer than every recommended version; 'obsolete' if a version is older than every recommended version; 'new in series' if a version has other recommended versions with the same first three components, and the version is newer than all such recommended versions, but it is not newer than every recommended version; 'unrecommended' if none of the above conditions hold. Omitted if either the directory authorities did not recommend versions, or the relay did not report which version it runs.">{% if relay['version_status'] -%}{{ relay['version_status']|escape }}{% else -%}unknown{% endif -%}</span>
</dd>
</dl>
</div>
</div>

{# Consensus Evaluation Section - Shows per-authority voting information #}
{% if relay.consensus_evaluation and relay.consensus_evaluation.available %}
{% set diag = relay.consensus_evaluation %}
{% set rv = diag.relay_values %}
<div class="row" style="margin-top: 20px;">
<div class="col-md-12">
<h3 id="consensus-evaluation">
<div class="section-header">
<a href="#consensus-evaluation" class="anchor-link">üîç Consensus Evaluation</a>
</div>
</h3>
<p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">
Data from <a href="https://collector.torproject.org/recent/relay-descriptors/votes/" target="_blank" rel="noopener">Tor CollecTor</a> (authority votes{% if relays.collector_fetched_at %}, fetched {{ relays.collector_fetched_at.replace('T', ' ').split('.')[0] }}{% endif %}).
</p>

{# Check if relay has IPv6 address - use namespace for proper scoping #}
{% set ns = namespace(has_ipv6=false) %}
{% for addr in relay.or_addresses|default([]) %}
    {% if '[' in addr %}{% set ns.has_ipv6 = true %}{% endif %}
{% endfor %}
{% set has_ipv6 = ns.has_ipv6 %}

{# Condensed Status, Flag Eligibility, Reachability, and Issues - all as bullets #}
<ul style="margin-bottom: 15px; padding-left: 20px; font-size: 13px;">
    {# 1. Consensus Status #}
    <li><strong>Consensus Status:</strong> 
        {% if diag.in_consensus %}
            <span style="color: #28a745; font-weight: bold;">In Consensus</span>
        {% else %}
            <span style="color: #dc3545; font-weight: bold;">Not In Consensus</span>
        {% endif %}
        ‚Äî {{ diag.vote_count }}/{{ diag.total_authorities }} authorities voted. Majority required: {{ diag.majority_required }}.
    </li>
    
    {# 2. Flag Eligibility (majority required: {{ diag.majority_required }}/{{ diag.total_authorities }}) #}
    <li><strong>Flag Eligibility</strong> <span style="color: #6c757d; font-size: 10px;">(need ‚â•{{ diag.majority_required }}/{{ diag.total_authorities }} for flag)</span>:
        {% for flag_name, flag_data in diag.flag_summary.items() %}
        <span style="color: {% if flag_data.status_class == 'success' %}#28a745{% elif flag_data.status_class == 'danger' %}#dc3545{% else %}#856404{% endif %}; font-weight: bold;">{{ flag_name|capitalize }}: {{ flag_data.eligible_count }}/{{ flag_data.total_authorities }}</span>{% if not loop.last %} | {% endif %}
        {% endfor %}
        | <span style="color: #28a745; font-weight: bold;">Running: {{ diag.vote_count }}/{{ diag.total_authorities }}</span>
        | <span style="color: #28a745; font-weight: bold;">Valid: {{ diag.vote_count }}/{{ diag.total_authorities }}</span>
        | <span style="color: #28a745; font-weight: bold;">V2Dir: {{ diag.vote_count }}/{{ diag.total_authorities }}</span>
    </li>
    
    {# 3. Reachability + Bandwidth #}
    {% if diag.reachability_summary %}
    <li><strong>Reachability:</strong>
        IPv4: <span style="color: {% if diag.reachability_summary.ipv4.status_class == 'success' %}#28a745{% else %}#dc3545{% endif %}; font-weight: bold;">{{ diag.reachability_summary.ipv4.reachable_count }}/{{ diag.reachability_summary.ipv4.total }}</span>
        {% if has_ipv6 %}
        | IPv6: <span style="color: {% if diag.reachability_summary.ipv6.status_class == 'success' %}#28a745{% elif diag.reachability_summary.ipv6.status_class == 'muted' %}#6c757d{% else %}#dc3545{% endif %}; font-weight: bold;">{{ diag.reachability_summary.ipv6.reachable_count }}/{{ diag.reachability_summary.ipv6.total }}</span>{% if diag.reachability_summary.ipv6.not_tested %} <span style="color: #6c757d;">({{ diag.reachability_summary.ipv6.not_tested|length }} don't test)</span>{% endif %}
        {% endif %}
        {% if diag.bandwidth_summary and diag.bandwidth_summary.median is not none %}
        | <strong>Cons. Weights:</strong> <span title="Tor consensus uses median of authority measurements for path selection. Min/Max show range of variation.">Median: {{ diag.bandwidth_summary.median_display }} | Min: {{ diag.bandwidth_summary.min_display }} | Max: {{ diag.bandwidth_summary.max_display }}</span>
        {% if diag.bandwidth_summary.deviation_class == 'warning' %}<span style="color: #856404;"> ‚ö†Ô∏è High deviation</span>{% endif %}
        {% endif %}
    </li>
    {% endif %}
    
    {# 4. Identified Issues #}
    {% set real_issues = diag.issues | selectattr('severity', 'ne', 'info') | list %}
    {% set info_notes = diag.issues | selectattr('severity', 'equalto', 'info') | list %}
    {% if real_issues or 'BadExit' in relay.flags %}
    <li><strong>Identified Issues:</strong>
        <ul style="margin: 3px 0; padding-left: 15px;">
        {% for issue in real_issues %}
            <li>
                <span style="color: {% if issue.severity == 'error' %}#dc3545{% else %}#856404{% endif %};">{{ issue.title }}</span>: {{ issue.description }}
                {% if issue.suggestion %}
                <ul style="margin: 2px 0; padding-left: 15px;"><li style="color: #666; font-size: 12px;">üí° {{ issue.suggestion }}</li></ul>
                {% endif %}
            </li>
        {% endfor %}
        {% if 'BadExit' in relay.flags %}
            <li><span style="color: #dc3545;">BadExit flag assigned</span>: This relay has been flagged as a bad exit. 
                <ul style="margin: 2px 0; padding-left: 15px;"><li style="color: #666; font-size: 12px;">üí° Contact the <a href="mailto:bad-relays@lists.torproject.org">bad-relays@lists.torproject.org</a> mailing list to understand and resolve this issue.</li></ul>
            </li>
        {% endif %}
        </ul>
    </li>
    {% endif %}
    {% if info_notes %}
    <li><strong>Notes:</strong>
        <ul style="margin: 3px 0; padding-left: 15px;">
        {% for note in info_notes %}
            <li><span style="color: #17a2b8;">{{ note.title }}</span>: {{ note.description }}</li>
        {% endfor %}
        </ul>
    </li>
    {% endif %}
</ul>

{# ============== TABLE 1: SUMMARY (Quick Answers) ============== #}
<h4 id="relay-summary" style="margin-top: 15px;">
<div class="section-header">
<a href="#relay-summary" class="anchor-link">Summary: Your Relay vs Consensus</a>
</div>
</h4>
<p class="text-muted" style="font-size: 11px; margin-bottom: 8px;">
<span style="color: #28a745;">Green</span> = meets threshold, <span style="color: #dc3545;">Red</span> = below threshold, <span style="color: #ffc107;">Yellow</span> = partial.
</p>
{% if rv %}
<div style="overflow-x: auto; overflow-y: visible; padding-top: 60px; margin-top: -50px;">
<table class="table table-condensed table-striped" style="font-size: 12px; table-layout: fixed;">
<colgroup>
    <col style="width: 18%;">
    <col style="width: 22%;">
    <col style="width: 28%;">
    <col style="width: 32%;">
</colgroup>
<thead>
<tr>
    <th style="text-align: left;">Metric</th>
    <th style="text-align: left;">Dir Auth Measured</th>
    <th style="text-align: left;">Dir Auth Threshold</th>
    <th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
    <tr>
        <td>In Consensus</td>
        <td>{{ diag.vote_count }}/{{ diag.total_authorities }} authorities</td>
        <td>‚â•{{ diag.majority_required }}/{{ diag.total_authorities }} (majority)</td>
        <td>{% if diag.in_consensus %}<span style="color: #28a745; font-weight: bold;">IN CONSENSUS</span>{% else %}<span style="color: #dc3545; font-weight: bold;">NOT IN CONSENSUS</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Running: Authority can connect to relay's OR port. When an authority votes for a relay, that relay is 'Running' from that authority's perspective.">Running (IPv4 Reachable)</td>
        <td>{{ diag.vote_count }}/{{ diag.total_authorities }} authorities reached this relay</td>
        <td>‚â•{{ diag.majority_required }}/{{ diag.total_authorities }} (majority)</td>
        <td>{% if diag.vote_count >= diag.majority_required %}<span style="color: #28a745; font-weight: bold;">RUNNING</span>{% else %}<span style="color: #dc3545; font-weight: bold;">NOT RUNNING</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Valid = Running + Not Blacklisted + Valid Descriptor. A relay is Valid when: 1) Authority can reach it (Running), 2) Identity key not on blacklist, 3) Descriptor is properly formatted and signed.">Valid</td>
        <td title="Valid = Running + Not Blacklisted + Valid Descriptor">{{ diag.vote_count }}/{{ diag.total_authorities }} (Running + Valid Descriptor)</td>
        <td>‚â•{{ diag.majority_required }}/{{ diag.total_authorities }} (majority)</td>
        <td>{% if diag.vote_count >= diag.majority_required %}<span style="color: #28a745; font-weight: bold;">VALID</span>{% else %}<span style="color: #dc3545; font-weight: bold;">NOT VALID</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Consensus weight is scaled for traffic distribution, not flag eligibility. Tor consensus uses median of all authority measurements.">Consensus Weight</td>
        <td title="Median of consensus weights from all authority votes. Tor uses median for path selection.">{% if diag.bandwidth_summary and diag.bandwidth_summary.median_display %}{{ diag.bandwidth_summary.median_display }}{% else %}{{ rv.measured_bw_display }}{% endif %} (median)</td>
        <td>N/A (no threshold, used for path selection)</td>
        <td><span style="color: #6c757d;">‚Äî</span></td>
    </tr>
    <tr>
        <td title="Weighted Fractional Uptime for Guard flag eligibility">Guard WFU (guard-wfu)</td>
        <td>{{ rv.wfu_display }}</td>
        <td>‚â•98% (all authorities)</td>
        <td>{% if rv.wfu_meets %}<span style="color: #28a745; font-weight: bold;">MEETS</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - cannot get Guard</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Time Known for Guard flag eligibility - how long authority has tracked this relay">Guard TK (tk)</td>
        <td>{{ rv.tk_display }}</td>
        <td>‚â•8 days (all authorities)</td>
        <td>{% if rv.tk_meets %}<span style="color: #28a745; font-weight: bold;">MEETS</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - need {{ "%.1f"|format(rv.tk_days_needed) }} more days</span>{% endif %}</td>
    </tr>
    <tr>
        <td>Guard BW</td>
        <td title="Observed bandwidth from relay's server descriptor (self-reported by relay). Bandwidth authorities measure actual throughput separately for consensus weight.">{{ rv.observed_bw_display }}</td>
        <td title="Guard requires: ‚â•2 MB/s (guarantee) OR in top 25% ({{ rv.guard_bw_range }})">‚â•{{ rv.guard_bw_guarantee_display }} OR ‚â•{{ rv.guard_bw_range }}</td>
        <td>{% if rv.guard_bw_meets_guarantee %}<span style="color: #28a745; font-weight: bold;">MEETS - ‚â•2 MB/s guarantee</span>{% elif rv.guard_bw_meets_some %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - in top 25% for {{ rv.guard_bw_meets_count }} auth(s)</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - need ‚â•2 MB/s</span>{% endif %}</td>
    </tr>
    <tr>
        <td>Stable Uptime</td>
        <td>{{ rv.tk_display }}</td>
        <td title="Range varies by authority">‚â•{{ rv.stable_range }}</td>
        <td>{% if rv.stable_meets_all %}<span style="color: #28a745; font-weight: bold;">MEETS - all authorities</span>{% elif rv.stable_meets_count >= diag.majority_required %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ rv.stable_meets_count }}/{{ rv.total_authorities }}</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - {{ rv.stable_meets_count }}/{{ rv.total_authorities }}</span>{% endif %}</td>
    </tr>
    <tr>
        <td>Stable MTBF</td>
        <td>{{ rv.mtbf_display|default('N/A') }}</td>
        <td title="Range varies by authority">‚â•{{ rv.stable_mtbf_range }}</td>
        <td>{% if rv.stable_mtbf_meets_all|default(false) %}<span style="color: #28a745; font-weight: bold;">MEETS - all authorities</span>{% elif rv.stable_mtbf_meets_count|default(0) >= diag.majority_required %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ rv.stable_mtbf_meets_count|default(0) }}/{{ rv.total_authorities }}</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - {{ rv.stable_mtbf_meets_count|default(0) }}/{{ rv.total_authorities }}</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Fast flag requires bandwidth in top 7/8ths of network OR ‚â•100 KB/s guarantee">Fast Speed</td>
        <td title="Observed bandwidth from relay's server descriptor (self-reported by relay). Used for Fast flag eligibility.">{{ rv.fast_speed_display }}</td>
        <td title="Most authorities: ‚â•{{ rv.fast_speed_typical_display }}{% if rv.fast_speed_strict_auths %}; Stricter: {{ rv.fast_speed_strict_auths|join(', ') }} uses ‚â•{{ rv.fast_speed_max_display }}{% endif %}">
            ‚â•{{ rv.fast_minimum_display }} <span style="color: #666; font-size: 11px;">(guarantee)</span> OR ‚â•{{ rv.fast_speed_typical_display }} <span style="color: #666; font-size: 11px;">(typical)</span>
            {% if rv.fast_speed_strict_auths %}
            <br><span style="color: #856404; font-size: 10px;" title="These authorities have stricter requirements">‚ö†Ô∏è {{ rv.fast_speed_strict_auths|join(', ') }}: ‚â•{{ rv.fast_speed_max_display }}</span>
            {% endif %}
        </td>
        <td>{% if rv.fast_meets_minimum %}<span style="color: #28a745; font-weight: bold;">MEETS - ‚â•100 KB/s guarantee</span>{% elif rv.fast_meets_all %}<span style="color: #28a745; font-weight: bold;">MEETS - all {{ rv.total_authorities }} auths</span>{% elif rv.fast_meets_count > 0 %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ rv.fast_meets_count }}/{{ rv.total_authorities }}</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - need ‚â•100 KB/s</span>{% endif %}</td>
    </tr>
    <tr>
        <td>HSDir WFU</td>
        <td>{{ rv.wfu_display }}</td>
        <td>‚â•{{ "%.1f"|format(rv.hsdir_wfu_threshold * 100) }}% (from all auths)</td>
        <td>{% if diag.flag_summary.hsdir.eligible_count == diag.total_authorities %}<span style="color: #28a745; font-weight: bold;">MEETS - all {{ diag.total_authorities }} auths</span>{% elif diag.flag_summary.hsdir.eligible_count >= diag.majority_required %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ diag.flag_summary.hsdir.eligible_count }}/{{ diag.total_authorities }}</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - {{ diag.flag_summary.hsdir.eligible_count }}/{{ diag.total_authorities }}</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="HSDir Time Known - how long relay has been tracked by authorities">HSDir TK</td>
        <td>{{ rv.tk_display }}</td>
        <td title="dir-spec default: 25 hours ({{ rv.hsdir_tk_default_count }} auths){% if rv.hsdir_tk_strict_auths %}; Stricter: {{ rv.hsdir_tk_strict_auths|join(', ') }} uses {{ rv.hsdir_tk_max_display }}{% endif %}">
            ‚â•{{ rv.hsdir_tk_consensus_display }} <span style="color: #666; font-size: 11px;">({{ rv.hsdir_tk_default_count }}/{{ diag.total_authorities }} auths)</span>
            {% if rv.hsdir_tk_strict_auths %}
            <br><span style="color: #856404; font-size: 10px;" title="These authorities have stricter requirements">‚ö†Ô∏è {{ rv.hsdir_tk_strict_auths|join(', ') }}: ‚â•{{ rv.hsdir_tk_max_display }}</span>
            {% endif %}
        </td>
        <td>{% if diag.flag_summary.hsdir.eligible_count == diag.total_authorities %}<span style="color: #28a745; font-weight: bold;">MEETS - all {{ diag.total_authorities }} auths</span>{% elif diag.flag_summary.hsdir.eligible_count >= diag.majority_required %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ diag.flag_summary.hsdir.eligible_count }}/{{ diag.total_authorities }}</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - {{ diag.flag_summary.hsdir.eligible_count }}/{{ diag.total_authorities }}</span>{% endif %}</td>
    </tr>
    <tr>
        <td>IPv4 Reachable</td>
        <td>{{ rv.ipv4_reachable_count }}/{{ rv.total_authorities }} authorities</td>
        <td>‚â•{{ diag.majority_required }}/{{ diag.total_authorities }} (majority)</td>
        <td>{% if rv.ipv4_reachable_count >= diag.majority_required %}<span style="color: #28a745; font-weight: bold;">REACHABLE</span>{% else %}<span style="color: #dc3545; font-weight: bold;">NOT REACHABLE</span>{% endif %}</td>
    </tr>
    {% if has_ipv6 %}
    <tr>
        <td>IPv6 Reachable</td>
        <td>{{ rv.ipv6_reachable_count }}/{{ rv.ipv6_tested_count }} tested</td>
        <td>‚â•majority of testers</td>
        <td>{% if rv.ipv6_tested_count == 0 %}<span style="color: #6c757d; font-weight: bold;">NOT TESTED</span>{% elif rv.ipv6_reachable_count >= (rv.ipv6_tested_count // 2 + 1) %}<span style="color: #28a745; font-weight: bold;">REACHABLE</span>{% elif rv.ipv6_reachable_count > 0 %}<span style="color: #ffc107; font-weight: bold;">PARTIAL</span>{% else %}<span style="color: #dc3545; font-weight: bold;">NOT REACHABLE</span>{% endif %}</td>
    </tr>
    {% endif %}
</tbody>
</table>
</div>
{% endif %}


{# ============== TABLE 2: PER-AUTHORITY DETAILS (Diagnosis) ============== #}
<h4 id="authority-votes" style="margin-top: 15px;">
<div class="section-header">
<a href="#authority-votes" class="anchor-link">Per-Authority Details</a>
</div>
</h4>
<p class="text-muted" style="font-size: 11px; margin-bottom: 8px;">
Each cell shows: <strong>your measured value | authority threshold</strong>. 
<span style="color: #28a745;">Green</span> = meets, <span style="color: #dc3545;">red</span> = below.
Flags: <span style="color: #28a745; font-weight: bold;">green</span> = all authorities agree, <span style="color: #856404; font-weight: bold;">yellow</span> = partial.
</p>
<div style="overflow-x: auto; overflow-y: visible; padding-top: 60px; margin-top: -50px;">
<table class="table table-condensed table-striped" style="font-size: 11px;">
<thead>
<tr>
    <th title="Authority nickname with country code">Authority</th>
    <th title="Running: Authority voted for this relay (could reach it via OR port). Voted = Running.">Running</th>
    <th title="Valid: Relay is not blacklisted and has valid descriptor. All Running relays get Valid unless blacklisted.">Valid</th>
    <th title="Runs sbws bandwidth scanner">BW Scan</th>
    <th title="IPv4 reachable (same as Running for this relay)">v4</th>
    {% if has_ipv6 %}<th title="IPv6 reachable | N/T = not tested by this authority">v6</th>{% endif %}
    <th title="Flags assigned by this authority. Order: Exit, Fast, Guard, HSDir, Running, Stable, V2Dir, Valid">Flags</th>
    <th title="Fast Speed: Observed BW | Threshold (7/8ths). Green if ‚â• threshold OR ‚â•100 KB/s">Fast Speed (M|T)</th>
    <th title="Guard BW: Observed BW | Top 25% threshold | 2 MB/s min. Green if meets either.">Guard BW (M|T)</th>
    <th title="Guard WFU: Measured | Threshold. ‚â•98% required for Guard flag.">Guard WFU (M|T)</th>
    <th title="Guard TK: Measured | Threshold. ‚â•8 days required for Guard flag.">Guard TK (M|T)</th>
    <th title="Stable MTBF: Measured | Threshold. Note: Actual flag assignment may differ from threshold.">Stable MTBF (M|T)</th>
    <th title="HSDir WFU: Measured | Threshold. ‚â•98% required for HSDir flag.">HSDir WFU (M|T)</th>
    <th title="HSDir TK: Measured | Threshold. dir-spec: ‚â•25 hours (most auths); moria1: ‚â•10 days">HSDir TK (M|T)</th>
    <th title="Descriptor Published: Timestamp of relay's descriptor. StaleDesc flag assigned if >18 hours old (bad). Red = StaleDesc, Green = Fresh.">Desc Published</th>
    <th title="Scaled consensus weight for path selection. From authority's 'w Bandwidth' line. 10 KB/s = default when authority uses relay's advertised BW instead of measured.">Cons Wt</th>
</tr>
</thead>
<tbody>
{% for vote in diag.authority_table %}
<tr class="{% if not vote.voted %}row-not-voted{% endif %}">
    <td>
        {% if vote.fingerprint %}
        <a href="{{ page_ctx.path_prefix }}relay/{{ vote.fingerprint }}/" style="text-decoration: underline;">
            <strong>{{ vote.authority_display|default(vote.authority) }}</strong>
        </a>
        {% else %}
        <strong>{{ vote.authority_display|default(vote.authority) }}</strong>
        {% endif %}
    </td>
    {# Running: Did this authority vote for this relay (i.e., could it reach the relay)? #}
    <td>
        {% if vote.voted %}
            <span style="color: #28a745;" title="Authority voted for this relay (Running)">‚úì</span>
        {% else %}
            <span style="color: #dc3545;" title="Authority did NOT vote for this relay (not reachable)">‚úó</span>
        {% endif %}
    </td>
    {# Valid: Relay has Valid flag from this authority #}
    <td>
        {% if vote.voted and vote.flags %}
            {% if 'Valid' in vote.flags %}
                <span style="color: #28a745;" title="Relay is Valid (verified, allowed in network)">‚úì</span>
            {% else %}
                <span style="color: #dc3545;" title="Relay does NOT have Valid flag">‚úó</span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    <td>
        {% if vote.is_bw_authority %}
            <span style="color: #28a745;">Y</span>
        {% else %}
            <span style="color: #6c757d;">N</span>
        {% endif %}
    </td>
    <td>
        {% if vote.ipv4_reachable %}
            <span style="color: #28a745;">‚úì</span>
        {% else %}
            <span style="color: #dc3545;">‚úó</span>
        {% endif %}
    </td>
    {% if has_ipv6 %}
    <td>
        {% if vote.ipv6_reachable == true %}
            <span style="color: #28a745;">‚úì</span>
        {% elif vote.ipv6_reachable == false %}
            <span style="color: #dc3545;">‚úó</span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    {% endif %}
    <td style="max-width: 180px; word-wrap: break-word; font-size: 10px;">
        {% if vote.flags_with_consensus %}
            {% for flag_info in vote.flags_with_consensus %}
                {%- if flag_info.unanimous -%}
                    <span style="color: #28a745; font-weight: bold;">{{ flag_info.name }}</span>
                {%- elif flag_info.partial -%}
                    <span style="color: #856404; font-weight: bold;">{{ flag_info.name }}</span>
                {%- else -%}
                    {{ flag_info.name }}
                {%- endif -%}
                {%- if not loop.last %}, {% endif -%}
            {% endfor %}
        {% elif vote.flags %}
            {{ vote.flags_display }}
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    {# Fast: observed BW | fast-speed threshold #}
    <td>
        {% if vote.voted and vote.fast_threshold_display %}
            <span style="color: {% if vote.fast_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Measured: {{ vote.fast_speed_display }} | Threshold (7/8ths): {{ vote.fast_threshold_display }} | {% if vote.fast_meets %}MEETS{% else %}BELOW{% endif %}">
                {{ vote.fast_speed_display }} | {{ vote.fast_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    {# Guard BW: observed BW | top 25% threshold | 2 MB/s min #}
    <td>
        {% if vote.voted and vote.guard_bw_guarantee_display %}
            <span style="color: {% if vote.guard_bw_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Measured: {{ vote.guard_bw_value_display }} | Top 25%: {{ vote.guard_bw_top25_display }} | Min: {{ vote.guard_bw_guarantee_display }} | {% if vote.guard_bw_meets_guarantee %}MEETS (‚â•2 MB/s){% elif vote.guard_bw_in_top25 %}MEETS (top 25%){% else %}BELOW{% endif %}">
                {{ vote.guard_bw_value_display }} | {{ vote.guard_bw_top25_display }} OR {{ vote.guard_bw_guarantee_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    {# WFU: measured | threshold #}
    <td>
        {% if vote.voted and vote.wfu is not none %}
            <span style="color: {% if vote.wfu_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your WFU: {{ vote.wfu_display }} | Threshold: {{ vote.wfu_threshold_display }}">
                {{ vote.wfu_display }} | {{ vote.wfu_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    {# TK: measured | threshold #}
    <td>
        {% if vote.voted and vote.tk is not none %}
            <span style="color: {% if vote.tk_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your TK: {{ vote.tk_display }} | Threshold: {{ vote.tk_threshold_display }}">
                {{ vote.tk_display }} | {{ vote.tk_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    {# Stable MTBF: measured MTBF | threshold #}
    <td>
        {% if vote.voted and vote.stable_threshold %}
            <span style="color: {% if vote.stable_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your MTBF: {{ vote.stable_mtbf_display }} | Threshold: {{ vote.stable_threshold_display }} | Note: Actual flag assignment may differ">
                {{ vote.stable_mtbf_display }} | {{ vote.stable_threshold_display }}
            </span>
        {% elif vote.voted and vote.stable_mtbf %}
            {{ vote.stable_mtbf_display }} | <span style="color: #6c757d;">‚Äî</span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    {# HSDir WFU: measured | threshold (same as guard WFU, 98%) #}
    <td>
        {% if vote.voted and vote.wfu is not none %}
            <span style="color: {% if vote.wfu >= 0.98 %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your WFU: {{ vote.wfu_display }} | Threshold: ‚â•98% for HSDir">
                {{ vote.wfu_display }} | 98.0%
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    {# HSDir TK: measured | threshold (25h dir-spec default; moria1 uses ~10 days) #}
    <td>
        {% if vote.voted and vote.hsdir_tk_threshold %}
            <span style="color: {% if vote.hsdir_tk_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your TK: {{ vote.hsdir_tk_value_display }} | Threshold: {{ vote.hsdir_tk_threshold_display }}">
                {{ vote.hsdir_tk_value_display }} | {{ vote.hsdir_tk_threshold_display }}
            </span>
        {% elif vote.voted and vote.tk %}
            {{ vote.tk_display }} | <span style="color: #6c757d;">‚Äî</span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    
    {# Descriptor Published: timestamp - Red if StaleDesc flag, Green if fresh #}
    <td>
        {% if vote.voted %}
            {% if vote.has_staledesc %}
                <span style="color: #8b0000; font-weight: bold;" title="StaleDesc flag assigned - descriptor is >18 hours old. This is a negative flag.">
                    {{ vote.descriptor_published|default('N/A') }} ‚ö†Ô∏è
                </span>
            {% else %}
                <span style="color: #28a745;" title="Descriptor is fresh (no StaleDesc flag)">
                    {{ vote.descriptor_published|default('N/A') }}
                </span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
    
    {# Consensus Weight: scaled value for path selection (moved to end) #}
    <td>
        {% if vote.voted and vote.measured %}
            <span title="Scaled consensus weight: {{ vote.measured }} (for traffic distribution). 10 KB/s = default when authority uses relay's advertised BW.">
                {{ vote.measured_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">‚Äî</span>
        {% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<p style="font-size: 10px; color: #666; margin-top: 5px;">
‚Äî = not tested/available ‚Ä¢ Format: your measured value | authority's threshold ‚Ä¢ WFU = Weighted Fractional Uptime ‚Ä¢ TK = Time Known
</p>

</div>
</div>
{% endif %}

</div>
{% endblock -%}

