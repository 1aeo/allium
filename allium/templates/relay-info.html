{% extends "skeleton.html" -%}
{% from "macros.html" import navigation, aroi_validation_badge %}
{% block title -%}
	Tor Relays :: {{ relay['nickname']|escape }}
{% endblock -%}
{% block body -%}
<style>
.section-header {
    position: relative;
    display: inline-block;
}

.anchor-link {
    text-decoration: none;
    color: inherit;
}







/* Highlight section when targeted */
:target {
    background-color: rgba(255, 193, 7, 0.2);
    padding: 8px;
    border-radius: 4px;
    margin: -8px;
    transition: background-color 0.3s;
}

/* Health Status Grid Layout */
.health-status-grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr;  /* 60/40 split */
    gap: 8px 24px;
}

.health-status-grid dl {
    margin: 0;
    font-size: 14px;
}

.health-status-grid .health-row {
    display: flex;
    align-items: baseline;
    margin-bottom: 8px;
}

.health-status-grid dt {
    width: 100px;
    font-weight: bold;
    color: #495057;
    flex-shrink: 0;
}

.health-status-grid dd {
    margin: 0;
    flex: 1;
}

/* Responsive: Stack on mobile */
@media (max-width: 767px) {
    .health-status-grid {
        grid-template-columns: 1fr;
    }
}

</style>
<div id="content">
<h2>View Relay "{{ relay['nickname'] }}"</h2>
{% set relay_data = {'nickname': relay['nickname'], 'fingerprint': relay['fingerprint'], 'as_number': relay['as']} %}
{{ navigation('all', page_ctx) }}
<h4>
{# AROI section with verification badge and relay count #}
{% if relay['aroi_domain'] and relay['aroi_domain'] != 'none' -%}
    {% if base_url and relay['aroi_domain'] in validated_aroi_domains -%}
        <a href="{{ base_url }}/{{ relay['aroi_domain']|lower|escape }}/" title="View all relays by this operator">Operator: {{ relay['aroi_domain']|escape }}</a>
    {% else -%}
        <a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/" title="View operator page">Operator: {{ relay['aroi_domain']|escape }}</a>
    {% endif -%}
    {# Show relay count if available from validation data #}
    {% if contact_validation_status and contact_validation_status.validation_summary -%}
        ({{ contact_validation_status.validation_summary.total_relays }} relay{% if contact_validation_status.validation_summary.total_relays != 1 %}s{% endif %})
    {% endif -%}
    {# Verification badge - DRY macro (links to operator page sections) #}
    {{- aroi_validation_badge(contact_validation_status) -}}
    | 
{% endif -%}
{# Family - always shown (not just as fallback) #}
{% if relay['effective_family']|length > 1 -%}
    <a href="{{ page_ctx.path_prefix }}family/{{ relay['fingerprint']|escape }}/" title="View family members">Family: {{ relay['effective_family']|length }} relays</a>
{% else -%}
    Family: {{ relay['effective_family']|length }} relay
{% endif -%} | 
{% if relay['contact'] -%}
    <a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/" title="Contact information">{{ relay['contact']|truncate(40)|escape }}</a> | 
{% endif -%}
{% if relay['as'] -%}
<a href="{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/">{{ relay['as']|escape }}</a>
{% else -%}
AS: unknown
{% endif -%} | 
{% if relay['country'] -%}
<a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">{{ relay['country_name']|escape }}</a>
{% else -%}
Country: unknown
{% endif -%} | 
<a href="{{ page_ctx.path_prefix }}platform/{{ relay['platform']|escape }}/">{{ relay['platform']|escape }}</a>
</h4>

{# ============== HEALTH STATUS SUMMARY (Enhanced) ============== #}
{# Displays 14 metrics in 8 cells using responsive 2-column layout #}
{% set diag = relay.consensus_evaluation if relay.consensus_evaluation and relay.consensus_evaluation.available else none %}

<div id="status" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid {% if diag and diag.in_consensus %}#28a745{% elif 'Running' in relay['flags'] %}#28a745{% else %}#dc3545{% endif %};">

<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#status" class="anchor-link">Health Status</a>
    </div>
</h4>

<div class="health-status-grid">
    {# LEFT COLUMN (60%) #}
    <dl>
        {# Row 1 Left: Consensus Status (merges: in_consensus + vote_count) #}
        <div class="health-row">
            <dt title="Inclusion in network consensus. Majority of Directory Auths must vote yes.">Consensus</dt>
            <dd>
                {% if diag -%}
                    {% if diag.in_consensus -%}
                        <span style="color: #28a745;" title="Relay IS in the network consensus. Tor clients will use this relay.">In Consensus</span>
                        <span title="Number of Directory Authorities that voted for this relay. Need majority ({{ diag.majority_required }}/{{ diag.total_authorities }}) for consensus.">({{ diag.vote_count }}/{{ diag.total_authorities }} Directory Auths)</span>
                    {% else -%}
                        <span style="color: #dc3545;" title="Relay is NOT in the network consensus. Tor clients will NOT use this relay.">Not In Consensus</span>
                        <span title="Number of Directory Authorities that voted for this relay. Need majority ({{ diag.majority_required }}/{{ diag.total_authorities }}) for consensus.">({{ diag.vote_count }}/{{ diag.total_authorities }} Directory Auths, need {{ diag.majority_required }})</span>
                    {% endif -%}
                {% elif 'Running' in relay['flags'] -%}
                    <span style="color: #28a745;" title="Relay IS in the network consensus. Tor clients will use this relay.">In Consensus</span>
                    <span title="Inferred from Running flag in Onionoo data.">(has Running flag)</span>
                {% else -%}
                    <span style="color: #dc3545;" title="Relay is NOT in the network consensus. Tor clients will NOT use this relay.">Not In Consensus</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 2 Left: Flags #}
        <div class="health-row">
            <dt title="Capabilities assigned by Dir. Auth. based on performance.">Flags</dt>
            <dd>
                {% set flag_list_unsorted = relay['flags']|reject('equalto', 'StaleDesc')|list -%}
                {% if diag and diag.eligible_flags_display -%}
                {% set flag_list = [] -%}
                {% for f in diag.eligible_flags_display.flag_order %}{% if f in flag_list_unsorted %}{% set _ = flag_list.append(f) %}{% endif %}{% endfor -%}
                {% for f in flag_list_unsorted %}{% if f not in diag.eligible_flags_display.flag_order %}{% set _ = flag_list.append(f) %}{% endif %}{% endfor -%}
                {% else -%}
                {% set flag_list = flag_list_unsorted -%}
                {% endif -%}
                {% set flag_count = flag_list|length -%}
                <span title="Guard=entry point, Exit=exit node, Stable=long-lived connections, Fast=high bandwidth, Valid=properly configured, Running=currently reachable.">{% for flag in flag_list -%}
                    <a href="{{ page_ctx.path_prefix }}flag/{{ flag.lower()|escape }}/">{{ flag|escape }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}</span> <span title="Total number of flags assigned to this relay.">({{ flag_count }})</span>
                {% if 'StaleDesc' in relay['flags'] -%}
                    <br><span style="color: #dc3545; font-size: 12px;" title="Relay's descriptor is outdated. May indicate connectivity issues.">[Warning] StaleDesc</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 3 Left: BW Verified (authority measurement count + median) #}
        <div class="health-row">
            <dt title="Bandwidth verification by directory authorities running sbws scanners.">BW Verified</dt>
            <dd>
                {% if diag and diag.bandwidth_summary and diag.bandwidth_summary.bw_auth_total -%}
<span style="color: {{ diag.bandwidth_summary.bw_auth_color }};" title="Number of bandwidth authorities (sbws scanners) that measured this relay. Currently {{ diag.bandwidth_summary.bw_auth_total }} authorities run bandwidth scanners.">{{ diag.bandwidth_summary.bw_auth_measured_count }}/{{ diag.bandwidth_summary.bw_auth_total }}</span> BW Auths Measured
                    {% if diag.bandwidth_summary.median_int -%}
<span title="Median bandwidth measurement from bandwidth authorities. Used to calculate consensus weight.">{{ diag.bandwidth_summary.median_int }} {{ diag.bandwidth_summary.median_unit }} Median</span>
                    {% endif -%}
                {% elif relay['measured'] -%}
<span style="color: #28a745;" title="Relay has been measured by bandwidth authorities.">Measured</span>
                {% elif relay['measured'] is none -%}
<span style="color: #6c757d;">Unknown</span>
                {% else -%}
<span style="color: #856404;" title="Relay has not been measured by bandwidth authorities yet.">Not Measured</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 4 Left: Stability (renamed from Uptime, with overload indicator) #}
        <div class="health-row">
            <dt title="Relay stability: overload status and uptime.">Stability</dt>
            <dd>
                <a href="#overload" title="{{ relay['stability_tooltip']|escape }}" style="text-decoration: none;">
                    <span style="color: {{ relay['stability_color'] }};">{{ relay['stability_text'] }}</span>
                </a>
                <span style="color: #6c757d;"> | </span>
                {% if relay.get('uptime_display') -%}
                    {% if relay['uptime_display'].startswith('DOWN') -%}
                        <span style="color: #dc3545;" title="Relay is currently offline.">{{ relay['uptime_display']|escape }}</span>
                    {% else -%}
                        <span style="color: #28a745;" title="Time since last restart. Source: relay descriptor.">{{ relay['uptime_display']|escape }}</span>
                    {% endif -%}
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
                {% set uptime_1m = relay.get('uptime_percentages', {}).get('1_month', 0) -%}
                {% if uptime_1m > 0 -%}
                    | <span style="color: {% if uptime_1m >= 100 %}#28a745{% elif uptime_1m >= 90 %}#856404{% else %}#dc3545{% endif %};" title="Percentage of time relay had Running flag in last month. 100%=always up, <90%=reliability concerns.">UP {{ uptime_1m|int }}%</span> <span title="1 Month availability percentage.">(1M)</span>
                {% endif -%}
            </dd>
        </div>
    </dl>

    {# RIGHT COLUMN (40%) #}
    <dl>
        {# Row 1 Right: Reachability (merges: IPv4 + IPv6) #}
        <div class="health-row">
            <dt title="Directory Auths connectivity to relay's OR port.">Reachability</dt>
            <dd>
                {% if diag and diag.reachability_summary -%}
                    <span title="Number of Directory Authorities that successfully connected to relay's IPv4 OR port.">IPv4: <span style="color: {% if diag.reachability_summary.ipv4.status_class == 'success' %}#28a745{% else %}#dc3545{% endif %};">{{ diag.reachability_summary.ipv4.reachable_count }}/{{ diag.reachability_summary.ipv4.total }}</span></span>
                    {% if diag.reachability_summary.ipv6.total > 0 -%}
                        | <span title="Number of Directory Authorities that successfully connected to relay's IPv6 OR port.">v6: <span style="color: {% if diag.reachability_summary.ipv6.status_class == 'success' %}#28a745{% elif diag.reachability_summary.ipv6.status_class == 'muted' %}#6c757d{% else %}#dc3545{% endif %};">{{ diag.reachability_summary.ipv6.reachable_count }}/{{ diag.reachability_summary.ipv6.total }}</span></span>
                    {% endif -%}
                    <span title="Reachability tested by Directory Authorities.">(Directory Auths)</span>
                {% else -%}
                    <span style="color: #6c757d;">N/A</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 2 Right: First Seen (swapped with Uptime) #}
        <div class="health-row">
            <dt title="First appearance in network consensus.">First Seen</dt>
            <dd>
                {% if relay['first_seen'] -%}
                    <a href="{{ page_ctx.path_prefix }}first_seen/{{ relay['first_seen'].split(' ', 1)[0]|escape }}/" title="Date relay first appeared in consensus. Newer relays have restrictions (Guard flag requires ~8 days).">{{ relay['first_seen']|format_time_ago }}</a>
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 3 Right: BW Weight (network percentage + observed bandwidth) #}
        <div class="health-row">
            <dt title="Traffic share and self-reported bandwidth capacity.">BW Weight</dt>
            <dd>
                {# Compute observed bandwidth once, used in both branches #}
                {% set obs_unit = relay['observed_bandwidth']|determine_unit(relays.use_bits) -%}
                {% set obs_bandwidth = relay['observed_bandwidth']|format_bandwidth_with_unit(obs_unit) -%}
                {% if relay['consensus_weight_fraction'] -%}
<span title="Percentage of total network consensus weight. Determines probability of being selected by clients.">{{ "%.2f"|format(relay['consensus_weight_fraction'] * 100) }}% of Network</span>
                    | <span title="Bandwidth capacity reported by the relay itself. May differ from measured bandwidth.">{{ obs_bandwidth|float|int }} {{ obs_unit }} Observed By Relay</span>
                {% else -%}
<span title="Bandwidth capacity reported by the relay itself.">{{ obs_bandwidth|float|int }} {{ obs_unit }} Observed By Relay</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 4 Right: Version (merges: version + recommended status) #}
        <div class="health-row">
            <dt title="Tor software version. Outdated versions may be rejected by Tor network and have security vulnerabilities.">Version</dt>
            <dd>
                {% if relay['version'] -%}
                    {% if relay['recommended_version'] is not none -%}
                        {% if relay['recommended_version'] -%}
                            <span style="color: #28a745;" title="This Tor version is on the recommended list. Safe to use.">{{ relay['version']|escape }} Recommended</span>
                        {% else -%}
                            <span style="color: #dc3545;" title="This Tor version is outdated. May have security issues or be rejected by the network.">{{ relay['version']|escape }} Not Recommended</span>
                        {% endif -%}
                    {% else -%}
                        <span title="Version recommendation status unknown.">{{ relay['version']|escape }}</span>
                    {% endif -%}
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>
        </div>
    </dl>
</div>

{# Issues and Warnings - Full width below grid #}
{# Use new diagnostics if available (includes overload issues), fallback to consensus_evaluation #}
{% set all_issues = relay.diagnostics.issues if relay.diagnostics else (diag.issues if diag else []) %}
{% if all_issues %}
{% set real_issues = all_issues | selectattr('severity', 'ne', 'info') | list %}
{% set info_notes = all_issues | selectattr('severity', 'equalto', 'info') | list %}

{% if real_issues %}
<div style="margin-top: 12px; padding: 10px; background: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
    <strong style="color: #856404;">Issues Detected:</strong>
    <ul style="margin: 5px 0 0 0; padding-left: 20px;">
    {% for issue in real_issues %}
        <li style="margin-bottom: 5px;">
            <span style="color: {% if issue.severity == 'error' %}#dc3545{% else %}#856404{% endif %}; font-weight: bold;">
                {{ issue.title }}
            </span>: {{ issue.description|safe }}
            {% if issue.suggestion %}
            <br><span style="color: #666; font-size: 12px;"><strong>Suggestion:</strong> {{ issue.suggestion|safe }}</span>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
</div>
{% endif %}

{% if info_notes %}
<div style="margin-top: 10px; padding: 10px; background: #d1ecf1; border-radius: 4px; border-left: 3px solid #17a2b8;">
    <strong style="color: #0c5460;">Notes:</strong>
    <ul style="margin: 5px 0 0 0; padding-left: 20px;">
    {% for note in info_notes %}
        <li style="font-size: 12px;">{{ note.title }}: {{ note.description }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}
{% else %}
{# No issues found - show green box if we have diagnostics data #}
{% if relay.diagnostics or diag %}
<div style="margin-top: 12px; padding: 10px; background: #d4edda; border-radius: 4px; border-left: 3px solid #28a745;">
    <span style="color: #155724;"><strong>No issues detected.</strong> Relay appears to be operating normally.</span>
</div>
{% endif %}
{% endif %}

</div>

{# ============== SECTION 2: CONNECTIVITY AND LOCATION ============== #}
{# NOTE: Reuses existing 'diag' variable (defined line 115) - no new variables #}
<section id="connectivity" class="section-box" style="padding-bottom: 5px;">
<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#connectivity" class="anchor-link">Connectivity and Location</a>
    </div>
</h4>

<div class="row">
{# ===== Left Column: Addresses and Reachability ===== #}
<div class="col-md-6">
<div class="subsection-card">
<h5 class="subsection-header">Addresses</h5>
<dl>
    <dt>OR Address</dt>
    <dd>
        {% if relay['verified_host_names'] -%}
            {% for hostname in relay['verified_host_names'] -%}
                <span class="verified-hostname" title="Verified: reverse DNS lookup matched a forward A record (DNSSEC validated). Source: Onionoo API">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
            {% endfor %}<br>
        {% elif relay['unverified_host_names'] -%}
            {% for hostname in relay['unverified_host_names'] -%}
                <span class="unverified-hostname" title="Unverified: reverse DNS found but no matching A record. Source: Onionoo API">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
            {% endfor %}<br>
        {% endif -%}
        {% for address in relay['or_addresses'] -%}
            {{ address }}{% if not loop.last %}<br>{% endif %}
        {% endfor -%}
    </dd>
    
    {% if relay['exit_addresses'] %}
    <dt>Exit Address</dt>
    <dd>{% for addr in relay['exit_addresses'] %}{{ addr|escape }}{% if not loop.last %}<br>{% endif %}{% endfor %}</dd>
    {% endif %}
    
    {% if relay['dir_address'] %}
    <dt>Dir Address</dt>
    <dd><a href="http://{{ relay['dir_address']|escape }}">{{ relay['dir_address']|escape }}</a></dd>
    {% endif %}
</dl>
</div>

<div class="subsection-card">
<h5 class="subsection-header">Reachability (Directory Authorities)</h5>
<dl>
    {% if diag and diag.reachability_summary %}
    {%- set reach = diag.reachability_summary -%}
    <dt>IPv4</dt>
    <dd>
        <span class="status-{{ reach.ipv4.status_class }}">{{ reach.ipv4.reachable_count }}/{{ reach.ipv4.total }}</span>
    </dd>
    {# IPv6: Use ipv6.total > 0 check (same as Health Status line 212) - no new loop needed #}
    {% if reach.ipv6.total > 0 %}
    <dt>IPv6</dt>
    <dd>
        <span class="status-{{ reach.ipv6.status_class }}">{{ reach.ipv6.reachable_count }}/{{ reach.ipv6.total }}</span>{% if reach.ipv6.not_tested %} <span class="status-note">({{ reach.ipv6.not_tested|length }} don't test)</span>{% endif %}
    </dd>
    {% endif %}
    {% else %}
    <dt>Status</dt>
    <dd><span class="status-note">Reachability data unavailable</span></dd>
    {% endif %}
</dl>
</div>
</div>

{# ===== Right Column: Location and AS ===== #}
<div class="col-md-6">
<div class="subsection-card">
<h5 class="subsection-header">Location</h5>
<dl>
    <dt>Country</dt>
    <dd>
        {% if relay['country'] -%}
            <a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">
                <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relay['country']|lower|escape }}.png"
                     title="{{ relay['country_name']|escape }}" alt="{{ relay['country_name']|escape }}">
            </a> {{ relay['country_name']|escape }}
        {% else -%}
            Unknown
        {% endif -%}
    </dd>
    
    {% if relay['region_name'] %}
    <dt>Region</dt>
    <dd>{{ relay['region_name']|escape }}</dd>
    {% endif %}
    
    {% if relay['city_name'] %}
    <dt>City</dt>
    <dd>{{ relay['city_name']|escape }}</dd>
    {% endif %}
    
    {% if relay['latitude'] and relay['longitude'] and relay['latitude'] != 0 and relay['longitude'] != 0 %}
    <dt>Coordinates</dt>
    <dd>{{ relay['latitude']|escape }}, {{ relay['longitude']|escape }}</dd>
    {% endif %}
    
    <dt>Interactive Map</dt>
    <dd><a href="https://routefluxmap.1aeo.com/#relay={{ relay['fingerprint']|escape }}" target="_blank" rel="noopener">View on Interactive Map</a></dd>
</dl>
</div>

<div class="subsection-card">
<h5 class="subsection-header">Autonomous System</h5>
<dl>
    <dt>AS Number</dt>
    <dd>
        {% if relay['as'] -%}
            <a href="{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/">{{ relay['as']|escape }}</a>
        {% else -%}
            Unknown
        {% endif -%}
    </dd>
    
    <dt>AS Name</dt>
    <dd>
        {% if relay['as_name'] -%}
            {{ relay['as_name']|escape }}
            {% if relay['as'] %}(<a href="https://bgp.tools/{{ relay['as']|escape }}">BGP.tools</a>){% endif %}
        {% else -%}
            Unknown
        {% endif -%}
    </dd>
    
    <dt>AS Rarity</dt>
    <dd>
        {% set tier = relay.get('as_rarity_tier', 'common') -%}
        {% set score = relay.get('as_rarity_score', 0) -%}
        <span style="color: {% if tier == 'legendary' %}#9b59b6{% elif tier == 'epic' %}#2e7d2e{% elif tier == 'rare' %}#007bff{% elif tier == 'emerging' %}#cc9900{% else %}#6c757d{% endif %}; font-weight: bold;" title="AS rarity measures how rare this hosting choice is for the Tor network. Higher scores indicate better diversity for the network. Score combines consensus weight concentration (0-3) and operator uniqueness (0-2).">{{ tier|capitalize }}</span> (score: {{ score }}/5, {{ relay.get('as_cw_label', 'n/a') }} consensus weight, {{ relay.get('as_operator_count', 0) }} operator{{ 's' if relay.get('as_operator_count', 0) != 1 else '' }})
    </dd>
</dl>
</div>
</div>
</div>
</section>

{# ============== SECTION 3: FLAGS AND ELIGIBILITY ============== #}
{% set rv = diag.relay_values if diag and diag.available else none %}
{% if diag and diag.available and rv %}
<section id="flags" class="section-box" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#flags" class="anchor-link" title="Consensus flags assigned by Directory Authorities based on relay performance and eligibility requirements.">Flags and Eligibility</a>
    </div>
</h4>

{# Current Flags Row - White box, ordered by dependency (using pre-computed FLAG_ORDER) #}
{% set efd = diag.eligible_flags_display %}
{% set flag_list_raw = relay['flags']|reject('equalto', 'StaleDesc')|list %}
{% set flag_list = [] %}
{% for f in efd.flag_order %}{% if f in flag_list_raw %}{% set _ = flag_list.append(f) %}{% endif %}{% endfor %}
{% for f in flag_list_raw %}{% if f not in efd.flag_order %}{% set _ = flag_list.append(f) %}{% endif %}{% endfor %}
<div style="margin-bottom: 10px; padding: 10px; background: #ffffff; border-radius: 6px; border: 1px solid #e9ecef;">
    <strong title="Flags currently assigned to this relay in the network consensus. Flags determine what roles the relay can serve.">Current Flags ({{ flag_list|length }}):</strong>
    {% for flag in flag_list -%}
        <a href="{{ page_ctx.path_prefix }}flag/{{ flag.lower()|escape }}/" title="{{ diag.tooltips.flags[flag.lower()]|default(flag ~ ' flag') }}">{{ flag|escape }}</a>{% if not loop.last %}, {% endif %}
    {% endfor -%}

</div>

{# Eligible Flags Row - Using pre-computed display data (DRY optimization) #}
<div style="margin-bottom: 12px; padding: 10px; background: #ffffff; border-radius: 6px; border: 1px solid #e9ecef;">
    <strong title="Number of Directory Authorities that consider this relay eligible for each flag. Need majority for flag assignment.">Eligible Flags ({{ efd.eligible_count }}):</strong>
    {# All flags in order: Running → Valid → V2Dir → Fast → Stable → HSDir → Guard → Exit #}
    {% for flag in efd.flags %}
    <span style="color: {{ flag.color }}; font-weight: bold;" title="{{ flag.tooltip }} Eligible from {{ flag.count }}/{{ flag.total }} authorities.">{{ flag.name }}: {{ flag.count }}/{{ flag.total }}</span>{% if not loop.last %} | {% endif %}
    {% endfor %}
    <span style="color: #6c757d; font-size: 11px; margin-left: 8px;">(need ≥{{ diag.majority_required }}/{{ diag.total_authorities }} for flag)</span>
</div>

{# Eligibility Flag Vote Details Table - White box, reordered columns #}
<div style="padding: 10px; background: #ffffff; border-radius: 6px; border: 1px solid #e9ecef;">
<h5 style="margin-top: 0; margin-bottom: 8px;" title="Detailed breakdown of relay's values vs Directory Authority thresholds for each flag.">Eligibility Flag Vote Details</h5>
<div class="table-responsive">
<table class="table table-condensed table-striped" style="font-size: 12px; margin-bottom: 0;">
<thead>
<tr>
    <th style="width: 12%;" title="The consensus flag and its requirements. Flags are assigned when relay meets majority of authority thresholds.">Flag</th>
    <th style="width: 13%;" title="The specific measurement used to evaluate flag eligibility. Each flag may have multiple requirements.">Metric</th>
    <th style="width: 15%;" title="Whether relay meets the threshold: Meets (green), Partial (yellow), or Below (red).">Status</th>
    <th style="width: 25%;" title="Your relay's current value for this metric. (DA)=measured by authorities, (R)=reported by relay.">Relay Value</th>
    <th style="width: 35%;" title="The minimum value required by Directory Authorities. May vary per authority; range shown when applicable.">Threshold Required</th>
</tr>
</thead>
<tbody>
    {% for row in diag.flag_requirements_table %}
    <tr>
        {% if row.rowspan > 0 %}
        <td rowspan="{{ row.rowspan }}" style="vertical-align: middle; color: {{ row.flag_color }}; font-weight: bold;" title="{{ row.flag_tooltip }}">{{ row.flag }}</td>
        {% endif %}
        <td title="{{ row.metric_tooltip }}">{{ row.metric }}</td>
        <td><span style="color: {{ row.status_color }}; font-weight: bold;" title="{{ row.status_tooltip }}">{{ row.status_text }}</span></td>
        <td>{{ row.value|safe }}</td>
        <td>{{ row.threshold|safe }}</td>
    </tr>
    {% endfor %}
</tbody>
</table>
</div>
</div>

{# Footer with legend and timestamp #}
<p style="font-size: 11px; color: #6c757d; margin-top: 8px; margin-bottom: 0;">
    <span title="Directory Authority Measured: Value measured by Dir. Authorities from CollecTor vote files. Authorities independently track relay performance.">(DA)</span> = Dir. Auth. Measured | 
    <span title="Relay Reported: Value self-reported by the relay in its descriptor. Verified by authorities but originates from relay.">(R)</span> = Relay Reported<br>
    Data from <a href="https://collector.torproject.org/recent/relay-descriptors/votes/" target="_blank" rel="noopener">Tor CollecTor</a> (authority votes{% if relays.collector_fetched_at %}, fetched {{ relays.collector_fetched_at.replace('T', ' ').split('.')[0] }}{% endif %}).
</p>
</section>
{% endif %}

{# ============== SECTION 4: BANDWIDTH METRICS (#bandwidth) ============== #}
{% set bw_diag = relay.consensus_evaluation if relay.consensus_evaluation and relay.consensus_evaluation.available else none %}

<section id="bandwidth" class="section-box" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#bandwidth" class="anchor-link">Bandwidth Metrics</a>
    </div>
</h4>

<div class="row">
    {# Left Column: Relay-Reported Capacity #}
    <div class="col-md-6">
        <h5 class="subsection-header">Capacity (Relay-Reported)</h5>
        <dl>
            <dt title="Bandwidth capacity your relay measured and reported in its descriptor">Observed Bandwidth</dt>
            <dd>
                {% set obs_unit = relay['observed_bandwidth']|determine_unit(relays.use_bits) %}
                {{ relay['observed_bandwidth']|format_bandwidth_with_unit(obs_unit) }} {{ obs_unit }}
            </dd>
            
            <dt title="min(Observed, Rate, Burst) - what your relay advertises to the network">Advertised Bandwidth</dt>
            <dd>
                {% if relay['advertised_bandwidth'] %}
                    {% set adv_unit = relay['advertised_bandwidth']|determine_unit(relays.use_bits) %}
                    {{ relay['advertised_bandwidth']|format_bandwidth_with_unit(adv_unit) }} {{ adv_unit }}
                {% else %}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif %}
            </dd>
            
            <dt title="RelayBandwidthRate setting in torrc">Rate Limit</dt>
            <dd>
                {% if relay['bandwidth_rate'] %}
                    {% set rate_unit = relay['bandwidth_rate']|determine_unit(relays.use_bits) %}
                    {{ relay['bandwidth_rate']|format_bandwidth_with_unit(rate_unit) }} {{ rate_unit }}
                {% else %}
                    <span style="color: #6c757d;">Not set</span>
                {% endif %}
            </dd>
            
            <dt title="RelayBandwidthBurst setting in torrc">Burst Limit</dt>
            <dd>
                {% if relay['bandwidth_burst'] %}
                    {% set burst_unit = relay['bandwidth_burst']|determine_unit(relays.use_bits) %}
                    {{ relay['bandwidth_burst']|format_bandwidth_with_unit(burst_unit) }} {{ burst_unit }}
                {% else %}
                    <span style="color: #6c757d;">Not set</span>
                {% endif %}
            </dd>
        </dl>
    </div>
    
    {# Right Column: Authority-Measured #}
    <div class="col-md-6">
        <h5 class="subsection-header">Measurement (Authority-Verified)</h5>
        <dl>
            <dt title="How many bandwidth authorities measured this relay">Measured By</dt>
            <dd>
                {% if bw_diag and bw_diag.bandwidth_summary %}
                    <span style="color: {{ bw_diag.bandwidth_summary.bw_auth_color }}; font-weight: bold;">
                        {{ bw_diag.bandwidth_summary.bw_auth_measured_count }}/{{ bw_diag.bandwidth_summary.bw_auth_total }}
                    </span> BW Authorities
                {% elif relay['measured'] is not none %}
                    {% if relay['measured'] %}
                        <span style="color: #28a745; font-weight: bold;">Yes</span> (≥3 authorities)
                    {% else %}
                        <span style="color: #856404;">Not Yet Measured</span>
                    {% endif %}
                {% else %}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif %}
            </dd>
            
            {% if bw_diag and bw_diag.bandwidth_summary and bw_diag.bandwidth_summary.median_display %}
            <dt title="Median of measurements from bandwidth authorities">Median Measurement</dt>
            <dd>{{ bw_diag.bandwidth_summary.median_display }}</dd>
            
            <dt title="Range of measurements across authorities">Min / Max</dt>
            <dd>
                {{ bw_diag.bandwidth_summary.min_display|default('N/A') }} / {{ bw_diag.bandwidth_summary.max_display|default('N/A') }}
            </dd>
            
            {% if bw_diag.bandwidth_summary.deviation_class == 'warning' %}
            <dt title="Large variation in measurements across authorities">Deviation</dt>
            <dd>
                <span style="color: #856404;">{{ bw_diag.bandwidth_summary.deviation_display }}</span>
                <small style="color: #856404;">[Warning] High variation</small>
            </dd>
            {% endif %}
            {% endif %}
        </dl>
    </div>
</div>

{# Network Participation - Full width #}
<div style="margin-top: 12px; padding: 10px; background: #ffffff; border-radius: 4px; border: 1px solid #e9ecef;">
    <strong>Network Participation:</strong>
    <span title="Fraction of total network consensus weight.">
        Consensus Weight:
        {% if relay['consensus_weight_fraction'] %}
            {{ "%.4f"|format(relay['consensus_weight_fraction'] * 100) }}% of network
            {% if relay['consensus_weight'] %}
                <span style="color: #6c757d;">({{ "{:,}".format(relay['consensus_weight']) }})</span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;">N/A</span>
        {% endif %}
    </span>
    |
    <span title="Probability of being selected as guard">Guard: 
        {% if relay['guard_probability'] %}{{ "%.4f"|format(relay['guard_probability'] * 100) }}%{% else %}N/A{% endif %}</span> |
    <span title="Probability of being selected as middle">Middle: 
        {% if relay['middle_probability'] %}{{ "%.4f"|format(relay['middle_probability'] * 100) }}%{% else %}N/A{% endif %}</span> |
    <span title="Probability of being selected as exit">Exit: 
        {% if relay['exit_probability'] %}{{ "%.4f"|format(relay['exit_probability'] * 100) }}%{% else %}N/A{% endif %}</span>
    
    {% if relay['fingerprint'] in relays.json.smart_context.performance_correlation.template_optimized.underutilized_fingerprints %}
    <div style="margin-top: 8px; color: #856404;">
        <strong>[Warning] Underutilized:</strong> High bandwidth capacity but low consensus weight.
    </div>
    {% endif %}
</div>
</section>

{# ============== SECTION 5: UPTIME, STABILITY & OVERLOAD (#uptime) ============== #}
<section id="uptime" class="section-box" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#uptime" class="anchor-link">Uptime and Stability</a>
    </div>
</h4>

<div class="row">
    {# Left Column: Uptime Metrics #}
    <div class="col-md-6">
        <h5 class="subsection-header">Uptime Metrics</h5>
        <dl>
            <dt title="Current uptime or downtime duration based on relay's running status and last_restarted timestamp.">Current Status</dt>
            <dd>
                {% if relay.get('uptime_display') -%}
                    {% if relay['uptime_display'].startswith('DOWN') -%}
                        <span style="color: #dc3545; font-weight: bold;">{{ relay['uptime_display']|escape }}</span>
                    {% else -%}
                        <span style="color: #28a745;">{{ relay['uptime_display']|escape }}</span>
                    {% endif -%}
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>

            <dt title="{% if contact_display_data and contact_display_data.outliers and contact_display_data.outliers.tooltip %}{{ contact_display_data.outliers.tooltip }}{% else %}Percentage of time relay had Running flag over 1 Month / 6 Months / 1 Year / 5 Years. Source: Onionoo uptime API.{% endif %}">Overall Uptime (1M/6M/1Y/5Y)</dt>
            <dd>
                {% if relay.get('uptime_api_display') -%}
                    {{ relay['uptime_api_display']|safe }}
                {% else -%}
                    N/A
                {% endif -%}
            </dd>

            <dt title="{{ relay.get('flag_uptime_tooltip', 'Flag-specific uptime percentages showing reliability in primary network role.')|escape }}">Flag Uptime (1M/6M/1Y/5Y)</dt>
            <dd>
                {% if relay.get('flag_uptime_display') and relay['flag_uptime_display'] != 'N/A' -%}
                    {% if relay['flag_uptime_display'] == 'Match' -%}
                        <span title="{{ relay['flag_uptime_tooltip']|escape }}">Matches Overall Uptime</span>
                    {% else -%}
                        <span title="{{ relay['flag_uptime_tooltip']|escape }}">{{ relay['flag_uptime_display']|safe }}</span>
                    {% endif -%}
                {% else -%}
                    N/A
                {% endif -%}
            </dd>

            <dt title="Whether relay indicated it is hibernating in its last known server descriptor. Hibernation typically means the relay reached its accounting limit.">Hibernating</dt>
            <dd>
                {% if relay['hibernating'] is not none -%}
                    {% if relay['hibernating'] -%}
                        <span style="color: #856404; font-weight: bold;">Yes</span>
                        <span style="font-size: 11px; color: #666;">(relay reached accounting limit)</span>
                    {% else -%}
                        No
                    {% endif -%}
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>
        </dl>
    </div>

    {# Right Column: Timestamps #}
    <div class="col-md-6">
        <h5 class="subsection-header">Timestamps</h5>
        <dl>
            <dt title="Date relay first appeared in network consensus. Newer relays have restrictions (Guard flag requires ~8 days).">First Seen</dt>
            <dd>
                {% if relay['first_seen'] -%}
                    <a href="{{ page_ctx.path_prefix }}first_seen/{{ relay['first_seen'].split(' ', 1)[0]|escape }}/">{{ relay['first_seen']|format_time_ago }}</a>
                    <span style="font-size: 11px; color: #666;">({{ relay['first_seen']|escape }})</span>
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>

            <dt title="Most recent time this relay was seen in the network consensus.">Last Seen</dt>
            <dd>
                {% if relay['last_seen'] -%}
                    {{ relay['last_seen']|format_time_ago }}
                    <span style="font-size: 11px; color: #666;">({{ relay['last_seen']|escape }})</span>
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>

            <dt title="UTC timestamp when this relay was last (re-)started. Missing if router descriptor containing this information cannot be found.">Last Restarted</dt>
            <dd>
                {% if relay['last_restarted'] -%}
                    {{ relay['last_restarted']|format_time_ago }}
                    <span style="font-size: 11px; color: #666;">({{ relay['last_restarted']|escape }})</span>
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>

            <dt title="UTC timestamp when this relay last stopped announcing an IPv4/IPv6 address or TCP port. Can indicate relay stability as a fallback directory.">Last Changed Address</dt>
            <dd>
                {% if relay['last_changed_address_or_port'] -%}
                    {{ relay['last_changed_address_or_port']|escape }}
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>
        </dl>
    </div>
</div>

{# ---- Overload Status Subsection (anchor target for Health Status Stability row) ---- #}
{# Health Status "Stability" row links here via <a href="#overload"> (line 194) #}
<span id="overload"></span>

{% set is_overloaded = relay.get('stability_is_overloaded', false) %}
{% set general_ts = relay.get('overload_general_timestamp') %}
{% set ratelimits = relay.get('overload_ratelimits') %}
{% set fd_exhausted = relay.get('overload_fd_exhausted') %}

{% if not is_overloaded %}
{# Not overloaded: compact single line #}
<div style="margin-top: 12px; padding: 10px; background: #d4edda; border-radius: 4px; border-left: 3px solid #28a745;">
    <strong style="color: #155724;">Overload Status:</strong>
    <span style="color: #155724;">Not Overloaded — No overload conditions reported.</span>
    {% if relay.get('stability_tooltip') and 'Last general overload' in relay.get('stability_tooltip', '') %}
    <span style="color: #155724; font-size: 12px;"> ({{ relay['stability_tooltip'] }})</span>
    {% endif %}
</div>

{% else %}
{# Overloaded: expanded detail view with all 3 fields + recommendations #}
<div style="margin-top: 12px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
    <div style="margin-bottom: 12px;">
        <strong style="color: #856404; font-size: 15px;">[Warning] OVERLOADED</strong>
        <span style="color: #856404; font-size: 13px;"> — {{ relay.get('stability_tooltip', '') }}</span>
    </div>
    
    <div class="row">
        {# Left: General Overload + File Descriptors #}
        <div class="col-md-6">
            <h5 style="margin-top: 0; font-size: 13px; font-weight: bold;">General Overload <small style="color: #6c757d;">(from /details)</small></h5>
            <dl>
                <dt>Status</dt>
                <dd>
                    {% if general_ts %}
                        <span style="color: #dc3545; font-weight: bold;">Reported</span>
                    {% else %}
                        <span style="color: #28a745;">Not Reported</span>
                    {% endif %}
                </dd>
                {% if general_ts %}
                <dt>When</dt>
                <dd>{{ general_ts|format_timestamp }} UTC ({{ general_ts|format_timestamp_ago }})</dd>
                {% endif %}
            </dl>
            <p style="font-size: 11px; color: #6c757d; margin-top: 3px;">
                OOM killer, onionskin queue saturation, or TCP port exhaustion.
                Flag remains 72h after last event (Tor spec 328).
            </p>
            
            <h5 style="font-size: 13px; font-weight: bold;">File Descriptor Exhaustion <small style="color: #6c757d;">(from /bandwidth)</small></h5>
            <dl>
                <dt>Status</dt>
                <dd>
                    {% if fd_exhausted %}
                        <span style="color: #dc3545; font-weight: bold;">Reported</span>
                        {% if fd_exhausted.get('timestamp') %}
                         — {{ fd_exhausted['timestamp']|format_timestamp }} UTC ({{ fd_exhausted['timestamp']|format_timestamp_ago }})
                        {% endif %}
                    {% else %}
                        <span style="color: #28a745;">Not Reported</span>
                    {% endif %}
                </dd>
            </dl>
        </div>
        
        {# Right: Rate Limits + Recommendations #}
        <div class="col-md-6">
            <h5 style="margin-top: 0; font-size: 13px; font-weight: bold;">Rate Limits <small style="color: #6c757d;">(from /bandwidth)</small></h5>
            {% if ratelimits %}
            <dl>
                <dt>Rate Limit</dt>
                <dd>
                    {% set rate_unit = ratelimits.get('rate-limit', 0)|determine_unit(relays.use_bits) %}
                    {{ ratelimits.get('rate-limit', 0)|format_bandwidth_with_unit(rate_unit) }} {{ rate_unit }}
                </dd>
                <dt>Burst Limit</dt>
                <dd>
                    {% set burst_unit = ratelimits.get('burst-limit', 0)|determine_unit(relays.use_bits) %}
                    {{ ratelimits.get('burst-limit', 0)|format_bandwidth_with_unit(burst_unit) }} {{ burst_unit }}
                </dd>
                <dt>Write Limit Hit</dt>
                <dd>
                    {% if ratelimits.get('write-count', 0) > 0 %}
                        <span style="color: #dc3545; font-weight: bold;">{{ "{:,}".format(ratelimits.get('write-count', 0)) }} times</span>
                    {% else %}
                        <span style="color: #28a745;">0 times</span>
                    {% endif %}
                </dd>
                <dt>Read Limit Hit</dt>
                <dd>
                    {% if ratelimits.get('read-count', 0) > 0 %}
                        <span style="color: #dc3545; font-weight: bold;">{{ "{:,}".format(ratelimits.get('read-count', 0)) }} times</span>
                    {% else %}
                        <span style="color: #28a745;">0 times</span>
                    {% endif %}
                </dd>
                {% if ratelimits.get('timestamp') %}
                <dt>Last Reported</dt>
                <dd>{{ ratelimits['timestamp']|format_timestamp_ago }}</dd>
                {% endif %}
            </dl>
            {% else %}
            <p style="color: #6c757d;">No rate limit data from /bandwidth endpoint.</p>
            {% endif %}
            
            <h5 style="font-size: 13px; font-weight: bold;">Recommendations</h5>
            <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                {% if general_ts %}
                <li>Check CPU/memory: <code>htop</code></li>
                <li>Review <code>MaxMemInQueues</code> in torrc</li>
                {% endif %}
                {% if ratelimits and (ratelimits.get('write-count', 0) > 0 or ratelimits.get('read-count', 0) > 0) %}
                <li>Consider increasing <code>RelayBandwidthRate</code></li>
                <li>Check if ISP is throttling traffic</li>
                {% endif %}
                {% if fd_exhausted %}
                <li>Increase FD limit: <code>ulimit -n 65535</code></li>
                <li>systemd: <code>LimitNOFILE=65535</code> in [Service]</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
{% endif %}

</section>

{# ============== SECTION 6: OPERATOR AND FAMILY (#operator) ============== #}
<section id="operator" class="section-box" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#operator" class="anchor-link">Operator and Family</a>
    </div>
</h4>

<div class="row">
{# Left Column: Operator (AROI) #}
<div class="col-md-6">
<h5 class="subsection-header">Operator Identity</h5>
<dl>
    <dt>AROI Domain</dt>
    <dd>
        {% if relay['aroi_domain'] and relay['aroi_domain'] != 'none' -%}
            {% if base_url and relay['aroi_domain'] in validated_aroi_domains -%}
                <a href="{{ base_url }}/{{ relay['aroi_domain']|lower|escape }}/">{{ relay['aroi_domain']|escape }}</a>
            {% else -%}
                <a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/">{{ relay['aroi_domain']|escape }}</a>
            {% endif -%}
        {% else -%}
            Not specified
        {% endif -%}
    </dd>
    
    {% if contact_validation_status and contact_validation_status.validation_summary -%}
    <dt>Operator Validation</dt>
    <dd>
        {% set vs = contact_validation_status.validation_summary -%}
        {% set cvs_status = contact_validation_status.validation_status -%}
        {% if cvs_status == 'validated' -%}
            <span style="color: #28a745;" title="All {{ vs.validated_count }} relays have valid AROI proof">
                Validated ({{ vs.validated_count }}/{{ vs.total_relays }} relays)</span>
        {% elif cvs_status == 'partially_validated' -%}
            <span style="color: #ffc107;" title="{{ vs.validated_count }} of {{ vs.total_relays }} relays have valid proof">
                Partially Validated ({{ vs.validated_count }}/{{ vs.total_relays }} relays)</span>
        {% else -%}
            <span style="color: #dc3545;" title="No relays have AROI validation proof">Unvalidated</span>
        {% endif -%}
    </dd>
    
    <dt>This Relay</dt>
    <dd>
        {% set this_fp = relay['fingerprint'] -%}
        {% if this_fp in contact_validation_status.validated_fingerprints -%}
            <span style="color: #28a745;" title="This relay's fingerprint found in AROI proof">Validated</span>
            {% for vr in contact_validation_status.validated_relays if vr.fingerprint == this_fp -%}
                <span style="font-size: 11px; color: #666;">({{ vr.proof_type }})</span>
            {% endfor -%}
        {% elif relay['aroi_domain'] and relay['aroi_domain'] != 'none' -%}
            <span style="color: #dc3545;" title="AROI configured but fingerprint not in proof">Unvalidated</span>
            {% for ur in contact_validation_status.unvalidated_relays if ur.fingerprint == this_fp -%}
                <span style="font-size: 11px; color: #856404;">({{ ur.error }})</span>
            {% endfor -%}
        {% else -%}
            <span style="color: #6c757d;">N/A (no AROI configured)</span>
        {% endif -%}
    </dd>
    {% endif -%}
    
    <dt>Contact</dt>
    <dd style="word-wrap: break-word; word-break: break-all; max-width: 100%;">
        {% if relay['contact'] -%}
            <a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/">{{ relay['contact']|escape }}</a>
        {% else -%}
            <a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/">none</a>
        {% endif -%}
    </dd>
</dl>
</div>

{# Right Column: Family (fingerprint-based) #}
<div class="col-md-6">
<h5 class="subsection-header">Family Configuration</h5>
<dl>
    <dt>Effective Family</dt>
    <dd>
        {{ relay['effective_family']|length }} relay{% if relay['effective_family']|length != 1 %}s{% endif %}
        {% if relay['effective_family']|length > 1 %}
            (<a href="{{ page_ctx.path_prefix }}family/{{ relay['fingerprint']|escape }}/">View Family Page</a>)
        {% endif %}
        <pre class="pre-scrollable" style="max-height: 100px; font-size: 11px; margin-top: 5px;">{% for fp in relay['effective_family'] -%}
{% if relay['effective_family']|length > 1 and fp != relay['fingerprint'] -%}
<a href="../{{ fp|escape }}/">{{ fp|escape }}</a>
{% else -%}
{{ fp|escape }}{% if fp == relay['fingerprint'] %} (this relay){% endif %}
{% endif -%}
{% endfor -%}</pre>
    </dd>
    
    <dt>Alleged Family</dt>
    <dd>
        {{ relay['alleged_family']|length if relay['alleged_family'] else 0 }} relay{% if not relay['alleged_family'] or relay['alleged_family']|length != 1 %}s{% endif %}
        {% if relay['alleged_family'] %}
        <span style="color: #856404; font-size: 11px;">(they don't list you back)</span>
        <pre class="pre-scrollable" style="max-height: 60px; font-size: 11px; margin-top: 5px;">{% for fp in relay['alleged_family'] -%}
<a href="../{{ fp|escape }}/">{{ fp|escape }}</a>
{% endfor -%}</pre>
        {% endif %}
    </dd>
    
    <dt>Indirect Family</dt>
    <dd>
        {{ relay['indirect_family']|length if relay['indirect_family'] else 0 }} relay{% if not relay['indirect_family'] or relay['indirect_family']|length != 1 %}s{% endif %}
        {% if relay['indirect_family'] %}
        <span style="color: #856404; font-size: 11px;">(they list you, you don't list them)</span>
        <pre class="pre-scrollable" style="max-height: 60px; font-size: 11px; margin-top: 5px;">{% for fp in relay['indirect_family'] -%}
<a href="../{{ fp|escape }}/">{{ fp|escape }}</a>
{% endfor -%}</pre>
        {% endif %}
    </dd>
</dl>
</div>
</div>
</section>

{# ============== SECTION 7: SOFTWARE AND VERSION (#software) ============== #}
<section id="software" class="section-box" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#software" class="anchor-link">Software and Version</a>
    </div>
</h4>

<dl>
    <dt title="Simplified platform identifier for categorization">Platform</dt>
    <dd>
        <a href="{{ page_ctx.path_prefix }}platform/{{ relay['platform']|escape }}/" title="View all relays on this platform">{{ relay['platform']|escape }}</a>
        {% if relay['platform_raw'] and relay['platform_raw'] != relay['platform'] -%}
            <span style="font-size: 12px; color: #666;"> — {{ relay['platform_raw']|escape }}</span>
        {% endif -%}
    </dd>

    <dt title="Tor software version. Outdated versions may have security vulnerabilities and could be rejected by the network.">Version</dt>
    <dd>
        {% if relay['version'] -%}
            <span>{{ relay['version']|escape }}</span>
            {% if relay['recommended_version'] is not none -%}
                {% if relay['recommended_version'] -%}
                    — <span style="color: #28a745; font-weight: bold;" title="This Tor version is on the recommended list.">Recommended</span>
                {% else -%}
                    — <span style="color: #dc3545; font-weight: bold;" title="This Tor version is NOT recommended. Update to the latest stable version.">Not Recommended</span>
                {% endif -%}
            {% endif -%}
        {% else -%}
            <span style="color: #6c757d;">Unknown</span>
        {% endif -%}
    </dd>

    {% if relay['version_status'] %}
    <dt title="Version status as determined by directory authorities: recommended, experimental, obsolete, new in series, unrecommended">Version Status</dt>
    <dd>
        {% if relay['version_status'] == 'recommended' -%}
            <span style="color: #28a745;">{{ relay['version_status']|escape }}</span>
        {% elif relay['version_status'] == 'obsolete' -%}
            <span style="color: #dc3545; font-weight: bold;">{{ relay['version_status']|escape }}</span>
            <span style="font-size: 11px; color: #666;"> — Update urgently. See <a href="https://www.torproject.org/download/tor/" target="_blank" rel="noopener">torproject.org/download</a></span>
        {% elif relay['version_status'] == 'experimental' -%}
            <span style="color: #856404;">{{ relay['version_status']|escape }}</span>
        {% else -%}
            <span style="color: #6c757d;">{{ relay['version_status']|escape }}</span>
        {% endif -%}
    </dd>
    {% endif %}
</dl>
</section>

{# ============== SECTION 8: EXIT POLICY (#exit-policy) ============== #}
<section id="exit-policy" class="section-box" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#exit-policy" class="anchor-link">Exit Policy</a>
    </div>
</h4>

<div class="row">
    {# IPv4 Exit Policy Summary #}
    <div class="col-md-6">
        <h5 class="subsection-header">IPv4 Exit Policy Summary</h5>
        {% if relay['exit_policy_summary'] -%}
            <pre class="pre-scrollable" style="max-height: 150px; font-size: 12px;">{% for k, v in relay['exit_policy_summary'].items() -%}
{{ k|escape }}: {{ '\n  ' + v|join('\n  ')|escape }}
{% endfor -%}</pre>
        {% else -%}
            <span style="color: #6c757d;">None</span>
        {% endif -%}
    </div>

    {# IPv6 Exit Policy Summary #}
    <div class="col-md-6">
        <h5 class="subsection-header">IPv6 Exit Policy Summary</h5>
        {% if relay['exit_policy_v6_summary'] -%}
            <pre class="pre-scrollable" style="max-height: 150px; font-size: 12px;">{% for k, v in relay['exit_policy_v6_summary'].items() -%}
{{ k|escape }}: {{ '\n  ' + v|join('\n  ')|escape }}
{% endfor -%}</pre>
        {% else -%}
            <span style="color: #6c757d;">None</span>
        {% endif -%}
    </div>
</div>

{# Full Exit Policy #}
<div style="margin-top: 10px;">
    <h5 class="subsection-header">Full Exit Policy</h5>
    <pre class="pre-scrollable" style="max-height: 200px; font-size: 12px;">{% for policy in relay['exit_policy'] -%}
{{ policy|escape }}
{% endfor -%}</pre>
</div>
</section>

<p>Last fetch was at {{ relays.timestamp }}.</p>

{# Consensus Evaluation Section - Shows per-authority voting information #}
{% if relay.consensus_evaluation and relay.consensus_evaluation.available %}
{% set diag = relay.consensus_evaluation %}
{% set rv = diag.relay_values %}
<div class="row" style="margin-top: 20px;">
<div class="col-md-12">
<h3 id="consensus-evaluation">
<div class="section-header">
<a href="#consensus-evaluation" class="anchor-link">Consensus Evaluation</a>
</div>
</h3>
<p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">
Data from <a href="https://collector.torproject.org/recent/relay-descriptors/votes/" target="_blank" rel="noopener">Tor CollecTor</a> (authority votes{% if relays.collector_fetched_at %}, fetched {{ relays.collector_fetched_at.replace('T', ' ').split('.')[0] }}{% endif %}).
</p>

{# Check if relay has IPv6 address - use namespace for proper scoping #}
{% set ns = namespace(has_ipv6=false) %}
{% for addr in relay.or_addresses|default([]) %}
    {% if '[' in addr %}{% set ns.has_ipv6 = true %}{% endif %}
{% endfor %}
{% set has_ipv6 = ns.has_ipv6 %}

{# Condensed Status, Flag Eligibility, Reachability, and Issues - all as bullets #}
<ul style="margin-bottom: 15px; padding-left: 20px; font-size: 13px;">
    {# 1. Consensus Status #}
    <li><strong>Consensus Status</strong> <span style="color: #6c757d; font-size: 10px;">(need ≥{{ diag.majority_required }}/{{ diag.total_authorities }})</span><strong>:</strong> 
        {% if diag.in_consensus %}
            <span style="color: #28a745; font-weight: bold;">In Consensus</span>
        {% else %}
            <span style="color: #dc3545; font-weight: bold;">Not In Consensus</span>
        {% endif %}
        — {{ diag.vote_count }}/{{ diag.total_authorities }} authorities voted.
    </li>
    
    {# 2. Flag Eligibility - Reuse pre-computed efd.flags (DRY optimization) #}
    <li><strong>Flag Eligibility</strong> <span style="color: #6c757d; font-size: 10px;">(need ≥{{ diag.majority_required }}/{{ diag.total_authorities }} for flag)</span>:
        {% for flag in efd.flags %}<span style="color: {{ flag.color }}; font-weight: bold;">{{ flag.name }}: {{ flag.count }}/{{ flag.total }}</span>{% if not loop.last %} | {% endif %}{% endfor %}
    </li>
    
    {# 3. Reachability #}
    {% if diag.reachability_summary %}
    <li><strong>Reachability:</strong>
        IPv4: <span style="color: {% if diag.reachability_summary.ipv4.status_class == 'success' %}#28a745{% else %}#dc3545{% endif %}; font-weight: bold;">{{ diag.reachability_summary.ipv4.reachable_count }}/{{ diag.reachability_summary.ipv4.total }}</span>
        {% if has_ipv6 %}
        | IPv6: <span style="color: {% if diag.reachability_summary.ipv6.status_class == 'success' %}#28a745{% elif diag.reachability_summary.ipv6.status_class == 'muted' %}#6c757d{% else %}#dc3545{% endif %}; font-weight: bold;">{{ diag.reachability_summary.ipv6.reachable_count }}/{{ diag.reachability_summary.ipv6.total }}</span>{% if diag.reachability_summary.ipv6.not_tested %} <span style="color: #6c757d;">({{ diag.reachability_summary.ipv6.not_tested|length }} don't test)</span>{% endif %}
        {% endif %}
    </li>
    {% endif %}
    
    {# 4. Consensus Weight (Authority Measured) #}
    {% if diag.bandwidth_summary and diag.bandwidth_summary.median is not none %}
    <li><strong>Consensus Weight</strong> <span style="color: #6c757d; font-size: 10px;">(Dir. Auth.)</span><strong>:</strong>
        <span title="Tor consensus uses median of authority measurements for path selection. This is a scaled value used for traffic distribution.">Median: {{ diag.bandwidth_summary.median_display }} | Min: {{ diag.bandwidth_summary.min_display }} | Max: {{ diag.bandwidth_summary.max_display }}</span>
        {% if diag.bandwidth_summary.deviation_class == 'warning' %}<span style="color: #856404;"> [Warning] High deviation</span>{% endif %}
    </li>
    {% endif %}
    
    {# 4. Identified Issues #}
    {# Use new diagnostics if available (includes overload issues), fallback to consensus_evaluation #}
    {% set section_issues = relay.diagnostics.issues if relay.diagnostics else (diag.issues if diag else []) %}
    {% set real_issues = section_issues | selectattr('severity', 'ne', 'info') | list %}
    {% set info_notes = section_issues | selectattr('severity', 'equalto', 'info') | list %}
    {% if real_issues %}
    <li><strong>Identified Issues:</strong>
        <ul style="margin: 3px 0; padding-left: 15px;">
        {% for issue in real_issues %}
            <li>
                <span style="color: {% if issue.severity == 'error' %}#dc3545{% else %}#856404{% endif %};">{{ issue.title }}</span>: {{ issue.description|safe }}
                {% if issue.suggestion %}
                <ul style="margin: 2px 0; padding-left: 15px;"><li style="color: #666; font-size: 12px;"><strong>Suggestion:</strong> {{ issue.suggestion|safe }}</li></ul>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    </li>
    {% endif %}
    {% if info_notes %}
    <li><strong>Notes:</strong>
        <ul style="margin: 3px 0; padding-left: 15px;">
        {% for note in info_notes %}
            <li><span style="color: #17a2b8;">{{ note.title }}</span>: {{ note.description }}</li>
        {% endfor %}
        </ul>
    </li>
    {% endif %}
</ul>

{# ============== TABLE 2: PER-AUTHORITY DETAILS (Diagnosis) ============== #}
<h4 id="authority-votes" style="margin-top: 15px;">
<div class="section-header">
<a href="#authority-votes" class="anchor-link">Per-Authority Details</a>
</div>
</h4>
<p class="text-muted" style="font-size: 11px; margin-bottom: 8px;">
Each cell shows: <strong>your measured value | authority threshold</strong>. 
<span style="color: #28a745;">Green</span> = meets, <span style="color: #dc3545;">red</span> = below.
Flags: <span style="color: #28a745; font-weight: bold;">green</span> = all authorities agree, <span style="color: #856404; font-weight: bold;">yellow</span> = partial.
</p>
<div style="overflow-x: auto; overflow-y: visible; padding-top: 60px; margin-top: -50px;">
<table class="table table-condensed table-striped" style="font-size: 11px;">
<thead>
<tr>
    <th title="Source: Onionoo | Authority nickname (relay with Authority flag) with country code">Authority</th>
    <th title="Source: CollecTor | File: vote | Field: 's' line contains 'Running' | Authority voted for this relay (could reach it via OR port)">Running</th>
    <th title="Source: CollecTor | File: vote | Field: 's' line contains 'Valid' | Relay is not blacklisted and has valid descriptor">Valid</th>
    <th title="Source: CollecTor | File: vote | Field: 's' line contains 'Exit' | Authority assigned Exit flag based on relay's exit policy allowing ≥1 /8 on ports 80+443">Exit</th>
    <th title="Source: CollecTor | File: vote | Field: 's' line contains 'MiddleOnly' | Relay restricted to middle position only. Removes Exit, Guard, HSDir, V2Dir flags. Assigned for suspicious behavior or Sybil risk.">MiddleOnly</th>
    <th title="Source: CollecTor | File: vote | Field: bandwidth-file-headers | Does this authority run sbws bandwidth scanner? 6 of 9 authorities measure bandwidth; 3 use relay-reported values.">BW Scan (Authority)</th>
    <th title="Source: CollecTor | File: vote | Presence of 'r' line = IPv4 reachable">v4</th>
    {% if has_ipv6 %}<th title="Source: CollecTor | File: vote | Field: 'a' line | IPv6 reachable | N/T = not tested by this authority">v6</th>{% endif %}
    <th title="Source: CollecTor | File: vote | Field: 's' line | Flags assigned by this authority">Flags</th>
    <th title="Source: Onionoo observed_bandwidth (Relay Reported) | CollecTor flag-thresholds fast-speed (Authority Threshold) | Fast flag: top 7/8ths OR ≥100 KB/s">Fast (Relay|T)</th>
    <th title="Source: Onionoo observed_bandwidth (Relay Reported) | CollecTor flag-thresholds guard-bw-inc-exits (Authority Threshold) | Guard BW: ≥2 MB/s OR top 25%">Guard BW (Relay|Threshold)</th>
    <th title="Source: CollecTor | File: vote | Field: stats wfu=X, flag-thresholds guard-wfu=X | Guard WFU: Measured | Threshold">Guard WFU (M|T)</th>
    <th title="Source: CollecTor | File: vote | Field: stats tk=X, flag-thresholds guard-tk=X | Guard TK: Measured | Threshold">Guard TK (M|T)</th>
    <th title="Source: CollecTor | File: vote | Field: stats mtbf=X, flag-thresholds stable-mtbf=X | Stable MTBF: Authority-measured MTBF | Authority's threshold">Stable MTBF (M|T)</th>
    <th title="Source: Onionoo last_restarted (Relay Reported) | CollecTor flag-thresholds stable-uptime (Authority Threshold) | Stable Uptime: Relay's uptime from descriptor | Authority's threshold. Two different data sources.">Stable Uptime (Relay|T)</th>
    <th title="Source: CollecTor | File: vote | Field: stats wfu=X, flag-thresholds hsdir-wfu=X | HSDir WFU: Measured | Threshold">HSDir WFU (M|T)</th>
    <th title="Source: CollecTor | File: vote | Field: stats tk=X, flag-thresholds hsdir-tk=X | HSDir TK: Measured | Threshold">HSDir TK (M|T)</th>
    <th title="Source: CollecTor | File: vote | Field: 'r' line timestamp | Descriptor Published timestamp">Desc Published</th>
    <th title="Source: CollecTor | File: vote | Field: 'w Bandwidth=X' | Authority-measured consensus weight (scaled) used for path selection. Authorities measure actual throughput; 10 KB/s = default when relay-reported bandwidth is used instead.">Cons Wt (Authority)</th>
</tr>
</thead>
<tbody>
{% for vote in diag.authority_table %}
<tr class="{% if not vote.voted %}row-not-voted{% endif %}">
    <td>
        {% if vote.fingerprint %}
        <a href="{{ page_ctx.path_prefix }}relay/{{ vote.fingerprint }}/" style="text-decoration: underline;">
            <strong>{{ vote.authority_display|default(vote.authority) }}</strong>
        </a>
        {% else %}
        <strong>{{ vote.authority_display|default(vote.authority) }}</strong>
        {% endif %}
    </td>
    {# Running: Did this authority vote for this relay (i.e., could it reach the relay)? #}
    <td>
        {% if vote.voted %}
            <span style="color: #28a745;" title="Authority voted for this relay (Running)">Yes</span>
        {% else %}
            <span style="color: #dc3545;" title="Authority did NOT vote for this relay (not reachable)">No</span>
        {% endif %}
    </td>
    {# Valid: Relay has Valid flag from this authority #}
    <td>
        {% if vote.voted and vote.flags %}
            {% if 'Valid' in vote.flags %}
                <span style="color: #28a745;" title="Relay is Valid (verified, allowed in network)">Yes</span>
            {% else %}
                <span style="color: #dc3545;" title="Relay does NOT have Valid flag">No</span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# Exit: Authority assigned Exit flag based on exit policy #}
    <td>
        {% if vote.voted and vote.flags %}
            {% if 'Exit' in vote.flags %}
                <span style="color: #28a745;" title="Authority assigned Exit flag - relay's exit policy meets requirements (≥1 /8 on ports 80+443)">Yes</span>
            {% else %}
                <span style="color: #6c757d;" title="Authority did not assign Exit flag - relay's exit policy does not meet Exit requirements">No</span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# MiddleOnly: Authority assigned MiddleOnly flag (restricts to middle position) #}
    <td>
        {% if vote.voted and vote.flags %}
            {% if 'MiddleOnly' in vote.flags %}
                <span style="color: #dc3545;" title="Authority assigned MiddleOnly flag - relay restricted to middle position only. Removes Exit, Guard, HSDir, V2Dir flags.">Yes</span>
            {% else %}
                <span style="color: #6c757d;">—</span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    <td>
        {% if vote.is_bw_authority %}
            <span style="color: #28a745;">Y</span>
        {% else %}
            <span style="color: #6c757d;">N</span>
        {% endif %}
    </td>
    <td>
        {% if vote.ipv4_reachable %}
            <span style="color: #28a745;">Yes</span>
        {% else %}
            <span style="color: #dc3545;">No</span>
        {% endif %}
    </td>
    {% if has_ipv6 %}
    <td>
        {% if vote.ipv6_reachable == true %}
            <span style="color: #28a745;">Yes</span>
        {% elif vote.ipv6_reachable == false %}
            <span style="color: #dc3545;">No</span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {% endif %}
    <td style="max-width: 180px; word-wrap: break-word; font-size: 10px;">
        {% if vote.flags_with_consensus %}
            {% for flag_info in vote.flags_with_consensus %}
                {%- if flag_info.unanimous -%}
                    <span style="color: #28a745; font-weight: bold;">{{ flag_info.name }}</span>
                {%- elif flag_info.partial -%}
                    <span style="color: #856404; font-weight: bold;">{{ flag_info.name }}</span>
                {%- else -%}
                    {{ flag_info.name }}
                {%- endif -%}
                {%- if not loop.last %}, {% endif -%}
            {% endfor %}
        {% elif vote.flags %}
            {{ vote.flags_display }}
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# Fast: observed BW | fast-speed threshold #}
    <td>
        {% if vote.voted and vote.fast_threshold_display %}
            <span style="color: {% if vote.fast_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Measured: {{ vote.fast_speed_display }} | Threshold (7/8ths): {{ vote.fast_threshold_display }} | {% if vote.fast_meets %}MEETS{% else %}BELOW{% endif %}">
                {{ vote.fast_speed_display }} | {{ vote.fast_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# Guard BW: observed BW | top 25% threshold | 2 MB/s min #}
    <td>
        {% if vote.voted and vote.guard_bw_guarantee_display %}
            <span style="color: {% if vote.guard_bw_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Measured: {{ vote.guard_bw_value_display }} | Top 25%: {{ vote.guard_bw_top25_display }} | Min: {{ vote.guard_bw_guarantee_display }} | {% if vote.guard_bw_meets_guarantee %}MEETS (≥2 MB/s){% elif vote.guard_bw_in_top25 %}MEETS (top 25%){% else %}BELOW{% endif %}">
                {{ vote.guard_bw_value_display }} | {{ vote.guard_bw_top25_display }} OR {{ vote.guard_bw_guarantee_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# WFU: measured | threshold #}
    <td>
        {% if vote.voted and vote.wfu is not none %}
            <span style="color: {% if vote.wfu_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your WFU: {{ vote.wfu_display }} | Threshold: {{ vote.wfu_threshold_display }}">
                {{ vote.wfu_display }} | {{ vote.wfu_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# TK: measured | threshold #}
    <td>
        {% if vote.voted and vote.tk is not none %}
            <span style="color: {% if vote.tk_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your TK: {{ vote.tk_display }} | Threshold: {{ vote.tk_threshold_display }}">
                {{ vote.tk_display }} | {{ vote.tk_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# Stable MTBF: measured MTBF | threshold #}
    <td>
        {% if vote.voted and vote.stable_threshold %}
            <span style="color: {% if vote.stable_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your MTBF: {{ vote.stable_mtbf_display }} | Threshold: {{ vote.stable_threshold_display }} | Note: Actual flag assignment may differ">
                {{ vote.stable_mtbf_display }} | {{ vote.stable_threshold_display }}
            </span>
        {% elif vote.voted and vote.stable_mtbf %}
            {{ vote.stable_mtbf_display }} | <span style="color: #6c757d;">—</span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# Stable Uptime: relay uptime (Onionoo) | authority threshold (CollecTor) #}
    {# Note: Relay uptime is the SAME for all authorities (self-reported from descriptor) #}
    {# Only the threshold varies per authority #}
    <td>
        {% if vote.voted and vote.stable_uptime_threshold %}
            {% if vote.stable_uptime_meets is not none %}
                <span style="color: {% if vote.stable_uptime_meets %}#28a745{% else %}#dc3545{% endif %};"
                      title="Relay Uptime (Onionoo): {{ vote.stable_uptime_display }} | Authority Threshold (CollecTor): {{ vote.stable_uptime_threshold_display }} | Note: Data from two sources">
                    {{ vote.stable_uptime_display }} | {{ vote.stable_uptime_threshold_display }}
                </span>
            {% else %}
                <span style="color: #6c757d;" title="Relay uptime not available from Onionoo">
                    N/A | {{ vote.stable_uptime_threshold_display }}
                </span>
            {% endif %}
        {% elif vote.voted and vote.stable_uptime is not none %}
            <span title="Relay Uptime (Onionoo): {{ vote.stable_uptime_display }} | Authority threshold not set">
                {{ vote.stable_uptime_display }} | <span style="color: #6c757d;">—</span>
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# HSDir WFU: measured | threshold (same as guard WFU, 98%) #}
    <td>
        {% if vote.voted and vote.wfu is not none %}
            <span style="color: {% if vote.wfu >= 0.98 %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your WFU: {{ vote.wfu_display }} | Threshold: ≥98% for HSDir">
                {{ vote.wfu_display }} | 98.0%
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# HSDir TK: measured | threshold (25h dir-spec default; moria1 uses ~10 days) #}
    <td>
        {% if vote.voted and vote.hsdir_tk_threshold %}
            <span style="color: {% if vote.hsdir_tk_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your TK: {{ vote.hsdir_tk_value_display }} | Threshold: {{ vote.hsdir_tk_threshold_display }}">
                {{ vote.hsdir_tk_value_display }} | {{ vote.hsdir_tk_threshold_display }}
            </span>
        {% elif vote.voted and vote.tk %}
            {{ vote.tk_display }} | <span style="color: #6c757d;">—</span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    
    {# Descriptor Published: timestamp - Red if StaleDesc flag, Green if fresh #}
    <td>
        {% if vote.voted %}
            {% if vote.has_staledesc %}
                <span style="color: #8b0000; font-weight: bold;" title="StaleDesc flag assigned - descriptor is >18 hours old. This is a negative flag.">
                    {{ vote.descriptor_published|default('N/A') }} [Stale]
                </span>
            {% else %}
                <span style="color: #28a745;" title="Descriptor is fresh (no StaleDesc flag)">
                    {{ vote.descriptor_published|default('N/A') }}
                </span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    
    {# Consensus Weight: scaled value for path selection (moved to end) #}
    <td>
        {% if vote.voted and vote.measured %}
            <span title="Scaled consensus weight: {{ vote.measured }} (for traffic distribution). 10 KB/s = default when authority uses relay's advertised BW.">
                {{ vote.measured_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<p style="font-size: 10px; color: #666; margin-top: 5px;">
— = not tested/available • Format: relay value | authority threshold • WFU = Weighted Fractional Uptime • TK = Time Known
</p>

<div style="font-size: 11px; color: #555; margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;">
<strong>Bandwidth Values Explained:</strong><br>
<strong>Relay Reported</strong> = Your relay's self-reported bandwidth from its descriptor (observed_bandwidth). Used for <em>flag eligibility</em> (Guard, Fast).<br>
<strong>Authority Measured</strong> = Bandwidth measured by authority's sbws scanner. Used for <em>consensus weight</em> (path selection probability).<br>
<em>Why different?</em> Authorities verify your reported bandwidth independently. 6 of 9 authorities run bandwidth scanners; 3 use relay-reported values directly.
</div>

<div style="font-size: 11px; color: #555; margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #17a2b8;">
<strong>Stable Uptime (Two Data Sources):</strong><br>
<strong>Relay Uptime</strong> = From <em>Onionoo API</em> (last_restarted field). This is your relay's self-reported uptime from its descriptor. Same value for all authorities.<br>
<strong>Authority Threshold</strong> = From <em>CollecTor vote files</em> (flag-thresholds stable-uptime). Each authority may have different thresholds.<br>
<em>Why two sources?</em> Vote files contain authority thresholds but not per-relay uptime values. Onionoo aggregates relay descriptors which include uptime.
</div>

</div>
</div>
{% endif %}

</div>
{% endblock -%}

