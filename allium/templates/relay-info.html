{% extends "skeleton.html" -%}
{% from "macros.html" import navigation, aroi_validation_badge %}
{% block title -%}
	Tor Relays :: {{ relay['nickname']|escape }}
{% endblock -%}
{% block body -%}
<style>
.section-header {
    position: relative;
    display: inline-block;
}

.anchor-link {
    text-decoration: none;
    color: inherit;
}







/* Highlight section when targeted */
:target {
    background-color: rgba(255, 193, 7, 0.2);
    padding: 8px;
    border-radius: 4px;
    margin: -8px;
    transition: background-color 0.3s;
}

/* Health Status Grid Layout */
.health-status-grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr;  /* 60/40 split */
    gap: 8px 24px;
}

.health-status-grid dl {
    margin: 0;
    font-size: 14px;
}

.health-status-grid .health-row {
    display: flex;
    align-items: baseline;
    margin-bottom: 8px;
}

.health-status-grid dt {
    width: 100px;
    font-weight: bold;
    color: #495057;
    flex-shrink: 0;
}

.health-status-grid dd {
    margin: 0;
    flex: 1;
}

/* Responsive: Stack on mobile */
@media (max-width: 767px) {
    .health-status-grid {
        grid-template-columns: 1fr;
    }
}

</style>
<div id="content">
<h2>View Relay "{{ relay['nickname'] }}"</h2>
{% set relay_data = {'nickname': relay['nickname'], 'fingerprint': relay['fingerprint'], 'as_number': relay['as']} %}
{{ navigation('all', page_ctx) }}
<h4>
{# AROI section with verification badge and relay count #}
{% if relay['aroi_domain'] and relay['aroi_domain'] != 'none' -%}
    {% if base_url and relay['aroi_domain'] in validated_aroi_domains -%}
        <a href="{{ base_url }}/{{ relay['aroi_domain']|lower|escape }}/" title="View all relays by this operator">Operator: {{ relay['aroi_domain']|escape }}</a>
    {% else -%}
        <a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/" title="View operator page">Operator: {{ relay['aroi_domain']|escape }}</a>
    {% endif -%}
    {# Show relay count if available from validation data #}
    {% if contact_validation_status and contact_validation_status.validation_summary -%}
        ({{ contact_validation_status.validation_summary.total_relays }} relay{% if contact_validation_status.validation_summary.total_relays != 1 %}s{% endif %})
    {% endif -%}
    {# Verification badge - DRY macro (links to operator page sections) #}
    {{- aroi_validation_badge(contact_validation_status) -}}
    | 
{% endif -%}
{# Family - always shown (not just as fallback) #}
{% if relay['effective_family']|length > 1 -%}
    <a href="{{ page_ctx.path_prefix }}family/{{ relay['fingerprint']|escape }}/" title="View family members">Family: {{ relay['effective_family']|length }} relays</a>
{% else -%}
    Family: {{ relay['effective_family']|length }} relay
{% endif -%} | 
{% if relay['contact'] -%}
    <a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/" title="Contact information">{{ relay['contact']|truncate(40)|escape }}</a> | 
{% endif -%}
{% if relay['as'] -%}
<a href="{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/">{{ relay['as']|escape }}</a>
{% else -%}
AS: unknown
{% endif -%} | 
{% if relay['country'] -%}
<a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">{{ relay['country_name']|escape }}</a>
{% else -%}
Country: unknown
{% endif -%} | 
<a href="{{ page_ctx.path_prefix }}platform/{{ relay['platform']|escape }}/">{{ relay['platform']|escape }}</a>
</h4>

{# ============== HEALTH STATUS SUMMARY (Enhanced) ============== #}
{# Displays 14 metrics in 8 cells using responsive 2-column layout #}
{% set diag = relay.consensus_evaluation if relay.consensus_evaluation and relay.consensus_evaluation.available else none %}

<div id="status" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid {% if diag and diag.in_consensus %}#28a745{% elif 'Running' in relay['flags'] %}#28a745{% else %}#dc3545{% endif %};">

<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#status" class="anchor-link">Health Status</a>
    </div>
</h4>

<div class="health-status-grid">
    {# LEFT COLUMN (60%) #}
    <dl>
        {# Row 1 Left: Consensus Status (merges: in_consensus + vote_count) #}
        <div class="health-row">
            <dt title="Inclusion in network consensus. Majority of Directory Auths must vote yes.">Consensus</dt>
            <dd>
                {% if diag -%}
                    {% if diag.in_consensus -%}
                        <span style="color: #28a745;" title="Relay IS in the network consensus. Tor clients will use this relay.">In Consensus</span>
                        <span title="Number of Directory Authorities that voted for this relay. Need majority ({{ diag.majority_required }}/{{ diag.total_authorities }}) for consensus.">({{ diag.vote_count }}/{{ diag.total_authorities }} Directory Auths)</span>
                    {% else -%}
                        <span style="color: #dc3545;" title="Relay is NOT in the network consensus. Tor clients will NOT use this relay.">Not In Consensus</span>
                        <span title="Number of Directory Authorities that voted for this relay. Need majority ({{ diag.majority_required }}/{{ diag.total_authorities }}) for consensus.">({{ diag.vote_count }}/{{ diag.total_authorities }} Directory Auths, need {{ diag.majority_required }})</span>
                    {% endif -%}
                {% elif 'Running' in relay['flags'] -%}
                    <span style="color: #28a745;" title="Relay IS in the network consensus. Tor clients will use this relay.">In Consensus</span>
                    <span title="Inferred from Running flag in Onionoo data.">(has Running flag)</span>
                {% else -%}
                    <span style="color: #dc3545;" title="Relay is NOT in the network consensus. Tor clients will NOT use this relay.">Not In Consensus</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 2 Left: Flags #}
        <div class="health-row">
            <dt title="Capabilities assigned by Dir. Auth. based on performance.">Flags</dt>
            <dd>
                {% set flag_list = relay['flags']|reject('equalto', 'StaleDesc')|list -%}
                {% set flag_count = flag_list|length -%}
                <span title="Guard=entry point, Exit=exit node, Stable=long-lived connections, Fast=high bandwidth, Valid=properly configured, Running=currently reachable.">{% for flag in flag_list -%}
                    <a href="{{ page_ctx.path_prefix }}flag/{{ flag.lower()|escape }}/">{{ flag|escape }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}</span> <span title="Total number of flags assigned to this relay.">({{ flag_count }})</span>
                {% if 'StaleDesc' in relay['flags'] -%}
                    <br><span style="color: #dc3545; font-size: 12px;" title="Relay's descriptor is outdated. May indicate connectivity issues.">[Warning] StaleDesc</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 3 Left: BW Verified (authority measurement count + median) #}
        <div class="health-row">
            <dt title="Bandwidth verification by directory authorities running sbws scanners.">BW Verified</dt>
            <dd>
                {% if diag and diag.bandwidth_summary and diag.bandwidth_summary.bw_auth_total -%}
<span style="color: {{ diag.bandwidth_summary.bw_auth_color }};" title="Number of bandwidth authorities (sbws scanners) that measured this relay. Currently {{ diag.bandwidth_summary.bw_auth_total }} authorities run bandwidth scanners.">{{ diag.bandwidth_summary.bw_auth_measured_count }}/{{ diag.bandwidth_summary.bw_auth_total }}</span> BW Auths Measured
                    {% if diag.bandwidth_summary.median_int -%}
<span title="Median bandwidth measurement from bandwidth authorities. Used to calculate consensus weight.">{{ diag.bandwidth_summary.median_int }} {{ diag.bandwidth_summary.median_unit }} Median</span>
                    {% endif -%}
                {% elif relay['measured'] -%}
<span style="color: #28a745;" title="Relay has been measured by bandwidth authorities.">Measured</span>
                {% elif relay['measured'] is none -%}
<span style="color: #6c757d;">Unknown</span>
                {% else -%}
<span style="color: #856404;" title="Relay has not been measured by bandwidth authorities yet.">Not Measured</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 4 Left: Stability (renamed from Uptime, with overload indicator) #}
        <div class="health-row">
            <dt title="Relay stability: overload status and uptime.">Stability</dt>
            <dd>
                <a href="#overload" title="{{ relay['stability_tooltip']|escape }}" style="text-decoration: none;">
                    <span style="color: {{ relay['stability_color'] }};">{{ relay['stability_text'] }}</span>
                </a>
                <span style="color: #6c757d;"> | </span>
                {% if relay.get('uptime_display') -%}
                    {% if relay['uptime_display'].startswith('DOWN') -%}
                        <span style="color: #dc3545;" title="Relay is currently offline.">{{ relay['uptime_display']|escape }}</span>
                    {% else -%}
                        <span style="color: #28a745;" title="Time since last restart. Source: relay descriptor.">{{ relay['uptime_display']|escape }}</span>
                    {% endif -%}
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
                {% set uptime_1m = relay.get('uptime_percentages', {}).get('1_month', 0) -%}
                {% if uptime_1m > 0 -%}
                    | <span style="color: {% if uptime_1m >= 100 %}#28a745{% elif uptime_1m >= 90 %}#856404{% else %}#dc3545{% endif %};" title="Percentage of time relay had Running flag in last month. 100%=always up, <90%=reliability concerns.">UP {{ uptime_1m|int }}%</span> <span title="1 Month availability percentage.">(1M)</span>
                {% endif -%}
            </dd>
        </div>
    </dl>

    {# RIGHT COLUMN (40%) #}
    <dl>
        {# Row 1 Right: Reachability (merges: IPv4 + IPv6) #}
        <div class="health-row">
            <dt title="Directory Auths connectivity to relay's OR port.">Reachability</dt>
            <dd>
                {% if diag and diag.reachability_summary -%}
                    <span title="Number of Directory Authorities that successfully connected to relay's IPv4 OR port.">IPv4: <span style="color: {% if diag.reachability_summary.ipv4.status_class == 'success' %}#28a745{% else %}#dc3545{% endif %};">{{ diag.reachability_summary.ipv4.reachable_count }}/{{ diag.reachability_summary.ipv4.total }}</span></span>
                    {% if diag.reachability_summary.ipv6.total > 0 -%}
                        | <span title="Number of Directory Authorities that successfully connected to relay's IPv6 OR port.">v6: <span style="color: {% if diag.reachability_summary.ipv6.status_class == 'success' %}#28a745{% elif diag.reachability_summary.ipv6.status_class == 'muted' %}#6c757d{% else %}#dc3545{% endif %};">{{ diag.reachability_summary.ipv6.reachable_count }}/{{ diag.reachability_summary.ipv6.total }}</span></span>
                    {% endif -%}
                    <span title="Reachability tested by Directory Authorities.">(Directory Auths)</span>
                {% else -%}
                    <span style="color: #6c757d;">N/A</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 2 Right: First Seen (swapped with Uptime) #}
        <div class="health-row">
            <dt title="First appearance in network consensus.">First Seen</dt>
            <dd>
                {% if relay['first_seen'] -%}
                    <a href="{{ page_ctx.path_prefix }}first_seen/{{ relay['first_seen'].split(' ', 1)[0]|escape }}/" title="Date relay first appeared in consensus. Newer relays have restrictions (Guard flag requires ~8 days).">{{ relay['first_seen']|format_time_ago }}</a>
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 3 Right: BW Weight (network percentage + observed bandwidth) #}
        <div class="health-row">
            <dt title="Traffic share and self-reported bandwidth capacity.">BW Weight</dt>
            <dd>
                {# Compute observed bandwidth once, used in both branches #}
                {% set obs_unit = relay['observed_bandwidth']|determine_unit(relays.use_bits) -%}
                {% set obs_bandwidth = relay['observed_bandwidth']|format_bandwidth_with_unit(obs_unit) -%}
                {% if relay['consensus_weight_fraction'] -%}
<span title="Percentage of total network consensus weight. Determines probability of being selected by clients.">{{ "%.2f"|format(relay['consensus_weight_fraction'] * 100) }}% of Network</span>
                    | <span title="Bandwidth capacity reported by the relay itself. May differ from measured bandwidth.">{{ obs_bandwidth|float|int }} {{ obs_unit }} Observed By Relay</span>
                {% else -%}
<span title="Bandwidth capacity reported by the relay itself.">{{ obs_bandwidth|float|int }} {{ obs_unit }} Observed By Relay</span>
                {% endif -%}
            </dd>
        </div>

        {# Row 4 Right: Version (merges: version + recommended status) #}
        <div class="health-row">
            <dt title="Tor software version. Outdated versions may be rejected by Tor network and have security vulnerabilities.">Version</dt>
            <dd>
                {% if relay['version'] -%}
                    {% if relay['recommended_version'] is not none -%}
                        {% if relay['recommended_version'] -%}
                            <span style="color: #28a745;" title="This Tor version is on the recommended list. Safe to use.">{{ relay['version']|escape }} Recommended</span>
                        {% else -%}
                            <span style="color: #dc3545;" title="This Tor version is outdated. May have security issues or be rejected by the network.">{{ relay['version']|escape }} Not Recommended</span>
                        {% endif -%}
                    {% else -%}
                        <span title="Version recommendation status unknown.">{{ relay['version']|escape }}</span>
                    {% endif -%}
                {% else -%}
                    <span style="color: #6c757d;">Unknown</span>
                {% endif -%}
            </dd>
        </div>
    </dl>
</div>

{# Issues and Warnings - Full width below grid #}
{% if diag and diag.issues %}
{% set real_issues = diag.issues | selectattr('severity', 'ne', 'info') | list %}
{% set info_notes = diag.issues | selectattr('severity', 'equalto', 'info') | list %}

{% if real_issues %}
<div style="margin-top: 12px; padding: 10px; background: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
    <strong style="color: #856404;">Issues Detected:</strong>
    <ul style="margin: 5px 0 0 0; padding-left: 20px;">
    {% for issue in real_issues %}
        <li style="margin-bottom: 5px;">
            <span style="color: {% if issue.severity == 'error' %}#dc3545{% else %}#856404{% endif %}; font-weight: bold;">
                {{ issue.title }}
            </span>: {{ issue.description|safe }}
            {% if issue.suggestion %}
            <br><span style="color: #666; font-size: 12px;"><strong>Suggestion:</strong> {{ issue.suggestion|safe }}</span>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
</div>
{% endif %}

{% if info_notes %}
<div style="margin-top: 10px; padding: 10px; background: #d1ecf1; border-radius: 4px; border-left: 3px solid #17a2b8;">
    <strong style="color: #0c5460;">Notes:</strong>
    <ul style="margin: 5px 0 0 0; padding-left: 20px;">
    {% for note in info_notes %}
        <li style="font-size: 12px;">{{ note.title }}: {{ note.description }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}
{% elif diag %}
<div style="margin-top: 12px; padding: 10px; background: #d4edda; border-radius: 4px; border-left: 3px solid #28a745;">
    <span style="color: #155724;"><strong>No issues detected.</strong> Relay appears to be operating normally.</span>
</div>
{% endif %}

</div>

{# ============== SECTION 2: CONNECTIVITY AND LOCATION ============== #}
{# NOTE: Reuses existing 'diag' variable (defined line 115) - no new variables #}
<section id="connectivity" class="section-box" style="padding-bottom: 5px;">
<h4 style="margin-top: 0; margin-bottom: 12px;">
    <div class="section-header">
        <a href="#connectivity" class="anchor-link">Connectivity and Location</a>
    </div>
</h4>

<div class="row">
{# ===== Left Column: Addresses and Reachability ===== #}
<div class="col-md-6">
<div class="subsection-card">
<h5 class="subsection-header">Addresses</h5>
<dl>
    <dt>OR Address</dt>
    <dd>
        {% if relay['verified_host_names'] -%}
            {% for hostname in relay['verified_host_names'] -%}
                <span class="verified-hostname" title="Verified: reverse DNS lookup matched a forward A record (DNSSEC validated). Source: Onionoo API">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
            {% endfor %}<br>
        {% elif relay['unverified_host_names'] -%}
            {% for hostname in relay['unverified_host_names'] -%}
                <span class="unverified-hostname" title="Unverified: reverse DNS found but no matching A record. Source: Onionoo API">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
            {% endfor %}<br>
        {% endif -%}
        {% for address in relay['or_addresses'] -%}
            {{ address }}{% if not loop.last %}<br>{% endif %}
        {% endfor -%}
    </dd>
    
    {% if relay['exit_addresses'] %}
    <dt>Exit Address</dt>
    <dd>{% for addr in relay['exit_addresses'] %}{{ addr|escape }}{% if not loop.last %}<br>{% endif %}{% endfor %}</dd>
    {% endif %}
    
    {% if relay['dir_address'] %}
    <dt>Dir Address</dt>
    <dd><a href="http://{{ relay['dir_address']|escape }}">{{ relay['dir_address']|escape }}</a></dd>
    {% endif %}
</dl>
</div>

<div class="subsection-card">
<h5 class="subsection-header">Reachability (Directory Authorities)</h5>
<dl>
    {% if diag and diag.reachability_summary %}
    {%- set reach = diag.reachability_summary -%}
    <dt>IPv4</dt>
    <dd>
        <span class="status-{{ reach.ipv4.status_class }}">{{ reach.ipv4.reachable_count }}/{{ reach.ipv4.total }}</span>
    </dd>
    {# IPv6: Use ipv6.total > 0 check (same as Health Status line 212) - no new loop needed #}
    {% if reach.ipv6.total > 0 %}
    <dt>IPv6</dt>
    <dd>
        <span class="status-{{ reach.ipv6.status_class }}">{{ reach.ipv6.reachable_count }}/{{ reach.ipv6.total }}</span>{% if reach.ipv6.not_tested %} <span class="status-note">({{ reach.ipv6.not_tested|length }} don't test)</span>{% endif %}
    </dd>
    {% endif %}
    {% else %}
    <dt>Status</dt>
    <dd><span class="status-note">Reachability data unavailable</span></dd>
    {% endif %}
</dl>
</div>
</div>

{# ===== Right Column: Location and AS ===== #}
<div class="col-md-6">
<div class="subsection-card">
<h5 class="subsection-header">Location</h5>
<dl>
    <dt>Country</dt>
    <dd>
        {% if relay['country'] -%}
            <a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">
                <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relay['country']|lower|escape }}.png"
                     title="{{ relay['country_name']|escape }}" alt="{{ relay['country_name']|escape }}">
            </a> {{ relay['country_name']|escape }}
        {% else -%}
            Unknown
        {% endif -%}
    </dd>
    
    {% if relay['region_name'] %}
    <dt>Region</dt>
    <dd>{{ relay['region_name']|escape }}</dd>
    {% endif %}
    
    {% if relay['city_name'] %}
    <dt>City</dt>
    <dd>{{ relay['city_name']|escape }}</dd>
    {% endif %}
    
    {% if relay['latitude'] and relay['longitude'] and relay['latitude'] != 0 and relay['longitude'] != 0 %}
    <dt>Coordinates</dt>
    <dd>{{ relay['latitude']|escape }}, {{ relay['longitude']|escape }}</dd>
    {% endif %}
    
    <dt>Interactive Map</dt>
    <dd><a href="https://routefluxmap.1aeo.com/#relay={{ relay['fingerprint']|escape }}" target="_blank" rel="noopener">View on Interactive Map</a></dd>
</dl>
</div>

<div class="subsection-card">
<h5 class="subsection-header">Autonomous System</h5>
<dl>
    <dt>AS Number</dt>
    <dd>
        {% if relay['as'] -%}
            <a href="{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/">{{ relay['as']|escape }}</a>
        {% else -%}
            Unknown
        {% endif -%}
    </dd>
    
    <dt>AS Name</dt>
    <dd>
        {% if relay['as_name'] -%}
            {{ relay['as_name']|escape }}
            {% if relay['as'] %}(<a href="https://bgp.tools/{{ relay['as']|escape }}">BGP.tools</a>){% endif %}
        {% else -%}
            Unknown
        {% endif -%}
    </dd>
</dl>
</div>
</div>
</div>
</section>

<p>Last fetch was at {{ relays.timestamp }}.</p>
<div class="row">
<div class="col-md-6">
<dl>
<dt id="nickname">
<div class="section-header">
<a href="#nickname" class="anchor-link">Nickname</a>
</div>
</dt>
<dd>
{{ relay['nickname']|escape }}
</dd>

<dt id="fingerprint">
<div class="section-header">
<a href="#fingerprint" class="anchor-link">Fingerprint</a>
</div>
</dt>
<dd>
<code>{{ relay['fingerprint']|escape }}</code>
</dd>

<dt id="aroi">
<div class="section-header">
<a href="#aroi" class="anchor-link">AROI</a> <a href="https://nusenu.github.io/ContactInfo-Information-Sharing-Specification/" target="_blank" title="Autonomous Relay Operator Identifier - unverified">(?)</a>
</div>
</dt>
{% if relay['aroi_domain'] and relay['aroi_domain'] != 'none' -%}
<dd>
{% if base_url and relay['aroi_domain'] in validated_aroi_domains -%}
<a href="{{ base_url }}/{{ relay['aroi_domain']|lower|escape }}/">{{ relay['aroi_domain']|escape }}</a>
{% else -%}
<a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/">{{ relay['aroi_domain']|escape }}</a>
{% endif -%}
</dd>
{% else -%}
<dd>
none
</dd>
{% endif -%}
<dt id="contact">
<div class="section-header">
<a href="#contact" class="anchor-link">Contact</a>
</div>
</dt>
{% if relay['contact'] -%}
<dd style="word-wrap: break-word; word-break: break-all; max-width: 100%; overflow-wrap: break-word;">
<a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}/" style="word-wrap: break-word; word-break: break-all; overflow-wrap: break-word;">{{
relay['contact']|escape }}</a>
</dd>
{% else -%}
<dd>
<a href="{{ page_ctx.path_prefix }}contact/{{ relay['contact_md5'] }}">none</a>
</dd>
{% endif -%}
<dt id="ipv4-exit-policy-summary">
<div class="section-header">
<a href="#ipv4-exit-policy-summary" class="anchor-link">IPv4 Exit Policy Summary</a>
</div>
</dt>
<dd>
{% if relay['exit_policy_summary'] -%}
{%- set v4_summary = relay['exit_policy_summary'].items() -%}
<pre class="pre-scrollable">{% for k, v in v4_summary -%}
{{ k|escape }}: {{ '\n  ' + v|join('\n  ')|escape }}
{% endfor -%}
</pre>
{% else -%}
<pre>none</pre>
{% endif -%}
</dd>
<dt id="ipv6-exit-policy-summary">
<div class="section-header">
<a href="#ipv6-exit-policy-summary" class="anchor-link">IPv6 Exit Policy Summary</a>
</div>
</dt>
<dd>
{% if relay['exit_policy_v6_summary'] -%}
{%- set v6_summary = relay['exit_policy_v6_summary'].items() -%}
<pre class="pre-scrollable">{% for k, v in v6_summary -%}
{{ k|escape }}: {{ '\n  ' + v|join('\n  ')|escape }}
{% endfor -%}
</pre>
{% else -%}
<pre>none</pre>
{% endif -%}
</dd>
<dt id="exit-policy">
<div class="section-header">
<a href="#exit-policy" class="anchor-link">Exit Policy</a>
</div>
</dt>
<dd>
<pre class="pre-scrollable">{% for policy in relay['exit_policy'] -%}
{{ policy|escape }}
{% endfor -%}
</pre>
</dd>
{% if relay['effective_family']|length > 1 -%}
<dt id="effective-family" title="Array of fingerprints of relays that are in an effective, mutual family relationship with this relay. These relays are part of this relay's family and they consider this relay to be part of their family. Always contains the relay's own fingerprint. Omitted if the descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#effective-family" class="anchor-link">Effective Family Members: {{ relay['effective_family']|length }}</a> (<a href="{{ page_ctx.path_prefix }}family/{{ relay['fingerprint']|escape }}/">View</a>)
</div>
</dt>
{% else -%}
<dt id="effective-family" title="Array of fingerprints of relays that are in an effective, mutual family relationship with this relay. These relays are part of this relay's family and they consider this relay to be part of their family. Always contains the relay's own fingerprint. Omitted if the descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#effective-family" class="anchor-link">Effective Family Member: {{ relay['effective_family']|length }}</a>
</div>
</dt>
{% endif -%}
<dd>
<pre class="pre-scrollable">{% for e_relay in relay['effective_family'] -%}
{% if relay['effective_family']|length > 1 -%}
<a href="../{{ e_relay|escape }}/">{{ e_relay|escape }}</a>
{% else -%}
{{ e_relay|escape }}
{% endif -%}
{% endfor -%}
</pre>
</dd>
<dt id="alleged-family" title="Array of fingerprints of relays that are not in an effective, mutual family relationship with this relay. These relays are part of this relay's family but they don't consider this relay to be part of their family. Omitted if empty or if descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#alleged-family" class="anchor-link">Alleged Family {% if relay['alleged_family'] and relay['alleged_family']|length == 1 -%}Member{% else -%}Members{% endif -%}: {% if relay['alleged_family'] -%}{{ relay['alleged_family']|length }}{% else -%}0{% endif -%}</a>
</div>
</dt>
<dd>
{% if relay['alleged_family'] -%}
<pre class="pre-scrollable">{% for a_relay in relay['alleged_family'] -%}
{% if relay['alleged_family']|length > 1 -%}
<a href="../{{ a_relay|escape }}/">{{ a_relay|escape }}</a>
{% else -%}
{{ a_relay|escape }}
{% endif -%}
{% endfor -%}
{% else -%}
<pre class="pre-scrollable">none
{% endif -%}
</pre>
</dd>
<dt id="indirect-family" title="Array of fingerprints of relays that consider this relay to be part of their family but that are not part of this relay's family. Omitted if empty or if descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#indirect-family" class="anchor-link">Indirect Family {% if relay['indirect_family'] and relay['indirect_family']|length == 1 -%}Member{% else -%}Members{% endif -%}: {% if relay['indirect_family'] -%}{{ relay['indirect_family']|length }}{% else -%}0{% endif -%}</a>
</div>
</dt>
<dd>
{% if relay['indirect_family'] -%}
<pre class="pre-scrollable">{% for i_relay in relay['indirect_family'] -%}
{% if relay['indirect_family']|length > 1 -%}
<a href="../{{ i_relay|escape }}/">{{ i_relay|escape }}</a>
{% else -%}
{{ i_relay|escape }}
{% endif -%}
{% endfor -%}
{% else -%}
<pre class="pre-scrollable">none
{% endif -%}
</pre>
</dd>
</dl>
</div>
<div class="col-md-6">
<dl>
<dt id="bandwidth-capacity" title="Bandwidth capacity details: Observed capacity | Advertised capability | Rate limit | Burst limit">
<div class="section-header">
<a href="#bandwidth-capacity" class="anchor-link">Bandwidth Capacity (Observed | Advertised | Rate Limit | Burst Limit)</a>
</div>
</dt>
    {% set obs_unit = relay['observed_bandwidth']|determine_unit(relays.use_bits) -%}
    {% set obs_bandwidth = relay['observed_bandwidth']|format_bandwidth_with_unit(obs_unit) -%}
<dd>
<span title="Observed: {{ obs_bandwidth }} {{ obs_unit }}">{{ obs_bandwidth }} {{ obs_unit }}</span> | 
{% if relay['advertised_bandwidth'] -%}{% set adv_unit = relay['advertised_bandwidth']|determine_unit(relays.use_bits) -%}{% set adv_bandwidth = relay['advertised_bandwidth']|format_bandwidth_with_unit(adv_unit) -%}<span title="Advertised: {{ adv_bandwidth }} {{ adv_unit }}">{{ adv_bandwidth }} {{ adv_unit }}</span>{% else -%}<span title="Advertised: unknown">unknown</span>{% endif -%} | 
{% if relay['bandwidth_rate'] -%}{% set rate_unit = relay['bandwidth_rate']|determine_unit(relays.use_bits) -%}{% set rate_bandwidth = relay['bandwidth_rate']|format_bandwidth_with_unit(rate_unit) -%}<span title="Rate: {{ rate_bandwidth }} {{ rate_unit }}">{{ rate_bandwidth }} {{ rate_unit }}</span>{% else -%}<span title="Rate: unknown">unknown</span>{% endif -%} | 
{% if relay['bandwidth_burst'] -%}{% set burst_unit = relay['bandwidth_burst']|determine_unit(relays.use_bits) -%}{% set burst_bandwidth = relay['bandwidth_burst']|format_bandwidth_with_unit(burst_unit) -%}<span title="Burst: {{ burst_bandwidth }} {{ burst_unit }}">{{ burst_bandwidth }} {{ burst_unit }}</span>{% else -%}<span title="Burst: unknown">unknown</span>{% endif -%}
{% if relay['measured'] is not none -%}
    {% if relay['measured'] -%}
        &nbsp;&nbsp;<span style="color: #28a745; font-weight: bold;" title="Bandwidth capacity measured by ≥3 bandwidth authorities">Measured</span>
    {% else -%}
        &nbsp;&nbsp;<span style="color: #dc3545; font-weight: bold;" title="Bandwidth capacity not measured by ≥3 bandwidth authorities">Not Measured</span>
    {% endif -%}
{% else -%}
    &nbsp;&nbsp;<span style="color: #6c757d;" title="Bandwidth capacity measurement status unknown">Unknown</span>
{% endif -%}
</dd>

<dt id="network-participation">
<div class="section-header">
<a href="#network-participation" class="anchor-link">Network Participation (Consensus Weight | Guard | Middle | Exit)</a>
</div>
</dt>
<dd>
<span title="Fraction of this relay's consensus weight compared to the sum of all consensus weights in the network. This fraction is a very rough approximation of the probability of this relay to be selected by clients.">{% if relay['consensus_weight_fraction'] -%}{{ "%.2f"|format(relay['consensus_weight_fraction'] * 100) }}%{% else -%}N/A{% endif -%}</span> | 
<span title="Probability of this relay to be selected for the guard position. This probability is calculated based on consensus weights, relay flags, and bandwidth weights in the consensus. Path selection depends on more factors, so that this probability can only be an approximation.">{% if relay['guard_probability'] -%}{{ "%.2f"|format(relay['guard_probability'] * 100) }}%{% else -%}N/A{% endif -%}</span> | 
<span title="Probability of this relay to be selected for the middle position. This probability is calculated based on consensus weights, relay flags, and bandwidth weights in the consensus. Path selection depends on more factors, so that this probability can only be an approximation.">{% if relay['middle_probability'] -%}{{ "%.2f"|format(relay['middle_probability'] * 100) }}%{% else -%}N/A{% endif -%}</span> | 
<span title="Probability of this relay to be selected for the exit position. This probability is calculated based on consensus weights, relay flags, and bandwidth weights in the consensus. Path selection depends on more factors, so that this probability can only be an approximation.">{% if relay['exit_probability'] -%}{{ "%.2f"|format(relay['exit_probability'] * 100) }}%{% else -%}N/A{% endif -%}</span>
{% if relay['fingerprint'] in relays.json.smart_context.performance_correlation.template_optimized.underutilized_fingerprints %}
<br><small class="text-warning">[Warning] Underutilized: High bandwidth capacity but low consensus weight</small>
{% endif %}
</dd>

<dt id="or-address" title="IP address and TCP port where this relay accepts onion-routing connections, with hostname when available">
<div class="section-header">
<a href="#or-address" class="anchor-link">OR Address</a>
</div>
</dt>
<dd>
{% if relay['verified_host_names'] -%}
{% for hostname in relay['verified_host_names'] -%}
<span class="verified-hostname" title="verified hostname">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
{% endfor %} | {% for address in relay['or_addresses'] -%}{{ address }}{% if not loop.last %}, {% endif %}{% endfor -%}
{% elif relay['unverified_host_names'] -%}
{% for hostname in relay['unverified_host_names'] -%}
<span class="unverified-hostname" title="unverified hostname">{{ hostname|escape }}</span>{% if not loop.last %}, {% endif %}
{% endfor %} | {% for address in relay['or_addresses'] -%}{{ address }}{% if not loop.last %}, {% endif %}{% endfor -%}
{% else -%}
{% for address in relay['or_addresses'] -%}{{ address }}{% if not loop.last %}, {% endif %}{% endfor -%}
{% endif -%}
</dd>
<dt id="exit-address">
<div class="section-header">
<a href="#exit-address" class="anchor-link">Exit Address</a>
</div>
</dt>
{% if relay['exit_address'] -%}
<dd>
{{ relay['exit_address']|escape }}
</dd>
{% else -%}
<dd>
none
</dd>
{% endif -%}
<dt id="dir-address">
<div class="section-header">
<a href="#dir-address" class="anchor-link">Dir Address</a>
</div>
</dt>
{% if relay['dir_address'] -%}
<dd>
<a href="http://{{ relay['dir_address']|escape }}">{{
relay['dir_address']|escape }}</a>
</dd>
{% else -%}
<dd>
none
</dd>
{% endif -%}

<dt id="location">
<div class="section-header">
<a href="#location" class="anchor-link">{% if relay['city_name'] or relay['region_name'] -%}City | Region | Country{% else -%}Country{% endif -%}</a>
</div>
</dt>
<dd>
{% if relay['city_name'] -%}
<span title="City name of the location of this relay as found by a geolocation database. Omitted if the relay location could not be found or if the database does not contain city information.">{{ relay['city_name']|escape }}</span>
{% endif -%}
{% if relay['city_name'] and relay['region_name'] -%} | {% endif -%}
{% if relay['region_name'] -%}
<span title="Region name of the location of this relay as found by a geolocation database. Omitted if the relay location could not be found or if the database does not contain region information.">{{ relay['region_name']|escape }}</span>
{% endif -%}
{% if (relay['city_name'] or relay['region_name']) and relay['country'] -%} | {% endif -%}
{% if relay['country'] -%}
<a href="{{ page_ctx.path_prefix }}country/{{ relay['country']|escape }}/">
<img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relay['country']|lower|escape }}.png"
title="{{ relay['country_name']|escape }}"
alt="{{ relay['country_name']|escape }}">
</a> <span title="Country name of the location of this relay as found by a geolocation database based on the relay's IP address. Omitted if the relay location could not be found.">{{ relay['country_name']|escape }}</span>
{% else -%}
unknown
{% endif -%}
</dd>
{% if relay['latitude'] and relay['longitude'] and relay['latitude'] != 0 and relay['longitude'] != 0 -%}
<dt id="coordinates">
<div class="section-header">
<a href="#coordinates" class="anchor-link">Latitude, Longitude</a>
</div>
</dt>
<dd>
<span title="Latitude of the location of this relay as found by a geolocation database based on the relay's IP address. Omitted if the relay location could not be found.">{{ relay['latitude']|escape }}</span>, 
<span title="Longitude of the location of this relay as found by a geolocation database based on the relay's IP address. Omitted if the relay location could not be found.">{{ relay['longitude']|escape }}</span>
</dd>
{% endif -%}
<dt id="interactive-map">
<div class="section-header">
<a href="#interactive-map" class="anchor-link">Interactive Map</a>
</div>
</dt>
<dd>
<a href="https://routefluxmap.1aeo.com/#relay={{ relay['fingerprint']|escape }}" target="_blank" rel="noopener" title="View this relay on RouteFluxMap interactive visualization">View on Interactive Map</a>
</dd>
<dt id="autonomous-system">
<div class="section-header">
<a href="#autonomous-system" class="anchor-link">Autonomous System (AS Number | AS Name)</a>
</div>
</dt>
<dd>
{% if relay['as'] -%}
<a href='{{ page_ctx.path_prefix }}as/{{ relay['as']|escape }}/' title="AS Number">{{ relay['as']|escape }}</a>
{% else -%}
<span title="AS Number">unknown</span>
{% endif -%} | {% if relay['as_name'] -%}
<span title="AS Name">{{ relay['as_name']|escape }}</span> (<a href='https://bgp.tools/{{ relay['as']|escape }}'>BGP.tools</a>)
{% else -%}
<span title="AS Name">unknown</span>
{% endif -%}
</dd>

<dt id="flags">
<div class="section-header">
<a href="#flags" class="anchor-link">Flags: {{ relay['flags']|reject('equalto', 'StaleDesc')|list|length }}</a>
</div>
</dt>
<dd>
{% for flag in relay['flags'] -%}
{% if flag != 'StaleDesc' -%}
<a href="{{ page_ctx.path_prefix }}flag/{{ flag.lower()|escape }}/">
<img src="{{ page_ctx.path_prefix }}static/images/flags/{{ flag.lower()|escape }}.png"
title="{{ flag|escape }}"
alt="{{ flag|escape }}">
</a> {{ flag|escape }}
{% endif -%}
{% endfor -%}
</dd>

<dt id="flag-uptime" title="Flag-specific uptime percentages showing the reliability of this relay when operating in its primary network role. Priority: Exit > Guard > Fast > Running flags.">
<div class="section-header">
<a href="#flag-uptime" class="anchor-link">Flag Uptime (1M/6M/1Y/5Y)</a>
</div>
</dt>
<dd>
{% if relay.get('flag_uptime_display') and relay['flag_uptime_display'] != 'N/A' -%}
    {% if relay['flag_uptime_display'] == 'Match' -%}
        <span title="{{ relay['flag_uptime_tooltip']|escape }}">Match Overall Uptime ({{ relay['uptime_api_display']|safe }})</span>
    {% else -%}
        <span title="{{ relay['flag_uptime_tooltip']|escape }}">{{ relay['flag_uptime_display']|safe }}</span>
    {% endif -%}
{% else -%}
N/A
{% endif -%}
</dd>
<dt id="uptime-history" title="{% if contact_display_data and contact_display_data.outliers and contact_display_data.outliers.tooltip %}{{ contact_display_data.outliers.tooltip }}{% else %}Statistical outliers: ≥2σ from average{% endif %}">
<div class="section-header">
<a href="#uptime-history" class="anchor-link">Uptime (1M/6M/1Y/5Y)</a>
</div>
</dt>
<dd>
{% if relay.get('uptime_api_display') -%}
    {{ relay['uptime_api_display']|safe }}
{% else -%}
    N/A
{% endif -%}
</dd>
<dt id="uptime-downtime">
<div class="section-header">
<a href="#uptime-downtime" class="anchor-link">Uptime / Downtime</a>
</div>
</dt>
<dd>
{% if relay.get('uptime_display') -%}
    {% if relay['uptime_display'].startswith('DOWN') -%}
        <span style="color: #dc3545;">{{ relay['uptime_display']|escape }}</span>
    {% else -%}
        {{ relay['uptime_display']|escape }}
    {% endif -%}
{% else -%}
    N/A
{% endif -%}
</dd>
<dt id="first-last-seen">
<div class="section-header">
<a href="#first-last-seen" class="anchor-link">Seen (First | Last)</a>
</div>
</dt>
<dd>
<a href="{{ page_ctx.path_prefix }}first_seen/{{ relay['first_seen'].split(' ', 1)[0]|escape }}/">{{ relay['first_seen']|format_time_ago }} ({{ relay['first_seen']|escape }})</a> | {{ relay['last_seen']|format_time_ago }} ({{ relay['last_seen']|escape }})
</dd>
<dt id="last-restarted" title="UTC timestamp when this relay was last (re-)started. Missing if router descriptor containing this information cannot be found.">
<div class="section-header">
<a href="#last-restarted" class="anchor-link">Last Restarted</a>
</div>
</dt>
<dd>
{% if relay['last_restarted'] -%}
{{ relay['last_restarted']|format_time_ago }} ({{ relay['last_restarted']|escape }})
{% else -%}
unknown
{% endif -%}
</dd>
<dt id="last-changed-address" title="UTC timestamp when this relay last stopped announcing an IPv4 or IPv6 address or TCP port where it previously accepted onion-routing or directory connections. This timestamp can serve as indicator whether this relay would be a suitable fallback directory.">
<div class="section-header">
<a href="#last-changed-address" class="anchor-link">Last Changed Address or Port</a>
</div>
</dt>
<dd>
{% if relay['last_changed_address_or_port'] -%}
{{ relay['last_changed_address_or_port']|escape }}
{% else -%}
unknown
{% endif -%}
</dd>
<dt id="hibernating" title="Boolean field saying whether this relay indicated that it is hibernating in its last known server descriptor. This information may be helpful to decide whether a relay that is not running anymore has reached its accounting limit and has not dropped out due to a technical problem. Omitted if the last known server descriptor of this relay does not contain hibernation information or if no such descriptor is known.">
<div class="section-header">
<a href="#hibernating" class="anchor-link">Hibernating</a>
</div>
</dt>
<dd>
{% if relay['hibernating'] is not none -%}
{% if relay['hibernating'] -%}Yes{% else -%}No{% endif -%}
{% else -%}
unknown
{% endif -%}
</dd>
<dt id="platform">
<div class="section-header">
<a href="#platform" class="anchor-link">Platform (Short | Long)</a>
</div>
</dt>
<dd>
<a href='{{ page_ctx.path_prefix }}platform/{{ relay['platform']|escape }}/' title="Simplified platform identifier for categorization">{{ relay['platform']|escape }}</a> | <span title="Complete platform information as reported by relay">{% if relay['platform_raw'] -%}{{ relay['platform_raw']|escape }}{% else -%}{{ relay['platform']|escape }}{% endif -%}</span>
</dd>
<dt id="version">
<div class="section-header">
<a href="#version" class="anchor-link">Version (Running | Recommended | Status)</a>
</div>
</dt>
<dd>
<span title="Tor software version without leading 'Tor' as reported by the directory authorities in the 'v' line of the consensus. Omitted if either the directory authorities or the relay did not report which version the relay runs or if the relay runs an alternative Tor implementation.">{% if relay['version'] -%}{{ relay['version']|escape }}{% else -%}unknown{% endif -%}</span> | 
<span title="Boolean field saying whether the Tor software version of this relay is recommended by the directory authorities or not. Uses the relay version in the consensus. Omitted if either the directory authorities did not recommend versions, or the relay did not report which version it runs.">{% if relay['recommended_version'] is not none -%}{% if relay['recommended_version'] -%}Yes{% else -%}No{% endif -%}{% else -%}unknown{% endif -%}</span> | 
<span title="Status of the Tor software version of this relay based on the versions recommended by the directory authorities. Possible version statuses are: 'recommended' if a version is listed as recommended; 'experimental' if a version is newer than every recommended version; 'obsolete' if a version is older than every recommended version; 'new in series' if a version has other recommended versions with the same first three components, and the version is newer than all such recommended versions, but it is not newer than every recommended version; 'unrecommended' if none of the above conditions hold. Omitted if either the directory authorities did not recommend versions, or the relay did not report which version it runs.">{% if relay['version_status'] -%}{{ relay['version_status']|escape }}{% else -%}unknown{% endif -%}</span>
</dd>
</dl>
</div>
</div>

{# Consensus Evaluation Section - Shows per-authority voting information #}
{% if relay.consensus_evaluation and relay.consensus_evaluation.available %}
{% set diag = relay.consensus_evaluation %}
{% set rv = diag.relay_values %}
<div class="row" style="margin-top: 20px;">
<div class="col-md-12">
<h3 id="consensus-evaluation">
<div class="section-header">
<a href="#consensus-evaluation" class="anchor-link">Consensus Evaluation</a>
</div>
</h3>
<p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">
Data from <a href="https://collector.torproject.org/recent/relay-descriptors/votes/" target="_blank" rel="noopener">Tor CollecTor</a> (authority votes{% if relays.collector_fetched_at %}, fetched {{ relays.collector_fetched_at.replace('T', ' ').split('.')[0] }}{% endif %}).
</p>

{# Check if relay has IPv6 address - use namespace for proper scoping #}
{% set ns = namespace(has_ipv6=false) %}
{% for addr in relay.or_addresses|default([]) %}
    {% if '[' in addr %}{% set ns.has_ipv6 = true %}{% endif %}
{% endfor %}
{% set has_ipv6 = ns.has_ipv6 %}

{# Condensed Status, Flag Eligibility, Reachability, and Issues - all as bullets #}
<ul style="margin-bottom: 15px; padding-left: 20px; font-size: 13px;">
    {# 1. Consensus Status #}
    <li><strong>Consensus Status</strong> <span style="color: #6c757d; font-size: 10px;">(need ≥{{ diag.majority_required }}/{{ diag.total_authorities }})</span><strong>:</strong> 
        {% if diag.in_consensus %}
            <span style="color: #28a745; font-weight: bold;">In Consensus</span>
        {% else %}
            <span style="color: #dc3545; font-weight: bold;">Not In Consensus</span>
        {% endif %}
        — {{ diag.vote_count }}/{{ diag.total_authorities }} authorities voted.
    </li>
    
    {# 2. Flag Eligibility (majority required: {{ diag.majority_required }}/{{ diag.total_authorities }}) #}
    <li><strong>Flag Eligibility</strong> <span style="color: #6c757d; font-size: 10px;">(need ≥{{ diag.majority_required }}/{{ diag.total_authorities }} for flag)</span>:
        {% for flag_name, flag_data in diag.flag_summary.items() %}
        {% set display_name = 'HSDir' if flag_name.lower() == 'hsdir' else flag_name|capitalize %}
        <span style="color: {% if flag_data.status_class == 'success' %}#28a745{% elif flag_data.status_class == 'danger' %}#dc3545{% else %}#856404{% endif %}; font-weight: bold;">{{ display_name }}: {{ flag_data.eligible_count }}/{{ flag_data.total_authorities }}</span>{% if not loop.last %} | {% endif %}
        {% endfor %}
        | <span style="color: #28a745; font-weight: bold;">Running: {{ diag.vote_count }}/{{ diag.total_authorities }}</span>
        | <span style="color: #28a745; font-weight: bold;">Valid: {{ diag.vote_count }}/{{ diag.total_authorities }}</span>
        | <span style="color: #28a745; font-weight: bold;">V2Dir: {{ diag.vote_count }}/{{ diag.total_authorities }}</span>
    </li>
    
    {# 3. Reachability #}
    {% if diag.reachability_summary %}
    <li><strong>Reachability:</strong>
        IPv4: <span style="color: {% if diag.reachability_summary.ipv4.status_class == 'success' %}#28a745{% else %}#dc3545{% endif %}; font-weight: bold;">{{ diag.reachability_summary.ipv4.reachable_count }}/{{ diag.reachability_summary.ipv4.total }}</span>
        {% if has_ipv6 %}
        | IPv6: <span style="color: {% if diag.reachability_summary.ipv6.status_class == 'success' %}#28a745{% elif diag.reachability_summary.ipv6.status_class == 'muted' %}#6c757d{% else %}#dc3545{% endif %}; font-weight: bold;">{{ diag.reachability_summary.ipv6.reachable_count }}/{{ diag.reachability_summary.ipv6.total }}</span>{% if diag.reachability_summary.ipv6.not_tested %} <span style="color: #6c757d;">({{ diag.reachability_summary.ipv6.not_tested|length }} don't test)</span>{% endif %}
        {% endif %}
    </li>
    {% endif %}
    
    {# 4. Consensus Weight (Authority Measured) #}
    {% if diag.bandwidth_summary and diag.bandwidth_summary.median is not none %}
    <li><strong>Consensus Weight</strong> <span style="color: #6c757d; font-size: 10px;">(Dir. Auth.)</span><strong>:</strong>
        <span title="Tor consensus uses median of authority measurements for path selection. This is a scaled value used for traffic distribution.">Median: {{ diag.bandwidth_summary.median_display }} | Min: {{ diag.bandwidth_summary.min_display }} | Max: {{ diag.bandwidth_summary.max_display }}</span>
        {% if diag.bandwidth_summary.deviation_class == 'warning' %}<span style="color: #856404;"> [Warning] High deviation</span>{% endif %}
    </li>
    {% endif %}
    
    {# 4. Identified Issues #}
    {% set real_issues = diag.issues | selectattr('severity', 'ne', 'info') | list %}
    {% set info_notes = diag.issues | selectattr('severity', 'equalto', 'info') | list %}
    {% if real_issues %}
    <li><strong>Identified Issues:</strong>
        <ul style="margin: 3px 0; padding-left: 15px;">
        {% for issue in real_issues %}
            <li>
                <span style="color: {% if issue.severity == 'error' %}#dc3545{% else %}#856404{% endif %};">{{ issue.title }}</span>: {{ issue.description|safe }}
                {% if issue.suggestion %}
                <ul style="margin: 2px 0; padding-left: 15px;"><li style="color: #666; font-size: 12px;"><strong>Suggestion:</strong> {{ issue.suggestion|safe }}</li></ul>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    </li>
    {% endif %}
    {% if info_notes %}
    <li><strong>Notes:</strong>
        <ul style="margin: 3px 0; padding-left: 15px;">
        {% for note in info_notes %}
            <li><span style="color: #17a2b8;">{{ note.title }}</span>: {{ note.description }}</li>
        {% endfor %}
        </ul>
    </li>
    {% endif %}
</ul>

{# ============== TABLE 1: SUMMARY (Quick Answers) ============== #}
<h4 id="relay-summary" style="margin-top: 15px;">
<div class="section-header">
<a href="#relay-summary" class="anchor-link">Summary: Your Relay vs Consensus</a>
</div>
</h4>
<p class="text-muted" style="font-size: 11px; margin-bottom: 8px;">
<span style="color: #28a745;">Green</span> = meets threshold, <span style="color: #dc3545;">Red</span> = below threshold, <span style="color: #ffc107;">Yellow</span> = partial.
</p>
{% if rv %}
<div style="overflow-x: auto; overflow-y: visible; padding-top: 60px; margin-top: -50px;">
<table class="table table-condensed table-striped" style="font-size: 12px; table-layout: fixed;">
<colgroup>
    <col style="width: 18%;">
    <col style="width: 22%;">
    <col style="width: 28%;">
    <col style="width: 32%;">
</colgroup>
<thead>
<tr>
    <th style="text-align: left;">Metric</th>
    <th style="text-align: left;">Dir Auth Measured</th>
    <th style="text-align: left;">Dir Auth Threshold</th>
    <th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
    <tr>
        <td title="Source: CollecTor | File: vote | Directory Authorities vote on whether relay is in consensus">In Consensus <span style="color: #6c757d; font-size: 10px;">(Dir. Auth.)</span></td>
        <td>{{ diag.vote_count }}/{{ diag.total_authorities }} authorities</td>
        <td>≥{{ diag.majority_required }}/{{ diag.total_authorities }} (majority)</td>
        <td>{% if diag.in_consensus %}<span style="color: #28a745; font-weight: bold;">IN CONSENSUS</span>{% else %}<span style="color: #dc3545; font-weight: bold;">NOT IN CONSENSUS</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: CollecTor | File: vote | Field: 's' line contains 'Running' | Authority can connect to relay's OR port">Running (IPv4 Reachable)</td>
        <td title="Source: CollecTor | Count of votes with 'r' line for this relay">{{ diag.vote_count }}/{{ diag.total_authorities }} authorities reached this relay</td>
        <td title="Tor dir-spec: Relay in consensus if majority (floor(n/2)+1) of authorities vote">≥{{ diag.majority_required }}/{{ diag.total_authorities }} (majority)</td>
        <td>{% if diag.vote_count >= diag.majority_required %}<span style="color: #28a745; font-weight: bold;">RUNNING</span>{% else %}<span style="color: #dc3545; font-weight: bold;">NOT RUNNING</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: CollecTor | File: vote | Field: 's' line contains 'Valid' | Valid = Running + Not Blacklisted + Valid Descriptor">Valid</td>
        <td title="Source: CollecTor | Count of votes with 'Valid' flag for this relay">{{ diag.vote_count }}/{{ diag.total_authorities }} (Running + Valid Descriptor)</td>
        <td title="Tor dir-spec: Relay in consensus if majority (floor(n/2)+1) of authorities vote">≥{{ diag.majority_required }}/{{ diag.total_authorities }} (majority)</td>
        <td>{% if diag.vote_count >= diag.majority_required %}<span style="color: #28a745; font-weight: bold;">VALID</span>{% else %}<span style="color: #dc3545; font-weight: bold;">NOT VALID</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: CollecTor | File: vote | Field: 'w Bandwidth=X' | Authority-measured bandwidth (scaled) for path selection. Tor uses median of all authority measurements.">Consensus Weight <span style="color: #6c757d; font-size: 10px;">(Dir. Auth.)</span></td>
        <td title="Source: CollecTor | File: vote | Field: 'w Bandwidth=X' | Median of all authority measurements">{% if diag.bandwidth_summary and diag.bandwidth_summary.median_display %}{{ diag.bandwidth_summary.median_display }}{% else %}{{ rv.measured_bw_display }}{% endif %} (median)</td>
        <td>N/A (no threshold, used for path selection)</td>
        <td><span style="color: #6c757d;">—</span></td>
    </tr>
    <tr>
        <td title="Source: CollecTor | File: vote | Field: stats wfu=X | Weighted Fractional Uptime - relay's uptime weighted so recent downtime counts more">Guard WFU <span style="color: #6c757d; font-size: 10px;">(Dir. Auth., guard-wfu)</span></td>
        <td title="Source: CollecTor | File: vote | Field: stats wfu=X">{{ rv.wfu_display }}</td>
        <td title="Source: CollecTor | File: vote | Field: flag-thresholds guard-wfu=X">≥98% (all authorities)</td>
        <td>{% if rv.wfu_meets %}<span style="color: #28a745; font-weight: bold;">MEETS</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - cannot get Guard</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: CollecTor | File: vote | Field: stats tk=X | Time Known - how long authority has tracked this relay (familiarity requirement)">Guard TK <span style="color: #6c757d; font-size: 10px;">(Dir. Auth., tk)</span></td>
        <td title="Source: CollecTor | File: vote | Field: stats tk=X">{{ rv.tk_display }}</td>
        <td title="Source: CollecTor | File: vote | Field: flag-thresholds guard-tk=X">≥8 days (all authorities)</td>
        <td>{% if rv.tk_meets %}<span style="color: #28a745; font-weight: bold;">MEETS</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - need {{ "%.1f"|format(rv.tk_days_needed) }} more days</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: Onionoo | File: details | Field: observed_bandwidth | Relay's self-reported bandwidth from its descriptor. Used for Guard flag eligibility (≥2 MB/s OR top 25%).">Guard BW <span style="color: #6c757d; font-size: 10px;">(Relay Reported)</span></td>
        <td title="Source: Onionoo | File: details | Field: observed_bandwidth | Relay's descriptor bandwidth (actual for Guard eligibility)">{{ rv.observed_bw_display }}</td>
        <td title="Source: CollecTor | File: vote | Field: flag-thresholds guard-bw-inc-exits=X | Guard requires: ≥2 MB/s (dir-spec guarantee) OR in top 25%">≥{{ rv.guard_bw_guarantee_display }} OR ≥{{ rv.guard_bw_range }}</td>
        <td>{% if rv.guard_bw_meets_guarantee %}<span style="color: #28a745; font-weight: bold;">MEETS - ≥2 MB/s guarantee</span>{% elif rv.guard_bw_meets_some %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - in top 25% for {{ rv.guard_bw_meets_count }} auth(s)</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - need ≥2 MB/s</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: Onionoo (relay value) + CollecTor (threshold) | Relay uptime from Onionoo last_restarted | Authority threshold from CollecTor flag-thresholds stable-uptime">Stable Uptime <span style="color: #6c757d; font-size: 10px;">(Relay Reported)</span></td>
        <td title="Source: Onionoo | File: details | Field: last_restarted | Relay's self-reported uptime from descriptor">{{ rv.stable_uptime_display }}</td>
        <td title="Source: CollecTor | File: vote | Field: flag-thresholds stable-uptime=X | Range varies by authority">
            ≥{{ rv.stable_uptime_min_display }} - {{ rv.stable_uptime_typical_display }} <span style="color: #666; font-size: 11px;">(typical)</span>
            {% if rv.stable_uptime_strict_auths %}
            <br><span style="color: #856404; font-size: 10px;" title="These authorities have stricter requirements">[Stricter] {{ rv.stable_uptime_strict_auths|join(', ') }}: ≥{{ rv.stable_uptime_max_display }}</span>
            {% endif %}
        </td>
        <td>{% if rv.stable_uptime_meets_all %}<span style="color: #28a745; font-weight: bold;">MEETS - all authorities</span>{% elif rv.stable_uptime_meets_count >= diag.majority_required %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ rv.stable_uptime_meets_count }}/{{ rv.total_authorities }}</span>{% elif rv.stable_uptime is none %}<span style="color: #6c757d;">N/A - uptime not available</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - {{ rv.stable_uptime_meets_count }}/{{ rv.total_authorities }}</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: CollecTor | File: vote | Field: flag-thresholds stable-mtbf=X | Mean Time Between Failures">Stable MTBF <span style="color: #6c757d; font-size: 10px;">(Dir. Auth., mtbf)</span></td>
        <td title="Source: CollecTor | File: vote | Field: stats mtbf=X">{{ rv.mtbf_display|default('N/A') }}</td>
        <td title="Most authorities: ≥{{ rv.stable_mtbf_typical_display }}{% if rv.stable_mtbf_strict_auths %}; Stricter: {{ rv.stable_mtbf_strict_auths|join(', ') }} uses ≥{{ rv.stable_mtbf_max_display }}{% endif %}">
            ≥{{ rv.stable_mtbf_min_display }} - {{ rv.stable_mtbf_typical_display }} <span style="color: #666; font-size: 11px;">(typical)</span>
            {% if rv.stable_mtbf_strict_auths %}
            <br><span style="color: #856404; font-size: 10px;" title="These authorities have stricter requirements">[Stricter] {{ rv.stable_mtbf_strict_auths|join(', ') }}: ≥{{ rv.stable_mtbf_max_display }}</span>
            {% endif %}
        </td>
        <td>{% if rv.stable_mtbf_meets_all|default(false) %}<span style="color: #28a745; font-weight: bold;">MEETS - all authorities</span>{% elif rv.stable_mtbf_meets_count|default(0) >= diag.majority_required %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ rv.stable_mtbf_meets_count|default(0) }}/{{ rv.total_authorities }}</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - {{ rv.stable_mtbf_meets_count|default(0) }}/{{ rv.total_authorities }}</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: Onionoo | File: details | Field: observed_bandwidth | Relay's self-reported bandwidth. Used for Fast flag eligibility (top 7/8ths OR ≥100 KB/s).">Fast Speed <span style="color: #6c757d; font-size: 10px;">(Relay Reported)</span></td>
        <td title="Source: Onionoo | File: details | Field: observed_bandwidth | Relay's descriptor bandwidth">{{ rv.fast_speed_display }}</td>
        <td title="Most authorities: ≥{{ rv.fast_speed_typical_display }}{% if rv.fast_speed_strict_auths %}; Stricter: {{ rv.fast_speed_strict_auths|join(', ') }} uses ≥{{ rv.fast_speed_max_display }}{% endif %}">
            ≥{{ rv.fast_minimum_display }} <span style="color: #666; font-size: 11px;">(guarantee)</span> OR ≥{{ rv.fast_speed_typical_display }} <span style="color: #666; font-size: 11px;">(typical)</span>
            {% if rv.fast_speed_strict_auths %}
            <br><span style="color: #856404; font-size: 10px;" title="These authorities have stricter requirements">[Stricter] {{ rv.fast_speed_strict_auths|join(', ') }}: ≥{{ rv.fast_speed_max_display }}</span>
            {% endif %}
        </td>
        <td>{% if rv.fast_meets_minimum %}<span style="color: #28a745; font-weight: bold;">MEETS - ≥100 KB/s guarantee</span>{% elif rv.fast_meets_all %}<span style="color: #28a745; font-weight: bold;">MEETS - all {{ rv.total_authorities }} auths</span>{% elif rv.fast_meets_count > 0 %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ rv.fast_meets_count }}/{{ rv.total_authorities }}</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - need ≥100 KB/s</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: CollecTor | File: vote | Field: flag-thresholds hsdir-wfu=X | Weighted Fractional Uptime for HSDir flag">HSDir WFU <span style="color: #6c757d; font-size: 10px;">(Dir. Auth., wfu)</span></td>
        <td title="Source: CollecTor | File: vote | Field: stats wfu=X">{{ rv.wfu_display }}</td>
        <td title="Source: CollecTor | File: vote | Field: flag-thresholds hsdir-wfu=X">≥{{ "%.1f"|format(rv.hsdir_wfu_threshold * 100) }}% (from all auths)</td>
        <td>{% if diag.flag_summary.hsdir.eligible_count == diag.total_authorities %}<span style="color: #28a745; font-weight: bold;">MEETS - all {{ diag.total_authorities }} auths</span>{% elif diag.flag_summary.hsdir.eligible_count >= diag.majority_required %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ diag.flag_summary.hsdir.eligible_count }}/{{ diag.total_authorities }}</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - {{ diag.flag_summary.hsdir.eligible_count }}/{{ diag.total_authorities }}</span>{% endif %}</td>
    </tr>
    <tr>
        <td title="Source: CollecTor | File: vote | Field: flag-thresholds hsdir-tk=X | Time Known required for HSDir flag">HSDir TK <span style="color: #6c757d; font-size: 10px;">(Dir. Auth., tk)</span></td>
        <td title="Source: CollecTor | File: vote | Field: stats tk=X">{{ rv.tk_display }}</td>
        <td title="dir-spec default: 25 hours ({{ rv.hsdir_tk_default_count }} auths){% if rv.hsdir_tk_strict_auths %}; Stricter: {{ rv.hsdir_tk_strict_auths|join(', ') }} uses {{ rv.hsdir_tk_max_display }}{% endif %}">
            ≥{{ rv.hsdir_tk_consensus_display }} <span style="color: #666; font-size: 11px;">({{ rv.hsdir_tk_default_count }}/{{ diag.total_authorities }} auths)</span>
            {% if rv.hsdir_tk_strict_auths %}
            <br><span style="color: #856404; font-size: 10px;" title="These authorities have stricter requirements">[Stricter] {{ rv.hsdir_tk_strict_auths|join(', ') }}: ≥{{ rv.hsdir_tk_max_display }}</span>
            {% endif %}
        </td>
        <td>{% if diag.flag_summary.hsdir.eligible_count == diag.total_authorities %}<span style="color: #28a745; font-weight: bold;">MEETS - all {{ diag.total_authorities }} auths</span>{% elif diag.flag_summary.hsdir.eligible_count >= diag.majority_required %}<span style="color: #ffc107; font-weight: bold;">PARTIAL - {{ diag.flag_summary.hsdir.eligible_count }}/{{ diag.total_authorities }}</span>{% else %}<span style="color: #dc3545; font-weight: bold;">BELOW - {{ diag.flag_summary.hsdir.eligible_count }}/{{ diag.total_authorities }}</span>{% endif %}</td>
    </tr>
    {% if has_ipv6 %}
    <tr>
        <td title="Source: CollecTor | File: vote | Field: 'a' line (IPv6 address) | Not all authorities test IPv6">IPv6 Reachable <span style="color: #6c757d; font-size: 10px;">(Dir. Auth.)</span></td>
        <td title="Source: CollecTor | File: vote | Field: 'a' line presence">{{ rv.ipv6_reachable_count }}/{{ rv.ipv6_tested_count }} tested</td>
        <td title="Some authorities don't test IPv6 reachability. Majority = floor(testers/2)+1">≥{{ (rv.ipv6_tested_count // 2 + 1) }}/{{ rv.ipv6_tested_count }} (majority)</td>
        <td>{% if rv.ipv6_tested_count == 0 %}<span style="color: #6c757d; font-weight: bold;">NOT TESTED</span>{% elif rv.ipv6_reachable_count >= (rv.ipv6_tested_count // 2 + 1) %}<span style="color: #28a745; font-weight: bold;">REACHABLE</span>{% elif rv.ipv6_reachable_count > 0 %}<span style="color: #ffc107; font-weight: bold;">PARTIAL</span>{% else %}<span style="color: #dc3545; font-weight: bold;">NOT REACHABLE</span>{% endif %}</td>
    </tr>
    {% endif %}
</tbody>
</table>
</div>
{% endif %}


{# ============== TABLE 2: PER-AUTHORITY DETAILS (Diagnosis) ============== #}
<h4 id="authority-votes" style="margin-top: 15px;">
<div class="section-header">
<a href="#authority-votes" class="anchor-link">Per-Authority Details</a>
</div>
</h4>
<p class="text-muted" style="font-size: 11px; margin-bottom: 8px;">
Each cell shows: <strong>your measured value | authority threshold</strong>. 
<span style="color: #28a745;">Green</span> = meets, <span style="color: #dc3545;">red</span> = below.
Flags: <span style="color: #28a745; font-weight: bold;">green</span> = all authorities agree, <span style="color: #856404; font-weight: bold;">yellow</span> = partial.
</p>
<div style="overflow-x: auto; overflow-y: visible; padding-top: 60px; margin-top: -50px;">
<table class="table table-condensed table-striped" style="font-size: 11px;">
<thead>
<tr>
    <th title="Source: Onionoo | Authority nickname (relay with Authority flag) with country code">Authority</th>
    <th title="Source: CollecTor | File: vote | Field: 's' line contains 'Running' | Authority voted for this relay (could reach it via OR port)">Running</th>
    <th title="Source: CollecTor | File: vote | Field: 's' line contains 'Valid' | Relay is not blacklisted and has valid descriptor">Valid</th>
    <th title="Source: CollecTor | File: vote | Field: bandwidth-file-headers | Does this authority run sbws bandwidth scanner? 6 of 9 authorities measure bandwidth; 3 use relay-reported values.">BW Scan (Authority)</th>
    <th title="Source: CollecTor | File: vote | Presence of 'r' line = IPv4 reachable">v4</th>
    {% if has_ipv6 %}<th title="Source: CollecTor | File: vote | Field: 'a' line | IPv6 reachable | N/T = not tested by this authority">v6</th>{% endif %}
    <th title="Source: CollecTor | File: vote | Field: 's' line | Flags assigned by this authority">Flags</th>
    <th title="Source: Onionoo observed_bandwidth (Relay Reported) | CollecTor flag-thresholds fast-speed (Authority Threshold) | Fast flag: top 7/8ths OR ≥100 KB/s">Fast (Relay|T)</th>
    <th title="Source: Onionoo observed_bandwidth (Relay Reported) | CollecTor flag-thresholds guard-bw-inc-exits (Authority Threshold) | Guard BW: ≥2 MB/s OR top 25%">Guard BW (Relay|Threshold)</th>
    <th title="Source: CollecTor | File: vote | Field: stats wfu=X, flag-thresholds guard-wfu=X | Guard WFU: Measured | Threshold">Guard WFU (M|T)</th>
    <th title="Source: CollecTor | File: vote | Field: stats tk=X, flag-thresholds guard-tk=X | Guard TK: Measured | Threshold">Guard TK (M|T)</th>
    <th title="Source: CollecTor | File: vote | Field: stats mtbf=X, flag-thresholds stable-mtbf=X | Stable MTBF: Authority-measured MTBF | Authority's threshold">Stable MTBF (M|T)</th>
    <th title="Source: Onionoo last_restarted (Relay Reported) | CollecTor flag-thresholds stable-uptime (Authority Threshold) | Stable Uptime: Relay's uptime from descriptor | Authority's threshold. Two different data sources.">Stable Uptime (Relay|T)</th>
    <th title="Source: CollecTor | File: vote | Field: stats wfu=X, flag-thresholds hsdir-wfu=X | HSDir WFU: Measured | Threshold">HSDir WFU (M|T)</th>
    <th title="Source: CollecTor | File: vote | Field: stats tk=X, flag-thresholds hsdir-tk=X | HSDir TK: Measured | Threshold">HSDir TK (M|T)</th>
    <th title="Source: CollecTor | File: vote | Field: 'r' line timestamp | Descriptor Published timestamp">Desc Published</th>
    <th title="Source: CollecTor | File: vote | Field: 'w Bandwidth=X' | Authority-measured consensus weight (scaled) used for path selection. Authorities measure actual throughput; 10 KB/s = default when relay-reported bandwidth is used instead.">Cons Wt (Authority)</th>
</tr>
</thead>
<tbody>
{% for vote in diag.authority_table %}
<tr class="{% if not vote.voted %}row-not-voted{% endif %}">
    <td>
        {% if vote.fingerprint %}
        <a href="{{ page_ctx.path_prefix }}relay/{{ vote.fingerprint }}/" style="text-decoration: underline;">
            <strong>{{ vote.authority_display|default(vote.authority) }}</strong>
        </a>
        {% else %}
        <strong>{{ vote.authority_display|default(vote.authority) }}</strong>
        {% endif %}
    </td>
    {# Running: Did this authority vote for this relay (i.e., could it reach the relay)? #}
    <td>
        {% if vote.voted %}
            <span style="color: #28a745;" title="Authority voted for this relay (Running)">Yes</span>
        {% else %}
            <span style="color: #dc3545;" title="Authority did NOT vote for this relay (not reachable)">No</span>
        {% endif %}
    </td>
    {# Valid: Relay has Valid flag from this authority #}
    <td>
        {% if vote.voted and vote.flags %}
            {% if 'Valid' in vote.flags %}
                <span style="color: #28a745;" title="Relay is Valid (verified, allowed in network)">Yes</span>
            {% else %}
                <span style="color: #dc3545;" title="Relay does NOT have Valid flag">No</span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    <td>
        {% if vote.is_bw_authority %}
            <span style="color: #28a745;">Y</span>
        {% else %}
            <span style="color: #6c757d;">N</span>
        {% endif %}
    </td>
    <td>
        {% if vote.ipv4_reachable %}
            <span style="color: #28a745;">Yes</span>
        {% else %}
            <span style="color: #dc3545;">No</span>
        {% endif %}
    </td>
    {% if has_ipv6 %}
    <td>
        {% if vote.ipv6_reachable == true %}
            <span style="color: #28a745;">Yes</span>
        {% elif vote.ipv6_reachable == false %}
            <span style="color: #dc3545;">No</span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {% endif %}
    <td style="max-width: 180px; word-wrap: break-word; font-size: 10px;">
        {% if vote.flags_with_consensus %}
            {% for flag_info in vote.flags_with_consensus %}
                {%- if flag_info.unanimous -%}
                    <span style="color: #28a745; font-weight: bold;">{{ flag_info.name }}</span>
                {%- elif flag_info.partial -%}
                    <span style="color: #856404; font-weight: bold;">{{ flag_info.name }}</span>
                {%- else -%}
                    {{ flag_info.name }}
                {%- endif -%}
                {%- if not loop.last %}, {% endif -%}
            {% endfor %}
        {% elif vote.flags %}
            {{ vote.flags_display }}
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# Fast: observed BW | fast-speed threshold #}
    <td>
        {% if vote.voted and vote.fast_threshold_display %}
            <span style="color: {% if vote.fast_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Measured: {{ vote.fast_speed_display }} | Threshold (7/8ths): {{ vote.fast_threshold_display }} | {% if vote.fast_meets %}MEETS{% else %}BELOW{% endif %}">
                {{ vote.fast_speed_display }} | {{ vote.fast_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# Guard BW: observed BW | top 25% threshold | 2 MB/s min #}
    <td>
        {% if vote.voted and vote.guard_bw_guarantee_display %}
            <span style="color: {% if vote.guard_bw_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Measured: {{ vote.guard_bw_value_display }} | Top 25%: {{ vote.guard_bw_top25_display }} | Min: {{ vote.guard_bw_guarantee_display }} | {% if vote.guard_bw_meets_guarantee %}MEETS (≥2 MB/s){% elif vote.guard_bw_in_top25 %}MEETS (top 25%){% else %}BELOW{% endif %}">
                {{ vote.guard_bw_value_display }} | {{ vote.guard_bw_top25_display }} OR {{ vote.guard_bw_guarantee_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# WFU: measured | threshold #}
    <td>
        {% if vote.voted and vote.wfu is not none %}
            <span style="color: {% if vote.wfu_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your WFU: {{ vote.wfu_display }} | Threshold: {{ vote.wfu_threshold_display }}">
                {{ vote.wfu_display }} | {{ vote.wfu_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# TK: measured | threshold #}
    <td>
        {% if vote.voted and vote.tk is not none %}
            <span style="color: {% if vote.tk_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your TK: {{ vote.tk_display }} | Threshold: {{ vote.tk_threshold_display }}">
                {{ vote.tk_display }} | {{ vote.tk_threshold_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# Stable MTBF: measured MTBF | threshold #}
    <td>
        {% if vote.voted and vote.stable_threshold %}
            <span style="color: {% if vote.stable_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your MTBF: {{ vote.stable_mtbf_display }} | Threshold: {{ vote.stable_threshold_display }} | Note: Actual flag assignment may differ">
                {{ vote.stable_mtbf_display }} | {{ vote.stable_threshold_display }}
            </span>
        {% elif vote.voted and vote.stable_mtbf %}
            {{ vote.stable_mtbf_display }} | <span style="color: #6c757d;">—</span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# Stable Uptime: relay uptime (Onionoo) | authority threshold (CollecTor) #}
    {# Note: Relay uptime is the SAME for all authorities (self-reported from descriptor) #}
    {# Only the threshold varies per authority #}
    <td>
        {% if vote.voted and vote.stable_uptime_threshold %}
            {% if vote.stable_uptime_meets is not none %}
                <span style="color: {% if vote.stable_uptime_meets %}#28a745{% else %}#dc3545{% endif %};"
                      title="Relay Uptime (Onionoo): {{ vote.stable_uptime_display }} | Authority Threshold (CollecTor): {{ vote.stable_uptime_threshold_display }} | Note: Data from two sources">
                    {{ vote.stable_uptime_display }} | {{ vote.stable_uptime_threshold_display }}
                </span>
            {% else %}
                <span style="color: #6c757d;" title="Relay uptime not available from Onionoo">
                    N/A | {{ vote.stable_uptime_threshold_display }}
                </span>
            {% endif %}
        {% elif vote.voted and vote.stable_uptime is not none %}
            <span title="Relay Uptime (Onionoo): {{ vote.stable_uptime_display }} | Authority threshold not set">
                {{ vote.stable_uptime_display }} | <span style="color: #6c757d;">—</span>
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# HSDir WFU: measured | threshold (same as guard WFU, 98%) #}
    <td>
        {% if vote.voted and vote.wfu is not none %}
            <span style="color: {% if vote.wfu >= 0.98 %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your WFU: {{ vote.wfu_display }} | Threshold: ≥98% for HSDir">
                {{ vote.wfu_display }} | 98.0%
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    {# HSDir TK: measured | threshold (25h dir-spec default; moria1 uses ~10 days) #}
    <td>
        {% if vote.voted and vote.hsdir_tk_threshold %}
            <span style="color: {% if vote.hsdir_tk_meets %}#28a745{% else %}#dc3545{% endif %};"
                  title="Your TK: {{ vote.hsdir_tk_value_display }} | Threshold: {{ vote.hsdir_tk_threshold_display }}">
                {{ vote.hsdir_tk_value_display }} | {{ vote.hsdir_tk_threshold_display }}
            </span>
        {% elif vote.voted and vote.tk %}
            {{ vote.tk_display }} | <span style="color: #6c757d;">—</span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    
    {# Descriptor Published: timestamp - Red if StaleDesc flag, Green if fresh #}
    <td>
        {% if vote.voted %}
            {% if vote.has_staledesc %}
                <span style="color: #8b0000; font-weight: bold;" title="StaleDesc flag assigned - descriptor is >18 hours old. This is a negative flag.">
                    {{ vote.descriptor_published|default('N/A') }} [Stale]
                </span>
            {% else %}
                <span style="color: #28a745;" title="Descriptor is fresh (no StaleDesc flag)">
                    {{ vote.descriptor_published|default('N/A') }}
                </span>
            {% endif %}
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
    
    {# Consensus Weight: scaled value for path selection (moved to end) #}
    <td>
        {% if vote.voted and vote.measured %}
            <span title="Scaled consensus weight: {{ vote.measured }} (for traffic distribution). 10 KB/s = default when authority uses relay's advertised BW.">
                {{ vote.measured_display }}
            </span>
        {% else %}
            <span style="color: #6c757d;">—</span>
        {% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<p style="font-size: 10px; color: #666; margin-top: 5px;">
— = not tested/available • Format: relay value | authority threshold • WFU = Weighted Fractional Uptime • TK = Time Known
</p>

<div style="font-size: 11px; color: #555; margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;">
<strong>Bandwidth Values Explained:</strong><br>
<strong>Relay Reported</strong> = Your relay's self-reported bandwidth from its descriptor (observed_bandwidth). Used for <em>flag eligibility</em> (Guard, Fast).<br>
<strong>Authority Measured</strong> = Bandwidth measured by authority's sbws scanner. Used for <em>consensus weight</em> (path selection probability).<br>
<em>Why different?</em> Authorities verify your reported bandwidth independently. 6 of 9 authorities run bandwidth scanners; 3 use relay-reported values directly.
</div>

<div style="font-size: 11px; color: #555; margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #17a2b8;">
<strong>Stable Uptime (Two Data Sources):</strong><br>
<strong>Relay Uptime</strong> = From <em>Onionoo API</em> (last_restarted field). This is your relay's self-reported uptime from its descriptor. Same value for all authorities.<br>
<strong>Authority Threshold</strong> = From <em>CollecTor vote files</em> (flag-thresholds stable-uptime). Each authority may have different thresholds.<br>
<em>Why two sources?</em> Vote files contain authority thresholds but not per-relay uptime values. Onionoo aggregates relay descriptors which include uptime.
</div>

</div>
</div>
{% endif %}

</div>
{% endblock -%}

