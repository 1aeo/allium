{% from "macros.html" import navigation %}
{% extends "skeleton.html" -%}

{% block title -%}
Network Health Dashboard
{% endblock -%}

{% block body -%}

<div class="aroi-center-text aroi-subsection">
    <h1>Tor Network Health Dashboard</h1>
    <p class="lead"><strong>Real-time Overview Metrics</strong></p>
</div>

{{ navigation('network_health', page_ctx, show_breadcrumbs=false) }}

<!-- COMPREHENSIVE HEALTH DASHBOARD -->
<div class="network-health-ribbon">
    
    <!-- FIRST ROW -->
    <div class="ribbon-row">
        
        <!-- CARD 1: RELAY COUNTS -->
        <div class="ribbon-card relay-counts">
            <div class="card-header" id="relay-counts">
                <h4><a href="#relay-counts" style="color: inherit; text-decoration: none;">üìä Relay Counts</a></h4>
            </div>
            <div class="card-metrics">
                <div class="metric-item primary" title="Total number of Tor relays currently running in the network. Calculated by counting all active relays from Onionoo API.">
                    <span class="metric-value"><a href="{{ page_ctx.path_prefix }}misc/all.html" style="color: inherit; text-decoration: none;">{{ relays.json.network_health.relays_total_formatted }}</a></span>
                    <span class="metric-label">Total Relays</span>
                </div>
                <div class="metric-grid">
                    <div class="metric-item" title="Exit relays allow traffic to leave the Tor network to the regular internet. Must allow exits to at least one /8 address space on ports 80 and 443.">
                        <span class="metric-value">{{ relays.json.network_health.exit_count_with_percentage }}</span>
                        <span class="metric-label">Exit</span>
                    </div>
                    <div class="metric-item" title="Guard relays serve as entry points into the Tor network. Must be Fast, Stable, and meet specific uptime and bandwidth requirements.">
                        <span class="metric-value">{{ relays.json.network_health.guard_count_with_percentage }}</span>
                        <span class="metric-label">Guard</span>
                    </div>
                    <div class="metric-item" title="Middle relays forward traffic between other relays within the Tor network. Cannot be used as entry or exit points.">
                        <span class="metric-value">{{ relays.json.network_health.middle_count_with_percentage }}</span>
                        <span class="metric-label">Middle</span>
                    </div>
                    <div class="metric-item" title="Relays with both Exit and Guard flags can serve as both entry and exit points. Provides maximum utility to the network.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.guard_exit_count) }} ({{ "%.1f%%"|format(relays.json.network_health.guard_exit_percentage) }})</span>
                        <span class="metric-label">Exit + Guard</span>
                    </div>
                </div>
                <div class="metric-grid">
                    <div class="metric-item" title="Fast relays have sufficient bandwidth capacity to be useful for high-speed circuits. Determined by being in the top 7/8ths for bandwidth capacity or at least 100KB/s.">
                        <span class="metric-value">{{ relays.json.network_health.fast_count_with_percentage }}</span>
                        <span class="metric-label">Fast</span>
                    </div>
                    <div class="metric-item" title="Stable relays have maintained high uptime and reliability over time. Essential for network stability and long-lived circuits.">
                        <span class="metric-value">{{ relays.json.network_health.stable_count_with_percentage }}</span>
                        <span class="metric-label">Stable</span>
                    </div>
                    <div class="metric-item" title="Measured relays have bandwidth capacity measured by directory authorities for accuracy. Provides more reliable bandwidth capacity estimates than self-reported values.">
                        <span class="metric-value">{{ relays.json.network_health.measured_relays_with_percentage }}</span>
                        <span class="metric-label">Measured</span>
                    </div>
                    <div class="metric-item" title="Offline relays are not currently running according to the latest consensus. These relays are temporarily unavailable to the network.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.offline_relays) }} ({{ "%.1f%%"|format(relays.json.network_health.offline_relays_percentage) }})</span>
                        <span class="metric-label">Offline</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Directory authorities coordinate the Tor network by creating the consensus document. Critical infrastructure nodes that vote on relay flags and network parameters.">
                        <span class="metric-value">{{ relays.json.network_health.authorities_count_with_percentage }}</span>
                        <span class="metric-label">Directory Authorities</span>
                    </div>
                    <div class="metric-item" title="V2Dir relays serve directory information including consensus documents and relay descriptors. Essential for network discovery and connectivity.">
                        <span class="metric-value">{{ relays.json.network_health.v2dir_count_with_percentage }}</span>
                        <span class="metric-label">V2Dir</span>
                    </div>
                    <div class="metric-item" title="HSDir relays store and serve hidden service descriptors, enabling access to onion services. Requires Stable and Fast flags plus 96+ hours uptime.">
                        <span class="metric-value">{{ relays.json.network_health.hsdir_count_with_percentage }}</span>
                        <span class="metric-label">HSDir</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Number and percentage of relays supporting both IPv4 and IPv6 protocols. Dual-stack relays provide maximum connectivity.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.both_ipv4_ipv6_relays) }} ({{ "%.1f%%"|format(relays.json.network_health.both_ipv4_ipv6_relays_percentage) }})</span>
                        <span class="metric-label">Relays with IPv4 & IPv6</span>
                    </div>
                    <div class="metric-item" title="Number and percentage of relays supporting only IPv4 protocol. These relays cannot connect to IPv6-only destinations.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.ipv4_only_relays) }} ({{ "%.1f%%"|format(relays.json.network_health.ipv4_only_relays_percentage) }})</span>
                        <span class="metric-label">Only IPv4</span>
                    </div>
                </div>
                <div class="metric-grid">
                    <div class="metric-item" title="BadExit relays are flagged by authorities when misconfigured or malicious. These relays cannot be used as exit points for security reasons.">
                        <span class="metric-value">{{ relays.json.network_health.bad_exits_count_with_percentage }}</span>
                        <span class="metric-label">Bad Relays</span>
                    </div>
                    <div class="metric-item" title="StaleDesc relays have published descriptors over 18 hours old. These relays may have outdated information about their capabilities.">
                        <span class="metric-value">{{ relays.json.network_health.stabledesc_count_with_percentage }}</span>
                        <span class="metric-label">StaleDesc</span>
                    </div>
                    <div class="metric-item" title="Sybil relays are flagged as potentially belonging to the same operator when more than 2 relays share an IP address. Helps prevent network control attacks.">
                        <span class="metric-value">{{ relays.json.network_health.sybil_count_with_percentage }}</span>
                        <span class="metric-label">Sybil</span>
                    </div>
                    <div class="metric-item" title="Overloaded relays are experiencing resource constraints like memory pressure, CPU exhaustion, or TCP port limits. May impact network performance.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.overloaded_relays) }} ({{ "%.1f%%"|format(relays.json.network_health.overloaded_relays_percentage) }})</span>
                        <span class="metric-label">Overloaded</span>
                    </div>
                </div>

                <div class="metric-grid">
                    <div class="metric-item" title="New relays that first appeared in the network in the last 24 hours based on first_seen timestamp.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.new_relays_24h) }} ({{ "%.1f%%"|format(relays.json.network_health.new_relays_24h_percentage) }})</span>
                        <span class="metric-label">New 1d</span>
                    </div>
                    <div class="metric-item" title="New relays that first appeared in the network in the last month based on first_seen timestamp.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.new_relays_30d) }} ({{ "%.1f%%"|format(relays.json.network_health.new_relays_30d_percentage) }})</span>
                        <span class="metric-label">New 1mo</span>
                    </div>
                    <div class="metric-item" title="New relays that first appeared in the network in the last 6 months based on first_seen timestamp.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.new_relays_6m) }} ({{ "%.1f%%"|format(relays.json.network_health.new_relays_6m_percentage) }})</span>
                        <span class="metric-label">New 6mo</span>
                    </div>
                    <div class="metric-item" title="New relays that first appeared in the network in the last year based on first_seen timestamp.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.new_relays_1y) }} ({{ "%.1f%%"|format(relays.json.network_health.new_relays_1y_percentage) }})</span>
                        <span class="metric-label">New 1y</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(1, 1fr);">
                    <div class="metric-item" title="Mean and median age of all relays in the network calculated from first_seen timestamps. Shows network maturity and experience.">
                        <span class="metric-value">{{ relays.json.network_health.network_mean_age_formatted }} | {{ relays.json.network_health.network_median_age_formatted }}</span>
                        <span class="metric-label">Age (Mean | Median)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CARD 2: BANDWIDTH AVAILABILITY -->
                    <div class="ribbon-card bandwidth-counts">
                <div class="card-header" id="bandwidth-capacity">
                    <h4><a href="#bandwidth-capacity" style="color: inherit; text-decoration: none;">‚ö° Bandwidth Capacity Availability</a></h4>
                </div>
            <div class="card-metrics">
                <div class="metric-item primary" title="Total observed bandwidth capacity across all relays. Sum of observed_bandwidth from all active relays.">
                    <span class="metric-value">{{ relays.json.network_health.total_bandwidth_formatted }}</span>
                    <span class="metric-label">Total Capacity</span>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Total observed bandwidth capacity of all Exit relays. Critical for network's ability to serve user traffic.">
                        <span class="metric-value">{{ relays.json.network_health.exit_bandwidth_formatted }}</span>
                        <span class="metric-label">Exit Capacity</span>
                    </div>
                    <div class="metric-item" title="Total observed bandwidth capacity of all Guard relays. Important for network entry capacity.">
                        <span class="metric-value">{{ relays.json.network_health.guard_bandwidth_formatted }}</span>
                        <span class="metric-label">Guard Capacity</span>
                    </div>
                    <div class="metric-item" title="Total observed bandwidth capacity of all Middle relays. Provides internal network relay capacity.">
                        <span class="metric-value">{{ relays.json.network_health.middle_bandwidth_formatted }}</span>
                        <span class="metric-label">Middle Capacity</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Mean and median bandwidth capacity per Exit relay. Shows average capacity and typical relay size distribution.">
                        <span class="metric-value">{{ relays.json.network_health.exit_bw_mean_formatted }} | {{ relays.json.network_health.exit_bw_median_formatted }}</span>
                        <span class="metric-label">Exit Mean | Median</span>
                    </div>
                    <div class="metric-item" title="Mean and median bandwidth capacity per Guard relay. Shows average capacity and typical relay size distribution.">
                        <span class="metric-value">{{ relays.json.network_health.guard_bw_mean_formatted }} | {{ relays.json.network_health.guard_bw_median_formatted }}</span>
                        <span class="metric-label">Guard Mean | Median</span>
                    </div>
                    <div class="metric-item" title="Mean and median bandwidth capacity per Middle relay. Shows average capacity and typical relay size distribution.">
                        <span class="metric-value">{{ relays.json.network_health.middle_bw_mean_formatted }} | {{ relays.json.network_health.middle_bw_median_formatted }}</span>
                        <span class="metric-label">Middle Mean | Median</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Mean and median bandwidth capacity per Fast relay. Shows performance characteristics of fast relays.">
                        <span class="metric-value">{{ relays.json.network_health.fast_bw_mean_formatted }} | {{ relays.json.network_health.fast_bw_median_formatted }}</span>
                        <span class="metric-label">Fast Mean | Median</span>
                    </div>
                    <div class="metric-item" title="Mean and median bandwidth capacity per Stable relay. Shows performance characteristics of stable relays.">
                        <span class="metric-value">{{ relays.json.network_health.stable_bw_mean_formatted }} | {{ relays.json.network_health.stable_bw_median_formatted }}</span>
                        <span class="metric-label">Stable Mean | Median</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Mean and median bandwidth capacity per Directory Authority. Shows infrastructure capacity of critical nodes.">
                        <span class="metric-value">{{ relays.json.network_health.authority_bw_mean_formatted }} | {{ relays.json.network_health.authority_bw_median_formatted }}</span>
                        <span class="metric-label">Authority Mean | Median</span>
                    </div>
                    <div class="metric-item" title="Mean and median bandwidth capacity per V2Dir relay. Shows directory service capacity.">
                        <span class="metric-value">{{ relays.json.network_health.v2dir_bw_mean_formatted }} | {{ relays.json.network_health.v2dir_bw_median_formatted }}</span>
                        <span class="metric-label">V2Dir Mean | Median</span>
                    </div>
                    <div class="metric-item" title="Mean and median bandwidth capacity per HSDir relay. Shows hidden service directory capacity.">
                        <span class="metric-value">{{ relays.json.network_health.hsdir_bw_mean_formatted }} | {{ relays.json.network_health.hsdir_bw_median_formatted }}</span>
                        <span class="metric-label">HSDir Mean | Median</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Total observed bandwidth capacity of relays supporting both IPv4 and IPv6 protocols. Dual-stack bandwidth provides maximum connectivity capacity.">
                        <span class="metric-value">{{ relays.json.network_health.both_ipv4_ipv6_bandwidth_formatted }} ({{ "%.1f%%"|format(relays.json.network_health.both_ipv4_ipv6_bandwidth_percentage) }})</span>
                        <span class="metric-label">Capacity with IPv4 & IPv6</span>
                    </div>
                    <div class="metric-item" title="Total observed bandwidth capacity of relays supporting only IPv4 protocol. These relays cannot provide IPv6 connectivity.">
                        <span class="metric-value">{{ relays.json.network_health.ipv4_only_bandwidth_formatted }} ({{ "%.1f%%"|format(relays.json.network_health.ipv4_only_bandwidth_percentage) }})</span>
                        <span class="metric-label">Capacity IPv4 Only</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Mean and median difference between observed and advertised bandwidth capacity. Indicates relay capacity accuracy.">
                        <span class="metric-value">{{ relays.json.network_health.avg_observed_advertised_diff_formatted }}</span>
                        <span class="metric-label">Obs to Adv Diff (Mean | Median)</span>
                    </div>
                    <div class="metric-item" title="Number and percentage of relays with bandwidth capacity measured by directory authorities for accuracy.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.measured_relays) }} ({{ "%.1f%%"|format(relays.json.network_health.measured_percentage) }})</span>
                        <span class="metric-label">Capacity Measured</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CARD 3: RELAY UPTIME -->
        <div class="ribbon-card relay-uptime">
            <div class="card-header" id="relay-uptime">
                <h4><a href="#relay-uptime" style="color: inherit; text-decoration: none;">‚è∞ Relay Uptime</a></h4>
            </div>
            <div class="card-metrics">
                <div class="metric-item primary" title="Average uptime percentage across all relays over the last month. Higher is better for network stability. 1mo Mean by category: Exit {{ relays.json.network_health.exit_uptime_1_month_mean_formatted }}, Guard {{ relays.json.network_health.guard_uptime_1_month_mean_formatted }}, Middle {{ relays.json.network_health.middle_uptime_1_month_mean_formatted }}, Other {{ relays.json.network_health.other_uptime_1_month_mean_formatted }}.">
                    <span class="metric-value">{{ relays.json.network_health.overall_uptime_formatted }}</span>
                    <span class="metric-label">Overall Uptime (1mo Mean)</span>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Mean and median uptime of Exit relays over 1 month. Critical for user experience and connection reliability.">
                        <span class="metric-value">{{ "%.1f"|format(relays.json.network_health.exit_uptime_1_month_mean) }}% | {{ "%.1f"|format(relays.json.network_health.exit_uptime_1_month_median) }}%</span>
                        <span class="metric-label">Exit 1mo (Mean | Median)</span>
                    </div>
                    <div class="metric-item" title="Mean and median uptime of Guard relays over 1 month. Important for initial connection stability.">
                        <span class="metric-value">{{ "%.1f"|format(relays.json.network_health.guard_uptime_1_month_mean) }}% | {{ "%.1f"|format(relays.json.network_health.guard_uptime_1_month_median) }}%</span>
                        <span class="metric-label">Guard 1mo (Mean | Median)</span>
                    </div>
                    <div class="metric-item" title="Mean and median uptime of Middle relays over 1 month. Affects overall network reliability.">
                        <span class="metric-value">{{ "%.1f"|format(relays.json.network_health.middle_uptime_1_month_mean) }}% | {{ "%.1f"|format(relays.json.network_health.middle_uptime_1_month_median) }}%</span>
                        <span class="metric-label">Middle 1mo (Mean | Median)</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Mean and median uptime of Directory Authority relays over 1 month. Critical infrastructure uptime for network coordination.">
                        <span class="metric-value">{{ "%.1f"|format(relays.json.network_health.authority_uptime_1_month_mean) }}% | {{ "%.1f"|format(relays.json.network_health.authority_uptime_1_month_median) }}%</span>
                        <span class="metric-label">Authority 1mo (Mean | Median)</span>
                    </div>
                    <div class="metric-item" title="Mean and median uptime of V2Dir relays over 1 month. Directory service reliability for clients and relays.">
                        <span class="metric-value">{{ "%.1f"|format(relays.json.network_health.v2dir_uptime_1_month_mean) }}% | {{ "%.1f"|format(relays.json.network_health.v2dir_uptime_1_month_median) }}%</span>
                        <span class="metric-label">V2Dir 1mo (Mean | Median)</span>
                    </div>
                    <div class="metric-item" title="Mean and median uptime of HSDir relays over 1 month. Hidden service directory availability.">
                        <span class="metric-value">{{ "%.1f"|format(relays.json.network_health.hsdir_uptime_1_month_mean) }}% | {{ "%.1f"|format(relays.json.network_health.hsdir_uptime_1_month_median) }}%</span>
                        <span class="metric-label">HSDir 1mo (Mean | Median)</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(1, 1fr);">
                    <div class="metric-item" title="Exit relay uptime over 1 month, 6 months, 1 year, and 5 years respectively.">
                        <span class="metric-value">{{ relays.json.network_health.exit_uptime_series_formatted }}</span>
                        <span class="metric-label">Exit: 1mo | 6mo | 1y | 5y (Mean)</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(1, 1fr);">
                    <div class="metric-item" title="Guard relay uptime over 1 month, 6 months, 1 year, and 5 years respectively.">
                        <span class="metric-value">{{ relays.json.network_health.guard_uptime_series_formatted }}</span>
                        <span class="metric-label">Guard: 1mo | 6mo | 1y | 5y (Mean)</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(1, 1fr);">
                    <div class="metric-item" title="Middle relay uptime over 1 month, 6 months, 1 year, and 5 years respectively.">
                        <span class="metric-value">{{ relays.json.network_health.middle_uptime_series_formatted }}</span>
                        <span class="metric-label">Middle: 1mo | 6mo | 1y | 5y (Mean)</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(1, 1fr);">
                    <div class="metric-item" title="Directory Authority relay uptime over 1 month, 6 months, 1 year, and 5 years respectively. Critical infrastructure uptime for network coordination.">
                        <span class="metric-value">{{ relays.json.network_health.authority_uptime_series_formatted }}</span>
                        <span class="metric-label">Authority: 1mo | 6mo | 1y | 5y (Mean)</span>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- SECOND ROW -->
    <div class="ribbon-row">
        
        <!-- CARD 4: OPERATOR PARTICIPATION -->
        <div class="ribbon-card operator-participation">
            <div class="card-header" id="operator-participation">
                <h4><a href="#operator-participation" style="color: inherit; text-decoration: none;">üë• Operator Participation</a></h4>
            </div>
            <div class="card-metrics">
                <!-- AROI Coverage - Dual Focus (matches Bandwidth Utilization style) -->
                <div class="metric-item primary" style="font-size: 18px; font-weight: 600;" title="AROI Authentication: {{ "{:,}".format(relays.json.network_health.unique_aroi_domains_count) }} unique operators using AROI domain verification across {{ "{:,}".format(relays.json.network_health.total_relays_with_aroi) }} relays ({{ "%.1f%%"|format(relays.json.network_health.total_relays_with_aroi_percentage) }} of network). Top operators: {{ relays.json.network_health.top_operators_text }}. Average: {{ relays.json.network_health.avg_relays_per_aroi_operator }} relays per operator.">
                    <span class="metric-value">
                        <a href="{{ page_ctx.path_prefix }}misc/contacts-by-bandwidth.html" style="color: inherit; text-decoration: none;">
                            {{ "{:,}".format(relays.json.network_health.unique_aroi_domains_count) }} domains
                        </a> | 
                        {{ "{:,}".format(relays.json.network_health.total_relays_with_aroi) }} relays 
                        ({{ "%.1f%%"|format(relays.json.network_health.total_relays_with_aroi_percentage) }})
                    </span>
                    <span class="metric-label">Unique AROI Operators | AROI Relays (% of network)</span>
                </div>
                
                <!-- Operator Validation Status -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Unique operators with at least one successfully validated relay ({{ "%.1f%%"|format(relays.json.network_health.validated_aroi_domains_percentage) }} of AROI operators). Validation confirms cryptographic proof of domain ownership via DNS-RSA or URI-RSA. This metric counts operators, not individual relays.">
                        <span class="metric-value" style="color: #28a745; font-weight: 600;">
                            {{ "{:,}".format(relays.json.network_health.validated_aroi_domains_count) }}
                        </span>
                        <span class="metric-label">Validated AROI Operators</span>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                            {{ "%.1f%%"|format(relays.json.network_health.validated_aroi_domains_percentage) }} of AROI
                        </div>
                    </div>
                    <div class="metric-item" title="Unique operators with no successfully validated relays ({{ "%.1f%%"|format(relays.json.network_health.invalid_aroi_domains_percentage) }} of AROI operators). These operators have AROI configuration but all their relays failed validation. This metric counts operators, not individual relays.{% if relays.json.network_health.operator_error_top5 %}
&#10;&#10;Top failure reasons (operator count):{% for error, count in relays.json.network_health.operator_error_top5 %}
&#10;‚Ä¢ {{ error }} ‚Äî {{ "{:,}".format(count) }} operators{% endfor %}{% endif %}">
                        <span class="metric-value" style="color: #dc3545;">
                            {{ "{:,}".format(relays.json.network_health.invalid_aroi_domains_count) }}
                        </span>
                        <span class="metric-label">Failed Validation</span>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                            {{ "%.1f%%"|format(relays.json.network_health.invalid_aroi_domains_percentage) }} of AROI
                        </div>
                    </div>
                </div>
                
                <!-- AROI Validation Quality (Relay-level) -->
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Relays with confirmed valid AROI proof of domain ownership via DNS-RSA or URI-RSA verification. These operators have successfully proven control of their claimed domain through cryptographic proofs. Shows {{ "%.1f%%"|format(relays.json.network_health.aroi_validated_percentage) }} of all relays and {{ "%.1f%%"|format(relays.json.network_health.aroi_validated_percentage_of_aroi) }} of relays with AROI configured.">
                        <span class="metric-value" style="color: #28a745;">{{ "{:,}".format(relays.json.network_health.aroi_validated_count) }}</span>
                        <span class="metric-label">Validated AROI Relays</span>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">{{ "%.1f%%"|format(relays.json.network_health.aroi_validated_percentage) }} all, {{ "%.1f%%"|format(relays.json.network_health.aroi_validated_percentage_of_aroi) }} AROI</div>
                    </div>
                    <div class="metric-item" title="Relays with AROI configured but validation failed ({{ "%.1f%%"|format(relays.json.network_health.aroi_invalid_percentage_of_aroi) }} of AROI relays).{% if relays.json.network_health.relay_error_top5 %}
&#10;&#10;Top validation failure reasons (relay count):{% for error, count in relays.json.network_health.relay_error_top5 %}
&#10;‚Ä¢ {{ error }} ‚Äî {{ "{:,}".format(count) }} relays{% endfor %}{% endif %}">
                        <span class="metric-value" style="color: #dc3545;">{{ "{:,}".format(relays.json.network_health.aroi_unvalidated_count) }}</span>
                        <span class="metric-label">Invalid AROI</span>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">{{ "%.1f%%"|format(relays.json.network_health.aroi_unvalidated_percentage) }} all, {{ "%.1f%%"|format(relays.json.network_health.aroi_invalid_percentage_of_aroi) }} AROI</div>
                    </div>
                    <div class="metric-item" title="Relays without AROI configuration ({{ "%.1f%%"|format(relays.json.network_health.relays_without_aroi_percentage) }} of network). These relays lack one or more required AROI fields.{% if relays.json.network_health.no_aroi_reasons_top5 %}
&#10;&#10;Top missing-field reasons:{% for reason, count in relays.json.network_health.no_aroi_reasons_top5 %}
&#10;‚Ä¢ {{ reason }} ‚Äî {{ "{:,}".format(count) }} relays{% endfor %}{% endif %}">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.relays_without_aroi) }}</span>
                        <span class="metric-label">No AROI</span>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">{{ "%.1f%%"|format(relays.json.network_health.relays_without_aroi_percentage) }} of all relays</div>
                    </div>
                </div>
                <!-- DNS-RSA and URI-RSA Validation Rates -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="DNS-RSA validation: {{ "{:,}".format(relays.json.network_health.dns_rsa_valid) }}/{{ "{:,}".format(relays.json.network_health.dns_rsa_total) }} relays validated. DNS-RSA uses DNS TXT records for domain verification.{% if relays.json.network_health.dns_error_top5 %}
&#10;&#10;Top DNS failure reasons:{% for error, count in relays.json.network_health.dns_error_top5 %}
&#10;‚Ä¢ {{ error }} ‚Äî {{ "{:,}".format(count) }} relays{% endfor %}{% endif %}">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.dns_rsa_valid) }}/{{ "{:,}".format(relays.json.network_health.dns_rsa_total) }} ({{ "%.1f%%"|format(relays.json.network_health.dns_rsa_success_rate) }})</span>
                        <span class="metric-label">DNS-RSA Validated</span>
                    </div>
                    <div class="metric-item" title="URI-RSA validation: {{ "{:,}".format(relays.json.network_health.uri_rsa_valid) }}/{{ "{:,}".format(relays.json.network_health.uri_rsa_total) }} relays validated. URI-RSA fetches proof from web server.{% if relays.json.network_health.uri_error_top5 %}
&#10;&#10;Top URI failure reasons:{% for error, count in relays.json.network_health.uri_error_top5 %}
&#10;‚Ä¢ {{ error }} ‚Äî {{ "{:,}".format(count) }} relays{% endfor %}{% endif %}">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.uri_rsa_valid) }}/{{ "{:,}".format(relays.json.network_health.uri_rsa_total) }} ({{ "%.1f%%"|format(relays.json.network_health.uri_rsa_success_rate) }})</span>
                        <span class="metric-label">URI-RSA Validated</span>
                    </div>
                </div>
                <!-- Contact Row (moved before Family) -->
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Total number of unique contact addresses provided by relay operators.">
                        <span class="metric-value"><a href="{{ page_ctx.path_prefix }}misc/contacts-by-bandwidth.html" style="color: inherit; text-decoration: none;">{{ "{:,}".format(relays.json.network_health.unique_contacts_count) }}</a></span>
                        <span class="metric-label">Total Contacts</span>
                    </div>
                    <div class="metric-item" title="Relays with contact information provided. Important for network communication and accountability.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.relays_with_contact) }} ({{ "%.1f%%"|format(relays.json.network_health.relays_with_contact_percentage) }})</span>
                        <span class="metric-label">With Contact</span>
                    </div>
                    <div class="metric-item" title="Relays without contact information. Should provide contact info for network administration.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.relays_without_contact) }} ({{ "%.1f%%"|format(relays.json.network_health.relays_without_contact_percentage) }})</span>
                        <span class="metric-label">Without Contact</span>
                    </div>
                </div>
                <!-- Family Row (moved after Contact) -->
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Total number of unique relay families - distinct groups of relays operated by the same entity.">
                        <span class="metric-value"><a href="{{ page_ctx.path_prefix }}misc/families-by-bandwidth.html" style="color: inherit; text-decoration: none;">{{ "{:,}".format(relays.json.network_health.families_count) }}</a></span>
                        <span class="metric-label">Total Families</span>
                    </div>
                    <div class="metric-item" title="Relays with family configuration. Family configuration helps prevent path selection issues.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.relays_with_family) }} ({{ "%.1f%%"|format(relays.json.network_health.relays_with_family_percentage) }})</span>
                        <span class="metric-label">With Family</span>
                    </div>
                    <div class="metric-item" title="Relays without family configuration. Should configure family relationships for proper network behavior.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.relays_without_family) }} ({{ "%.1f%%"|format(relays.json.network_health.relays_without_family_percentage) }})</span>
                        <span class="metric-label">Without Family</span>
                    </div>
                </div>
                <!-- IPv6 Row -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Number and percentage of validated AROI operators running at least one relay with both IPv4 and IPv6 support. Percentage is calculated as a portion of the {{ "{:,}".format(relays.json.network_health.validated_aroi_domains_count) }} validated AROI operators.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.both_ipv4_ipv6_aroi_operators) }} ({{ "%.1f%%"|format(relays.json.network_health.both_ipv4_ipv6_aroi_operators_percentage) }})</span>
                        <span class="metric-label">Validated AROI with IPv4 & IPv6</span>
                    </div>
                    <div class="metric-item" title="Number and percentage of validated AROI operators running only IPv4-only relays (no dual-stack relays). Percentage is calculated as a portion of the {{ "{:,}".format(relays.json.network_health.validated_aroi_domains_count) }} validated AROI operators.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.ipv4_only_aroi_operators) }} ({{ "%.1f%%"|format(relays.json.network_health.ipv4_only_aroi_operators_percentage) }})</span>
                        <span class="metric-label">Validated AROI with IPv4 Only</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CARD 5: GEOGRAPHIC PARTICIPATION -->
        <div class="ribbon-card geographic-participation">
            <div class="card-header" id="geographic-participation">
                <h4><a href="#geographic-participation" style="color: inherit; text-decoration: none;">üåç Geographic Participation</a></h4>
            </div>
            <div class="card-metrics">
                <div class="metric-item primary" title="Number of countries hosting Tor relays. Higher geographic diversity improves censorship resistance and network resilience.">
                    <span class="metric-value"><a href="{{ page_ctx.path_prefix }}misc/countries-by-bandwidth.html" style="color: inherit; text-decoration: none;">{{ "{:,}".format(relays.json.network_health.countries_count) }}</a></span>
                    <span class="metric-label">Unique Countries</span>
                </div>
                <!-- NEW: Top 3 Countries by Consensus Weight -->
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    {% for country in relays.json.network_health.top_3_countries %}
                    <div class="metric-item" title="Country ranked #{{ country.rank }} by consensus weight concentration in the Tor network.">
                        <span class="metric-value">{{ "%.1f%%"|format(country.consensus_weight_percentage) }} <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ country.country_code.lower() }}.png" alt="{{ country.country_code }}" style="width: 16px; height: 11px; margin-left: 3px;"> {{ country.country_code }}</span>
                        <span class="metric-label">#{{ country.rank }} Country CW</span>
                    </div>
                    {% endfor %}
                </div>
                <!-- First Row: EU/Non-EU/Rare Consensus Weight -->
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Total consensus weight held by relays in European Union countries. Shows EU influence on network routing decisions. {{ "{:,}".format(relays.json.network_health.eu_relays_count) }} ({{ "%.1f%%"|format(relays.json.network_health.eu_relays_percentage) }}) are EU relays.">
                        <span class="metric-value">{{ "%.1f%%"|format(relays.json.network_health.eu_consensus_weight_percentage) }}</span>
                        <span class="metric-label">EU Consensus Weight</span>
                    </div>
                    <div class="metric-item" title="Total consensus weight held by relays in non-European Union countries. Shows non-EU influence on network routing decisions. {{ "{:,}".format(relays.json.network_health.non_eu_relays_count) }} ({{ "%.1f%%"|format(relays.json.network_health.non_eu_relays_percentage) }}) are non-EU relays.">
                        <span class="metric-value">{{ "%.1f%%"|format(relays.json.network_health.non_eu_consensus_weight_percentage) }}</span>
                        <span class="metric-label">Non-EU Consensus Weight</span>
                    </div>
                    <div class="metric-item" title="Total consensus weight held by relays in rare/frontier countries. Shows frontier countries' influence on network routing decisions. {{ "{:,}".format(relays.json.network_health.rare_countries_relays) }} ({{ "%.1f%%"|format(relays.json.network_health.rare_countries_relays_percentage) }}) are rare country relays.">
                        <span class="metric-value">{{ "%.1f%%"|format(relays.json.network_health.rare_countries_consensus_weight_percentage) }}</span>
                        <span class="metric-label">Rare Countries Consensus Weight</span>
                    </div>
                </div>
                <!-- Second Row: Five Eyes and Fourteen Eyes Consensus Weight -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Total consensus weight held by relays in Five Eyes intelligence alliance countries (US, UK, CA, AU, NZ). Shows Five Eyes influence on network routing decisions.">
                        <span class="metric-value">{{ relays.json.network_health.jurisdiction_five_eyes }}%</span>
                        <span class="metric-label">Five Eyes Consensus Weight</span>
                    </div>
                    <div class="metric-item" title="Total consensus weight held by relays in Fourteen Eyes intelligence alliance countries (Five Eyes plus DE, FR, IT, ES, NL, BE, DK, SE, NO). Shows extended intelligence alliance influence on network routing decisions.">
                        <span class="metric-value">{{ relays.json.network_health.jurisdiction_fourteen_eyes }}%</span>
                        <span class="metric-label">Fourteen Eyes Consensus Weight</span>
                    </div>
                </div>
                <!-- Top 3 Countries by Validated AROI Operators -->
                {% if relays.json.network_health.top_3_aroi_countries %}
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    {% for country in relays.json.network_health.top_3_aroi_countries %}
                    <div class="metric-item" title="Country ranked #{{ country.rank }} by number of validated AROI operators. {{ country.count }} validated AROI operators ({{ "%.1f%%"|format(country.percentage) }} of all validated operators) are based in {{ country.country_code }}.">
                        <span class="metric-value">{{ country.count }} ({{ "%.1f%%"|format(country.percentage) }}) <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ country.country_code.lower() }}.png" alt="{{ country.country_code }}" style="width: 16px; height: 11px; margin-left: 3px;"> {{ country.country_code }}</span>
                        <span class="metric-label">#{{ country.rank }} AROI Operators</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                <!-- IPv6 Country Row -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Top country with the highest number of relays supporting both IPv4 and IPv6 protocols.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.top_both_ipv4_ipv6_country_count) }} ({{ "%.1f%%"|format(relays.json.network_health.top_both_ipv4_ipv6_country_percentage) }}) <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relays.json.network_health.top_both_ipv4_ipv6_country.lower() }}.png" alt="{{ relays.json.network_health.top_both_ipv4_ipv6_country }}" style="width: 16px; height: 11px; margin-left: 3px;"> {{ relays.json.network_health.top_both_ipv4_ipv6_country }}</span>
                        <span class="metric-label">#1 Country IPv4 & IPv6</span>
                    </div>
                    <div class="metric-item" title="Top country with the highest number of relays supporting IPv4-only protocol.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.top_ipv4_only_country_count) }} ({{ "%.1f%%"|format(relays.json.network_health.top_ipv4_only_country_percentage) }}) <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relays.json.network_health.top_ipv4_only_country.lower() }}.png" alt="{{ relays.json.network_health.top_ipv4_only_country }}" style="width: 16px; height: 11px; margin-left: 3px;"> {{ relays.json.network_health.top_ipv4_only_country }}</span>
                        <span class="metric-label">#1 Country IPv4 Only</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CARD 6: PROVIDER PARTICIPATION -->
        <div class="ribbon-card provider-participation">
            <div class="card-header" id="provider-participation">
                <h4><a href="#provider-participation" style="color: inherit; text-decoration: none;">üè¢ Provider Participation</a></h4>
            </div>
            <div class="card-metrics">
                <div class="metric-item primary" title="Unique Autonomous Systems hosting relays. Higher AS diversity reduces single points of failure and improves network resilience.">
                    <span class="metric-value"><a href="{{ page_ctx.path_prefix }}misc/networks-by-bandwidth.html" style="color: inherit; text-decoration: none;">{{ "{:,}".format(relays.json.network_health.unique_as_count) }}</a></span>
                    <span class="metric-label">Unique AS</span>
                </div>
                <!-- NEW: Top 3 AS by Consensus Weight -->
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    {% for as_info in relays.json.network_health.top_3_as %}
                    <div class="metric-item" title="AS{{ as_info.as_number }} ({{ as_info.as_name }}) - Autonomous System ranked #{{ as_info.rank }} by consensus weight concentration.">
                        <span class="metric-value">{{ "%.1f%%"|format(as_info.consensus_weight_percentage) }} {{ as_info.as_name_truncated }}</span>
                        <span class="metric-label">#{{ as_info.rank }} AS CW</span>
                    </div>
                    {% endfor %}
                </div>
                <!-- NEW: AS Concentration Metrics -->
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Total consensus weight held by the top 3 Autonomous Systems. Shows network concentration risk.">
                        <span class="metric-value">{{ "%.1f%%"|format(relays.json.network_health.top_3_as_concentration) }}</span>
                        <span class="metric-label">Top 3 AS CW Share</span>
                    </div>
                    <div class="metric-item" title="Total consensus weight held by the top 5 Autonomous Systems. Shows network concentration risk.">
                        <span class="metric-value">{{ "%.1f%%"|format(relays.json.network_health.top_5_as_concentration) }}</span>
                        <span class="metric-label">Top 5 AS CW Share</span>
                    </div>
                    <div class="metric-item" title="Total consensus weight held by the top 10 Autonomous Systems. Shows network concentration risk.">
                        <span class="metric-value">{{ "%.1f%%"|format(relays.json.network_health.top_10_as_concentration) }}</span>
                        <span class="metric-label">Top 10 AS CW Share</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Average number of Autonomous Systems per country. Indicates infrastructure diversity within countries.">
                        <span class="metric-value">{{ relays.json.network_health.avg_as_per_country }}</span>
                        <span class="metric-label">Avg AS/Country</span>
                    </div>
                    <div class="metric-item" title="Average number of AROI operators per Autonomous System. Shows operator distribution across providers.">
                        <span class="metric-value">{{ relays.json.network_health.avg_aroi_per_as }}</span>
                        <span class="metric-label">Avg AROI/AS</span>
                    </div>
                    <div class="metric-item" title="Average number of relay families per Autonomous System. Indicates family distribution across providers.">
                        <span class="metric-value">{{ relays.json.network_health.avg_families_per_as }}</span>
                        <span class="metric-label">Avg Families/AS</span>
                    </div>
                </div>
                <!-- IPv6 AS Row -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Autonomous System with the highest number of relays supporting both IPv4 and IPv6 protocols.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.top_both_ipv4_ipv6_as_count) }} ({{ "%.1f%%"|format(relays.json.network_health.top_both_ipv4_ipv6_as_percentage) }}) {{ relays.json.network_health.top_both_ipv4_ipv6_as_name }}</span>
                        <span class="metric-label">#1 AS IPv4 & IPv6</span>
                    </div>
                    <div class="metric-item" title="Autonomous System with the highest number of relays supporting IPv4-only protocol.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.top_ipv4_only_as_count) }} ({{ "%.1f%%"|format(relays.json.network_health.top_ipv4_only_as_percentage) }}) {{ relays.json.network_health.top_ipv4_only_as_name }}</span>
                        <span class="metric-label">#1 AS IPv4 Only</span>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- THIRD ROW -->
    <div class="ribbon-row">
        
        <!-- CARD 8: BANDWIDTH UTILIZATION -->
        <div class="ribbon-card bandwidth-utilization">
            <div class="card-header" id="bandwidth-utilization">
                <h4><a href="#bandwidth-utilization" style="color: inherit; text-decoration: none;">üìà Bandwidth Utilization</a></h4>
            </div>
            <div class="card-metrics">
                <div class="metric-item primary" title="Network-wide CW/BW ratio mean and median across all relays. CW/BW ratio = Consensus Weight √∑ Bandwidth Capacity √ó 1,000,000. Higher ratios indicate better network utilization per bandwidth capacity contributed. Same calculation as Performance Insights in contact operator pages.">
                    <span class="metric-value">{{ relays.json.network_health.cw_bw_ratio_overall_mean }} | {{ relays.json.network_health.cw_bw_ratio_overall_median }}</span>
                    <span class="metric-label">CW/BW Ratio Network Mean | Median</span>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Guard relay CW/BW ratio network mean and median. Performance compared to all guard relays network-wide. Same calculation as Performance Insights in contact operator pages.">
                        <span class="metric-value">{{ relays.json.network_health.cw_bw_ratio_guard_mean }} | {{ relays.json.network_health.cw_bw_ratio_guard_median }}</span>
                        <span class="metric-label">Guard CW/BW Ratio Mean | Median</span>
                    </div>
                    <div class="metric-item" title="Exit relay CW/BW ratio network mean and median. Performance compared to all exit relays network-wide. Same calculation as Performance Insights in contact operator pages.">
                        <span class="metric-value">{{ relays.json.network_health.cw_bw_ratio_exit_mean }} | {{ relays.json.network_health.cw_bw_ratio_exit_median }}</span>
                        <span class="metric-label">Exit CW/BW Ratio Mean | Median</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="EU relay CW/BW ratio network mean and median. Performance of relays in European Union countries. CW/BW ratio = Consensus Weight √∑ Bandwidth Capacity √ó 1,000,000.">
                        <span class="metric-value">{{ relays.json.network_health.eu_cw_bw_mean }} | {{ relays.json.network_health.eu_cw_bw_median }}</span>
                        <span class="metric-label">EU CW/BW Ratio Mean | Median</span>
                    </div>
                    <div class="metric-item" title="Non-EU relay CW/BW ratio network mean and median. Performance of relays in non-European Union countries. CW/BW ratio = Consensus Weight √∑ Bandwidth Capacity √ó 1,000,000.">
                        <span class="metric-value">{{ relays.json.network_health.non_eu_cw_bw_mean }} | {{ relays.json.network_health.non_eu_cw_bw_median }}</span>
                        <span class="metric-label">Non-EU CW/BW Ratio Mean | Median</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Top 3 AS relay CW/BW ratio network mean and median. Performance of relays in the 3 largest Autonomous Systems by consensus weight. CW/BW ratio = Consensus Weight √∑ Bandwidth Capacity √ó 1,000,000.">
                        <span class="metric-value">{{ relays.json.network_health.top_3_as_cw_bw_mean }} | {{ relays.json.network_health.top_3_as_cw_bw_median }}</span>
                        <span class="metric-label">Top 3 AS CW/BW Ratio Mean | Median</span>
                    </div>
                    <div class="metric-item" title="Top 5 AS relay CW/BW ratio network mean and median. Performance of relays in the 5 largest Autonomous Systems by consensus weight. CW/BW ratio = Consensus Weight √∑ Bandwidth Capacity √ó 1,000,000.">
                        <span class="metric-value">{{ relays.json.network_health.top_5_as_cw_bw_mean }} | {{ relays.json.network_health.top_5_as_cw_bw_median }}</span>
                        <span class="metric-label">Top 5 AS CW/BW Ratio Mean | Median</span>
                    </div>
                    <div class="metric-item" title="Top 10 AS relay CW/BW ratio network mean and median. Performance of relays in the 10 largest Autonomous Systems by consensus weight. CW/BW ratio = Consensus Weight √∑ Bandwidth Capacity √ó 1,000,000.">
                        <span class="metric-value">{{ relays.json.network_health.top_10_as_cw_bw_mean }} | {{ relays.json.network_health.top_10_as_cw_bw_median }}</span>
                        <span class="metric-label">Top 10 AS CW/BW Ratio Mean | Median</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CARD 9: VERSION COMPLIANCE -->
        <div class="ribbon-card version-compliance">
            <div class="card-header" id="version-compliance">
                <h4><a href="#version-compliance" style="color: inherit; text-decoration: none;">üîÑ Version Compliance</a></h4>
            </div>
            <div class="card-metrics">
                <div class="metric-item primary" title="Percentage of relays running Tor versions recommended by directory authorities. Higher is better for security.">
                    <span class="metric-value">{{ "%.1f%%"|format(relays.json.network_health.recommended_version_percentage) }}</span>
                    <span class="metric-label">Recommended Version %</span>
                </div>
                <div class="metric-grid">
                    <div class="metric-item" title="Number of relays not running recommended Tor versions. May have security vulnerabilities.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.not_recommended_count) }} ({{ "%.1f%%"|format(relays.json.network_health.not_recommended_percentage) }})</span>
                        <span class="metric-label">Not Recommended</span>
                    </div>
                    <div class="metric-item" title="Number of relays running experimental Tor versions. Newer than recommended versions.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.experimental_count) }} ({{ "%.1f%%"|format(relays.json.network_health.experimental_percentage) }})</span>
                        <span class="metric-label">Experimental</span>
                    </div>
                    <div class="metric-item" title="Number of relays running obsolete Tor versions. Older than all recommended versions.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.obsolete_count) }} ({{ "%.1f%%"|format(relays.json.network_health.obsolete_percentage) }})</span>
                        <span class="metric-label">Obsolete</span>
                    </div>
                    <div class="metric-item" title="Number of relays running outdated or unrecommended Tor versions. Should be upgraded for security.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.outdated_count) }} ({{ "%.1f%%"|format(relays.json.network_health.outdated_percentage) }})</span>
                        <span class="metric-label">Outdated</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CARD 7: UNIQUE OPERATING SYSTEMS -->
        <div class="ribbon-card platform-counts">
            <div class="card-header" id="operating-systems">
                <h4><a href="#operating-systems" style="color: inherit; text-decoration: none;">üíª Unique Operating Systems</a></h4>
            </div>
            <div class="card-metrics">
                <div class="metric-item primary" title="Number of unique platform strings reported by relays. Shows diversity of operating systems and Tor versions.">
                    <span class="metric-value">{{ "{:,}".format(relays.json.network_health.unique_platforms_count) }}</span>
                    <span class="metric-label">Unique Operating Systems</span>
                </div>
                <div class="metric-grid">
                    {% for platform, count_formatted, percentage_formatted in relays.json.network_health.platform_top3_formatted %}
                    <div class="metric-item" title="Number of relays running {{ platform }}. Top platforms by relay count.">
                        <span class="metric-value">{{ count_formatted }} ({{ percentage_formatted }})</span>
                        <span class="metric-label">{{ platform }}</span>
                    </div>
                    {% endfor %}
                    <div class="metric-item" title="Number of relays running all other platforms combined.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.platform_others) }} ({{ "%.0f%%"|format(relays.json.network_health.platform_others_percentage) }})</span>
                        <span class="metric-label">Others</span>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- FOURTH ROW -->
    <div class="ribbon-row">
        
        <!-- CARD 11: HAPPY FAMILY KEY MIGRATION -->
        <div class="ribbon-card happy-family-migration">
            <div class="card-header" id="happy-families">
                <h4><a href="#happy-families" style="color: inherit; text-decoration: none;">üîë Happy Families Key Migration</a></h4>
            </div>
            <div class="card-metrics">
                <!-- Row 1: DA Readiness (primary) -->
                <div class="metric-item primary" title="Voting directory authorities running Tor ‚â•0.4.9.x, which implements Proposal 321 (Happy Families) with family-cert support.">
                    <span class="metric-value" style="{% if relays.json.network_health.hf_consensus_total_voters > 0 and relays.json.network_health.hf_ready_authorities == relays.json.network_health.hf_consensus_total_voters %}color: #28a745;{% elif relays.json.network_health.hf_ready_authorities > 0 %}color: #ff8c00;{% else %}color: #dc3545;{% endif %} font-weight: 700;">
                        {{ relays.json.network_health.hf_ready_authorities }}/{{ relays.json.network_health.hf_consensus_total_voters }}
                    </span>
                    <span class="metric-label">Dir Authorities on v0.4.9.x+</span>
                </div>
                
                <!-- Row 2: Consensus Method + DAs Support Max Method -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Current consensus-method from the consensus document (dir-spec ¬ß3.4.1). Must advance to minimum method {{ relays.json.network_health.hf_consensus_method_max|default('?', true) }} for family-ids to appear in microdescriptors.">
                        <span class="metric-value" style="{% if relays.json.network_health.hf_consensus_method and relays.json.network_health.hf_consensus_method_max and relays.json.network_health.hf_consensus_method >= relays.json.network_health.hf_consensus_method_max %}color: #28a745;{% elif relays.json.network_health.hf_consensus_method %}color: #dc3545;{% else %}color: #6c757d;{% endif %} font-weight: 600;">
                            {{ relays.json.network_health.hf_consensus_method|default('N/A', true) }}
                        </span>
                        <span class="metric-label">Consensus Method{% if relays.json.network_health.hf_consensus_method_max %} (max: {{ relays.json.network_health.hf_consensus_method_max }}){% endif %}</span>
                    </div>
                    <div class="metric-item" title="Authorities advertising method {{ relays.json.network_health.hf_consensus_method_max|default('?', true) }} in their consensus-methods vote header. Per dirvote.c, a 2/3 supermajority (>‚åän√ó2/3‚åã) is required to activate a new method.">
                        <span class="metric-value" style="{% if relays.json.network_health.hf_max_method_support >= relays.json.network_health.hf_method_threshold and relays.json.network_health.hf_method_threshold > 0 %}color: #28a745;{% elif relays.json.network_health.hf_max_method_support > 0 %}color: #cc9900;{% else %}color: #dc3545;{% endif %}">
                            {{ relays.json.network_health.hf_max_method_support }}/{{ relays.json.network_health.hf_consensus_total_voters }}
                        </span>
                        <span class="metric-label">DAs Support Method {{ relays.json.network_health.hf_consensus_method_max|default('?', true) }} (Need {{ relays.json.network_health.hf_method_threshold }} for Majority)</span>
                    </div>
                </div>
                
                <!-- Row 3: Consensus Parameters (hidden when data unavailable, auto-populates when authorities vote on them) -->
                {% if relays.json.network_health.hf_use_family_ids is not none or relays.json.network_health.hf_use_family_lists is not none %}
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Consensus parameter use-family-ids (param-spec). When 1, clients enforce family membership via family-ids in microdescriptors per Proposal 321. Default: 1.">
                        <span class="metric-value">
                            {% if relays.json.network_health.hf_use_family_ids is not none %}
                                {% if relays.json.network_health.hf_use_family_ids == 1 %}
                                    <span style="color: #28a745; font-weight: 600;">Yes</span>
                                {% else %}
                                    <span style="color: #cc9900; font-weight: 600;">No</span>
                                {% endif %}
                            {% endif %}
                        </span>
                        <span class="metric-label">Clients Using Happy Families</span>
                    </div>
                    <div class="metric-item" title="Consensus parameter use-family-lists (param-spec). When 0, the legacy MyFamily system is deprecated ‚Äî operators can remove MyFamily from torrc, reducing microdescriptors by ~80%. Default: 1.">
                        <span class="metric-value">
                            {% if relays.json.network_health.hf_use_family_lists is not none %}
                                {% if relays.json.network_health.hf_use_family_lists == 0 %}
                                    <span style="color: #28a745; font-weight: 600;">Yes</span>
                                {% else %}
                                    <span style="color: #cc9900; font-weight: 600;">No</span>
                                {% endif %}
                            {% endif %}
                        </span>
                        <span class="metric-label">MyFamily Deprecated</span>
                    </div>
                </div>
                {% endif %}
                
                <!-- Row 4: Family-cert adoption from server descriptors -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Relays publishing a family-cert entry in their server descriptor, proving family membership via an ed25519 family key (Proposal 321). Source: CollecTor server descriptors, last 18 hourly files. Tracking {{ "{:,}".format(relays.json.network_health.hf_family_cert_seen_total) }} relays.">
                        <span class="metric-value" style="color: #28a745; font-weight: 600;">{{ "{:,}".format(relays.json.network_health.hf_family_cert_count) }}</span>
                        <span class="metric-label">Relays with family-cert</span>
                    </div>
                    <div class="metric-item" title="Relays seen in server descriptors without a family-cert entry. Operators can add one with 'tor --keygen-family' (requires Tor ‚â•0.4.9.2-alpha). Source: CollecTor server descriptors.">
                        <span class="metric-value" style="color: #dc3545;">{{ "{:,}".format(relays.json.network_health.hf_family_no_cert_count) }}</span>
                        <span class="metric-label">Relays without family-cert</span>
                    </div>
                </div>
                
                <!-- Row 5: Operator adoption from server descriptors (AROI validated) -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Validated AROI operators with at least one relay publishing family-cert. Source: CollecTor server descriptors matched against AROI-validated operator domains. Percentage of {{ "{:,}".format(relays.json.network_health.hf_total_validated_operators) }} validated operators.">
                        <span class="metric-value" style="color: #28a745;">{{ "{:,}".format(relays.json.network_health.hf_some_operators) }} ({{ "%.1f%%"|format(relays.json.network_health.hf_some_operators_percentage) }})</span>
                        <span class="metric-label">Operators with ‚â•1 family-cert</span>
                    </div>
                    <div class="metric-item" title="Validated AROI operators where every relay publishes family-cert. Fully transitioned to Proposal 321. Source: CollecTor server descriptors. Percentage of {{ "{:,}".format(relays.json.network_health.hf_total_validated_operators) }} validated operators.">
                        <span class="metric-value" style="color: {% if relays.json.network_health.hf_all_operators > 0 %}#28a745{% else %}#dc3545{% endif %}; font-weight: 600;">{{ "{:,}".format(relays.json.network_health.hf_all_operators) }} ({{ "%.1f%%"|format(relays.json.network_health.hf_all_operators_percentage) }})</span>
                        <span class="metric-label">Operators Fully Migrated</span>
                    </div>
                </div>
                
                <!-- Row 6: Relay Version Adoption -->
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Relays running Tor ‚â•0.4.9.1-alpha, the first version implementing Proposal 321 family-cert support. Source: Onionoo details API version field.">
                        <span class="metric-value" style="color: #28a745;">{{ "{:,}".format(relays.json.network_health.hf_ready_relays) }} ({{ "%.1f%%"|format(relays.json.network_health.hf_ready_relays_percentage) }})</span>
                        <span class="metric-label">Relays on v0.4.9.x+</span>
                    </div>
                    <div class="metric-item" title="Relays running Tor <0.4.9.x without Proposal 321 support. Must upgrade before they can publish family-cert. Source: Onionoo details API version field.">
                        <span class="metric-value" style="color: #dc3545;">{{ "{:,}".format(relays.json.network_health.hf_not_ready_relays) }} ({{ "%.1f%%"|format(relays.json.network_health.hf_not_ready_relays_percentage) }})</span>
                        <span class="metric-label">Relays on Older Versions</span>
                    </div>
                </div>
                
                <!-- Row 7: Role breakdown + CW -->
                <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-item" title="Exit relays running Tor ‚â•0.4.9.x (Proposal 321 capable). Source: Onionoo details API.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.hf_ready_exit_relays) }}</span>
                        <span class="metric-label">Exit Relays Ready</span>
                    </div>
                    <div class="metric-item" title="Guard relays running Tor ‚â•0.4.9.x (Proposal 321 capable). Source: Onionoo details API.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.hf_ready_guard_relays) }}</span>
                        <span class="metric-label">Guard Relays Ready</span>
                    </div>
                    <div class="metric-item" title="Fraction of total consensus weight contributed by relays running Tor ‚â•0.4.9.x. Source: Onionoo details API.">
                        <span class="metric-value">{{ "%.1f%%"|format(relays.json.network_health.hf_ready_cw_percentage) }}</span>
                        <span class="metric-label">CW Ready</span>
                    </div>
                </div>
                
                <!-- Row 8: Bandwidth ready -->
                <div class="metric-grid" style="grid-template-columns: repeat(1, 1fr);">
                    <div class="metric-item" title="Total observed bandwidth from relays running Tor ‚â•0.4.9.x (Proposal 321 capable). Source: Onionoo details API.">
                        <span class="metric-value">{{ relays.json.network_health.hf_ready_bandwidth_formatted }} ({{ "%.1f%%"|format(relays.json.network_health.hf_ready_bandwidth_percentage) }})</span>
                        <span class="metric-label">Bandwidth Capacity Ready</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CARD 10: EXIT POLICIES -->
        <div class="ribbon-card exit-policies">
            <div class="card-header" id="exit-policies">
                <h4><a href="#exit-policies" style="color: inherit; text-decoration: none;">üö™ Exit Policies</a></h4>
            </div>
            <div class="card-metrics">
                <div class="metric-item primary" title="Number and percentage of exit relays without ANY restrictions - neither port restrictions nor public IP address restrictions. These relays provide maximum utility for Tor users, allowing unrestricted access to all public internet resources.">
                    <span class="metric-value">{{ "{:,}".format(relays.json.network_health.unrestricted_and_no_ip_restrictions) }} ({{ "%.1f%%"|format(relays.json.network_health.unrestricted_and_no_ip_restrictions_percentage) }})</span>
                    <span class="metric-label">Completely Unrestricted Relays</span>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Number and percentage of exit relays without port restrictions, allowing all traffic to any destination port. These relays provide comprehensive port access for Tor users.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.unrestricted_exits) }} ({{ "%.1f%%"|format(relays.json.network_health.unrestricted_exits_percentage) }})</span>
                        <span class="metric-label">without Port Restrictions</span>
                    </div>
                    <div class="metric-item" title="Number and percentage of exit relays with port restrictions. These relays block certain types of traffic based on destination port.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.restricted_exits) }} ({{ "%.1f%%"|format(relays.json.network_health.restricted_exits_percentage) }})</span>
                        <span class="metric-label">with Port Restrictions</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(1, 1fr);">
                    <div class="metric-item" title="Number and percentage of exit relays that allow web traffic on ports 80 and 443. Essential for basic web browsing functionality.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.web_traffic_exits) }} ({{ "%.1f%%"|format(relays.json.network_health.web_traffic_exits_percentage) }})</span>
                        <span class="metric-label">allow Web Traffic (ports 80, 443)</span>
                    </div>
                </div>
                <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="metric-item" title="Number and percentage of exit relays without public IP address restrictions. These relays accept traffic from any public IP address (restrictions on private IP ranges like 192.168.x, 10.x are not counted).">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.ip_unrestricted_exits) }} ({{ "%.1f%%"|format(relays.json.network_health.ip_unrestricted_exits_percentage) }})</span>
                        <span class="metric-label">without Public IP Restrictions</span>
                    </div>
                    <div class="metric-item" title="Number and percentage of exit relays with public IP address restrictions limiting connections from specific public IP addresses or ranges. Restrictions on private IP ranges (192.168.x, 10.x, 127.x, etc.) are not counted as they don't limit access to public internet resources.">
                        <span class="metric-value">{{ "{:,}".format(relays.json.network_health.ip_restricted_exits) }} ({{ "%.1f%%"|format(relays.json.network_health.ip_restricted_exits_percentage) }})</span>
                        <span class="metric-label">with Public IP Restrictions</span>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- LAST UPDATED -->
    <div class="ribbon-footer">
        <p class="last-updated">Last updated: {{ page_ctx.timestamp_str }} UTC</p>
    </div>
    
</div>

{% endblock -%} 