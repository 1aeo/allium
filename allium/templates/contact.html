{% extends "relay-list.html" %}
{% from "macros.html" import navigation, detail_summary %}
{% set contact_hash = relays.json['relay_subset'][0]['contact_md5'] %}
{% if relays.json['relay_subset'][0]['contact'] %}
    {% set contact = relays.json['relay_subset'][0]['contact']|escape %}
{% else %}
    {% set contact = 'none' %}
{% endif %}
{% block title %}Tor Relays :: Contact {{ contact_hash }}{% endblock %}
{% block header %}
    {% if relays.json['relay_subset'][0]['aroi_domain'] and relays.json['relay_subset'][0]['aroi_domain'] != 'none' -%}
        View Contact {{ relays.json['relay_subset'][0]['aroi_domain']|escape }} Details
    {% elif contact != 'none' -%}
        View Contact {{ contact }} Details
    {% else -%}
        View Contact {{ contact_hash }} Details
    {% endif -%}
{% endblock %}
{% block navigation -%}
{% set aroi_domain = relays.json['relay_subset'][0]['aroi_domain'] if relays.json['relay_subset'][0]['aroi_domain'] else 'none' %}
{{ navigation('contacts', page_ctx) }}
{% endblock -%}
{% block description %}Contact {{ contact_hash }} summary:
{{ detail_summary(bandwidth, bandwidth_unit, guard_bandwidth, middle_bandwidth, exit_bandwidth, consensus_weight_fraction, guard_consensus_weight_fraction, middle_consensus_weight_fraction, exit_consensus_weight_fraction, guard_count, middle_count, exit_count, relays.json['relay_subset']|length, network_position) }}

{# Contact Intelligence Phase 1 + Phase 2 - using pre-calculated data from intelligence engine #}
{% if relays.json.smart_context and relays.json.smart_context.contact_intelligence and relays.json.smart_context.contact_intelligence.template_optimized.get(contact_hash) %}
{% set contact_intel = relays.json.smart_context.contact_intelligence.template_optimized[contact_hash] %}
<div class="intelligence-section" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-left: 4px solid #007bff;">
    <h4 style="margin-top: 0; color: #495057;">Operator Intelligence</h4>
    
    <ul style="list-style-type: disc; padding-left: 20px; margin-bottom: 0;">
        <li><strong><span title="Network diversity measures infrastructure distribution across different autonomous systems (AS). Risk levels: 1 network = high risk (single point of failure), 2-3 networks = medium risk (limited redundancy), 4+ networks = low risk (good resilience). Higher diversity reduces single points of failure and improves network resilience.">Network Diversity</span>:</strong> {{ contact_intel.portfolio_diversity }}</li>
        
        <li><strong><span title="Geographic diversity assesses country distribution risk. Single country: high censorship/legal risk. 2 countries: moderate concentration risk. 3+ countries: good diversification for network resilience.">Geographic Diversity</span>:</strong> {{ contact_intel.geographic_countries }} {{ "country" if contact_intel.geographic_countries == 1 else "countries" }} - {{ contact_intel.geographic_risk }}</li>
        
        <li><strong><span title="Infrastructure diversity analyzes platform and version distribution. All same platform/version: high synchronization risk. Mixed platforms/versions: better security through diversity.">Infrastructure Diversity</span>:</strong> {{ contact_intel.infrastructure_platforms }} {{ "platform" if contact_intel.infrastructure_platforms == 1 else "platforms" }}, {{ contact_intel.infrastructure_versions }} {{ "version" if contact_intel.infrastructure_versions == 1 else "versions" }} - {{ contact_intel.infrastructure_risk }}</li>
        
        <li><strong><span title="Bandwidth measurements show how many relays are measured by directory authorities for consensus weight calculation. Measured relays contribute more effectively to the network.">Bandwidth Measurements</span>:</strong> {{ contact_intel.measurement_status }}</li>
        
        <li><strong><span title="Performance insights identify underutilized relays with high bandwidth (>10MB/s) but low consensus weight (<0.05% of bandwidth). These relays may need configuration optimization or better connectivity.">Performance Insights</span>:</strong> {{ contact_intel.performance_underutilized }} underutilized relays - {{ contact_intel.performance_status }}{% if contact_intel.performance_underutilized_fps %} ({% for fp in contact_intel.performance_underutilized_fps %}{{ fp[:8] }}{% if not loop.last %}, {% endif %}{% endfor %}){% endif %}</li>
        
        <li><strong><span title="Operational maturity tracks deployment timeline and expansion patterns. Shows operator experience and growth strategy over time.">Operational Maturity</span>:</strong> {{ contact_intel.maturity }}</li>
    </ul>
</div>
{% endif %}{% endblock %}
