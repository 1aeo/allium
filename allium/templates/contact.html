{% extends "relay-list.html" %}
{% from "macros.html" import navigation, detail_summary %}
{% set contact_hash = relays.json['relay_subset'][0]['contact_md5'] %}
{% if relays.json['relay_subset'][0]['contact'] %}
    {% set contact = relays.json['relay_subset'][0]['contact']|escape %}
{% else %}
    {% set contact = 'none' %}
{% endif %}
{% block title %}Tor Relays :: Contact {{ contact_hash }}{% endblock %}
{% block header %}
    {% if relays.json['relay_subset'][0]['aroi_domain'] and relays.json['relay_subset'][0]['aroi_domain'] != 'none' -%}
        View Contact {{ relays.json['relay_subset'][0]['aroi_domain']|escape }} Details
    {% elif contact != 'none' -%}
        View Contact {{ contact }} Details
    {% else -%}
        View Contact {{ contact_hash }} Details
    {% endif -%}
{% endblock %}
{% block navigation -%}
{% set aroi_domain = relays.json['relay_subset'][0]['aroi_domain'] if relays.json['relay_subset'][0]['aroi_domain'] else 'none' %}
{{ navigation('contacts', page_ctx) }}
{% endblock -%}
{% block description %}
{# Option 1: Two-Column Layout (60/40 Split) - Final Version #}
<div class="row" style="margin-bottom: 20px;">
    {# Left Column (60%): Contact & Network Overview + Operator Intelligence #}
    <div class="col-md-7" style="padding-right: 20px;">
        <div style="padding: 15px; background-color: #f8f9fa; border-left: 4px solid #007bff; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #495057;">📋 Contact & Network Overview</h4>
            
            {# Contact Information #}
            <div style="margin-bottom: 15px;">
                <ul style="list-style-type: disc; padding-left: 20px; margin-bottom: 0;">
                    {% if aroi_domain and aroi_domain != 'none' %}
                    <li><strong>Domain:</strong> {{ aroi_domain|escape }}</li>
                    {% endif %}
                    {% if contact != 'none' %}
                    <li><strong>Contact:</strong> {{ contact }}</li>
                    {% endif %}
                    <li><strong>Hash:</strong> {{ contact_hash }}</li>
                    {% if relays.json['relay_subset'][0]['country'] %}
                    <li><strong>Country:</strong> 
                        <a href="{{ page_ctx.path_prefix }}country/{{ relays.json['relay_subset'][0]['country'] }}/" style="color: #337ab7; text-decoration: none;">
                            <img src="{{ page_ctx.path_prefix }}static/images/cc/{{ relays.json['relay_subset'][0]['country'] }}.png" 
                                 title="{{ relays.json['relay_subset'][0]['country_name'] if relays.json['relay_subset'][0]['country_name'] else relays.json['relay_subset'][0]['country']|upper }}" 
                                 alt="{{ relays.json['relay_subset'][0]['country_name'] if relays.json['relay_subset'][0]['country_name'] else relays.json['relay_subset'][0]['country']|upper }}" 
                                 style="width: 16px; height: 12px; margin-right: 5px; vertical-align: middle;">
                            {{ relays.json['relay_subset'][0]['country_name'] if relays.json['relay_subset'][0]['country_name'] else relays.json['relay_subset'][0]['country']|upper }}
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
            
            {# Network Summary - Enhanced with conditional display #}
            <div>
                <strong>Network Summary:</strong>
                <ul style="list-style-type: disc; padding-left: 20px; margin-bottom: 15px;">
                    <li><strong><span title="Observed bandwidth represents the estimated capacity this group can handle, combining total, guard, middle, and exit bandwidth contributions">Bandwidth</span>:</strong> ~{{ bandwidth }} {{ bandwidth_unit }}
                        {# Only show non-zero bandwidth components #}
                        {% set bw_components = [] %}
                        {% if guard_count > 0 and guard_bandwidth != '0.00' %}
                            {% set _ = bw_components.append(guard_bandwidth + ' ' + bandwidth_unit + ' guard') %}
                        {% endif %}
                        {% if middle_count > 0 and middle_bandwidth != '0.00' %}
                            {% set _ = bw_components.append(middle_bandwidth + ' ' + bandwidth_unit + ' middle') %}
                        {% endif %}
                        {% if exit_count > 0 and exit_bandwidth != '0.00' %}
                            {% set _ = bw_components.append(exit_bandwidth + ' ' + bandwidth_unit + ' exit') %}
                        {% endif %}
                        {% if bw_components %}
                            (<span title="Bandwidth breakdown by relay type">{{ bw_components|join(', ') }}</span>)
                        {% endif %}
                    </li>
                    
                    <li><strong><span title="Network influence represents the percentage of overall consensus weight, indicating relative importance in the Tor network across guard, middle, and exit positions">Network Influence</span>:</strong> {{ "%.2f%%"|format(consensus_weight_fraction * 100) }} of overall consensus weight
                        {# Only show non-zero consensus components #}
                        {% set cw_components = [] %}
                        {% if guard_count > 0 and guard_consensus_weight_fraction > 0 %}
                            {% set _ = cw_components.append("%.2f%% guard"|format(guard_consensus_weight_fraction * 100)) %}
                        {% endif %}
                        {% if middle_count > 0 and middle_consensus_weight_fraction > 0 %}
                            {% set _ = cw_components.append("%.2f%% middle"|format(middle_consensus_weight_fraction * 100)) %}
                        {% endif %}
                        {% if exit_count > 0 and exit_consensus_weight_fraction > 0 %}
                            {% set _ = cw_components.append("%.2f%% exit"|format(exit_consensus_weight_fraction * 100)) %}
                        {% endif %}
                        {% if cw_components %}
                            (<span title="Consensus weight breakdown by position">{{ cw_components|join(', ') }}</span>)
                        {% endif %}
                    </li>
                    
                    <li><strong><span title="Network position indicates the strategic role distribution of relays. Labels: Guard-focused (>60% guard), Exit-focused (>40% exit), Multi-role (both guard and exit >20%), Balanced (mixed roles), Guard-only (100% guard), Exit-only (100% exit), Middle-only (100% middle)">Network Position</span>:</strong> {{ network_position.formatted_string }}
                        {# Only show non-zero relay counts #}
                        {% set position_components = [] %}
                        {% if guard_count > 0 %}
                            {% set _ = position_components.append(guard_count|string + ' guard' + ('s' if guard_count != 1 else '')) %}
                        {% endif %}
                        {% if middle_count > 0 %}
                            {% set _ = position_components.append(middle_count|string + ' middle') %}
                        {% endif %}
                        {% if exit_count > 0 %}
                            {% set _ = position_components.append(exit_count|string + ' exit' + ('s' if exit_count != 1 else '')) %}
                        {% endif %}
                        ({{ relays.json['relay_subset']|length }} total relay{{ 's' if relays.json['relay_subset']|length != 1 else '' }}{% if position_components %}, {{ position_components|join(', ') }}{% endif %})
                    </li>
                </ul>
            </div>
        </div>
        
        {# Operator Intelligence - Moved to left column #}
        {% if relays.json.smart_context and relays.json.smart_context.contact_intelligence and relays.json.smart_context.contact_intelligence.template_optimized.get(contact_hash) %}
        {% set contact_intel = relays.json.smart_context.contact_intelligence.template_optimized[contact_hash] %}
        <div class="intelligence-section" style="padding: 15px; background-color: #f8f9fa; border-left: 4px solid #007bff;">
            <h4 style="margin-top: 0; color: #495057;">📊 Operator Intelligence</h4>
            
            <ul style="list-style-type: disc; padding-left: 20px; margin-bottom: 0;">
                <li><strong><span title="Network diversity measures infrastructure distribution across different autonomous systems (AS). Ratings: 1 network = Poor (single point of failure), 2-3 networks = Okay (limited redundancy), 4+ networks = Great (excellent resilience). Higher diversity reduces single points of failure and improves network resilience.">Network Diversity</span>:</strong> {% if 'Poor' in contact_intel.portfolio_diversity %}<span style="color: #c82333; font-weight: bold;">Poor</span>, {{ contact_intel.portfolio_diversity.split(', ', 1)[1] }}{% elif 'Okay' in contact_intel.portfolio_diversity %}<span style="color: #cc9900; font-weight: bold;">Okay</span>, {{ contact_intel.portfolio_diversity.split(', ', 1)[1] }}{% else %}<span style="color: #2e7d2e; font-weight: bold;">Great</span>, {{ contact_intel.portfolio_diversity.split(', ', 1)[1] }}{% endif %}</li>
                
                <li><strong><span title="Geographic diversity assesses legal and censorship risk based on country distribution. Ratings: 1 country = Poor (high legal/censorship risk), 2-3 countries = Okay (limited jurisdictional diversity), 4+ countries = Great (excellent jurisdictional protection). Diversification across countries protects against coordinated legal action and censorship.">Geographic Diversity</span>:</strong> {% if 'Poor' in contact_intel.geographic_risk %}<span style="color: #c82333; font-weight: bold;">Poor</span>, {{ contact_intel.geographic_risk.split(', ', 1)[1] }}{% elif 'Okay' in contact_intel.geographic_risk %}<span style="color: #cc9900; font-weight: bold;">Okay</span>, {{ contact_intel.geographic_risk.split(', ', 1)[1] }}{% else %}<span style="color: #2e7d2e; font-weight: bold;">Great</span>, {{ contact_intel.geographic_risk.split(', ', 1)[1] }}{% endif %}</li>
                
                <li><strong><span title="Infrastructure diversity analyzes platform and version distribution. Ratings: Same platform/version = Poor (high synchronization risk), Limited diversity = Okay (moderate risk), Multiple platforms/versions = Great (excellent security through diversity).">Infrastructure Diversity</span>:</strong> {% if 'Poor' in contact_intel.infrastructure_risk %}<span style="color: #c82333; font-weight: bold;">Poor</span>, {{ contact_intel.infrastructure_risk.split(', ', 1)[1] }}{% elif 'Okay' in contact_intel.infrastructure_risk %}<span style="color: #cc9900; font-weight: bold;">Okay</span>, {{ contact_intel.infrastructure_risk.split(', ', 1)[1] }}{% else %}<span style="color: #2e7d2e; font-weight: bold;">Great</span>, {{ contact_intel.infrastructure_risk.split(', ', 1)[1] }}{% endif %}</li>
                
                <li><strong><span title="Bandwidth measurements show how many relays are measured by directory authorities for consensus weight calculation. Measured relays contribute more effectively to the network.">Bandwidth Measurements</span>:</strong> {{ contact_intel.measurement_status }}</li>
                
                <li><strong><span title="Performance insights identify underutilized relays with high bandwidth (>10MB/s) but low consensus weight (<0.05% of bandwidth). These relays may need configuration optimization or better connectivity.">Performance Insights</span>:</strong> {{ contact_intel.performance_underutilized }} underutilized relays - {{ contact_intel.performance_status }}{% if contact_intel.performance_underutilized_fps %} ({% for fp in contact_intel.performance_underutilized_fps %}{{ fp[:8] }}{% if not loop.last %}, {% endif %}{% endfor %}){% endif %}</li>
                
                <li><strong><span title="Operational maturity tracks deployment timeline and expansion patterns. Shows operator experience and growth strategy over time.">Operational Maturity</span>:</strong> {{ contact_intel.maturity }}</li>
            </ul>
        </div>
        {% endif %}
    </div>
    
    {# Right Column (40%): AROI Rankings & Streamlined Reliability #}
    <div class="col-md-5">
        {# AROI Leaderboard Rankings #}
        {% if contact_rankings %}
        <div class="aroi-rankings-section" style="margin-bottom: 20px; padding: 15px; background-color: #f0f8ff; border-left: 4px solid #28a745;">
            <h4 style="margin: 0 0 8px 0; color: #495057; font-size: 16px;">🏆 AROI Champion Rankings</h4>
            
            <p style="margin-bottom: 8px; color: #666; font-size: 13px;">{{ contact_rankings|length }} winning <a href="{{ page_ctx.path_prefix }}misc/aroi-leaderboards.html" title="View complete AROI Champions Dashboard" style="color: #007bff; text-decoration: none; font-weight: bold;">AROI Champions Dashboard</a> categories:</p>
            
            <ul style="list-style-type: none; padding-left: 0; margin-bottom: 0;">
                {% for ranking in contact_rankings %}
                <li style="margin-bottom: 4px; padding: 4px 8px; background-color: #ffffff; border-radius: 3px; border: 1px solid #dee2e6; font-size: 14px;">
                    <a href="{{ page_ctx.path_prefix }}misc/{{ ranking.link }}" title="View {{ ranking.category_name }} leaderboard rankings" style="color: #007bff; text-decoration: none; font-weight: bold;">
                        {{ ranking.emoji }} {{ ranking.statement }}
                    </a>
                    <small style="color: #666; margin-left: 6px; font-size: 12px;">— {{ ranking.title }}</small>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        {# Network Reliability - Enhanced formatting #}
        {% if operator_reliability and operator_reliability.valid_relays > 0 %}
        <div class="reliability-section" style="padding: 15px; background-color: #f8f9fa; border-left: 4px solid #28a745;">
            <h4 style="margin-top: 0; color: #495057;">⏰ Network Reliability</h4>
            
            {# Overall uptime - with green highlighting for 100% #}
            <div style="margin-bottom: 15px;">
                <strong>Overall uptime:</strong>
                {% for period, data in operator_reliability.overall_uptime.items() %}
                    {% if data.average == 100.0 %}
                        <span style="color: #28a745; font-weight: bold;">{{ data.display_name }} {{ "%.1f"|format(data.average) }}%</span>
                    {% else %}
                        {{ data.display_name }} {{ "%.1f"|format(data.average) }}%
                    {% endif %}
                    ({{ data.relay_count }} relays){% if not loop.last %}, {% endif %}
                {% endfor %}
            </div>
            
            {# Statistical outliers section - single line format #}
            {% set total_outliers = operator_reliability.outliers.low_outliers|length + operator_reliability.outliers.high_outliers|length %}
            {% if total_outliers > 0 %}
            <div style="margin-bottom: 10px;">
                {# Get the mean from 6-month period as reference for tooltip #}
                {% set mean_uptime = operator_reliability.overall_uptime.get('6_months', {}).get('average', 0) %}
                <strong><span title="≥2σ from average μ {{ "%.1f"|format(mean_uptime) }}%">Outliers</span>:</strong>
                <span style="color: #000; font-weight: normal;">{{ total_outliers }} relay{{ 's' if total_outliers != 1 else '' }}</span>{% if operator_reliability.outliers.low_outliers %}, <span style="color: #dc3545; font-weight: bold;">⚠️ Low:</span> {% set low_names = [] %}{% for outlier in operator_reliability.outliers.low_outliers %}{% set _ = low_names.append(outlier.nickname + " (" + "%.1f"|format(outlier.uptime) + "%)") %}{% endfor %}<span title="{{ low_names|join(', ') }}" style="cursor: help; text-decoration: underline;">{{ operator_reliability.outliers.low_outliers|length }} relay{{ 's' if operator_reliability.outliers.low_outliers|length != 1 else '' }}</span>{% endif %}{% if operator_reliability.outliers.high_outliers %}{% if operator_reliability.outliers.low_outliers %}, {% endif %}<span style="color: #28a745; font-weight: bold;">🏆 Exceptional:</span> {% set high_names = [] %}{% for outlier in operator_reliability.outliers.high_outliers %}{% set _ = high_names.append(outlier.nickname + " (" + "%.1f"|format(outlier.uptime) + "%)") %}{% endfor %}<span title="{{ high_names|join(', ') }}" style="cursor: help; text-decoration: underline;">{{ operator_reliability.outliers.high_outliers|length }} relay{{ 's' if operator_reliability.outliers.high_outliers|length != 1 else '' }}</span>{% endif %}
            </div>
            {% else %}
            <div style="margin-bottom: 10px;">
                <span style="color: #28a745;">✅ No statistical outliers detected - consistent performance across all relays</span>
            </div>
            {% endif %}
            
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
                Reliability data available for {{ operator_reliability.valid_relays }}/{{ operator_reliability.total_relays }} relays
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
